{"version":3,"file":"web-HPdob_9n.js","sources":["../../../src/renderer/js/error-handler.ts","../../../src/renderer/js/logger.ts","../../../src/renderer/js/web/fgraph-shim.ts","../../../src/renderer/js/web/api-key-ui.ts","../../../src/renderer/js/web/iframe-api.ts","../../../src/renderer/js/assisted/app/history.ts","../../../src/renderer/data/prompt-templates.ts","../../../src/renderer/js/posture-manager.ts","../../../src/renderer/js/assisted/app/adaptive.ts","../../../src/renderer/js/canvas-id-store.ts","../../../src/renderer/js/canvas/validation.ts","../../../src/renderer/js/storage.ts","../../../src/renderer/js/canvas/minimap.ts","../../../src/renderer/js/canvas/connections.ts","../../../src/renderer/js/canvas/persistence.ts","../../../src/renderer/js/canvas/filters.ts","../../../src/renderer/js/canvas/spatial-grid.ts","../../../src/renderer/js/canvas/layout.ts","../../../src/renderer/js/canvas/collisions.ts","../../../src/renderer/js/canvas/viewport.ts","../../../src/renderer/js/canvas/tree-layout.ts","../../../src/renderer/js/canvas/selection.ts","../../../src/renderer/js/canvas/menus.ts","../../../src/renderer/js/canvas/interactions.ts","../../../src/renderer/js/canvas/nodes.ts","../../../src/renderer/js/canvas.ts","../../../src/renderer/js/history.ts","../../../src/renderer/js/assisted/llm.ts","../../../src/renderer/js/assisted/metrics.ts","../../../src/renderer/js/assisted/analyzer/config.ts","../../../src/renderer/js/assisted/friction/referentielsLoader.ts","../../../src/renderer/js/assisted/analyzer/diversity.ts","../../../src/renderer/js/assisted/analyzer/history.ts","../../../src/renderer/js/assisted/analyzer/friction.ts","../../../src/renderer/js/assisted/canvas-analyzer.ts","../../../src/renderer/js/assisted/webview/capture-parsers.ts","../../../src/renderer/js/assisted/webview/capture.ts","../../../src/renderer/js/assisted/llm-api/router.ts","../../../src/renderer/js/assisted/llm-api/executor.ts","../../../src/renderer/js/assisted/llm-api/ui-states.ts","../../../src/renderer/js/assisted/llm-api/config-modal.ts","../../../src/renderer/js/assisted/llm-api.ts","../../../src/renderer/js/oxygen/graph-analysis.ts","../../../src/renderer/js/oxygen/oxygen.ts","../../../src/renderer/js/theme-manager.ts","../../../src/renderer/js/web-app.ts"],"sourcesContent":["// Error handler global ‚Äî extrait de index.html et assisted.html pour compatibilit√© ES modules\r\nwindow.onerror = function (msg: string | Event, url?: string, line?: number, _col?: number, _error?: Error): boolean {\r\n    console.error('[KAIROS ERROR]', msg, 'at', url, 'line', line);\r\n    return false;\r\n};\r\n","/**\r\n * Logger - Structured logging module for KAIROS\r\n *\r\n * Replaces direct console.log/warn/error calls with level-based logging.\r\n * Preserves the existing [ComponentName] tag pattern.\r\n *\r\n * Usage:\r\n *   import { createLogger } from './logger.js';\r\n *   const log = createLogger('WebviewHandler');\r\n *   log.info('Capture en cours...');     // [WebviewHandler] Capture en cours...\r\n *   log.debug('Details:', data);         // Only shown if level >= DEBUG\r\n *   log.warn('Timeout');                 // [WebviewHandler] Timeout\r\n *   log.error('Failed:', error);         // [WebviewHandler] Failed: ...\r\n */\r\n\r\nexport enum LogLevel {\r\n    DEBUG = 0,\r\n    INFO = 1,\r\n    WARN = 2,\r\n    ERROR = 3,\r\n    SILENT = 4,\r\n}\r\n\r\nlet globalLevel: LogLevel = LogLevel.DEBUG;\r\n\r\nexport function setGlobalLevel(level: LogLevel): void {\r\n    globalLevel = level;\r\n}\r\n\r\nexport function getGlobalLevel(): LogLevel {\r\n    return globalLevel;\r\n}\r\n\r\nexport interface Logger {\r\n    debug(...args: any[]): void;\r\n    info(...args: any[]): void;\r\n    warn(...args: any[]): void;\r\n    error(...args: any[]): void;\r\n}\r\n\r\nexport function createLogger(tag: string): Logger {\r\n    const prefix = `[${tag}]`;\r\n\r\n    return {\r\n        debug(...args: any[]) {\r\n            if (globalLevel <= LogLevel.DEBUG) {\r\n                console.log(prefix, ...args);\r\n            }\r\n        },\r\n        info(...args: any[]) {\r\n            if (globalLevel <= LogLevel.INFO) {\r\n                console.log(prefix, ...args);\r\n            }\r\n        },\r\n        warn(...args: any[]) {\r\n            if (globalLevel <= LogLevel.WARN) {\r\n                console.warn(prefix, ...args);\r\n            }\r\n        },\r\n        error(...args: any[]) {\r\n            if (globalLevel <= LogLevel.ERROR) {\r\n                console.error(prefix, ...args);\r\n            }\r\n        },\r\n    };\r\n}\r\n","/**\r\n * fgraph-shim.ts ‚Äî Polyfill window.fgraph pour la version web\r\n *\r\n * Remplace le bridge Electron IPC par :\r\n * - DB : no-ops (session √©ph√©m√®re, pas de persistence)\r\n * - LLM : fetch direct vers un proxy configurable (bypass CORS)\r\n * - Secure storage : Map en m√©moire (cl√©s API session-only)\r\n * - Electron-specific : no-ops\r\n */\r\n\r\nimport { createLogger } from '../logger.js';\r\n\r\nconst log = createLogger('FgraphShim');\r\n\r\n// ‚îÄ‚îÄ‚îÄ API Key Store (m√©moire session uniquement) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n\r\nconst apiKeyStore = new Map<string, string>();\r\n\r\n// ‚îÄ‚îÄ‚îÄ Proxy LLM configurable ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n\r\nlet proxyUrl: string | null = null;\r\n\r\nconst ALLOWED_PROXY_PATTERNS: RegExp[] = [\r\n    /^\\/api\\//, // chemins relatifs commen√ßant par /api/\r\n    /^https?:\\/\\/localhost(:\\d+)?\\//, // localhost en dev\r\n    // IMPORTANT : remplacer par le subdomain exact apr√®s d√©ploiement\r\n    // ex: /^https:\\/\\/kairos-llm-proxy\\.VOTRE-COMPTE\\.workers\\.dev\\//\r\n    /^https:\\/\\/kairos-llm-proxy\\.[a-z0-9-]+\\.workers\\.dev\\/api\\/llm$/,\r\n];\r\n\r\nfunction isProxyUrlAllowed(url: string): boolean {\r\n    return ALLOWED_PROXY_PATTERNS.some((pattern) => pattern.test(url));\r\n}\r\n\r\nexport function setProxyUrl(url: string): void {\r\n    if (!isProxyUrlAllowed(url)) {\r\n        log.error(`Proxy URL refus√©e (non whitelist√©e): ${url}`);\r\n        return;\r\n    }\r\n    proxyUrl = url;\r\n    log.info(`Proxy URL configur√©e: ${url}`);\r\n}\r\n\r\nexport function getProxyUrl(): string | null {\r\n    return proxyUrl;\r\n}\r\n\r\n// ‚îÄ‚îÄ‚îÄ LLM Query via proxy ou direct ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n\r\ninterface LLMQueryParams {\r\n    provider: string;\r\n    apiKey: string | null;\r\n    model: string;\r\n    messages: Array<{ role: string; content: string }>;\r\n    systemPrompt?: string;\r\n    options?: Record<string, any>;\r\n}\r\n\r\ninterface LLMQueryResponse {\r\n    success: boolean;\r\n    content?: string;\r\n    thinking?: string | null;\r\n    usage?: Record<string, any>;\r\n    error?: string;\r\n}\r\n\r\nasync function callLLMDirect(params: LLMQueryParams): Promise<LLMQueryResponse> {\r\n    const { provider, apiKey, model, messages, systemPrompt, options } = params;\r\n    const maxTokens = options?.max_tokens || options?.maxTokens || 4096;\r\n\r\n    let url: string;\r\n    let headers: Record<string, string>;\r\n    let body: Record<string, any>;\r\n\r\n    if (provider === 'anthropic' || provider === 'claude') {\r\n        url = 'https://api.anthropic.com/v1/messages';\r\n        headers = {\r\n            'Content-Type': 'application/json',\r\n            'x-api-key': apiKey || '',\r\n            'anthropic-version': '2023-06-01',\r\n            'anthropic-dangerous-direct-browser-access': 'true',\r\n        };\r\n        body = { model: model || 'claude-sonnet-4-20250514', max_tokens: maxTokens, messages };\r\n        if (systemPrompt) body.system = systemPrompt;\r\n    } else if (provider === 'openai' || provider === 'chatgpt') {\r\n        url = 'https://api.openai.com/v1/chat/completions';\r\n        headers = { 'Content-Type': 'application/json', Authorization: `Bearer ${apiKey}` };\r\n        const fullMessages = systemPrompt\r\n            ? [{ role: 'system', content: systemPrompt }, ...messages]\r\n            : messages;\r\n        body = { model: model || 'gpt-4o', messages: fullMessages, max_tokens: maxTokens };\r\n    } else if (provider === 'gemini') {\r\n        url = `https://generativelanguage.googleapis.com/v1beta/models/${model || 'gemini-1.5-pro'}:generateContent?key=${apiKey}`;\r\n        headers = { 'Content-Type': 'application/json' };\r\n        const contents = messages.map((m) => ({\r\n            role: m.role === 'assistant' ? 'model' : 'user',\r\n            parts: [{ text: m.content }],\r\n        }));\r\n        body = { contents, generationConfig: { maxOutputTokens: maxTokens } };\r\n        if (systemPrompt) body.systemInstruction = { parts: [{ text: systemPrompt }] };\r\n    } else if (provider === 'deepseek') {\r\n        url = 'https://api.deepseek.com/chat/completions';\r\n        headers = { 'Content-Type': 'application/json', Authorization: `Bearer ${apiKey}` };\r\n        const fullMessages = systemPrompt\r\n            ? [{ role: 'system', content: systemPrompt }, ...messages]\r\n            : messages;\r\n        body = { model: model || 'deepseek-chat', messages: fullMessages, max_tokens: maxTokens };\r\n    } else if (provider === 'grok') {\r\n        url = 'https://api.x.ai/v1/chat/completions';\r\n        headers = { 'Content-Type': 'application/json', Authorization: `Bearer ${apiKey}` };\r\n        const fullMessages = systemPrompt\r\n            ? [{ role: 'system', content: systemPrompt }, ...messages]\r\n            : messages;\r\n        body = { model: model || 'grok-2', messages: fullMessages, max_tokens: maxTokens };\r\n    } else {\r\n        return { success: false, error: `Provider inconnu: ${provider}` };\r\n    }\r\n\r\n    const response = await fetch(url, {\r\n        method: 'POST',\r\n        headers,\r\n        body: JSON.stringify(body),\r\n    });\r\n\r\n    if (!response.ok) {\r\n        const errorText = await response.text();\r\n        // Tronquer et nettoyer le message d'erreur (pas de fuite de cl√©/donn√©es sensibles)\r\n        const safeError = errorText\r\n            .slice(0, 300)\r\n            .replace(/sk-[a-zA-Z0-9]{4,}/g, 'sk-***')\r\n            .replace(/key-[a-zA-Z0-9]{4,}/g, 'key-***')\r\n            .replace(/AIza[a-zA-Z0-9_-]{4,}/g, 'AIza***');\r\n        return { success: false, error: `API Error ${response.status}: ${safeError}` };\r\n    }\r\n\r\n    const data = await response.json();\r\n\r\n    // Normaliser la r√©ponse selon le provider\r\n    let content = '';\r\n    let thinking: string | null = null;\r\n\r\n    if (provider === 'anthropic' || provider === 'claude') {\r\n        if (data.content?.length > 0) {\r\n            for (const block of data.content) {\r\n                if (block.type === 'text') content += block.text;\r\n                else if (block.type === 'thinking') thinking = block.thinking;\r\n            }\r\n        }\r\n    } else if (provider === 'gemini') {\r\n        content = data.candidates?.[0]?.content?.parts?.[0]?.text || '';\r\n    } else {\r\n        content = data.choices?.[0]?.message?.content || '';\r\n    }\r\n\r\n    return { success: true, content, thinking, usage: data.usage || data.usageMetadata };\r\n}\r\n\r\nasync function callLLMProxy(params: LLMQueryParams): Promise<LLMQueryResponse> {\r\n    if (!proxyUrl) {\r\n        // Pas de proxy configur√© ‚Üí appel direct (CORS peut bloquer)\r\n        return callLLMDirect(params);\r\n    }\r\n\r\n    try {\r\n        const response = await fetch(proxyUrl, {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify(params),\r\n        });\r\n\r\n        if (!response.ok) {\r\n            const errorText = await response.text();\r\n            return { success: false, error: `Proxy Error ${response.status}: ${errorText.slice(0, 300)}` };\r\n        }\r\n\r\n        return await response.json();\r\n    } catch (error) {\r\n        return { success: false, error: `Proxy unreachable: ${(error as Error).message}` };\r\n    }\r\n}\r\n\r\n// ‚îÄ‚îÄ‚îÄ Installation du shim ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n\r\nexport function installFgraphShim(): void {\r\n    (window as any).fgraph = {\r\n        // ‚îÄ‚îÄ‚îÄ Database (all no-ops) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n        db: {\r\n            canvas: {\r\n                saveAll: async () => ({ success: true }),\r\n                loadAll: async () => ({ nodes: [], connections: [] }),\r\n                ensureDefault: async () => {},\r\n                getAll: async () => [],\r\n                getById: async () => null,\r\n                create: async () => {},\r\n                update: async () => {},\r\n                remove: async () => {},\r\n            },\r\n            nodes: {\r\n                replaceAll: async () => {},\r\n            },\r\n            connections: {\r\n                replaceAll: async () => {},\r\n            },\r\n            syntheses: {\r\n                getAllByCanvas: async () => [],\r\n                replaceAll: async () => {},\r\n            },\r\n            promptLogs: {\r\n                create: async () => {},\r\n                getAllByCanvas: async () => [],\r\n                removeAllByCanvas: async () => {},\r\n                update: async () => {},\r\n                prune: async () => {},\r\n            },\r\n            attractors: {\r\n                upsert: async () => {},\r\n                getData: async () => ({}),\r\n                mergeData: async () => {},\r\n            },\r\n            captures: {\r\n                replaceAll: async () => {},\r\n            },\r\n        },\r\n\r\n        // ‚îÄ‚îÄ‚îÄ Secure storage (in-memory) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n        secureGet: async (key: string) => {\r\n            const value = apiKeyStore.get(key) || null;\r\n            return { success: true, value };\r\n        },\r\n        secureSet: async (key: string, value: string) => {\r\n            apiKeyStore.set(key, value);\r\n            return { success: true };\r\n        },\r\n\r\n        // ‚îÄ‚îÄ‚îÄ LLM Query ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n        llmQuery: async (params: LLMQueryParams): Promise<LLMQueryResponse> => {\r\n            log.info(`LLM query: provider=${params.provider}, model=${params.model}`);\r\n            return callLLMProxy(params);\r\n        },\r\n\r\n        // ‚îÄ‚îÄ‚îÄ Electron-specific (no-ops) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n        focusMainWindow: async () => {},\r\n    };\r\n\r\n    // ‚îÄ‚îÄ‚îÄ Legacy global stub (CircularityDetector) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n    // Remplac√© par CanvasAnalyzer, mais referentielsLoader.ts v√©rifie encore\r\n    // typeof CircularityDetector. Un objet vide suffit √† supprimer le warning.\r\n    (window as any).CircularityDetector = { REFERENTIELS: {} };\r\n\r\n    log.info('Shim install√© ‚Äî mode web √©ph√©m√®re');\r\n}\r\n","/**\r\n * api-key-ui.ts ‚Äî Modal de saisie de cl√© API pour la version web\r\n *\r\n * La cl√© est stock√©e en m√©moire uniquement (via le shim fgraph secureSet).\r\n * Jamais persist√©e dans localStorage, sessionStorage, cookie, ou attribut DOM.\r\n */\r\n\r\nimport { createLogger } from '../logger.js';\r\n\r\nconst log = createLogger('ApiKeyUI');\r\n\r\n// Mod√®les par d√©faut selon le provider\r\nconst DEFAULT_MODELS: Record<string, string> = {\r\n    claude: 'claude-sonnet-4-20250514',\r\n    chatgpt: 'gpt-4o',\r\n    gemini: 'gemini-1.5-pro',\r\n    deepseek: 'deepseek-chat',\r\n    grok: 'grok-2',\r\n};\r\n\r\n/**\r\n * Configure l'UI de saisie de cl√© API\r\n * @param llm - Instance du LLMManager\r\n * @param onConfigured - Callback appel√© quand une cl√© est valid√©e\r\n */\r\nexport function setupApiKeyUI(llm: any, onConfigured?: () => void): void {\r\n    const modal = document.getElementById('api-key-modal');\r\n    const providerSelect = document.getElementById('api-provider-select') as HTMLSelectElement | null;\r\n    const modelInput = document.getElementById('api-model-input') as HTMLInputElement | null;\r\n    const keyInput = document.getElementById('api-key-input') as HTMLInputElement | null;\r\n    const saveBtn = document.getElementById('api-key-save-btn');\r\n    const cancelBtn = document.getElementById('api-key-cancel-btn');\r\n    const configBtn = document.getElementById('api-config-btn');\r\n\r\n    if (!modal || !providerSelect || !modelInput || !keyInput || !saveBtn || !cancelBtn) {\r\n        log.error('√âl√©ments DOM de la modal API manquants');\r\n        return;\r\n    }\r\n\r\n    // Dernier provider connu ‚Äî pour d√©tecter un vrai changement de provider\r\n    let lastProvider = '';\r\n\r\n    // Mettre √† jour le mod√®le selon le provider s√©lectionn√©\r\n    function updateModelForProvider(): void {\r\n        const provider = providerSelect!.value;\r\n        const defaultModel = DEFAULT_MODELS[provider] || '';\r\n        modelInput!.placeholder = `ex: ${defaultModel}`;\r\n\r\n        // Si le provider a chang√©, remplacer le mod√®le par celui du nouveau provider\r\n        if (provider !== lastProvider) {\r\n            modelInput!.value = llm.providers[provider]?.model || defaultModel;\r\n            lastProvider = provider;\r\n        }\r\n    }\r\n\r\n    providerSelect.addEventListener('change', updateModelForProvider);\r\n\r\n    // Ouvrir la modal\r\n    function openModal(): void {\r\n        // Remplir avec les valeurs actuelles du LLM manager\r\n        const currentProvider = llm.currentProvider || 'claude';\r\n        providerSelect!.value = currentProvider;\r\n        lastProvider = currentProvider;\r\n        modelInput!.value = llm.providers[currentProvider]?.model || DEFAULT_MODELS[currentProvider] || '';\r\n        // Ne jamais pr√©-remplir la cl√©\r\n        keyInput!.value = '';\r\n        modal!.classList.remove('hidden');\r\n        keyInput!.focus();\r\n    }\r\n\r\n    // Fermer la modal\r\n    function closeModal(): void {\r\n        // Vider le champ cl√© API du DOM\r\n        keyInput!.value = '';\r\n        modal!.classList.add('hidden');\r\n    }\r\n\r\n    // Bouton config dans la toolbar\r\n    if (configBtn) {\r\n        configBtn.addEventListener('click', openModal);\r\n    }\r\n\r\n    // V√©rifie si au moins une cl√© est configur√©e\r\n    function hasApiKey(): boolean {\r\n        return Object.values(llm.providers).some((p: any) => p.apiKey);\r\n    }\r\n\r\n    // Bouton annuler (bloqu√© si aucune cl√©)\r\n    cancelBtn.addEventListener('click', () => {\r\n        if (hasApiKey()) closeModal();\r\n    });\r\n\r\n    // Clic en dehors de la modal (bloqu√© si aucune cl√©)\r\n    modal.addEventListener('click', (e) => {\r\n        if (e.target === modal && hasApiKey()) closeModal();\r\n    });\r\n\r\n    // √âchap pour fermer (bloqu√© si aucune cl√©)\r\n    document.addEventListener('keydown', (e) => {\r\n        if (e.key === 'Escape' && !modal.classList.contains('hidden') && hasApiKey()) {\r\n            closeModal();\r\n        }\r\n    });\r\n\r\n    // Validation\r\n    saveBtn.addEventListener('click', async () => {\r\n        const provider = providerSelect.value;\r\n        const model = modelInput.value.trim();\r\n        const key = keyInput.value.trim();\r\n\r\n        if (!key) {\r\n            keyInput.classList.add('input-error');\r\n            setTimeout(() => keyInput.classList.remove('input-error'), 1500);\r\n            return;\r\n        }\r\n\r\n        // Configurer le LLM manager\r\n        llm.currentProvider = provider;\r\n        if (model) llm.providers[provider].model = model;\r\n        llm.providers[provider].apiKey = key;\r\n\r\n        // Sauvegarder via le shim (en m√©moire)\r\n        await llm.saveConfig();\r\n\r\n        log.info(`Cl√© API configur√©e pour provider: ${provider}`);\r\n\r\n        // Vider le champ cl√© avant de fermer\r\n        keyInput.value = '';\r\n        closeModal();\r\n\r\n        onConfigured?.();\r\n    });\r\n\r\n    // Entr√©e dans le champ cl√© ‚Üí valider\r\n    keyInput.addEventListener('keydown', (e) => {\r\n        if (e.key === 'Enter') {\r\n            e.preventDefault();\r\n            saveBtn.click();\r\n        }\r\n    });\r\n\r\n    // Initialiser le mod√®le par d√©faut\r\n    lastProvider = providerSelect.value;\r\n    updateModelForProvider();\r\n\r\n    // Si aucune cl√© n'est configur√©e, ouvrir la modal au d√©marrage (apr√®s un court d√©lai)\r\n    setTimeout(() => {\r\n        const hasAnyKey = Object.values(llm.providers).some((p: any) => p.apiKey);\r\n        if (!hasAnyKey) {\r\n            openModal();\r\n        }\r\n    }, 500);\r\n}\r\n","/**\r\n * KAIROS iframe API ‚Äî Communication avec le site parent\r\n *\r\n * Int√©gration recommand√©e c√¥t√© parent :\r\n *\r\n * <iframe\r\n *   src=\"kairos-web.html\"\r\n *   sandbox=\"allow-scripts allow-same-origin\"\r\n *   style=\"width:100%; height:600px; border:none;\"\r\n * ></iframe>\r\n *\r\n * S√âCURIT√â :\r\n * - sandbox=\"allow-scripts allow-same-origin\" : pas de allow-top-navigation ni allow-popups\r\n * - Les messages postMessage sont filtr√©s par origin (ALLOWED_ORIGINS)\r\n * - Le proxyUrl est valid√© contre une whitelist\r\n * - Les erreurs sont sanitiz√©es avant envoi\r\n * - La cl√© API n'est jamais persist√©e ni transmise au parent\r\n */\r\n\r\nimport { setProxyUrl } from './fgraph-shim.js';\r\nimport { createLogger } from '../logger.js';\r\n\r\nconst log = createLogger('IframeAPI');\r\n\r\n// ‚îÄ‚îÄ‚îÄ S√©curit√© : origins autoris√©es ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n\r\nconst ALLOWED_ORIGINS: string[] = [\r\n    // En dev, accepter localhost\r\n    'http://localhost:3000',\r\n    'http://localhost:5173',\r\n    'http://localhost:5174',\r\n    // Prod ‚Äî GitHub Pages\r\n    'https://kairos-commu.github.io',\r\n];\r\n\r\nlet trustedParentOrigin: string | null = null;\r\n\r\n// ‚îÄ‚îÄ‚îÄ Sanitize des erreurs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n\r\nfunction sanitizeErrorMessage(error: unknown): string {\r\n    if (error instanceof Error) {\r\n        const msg = error.message;\r\n        // Ne pas leaker les cl√©s API partielles\r\n        return msg.replace(/sk-[a-zA-Z0-9]{4,}/g, 'sk-***').replace(/key-[a-zA-Z0-9]{4,}/g, 'key-***');\r\n    }\r\n    return 'Erreur interne KAIROS';\r\n}\r\n\r\n// ‚îÄ‚îÄ‚îÄ Envoi s√©curis√© au parent ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n\r\nfunction sendToParent(payload: Record<string, any>): void {\r\n    if (trustedParentOrigin && window.parent !== window) {\r\n        window.parent.postMessage(payload, trustedParentOrigin);\r\n    }\r\n}\r\n\r\n// ‚îÄ‚îÄ‚îÄ Setup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n\r\nexport function setupIframeAPI(app: any): void {\r\n    // Ne rien faire si on n'est pas dans une iframe\r\n    const isInIframe = window.parent !== window;\r\n\r\n    window.addEventListener('message', (event: MessageEvent) => {\r\n        // Filtrage par origin\r\n        if (!ALLOWED_ORIGINS.includes(event.origin)) {\r\n            log.warn(`Message ignor√© depuis origin non autoris√©e: ${event.origin}`);\r\n            return;\r\n        }\r\n\r\n        // M√©moriser l'origin de confiance\r\n        if (!trustedParentOrigin) {\r\n            trustedParentOrigin = event.origin;\r\n        }\r\n\r\n        const data = event.data;\r\n        if (!data || typeof data.type !== 'string') return;\r\n\r\n        try {\r\n            switch (data.type) {\r\n                case 'kairos:config':\r\n                    handleConfig(data, app);\r\n                    break;\r\n\r\n                case 'kairos:setApiKey':\r\n                    handleSetApiKey(data, app);\r\n                    break;\r\n\r\n                default:\r\n                    log.warn(`Message type inconnu: ${data.type}`);\r\n            }\r\n        } catch (error) {\r\n            log.error('Erreur traitement message:', error);\r\n            sendToParent({ type: 'kairos:error', message: sanitizeErrorMessage(error) });\r\n        }\r\n    });\r\n\r\n    // Notifier le parent que l'app est pr√™te (uniquement vers les origins autoris√©es)\r\n    if (isInIframe) {\r\n        for (const origin of ALLOWED_ORIGINS) {\r\n            window.parent.postMessage({ type: 'kairos:ready' }, origin);\r\n        }\r\n        log.info('Message kairos:ready envoy√© aux origins autoris√©es');\r\n    }\r\n\r\n    // √âmettre le nodeCount quand le canvas change\r\n    document.addEventListener('canvas:nodeAdded', () => emitNodeCount(app));\r\n    document.addEventListener('nodeDeleted', () => emitNodeCount(app));\r\n\r\n    log.info(`iframe API initialis√©e (iframe: ${isInIframe})`);\r\n}\r\n\r\n// ‚îÄ‚îÄ‚îÄ Handlers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n\r\nfunction handleConfig(data: any, app: any): void {\r\n    if (data.theme && (data.theme === 'obsidian' || data.theme === 'porcelain')) {\r\n        document.documentElement.setAttribute('data-theme', data.theme);\r\n        localStorage.setItem('kairos_theme', data.theme);\r\n        log.info(`Th√®me configur√©: ${data.theme}`);\r\n    }\r\n\r\n    if (data.proxyUrl) {\r\n        setProxyUrl(data.proxyUrl);\r\n    }\r\n}\r\n\r\nfunction handleSetApiKey(data: any, app: any): void {\r\n    if (!data.provider || !data.key) {\r\n        log.warn('kairos:setApiKey: provider ou key manquant');\r\n        return;\r\n    }\r\n\r\n    // Ne jamais logger la cl√©\r\n    log.info(`Cl√© API re√ßue pour provider: ${data.provider}`);\r\n\r\n    const llm = app.llm;\r\n    if (llm && llm.providers[data.provider]) {\r\n        llm.providers[data.provider].apiKey = data.key;\r\n        llm.currentProvider = data.provider;\r\n        llm.saveConfig();\r\n    }\r\n}\r\n\r\nfunction emitNodeCount(app: any): void {\r\n    const count = app.canvas?.state?.nodes?.length || 0;\r\n    sendToParent({ type: 'kairos:nodeCount', count });\r\n}\r\n","/**\r\n * History - Configuration des boutons Undo/Redo\r\n *\r\n * Responsabilit√© : Setup des boutons d'historique dans la toolbar\r\n *\r\n * D√©pendances :\r\n * - app.history : Instance de HistoryManager\r\n *\r\n * @exports setupHistoryButtons\r\n */\r\n\r\n/**\r\n * Configure les boutons Undo/Redo dans le bandeau\r\n */\r\nexport function setupHistoryButtons(app: any): void {\r\n    const undoBtn = document.getElementById('btn-undo');\r\n    const redoBtn = document.getElementById('btn-redo');\r\n\r\n    if (undoBtn) {\r\n        undoBtn.addEventListener('click', () => {\r\n            app.history.undo();\r\n        });\r\n    }\r\n\r\n    if (redoBtn) {\r\n        redoBtn.addEventListener('click', () => {\r\n            app.history.redo();\r\n        });\r\n    }\r\n}\r\n","/**\r\n * Prompt Templates ‚Äî Templates externalis√©s pour les op√©rations LLM\r\n *\r\n * Ce fichier centralise tous les templates de prompts utilis√©s par KAIROS.\r\n * Pr√©pare les niveaux 2 (√©dition templates) et 3 (pr√©visualisation) de la transparence.\r\n *\r\n * Variables dynamiques (interpol√©es √† l'ex√©cution) :\r\n * - {targetCount} : nombre adaptatif de vignettes (\"3-5\", \"2-3\", \"1-2\")\r\n * - {recentKeywords} : mots-cl√©s r√©cents (friction forte D√âVELOPPER)\r\n * - {recentMechanisms} : m√©canismes r√©cents (friction forte RELIER)\r\n * - {groupNum}, {totalGroups} : num√©rotation groupes mini-synth√®se\r\n */\r\n\r\nexport interface PromptTemplates {\r\n    systemPrompt: string;\r\n    systemPromptChatSuffix: string;\r\n    systemPromptChatEmpty: string;\r\n    structuralFraming: {\r\n        D√âVELOPPER: string;\r\n        RELIER: string;\r\n        SYNTH√âTISER: string;\r\n    };\r\n    operations: {\r\n        D√âVELOPPER: {\r\n            deepen: { full: string; branch: string };\r\n            diverge: { full: string; branch: string };\r\n        };\r\n        RELIER: { full: string; branch: string };\r\n        SYNTH√âTISER: { full: string; branch: string };\r\n    };\r\n    friction: {\r\n        develop: { moderate: string; strong: string };\r\n        link: { moderate: string; strong: string };\r\n    };\r\n    synthesis: {\r\n        simple: string;\r\n        simpleWithReinjection: string;\r\n        mini: string;\r\n        meta: string;\r\n    };\r\n}\r\n\r\nexport const defaultTemplates: PromptTemplates = {\r\n    // === SYSTEM PROMPT (Couche 1 ‚Äî Grammaire de lecture) ===\r\n    systemPrompt: `Tu re√ßois un graphe de pens√©e non-lin√©aire.\r\n\r\nLes n≈ìuds sont des √©l√©ments simultan√©s, pas des √©tapes.\r\nLeur ordre de pr√©sentation n'implique aucune hi√©rarchie.\r\n\r\nStatuts :\r\n- \\u25CB neutre\r\n- \\uD83C\\uDFAF ancre du graphe ‚Äî objectif structurant. Toutes les vignettes et connexions doivent √™tre lues en rapport √† cette ancre. Il n'y en a qu'une.\r\n\r\nConnexions entre n≈ìuds :\r\n- \\u2192 implication ou d√©pendance\r\n- \\u2194 co-conditionnement mutuel\r\n\r\nTags (#) : dimensions transversales du graphe.\r\nUn tag partag√© par plusieurs n≈ìuds signale un axe qui les traverse.\r\nUn tag isol√© signale une dimension amorc√©e mais pas d√©ploy√©e.\r\n\r\nR√©ponds toujours en fran√ßais.`,\r\n\r\n    systemPromptChatSuffix: `\\n\\nR√©ponds de mani√®re concise en tenant compte du contexte.`,\r\n\r\n    systemPromptChatEmpty: `\\nR√©ponds de mani√®re concise et utile.`,\r\n\r\n    // === CADRAGE STRUCTUREL (Couche 0 ‚Äî toujours actif, anti-arborescence) ===\r\n    structuralFraming: {\r\n        'D√âVELOPPER': `CADRE STRUCTUREL :\r\nUn graphe sain contient des boucles de r√©troaction,\r\npas seulement des ramifications.\r\nSi tes vignettes ne font que descendre du g√©n√©ral au particulier,\r\ntu produis une arborescence, pas une cartographie.\r\n\r\nCrit√®res :\r\n- Au moins une vignette doit REMONTER vers un n≈ìud existant\r\n  en position haute (üéØ ou fortement connect√©) pour le contester,\r\n  le nuancer, ou poser une condition √† sa validit√©.\r\n- Les vignettes qui prolongent sans contester sont du bruit,\r\n  pas du d√©veloppement.\r\n- Si le graphe d√©passe 15 vignettes, ce crit√®re est OBLIGATOIRE.\r\n  En dessous, il reste une orientation.\r\n`,\r\n\r\n        'RELIER': `CADRE STRUCTUREL :\r\nUn graphe o√π toutes les connexions descendent\r\n(du g√©n√©ral au particulier) est arborescent, pas syst√©mique.\r\n\r\nCrit√®res :\r\n- V√©rifie la directionnalit√© globale des connexions existantes.\r\n- Propose au moins une connexion REMONTANTE :\r\n  un n≈ìud p√©riph√©rique qui contraint, invalide,\r\n  ou conditionne un n≈ìud central.\r\n- Une connexion qui redouble un lien existant\r\n  sous une autre formulation n'est pas une connexion,\r\n  c'est un √©cho.\r\n- Si le graphe d√©passe 15 vignettes et que TOUTES les connexions\r\n  existantes sont descendantes, signale-le explicitement\r\n  avant de proposer tes connexions.\r\n`,\r\n\r\n        'SYNTH√âTISER': `CADRE STRUCTUREL :\r\nAvant d'√©crire, observe la FORME du graphe :\r\n- Les connexions vont-elles toutes dans le m√™me sens (arborescence) ou forment-elles des boucles ?\r\n- La densit√© de connexions est-elle homog√®ne ou y a-t-il des clusters isol√©s ?\r\n\r\nAdapte ton texte √† la complexit√© r√©elle du graphe.\r\nUn graphe lin√©aire de 5 vignettes donne un texte court et direct.\r\nUn graphe dense de 20 vignettes avec des boucles donne un texte plus riche.\r\nLa forme du graphe guide la forme du texte.\r\n`,\r\n    },\r\n\r\n    // === INSTRUCTIONS D'OP√âRATION (Couche 2 ‚Äî 6 combinaisons) ===\r\n    operations: {\r\n        'D√âVELOPPER': {\r\n            // R√©gime APPROFONDIR (ex-D√âVELOPPER par d√©faut)\r\n            deepen: {\r\n                // R√©gime A ‚Äî Graphe entier\r\n                full: `T√ÇCHE : G√©n√®re {targetCount} nouvelles vignettes pour ce graphe.\r\n\r\nObserve d'abord :\r\n- Quelles zones du graphe sont sous-explor√©es ?\r\n- Quels tags n'apparaissent que sur un seul n≈ìud ?\r\n- Quelles tensions entre n≈ìuds ne sont pas nomm√©es ?\r\n- Que sugg√®rent les connexions sans le dire ?\r\n\r\nLes vignettes peuvent prolonger, contester, ou ouvrir\r\nun territoire adjacent. Elles ne reformulent pas l'existant.\r\n\r\nFORMAT DE R√âPONSE ‚Äî chaque vignette sur ce mod√®le exact :\r\n[NOUVELLE VIGNETTE] Texte concis de l'id√©e | #tag1 #tag2\r\n\r\nSi une vignette remet en question un pr√©suppos√© du graphe,\r\nutilise [FRICTION] au lieu de [NOUVELLE VIGNETTE].\r\n\r\nCONNEXIONS ‚Äî pour chaque vignette qui prolonge, conteste\r\nou pr√©cise un n≈ìud existant, indique le lien :\r\n[CONNEXION] \"Texte exact source\" ‚Üí \"Texte exact cible\" | M√©canisme pr√©cis\r\n[CONNEXION] \"Texte exact source\" ‚Üî \"Texte exact cible\" | M√©canisme pr√©cis\r\n\r\n‚Üí = implication (A conditionne B)\r\n‚Üî = co-conditionnement (A et B se contraignent mutuellement)\r\n\r\nIMPORTANT : utilise le TEXTE EXACT des vignettes entre guillemets.\r\nLe m√©canisme nomme COMMENT les n≈ìuds sont li√©s.`,\r\n\r\n                // R√©gime B ‚Äî Branche s√©lectionn√©e\r\n                branch: `T√ÇCHE : G√©n√®re {targetCount} nouvelles vignettes\r\nqui prolongent cette branche.\r\n\r\nObserve d'abord :\r\n- Quelle direction cette s√©quence dessine-t-elle\r\n  sans la nommer ?\r\n- Qu'est-ce qui manquerait pour que cette branche\r\n  tienne toute seule ?\r\n- Les n≈ìuds voisins signalent-ils une bifurcation\r\n  que la s√©lection ignore ?\r\n- Y a-t-il une tension interne entre ces n≈ìuds\r\n  que leur connexion masque ?\r\n\r\nLes vignettes restent dans le prolongement de la branche\r\nou r√©v√®lent ce qu'elle pr√©suppose sans le dire.\r\nElles ne reformulent pas l'existant.\r\n\r\nFORMAT DE R√âPONSE ‚Äî chaque vignette sur ce mod√®le exact :\r\n[NOUVELLE VIGNETTE] Texte concis de l'id√©e | #tag1 #tag2\r\n\r\nSi une vignette remet en question un pr√©suppos√© du graphe,\r\nutilise [FRICTION] au lieu de [NOUVELLE VIGNETTE].\r\n\r\nCONNEXIONS ‚Äî pour chaque vignette qui prolonge, conteste\r\nou pr√©cise un n≈ìud de la branche, indique le lien :\r\n[CONNEXION] \"Texte exact source\" ‚Üí \"Texte exact cible\" | M√©canisme pr√©cis\r\n[CONNEXION] \"Texte exact source\" ‚Üî \"Texte exact cible\" | M√©canisme pr√©cis\r\n\r\n‚Üí = implication (A conditionne B)\r\n‚Üî = co-conditionnement (A et B se contraignent mutuellement)\r\n\r\nIMPORTANT : utilise le TEXTE EXACT des vignettes entre guillemets.\r\nLe m√©canisme nomme COMMENT les n≈ìuds sont li√©s.`,\r\n            },\r\n\r\n            // R√©gime DIVERGER (nouveau ‚Äî canvas convergent)\r\n            diverge: {\r\n                // R√©gime A ‚Äî Graphe entier\r\n                full: `Mots-cl√©s D√âJ√Ä surrepr√©sent√©s sur ce canvas :\r\n{topKeywordsCanvas}\r\n\r\nT√ÇCHE : Ce canvas converge autour des m√™mes concepts.\r\nIl a besoin de TERRITOIRES ADJACENTS, pas de reformulations.\r\n\r\nPropose 2 √† 4 nouvelles vignettes qui :\r\n1. Ne r√©utilisent AUCUN des mots-cl√©s surrepr√©sent√©s list√©s ci-dessus\r\n2. Ouvrent un CHAMP CONCEPTUEL DIFF√âRENT reli√© au sujet par un pont logique\r\n3. Apportent une perspective, une discipline ou un angle\r\n   que le canvas n'explore pas encore\r\n\r\nPour chaque vignette, indique le PONT CONCEPTUEL\r\nqui la relie au canvas existant.\r\n\r\nFORMAT DE R√âPONSE :\r\n[NOUVELLE VIGNETTE] Texte de la vignette | #tag1 #tag2\r\nPont : explication du lien avec le canvas existant\r\n\r\n[CONNEXION] \"Texte vignette source\" \\u2192 \"Texte vignette cible\" | M√©canisme : le pont conceptuel\r\n\r\nSi une vignette remet en question un pr√©suppos√© du graphe,\r\nutilise [FRICTION] au lieu de [NOUVELLE VIGNETTE].`,\r\n\r\n                // R√©gime B ‚Äî Branche s√©lectionn√©e\r\n                branch: `Mots-cl√©s D√âJ√Ä surrepr√©sent√©s sur ce canvas :\r\n{topKeywordsCanvas}\r\n\r\nT√ÇCHE : √Ä partir des vignettes s√©lectionn√©es,\r\npropose 1 √† 3 nouvelles vignettes qui ouvrent vers\r\nun CHAMP ADJACENT non encore explor√© par le canvas.\r\n\r\nLes nouvelles vignettes ne doivent PAS reformuler\r\nles concepts existants. Elles doivent apporter\r\nun ANGLE NOUVEAU reli√© par un pont logique.\r\n\r\nN'utilise PAS les mots-cl√©s surrepr√©sent√©s list√©s ci-dessus.\r\n\r\nFORMAT DE R√âPONSE :\r\n[NOUVELLE VIGNETTE] Texte de la vignette | #tag1 #tag2\r\nPont : lien avec les vignettes s√©lectionn√©es\r\n\r\n[CONNEXION] \"Texte source\" \\u2192 \"Texte cible\" | M√©canisme : pont conceptuel\r\n\r\nSi une vignette remet en question un pr√©suppos√© du graphe,\r\nutilise [FRICTION] au lieu de [NOUVELLE VIGNETTE].`,\r\n            },\r\n        },\r\n\r\n        'RELIER': {\r\n            // R√©gime A ‚Äî Graphe entier\r\n            full: `T√ÇCHE : Propose {connectionTarget} connexions manquantes dans ce graphe.\r\n{isolatedCount} n≈ìud(s) n'ont actuellement AUCUNE connexion.\r\n\r\nPRIORIT√â : connecter les n≈ìuds isol√©s en premier.\r\nUn n≈ìud isol√© dans un graphe de 20+ vignettes est une anomalie ‚Äî\r\nil a forc√©ment un lien avec au moins un autre n≈ìud.\r\n\r\nObserve ensuite :\r\n- Quels n≈ìuds partagent des tags sans √™tre connect√©s ?\r\n- Quels n≈ìuds semblent √©loign√©s mais pr√©supposent\r\n  la m√™me chose ?\r\n- Les connexions existantes laissent-elles un chemin\r\n  implicite non trac√© ?\r\n\r\nIMPORTANT : Utilise le TEXTE EXACT des vignettes entre guillemets.\r\nNe reformule pas, ne r√©sume pas, ne paraphrase pas les textes.\r\nCopie-les mot pour mot depuis la liste ci-dessus.\r\n\r\nFORMAT DE R√âPONSE ‚Äî chaque connexion sur ce mod√®le exact :\r\n[CONNEXION] \"Texte exact A\" \\u2192 \"Texte exact B\" | M√©canisme pr√©cis\r\n[CONNEXION] \"Texte exact A\" \\u2194 \"Texte exact B\" | M√©canisme pr√©cis\r\n\r\n\\u2192 = implication ou d√©pendance (A conditionne B)\r\n\\u2194 = co-conditionnement mutuel (A et B se contraignent r√©ciproquement)\r\n\r\nLe m√©canisme nomme COMMENT les n≈ìuds sont li√©s,\r\npas seulement QU'ils le sont.\r\nLe m√©canisme sera affich√© dans le graphe.\r\nFormule-le comme une phrase lisible autonome.\r\n\r\nExemples :\r\n\\u2717 \"Lien th√©matique\" / \"Relation de cause √† effet\" / \"√âcho\"\r\n\\u2713 \"Le premier pose la condition que le second pr√©suppose\"\r\n\\u2713 \"Opposition : l'un traite l'√©criture comme processus,\r\n    l'autre comme produit\"`,\r\n\r\n            // R√©gime B ‚Äî Branche s√©lectionn√©e\r\n            branch: `T√ÇCHE : Propose {connectionTarget} connexions manquantes\r\ndans cette branche ou entre cette branche et son voisinage.\r\n{isolatedCount} n≈ìud(s) de la s√©lection n'ont aucune connexion interne.\r\n\r\nObserve d'abord :\r\n- La s√©quence interne a-t-elle des sauts ?\r\n  Deux n≈ìuds qui devraient √™tre reli√©s mais ne le sont pas ?\r\n- Un n≈ìud voisin compl√®te-t-il ou contredit-il\r\n  un n≈ìud de la s√©lection ?\r\n- Les tags dessinent-ils un lien transversal\r\n  que les connexions directes ne montrent pas ?\r\n- Y a-t-il une d√©pendance implicite que la branche\r\n  traite comme acquise ?\r\n\r\nIMPORTANT : Utilise le TEXTE EXACT des vignettes entre guillemets.\r\nNe reformule pas, ne r√©sume pas, ne paraphrase pas les textes.\r\nCopie-les mot pour mot depuis la liste ci-dessus.\r\n\r\nFORMAT DE R√âPONSE ‚Äî chaque connexion sur ce mod√®le exact :\r\n[CONNEXION] \"Texte exact A\" \\u2192 \"Texte exact B\" | M√©canisme pr√©cis\r\n[CONNEXION] \"Texte exact A\" \\u2194 \"Texte exact B\" | M√©canisme pr√©cis\r\n\r\n\\u2192 = implication ou d√©pendance (A conditionne B)\r\n\\u2194 = co-conditionnement mutuel (A et B se contraignent r√©ciproquement)\r\n\r\nLe m√©canisme nomme COMMENT les n≈ìuds sont li√©s,\r\npas seulement QU'ils le sont.\r\nLe m√©canisme sera affich√© dans le graphe.\r\nFormule-le comme une phrase lisible autonome.\r\n\r\nExemples :\r\n\\u2717 \"Lien th√©matique\" / \"Relation de cause √† effet\" / \"√âcho\"\r\n\\u2713 \"Le premier pose la condition que le second pr√©suppose\"\r\n\\u2713 \"Opposition : l'un traite l'√©criture comme processus,\r\n    l'autre comme produit\"`,\r\n        },\r\n\r\n        'SYNTH√âTISER': {\r\n            // R√©gime A ‚Äî Graphe entier\r\n            full: `Tu re√ßois un graphe cognitif (vignettes + connexions + tags).\r\n\r\nR√©dige un texte structur√© qui restitue le contenu de ce graphe.\r\n\r\nINTRODUCTION\r\n- Pose le contexte : quel territoire ce graphe explore-t-il ?\r\n- Si une ancre (\\uD83C\\uDFAF) existe, pars d'elle.\r\n- 2-3 phrases.\r\n\r\nD√âVELOPPEMENT\r\n- D√©ploie les id√©es en suivant les connexions comme fil conducteur.\r\n- \\u2192 (implication) : une id√©e conduit √† une autre.\r\n- \\u2194 (r√©sonance) : deux id√©es se r√©pondent.\r\n- Nomme les vignettes et tags quand c'est utile, sans les lister m√©caniquement.\r\n- Fais appara√Ætre les tensions, les compl√©mentarit√©s, les zones denses.\r\n- N'ajoute pas de concepts absents du graphe. Le texte restitue, il n'interpr√®te pas.\r\n- Adapte la longueur au graphe : un graphe de 5 vignettes ne demande pas le m√™me d√©veloppement qu'un graphe de 20.\r\n\r\nOUVERTURE\r\n- Termine par ce que le graphe n'a pas encore explor√© : pr√©suppos√©s non questionn√©s, zones absentes, directions possibles.\r\n- Formule-le comme une invitation √† poursuivre, pas comme un diagnostic.\r\n\r\n√âcris en prose continue. Pas de listes √† puces, pas de titres de section visibles.\r\nPas de pr√©ambule (\"Voici la synth√®se...\"), commence directement.\r\nR√©ponds en fran√ßais.`,\r\n\r\n            // R√©gime B ‚Äî Branche s√©lectionn√©e\r\n            branch: `Tu re√ßois une branche d'un graphe cognitif (vignettes s√©lectionn√©es + voisinage + connexions).\r\n\r\nR√©dige un texte structur√© qui restitue le contenu de cette branche.\r\n\r\nINTRODUCTION\r\n- Quel sous-territoire cette s√©lection dessine-t-elle ?\r\n- 2-3 phrases.\r\n\r\nD√âVELOPPEMENT\r\n- Suis les connexions internes comme fil conducteur.\r\n- Si le voisinage (n≈ìuds non s√©lectionn√©s mais connect√©s) apporte un √©clairage, int√®gre-le.\r\n- Fais appara√Ætre ce que la branche articule et les tensions qu'elle contient.\r\n- N'ajoute pas de concepts absents du graphe.\r\n\r\nOUVERTURE\r\n- Ce que cette branche pr√©suppose sans le dire, ou les directions qu'elle ouvre sans les suivre.\r\n\r\n√âcris en prose continue. Pas de listes √† puces, pas de titres de section visibles.\r\nPas de pr√©ambule, commence directement.\r\nR√©ponds en fran√ßais.`,\r\n        },\r\n    },\r\n\r\n    // === BLOCS FRICTION (Couche 4 ‚Äî injection conditionnelle) ===\r\n    friction: {\r\n        develop: {\r\n            moderate: `\\n---\\n\\u26A0\\uFE0F Ce graphe montre des signes de circularit√©.\r\nAu moins une vignette DOIT √™tre marqu√©e [FRICTION].\\n---\\n`,\r\n\r\n            strong: `\\n---\\n\\u26A0\\uFE0F Les derni√®res g√©n√©rations ont produit des vignettes\r\nproches de : \"{recentKeywords}\"\r\n\r\nLe graphe stagne dans cette zone.\r\nTes vignettes DOIVENT sortir de ce p√©rim√®tre s√©mantique.\r\nAu moins une DOIT √™tre marqu√©e [FRICTION].\\n---\\n`,\r\n        },\r\n        link: {\r\n            moderate: `\\n---\\n\\u26A0\\uFE0F Ce graphe montre des signes de circularit√©.\r\nV√©rifie que les connexions propos√©es ne redoublent pas\r\ndes liens d√©j√† pr√©sents sous une autre formulation.\\n---\\n`,\r\n\r\n            strong: `\\n---\\n\\u26A0\\uFE0F Les derni√®res connexions produites utilisaient\r\ndes m√©canismes proches de : \"{recentMechanisms}\"\r\n\r\nPropose des connexions dont le m√©canisme est structurellement\r\ndiff√©rent de ceux d√©j√† pr√©sents.\\n---\\n`,\r\n        },\r\n    },\r\n\r\n    // === TEMPLATES SYNTH√àSE (pipeline s√©par√©) ===\r\n    synthesis: {\r\n        simple: `T√ÇCHE : R√©diger un texte d√©velopp√© √† partir de ces vignettes connect√©es.\r\n\r\nR√àGLES :\r\n1. Chaque vignette = un paragraphe d√©velopp√©\r\n2. Suivre les connexions comme fil conducteur :\r\n   - \\u2192 (implique) : \"Ceci conduit √†...\", \"De l√† d√©coule...\"\r\n   - \\u2194 (r√©sonance) : \"En parall√®le...\", \"Ce qui fait √©cho √†...\"\r\n3. Commencer par les vignettes les plus connect√©es (hubs)\r\n4. Ne pas fusionner les id√©es distinctes\r\n5. Ne pas ajouter de concepts absents du graphe\r\n\r\nLe texte est une mise en prose du graphe, pas une interpr√©tation.\r\nR√©ponds directement avec le texte, sans pr√©ambule.`,\r\n\r\n        simpleWithReinjection: `T√ÇCHE : R√©diger un texte d√©velopp√© √† partir de ces vignettes connect√©es.\r\n\r\nR√àGLES :\r\n1. Chaque vignette = un paragraphe d√©velopp√©\r\n2. Suivre les connexions comme fil conducteur :\r\n   - \\u2192 (implique) : \"Ceci conduit √†...\", \"De l√† d√©coule...\"\r\n   - \\u2194 (r√©sonance) : \"En parall√®le...\", \"Ce qui fait √©cho √†...\"\r\n3. Commencer par les vignettes les plus connect√©es (hubs)\r\n4. Ne pas fusionner les id√©es distinctes\r\n5. Ne pas ajouter de concepts absents du graphe\r\n6. S'inscrire dans la continuit√© des explorations pass√©es\r\n\r\nLe texte est une mise en prose du graphe, pas une interpr√©tation.\r\nR√©ponds directement avec le texte, sans pr√©ambule.`,\r\n\r\n        mini: `T√ÇCHE : R√©diger un texte d√©velopp√© pour ce groupe.\r\nR√®gles : 1 paragraphe par vignette, suivre les connexions (\\u2192/\\u2194), ne pas fusionner.\r\nR√©ponds directement, sans pr√©ambule.`,\r\n\r\n        meta: `T√ÇCHE : Assembler ces textes en un document coh√©rent.\r\nR√®gles : pr√©server le contenu de chaque groupe, ajouter uniquement des transitions entre groupes.\r\nR√©ponds directement avec le texte final, sans pr√©ambule.`,\r\n    },\r\n};\r\n\r\n/**\r\n * Interpole les variables dynamiques dans un template\r\n */\r\nexport function interpolateTemplate(template: string, variables: Record<string, string>): string {\r\n    let result = template;\r\n    for (const [key, value] of Object.entries(variables)) {\r\n        result = result.replace(new RegExp(`\\\\{${key}\\\\}`, 'g'), value);\r\n    }\r\n    return result;\r\n}\r\n\r\n/**\r\n * Retourne les templates actifs (d√©fauts pour l'instant, futurs overrides en niveau 2)\r\n */\r\nlet activeTemplates: PromptTemplates = { ...defaultTemplates };\r\n\r\nexport function getTemplates(): PromptTemplates {\r\n    return activeTemplates;\r\n}\r\n\r\n/**\r\n * Permet de surcharger les templates (pr√©paration niveau 2)\r\n */\r\nexport function setCustomTemplates(overrides: Partial<PromptTemplates>): void {\r\n    activeTemplates = { ...defaultTemplates, ...overrides };\r\n    // Deep merge pour les sous-objets\r\n    if (overrides.operations) {\r\n        activeTemplates.operations = { ...defaultTemplates.operations };\r\n        for (const [op, regimes] of Object.entries(overrides.operations)) {\r\n            const key = op as keyof typeof defaultTemplates.operations;\r\n            if (defaultTemplates.operations[key]) {\r\n                if (key === 'D√âVELOPPER') {\r\n                    // Deep merge for D√âVELOPPER (nested deepen/diverge)\r\n                    const devOverrides = regimes as any;\r\n                    const devDefaults = defaultTemplates.operations['D√âVELOPPER'];\r\n                    activeTemplates.operations['D√âVELOPPER'] = {\r\n                        deepen: { ...devDefaults.deepen, ...(devOverrides.deepen || {}) },\r\n                        diverge: { ...devDefaults.diverge, ...(devOverrides.diverge || {}) },\r\n                    };\r\n                } else {\r\n                    (activeTemplates.operations as any)[key] = { ...(defaultTemplates.operations as any)[key], ...regimes };\r\n                }\r\n            }\r\n        }\r\n    }\r\n    if (overrides.structuralFraming) {\r\n        activeTemplates.structuralFraming = { ...defaultTemplates.structuralFraming, ...overrides.structuralFraming };\r\n    }\r\n    if (overrides.friction) {\r\n        activeTemplates.friction = { ...defaultTemplates.friction };\r\n        for (const [op, levels] of Object.entries(overrides.friction)) {\r\n            const key = op as keyof typeof defaultTemplates.friction;\r\n            if (defaultTemplates.friction[key]) {\r\n                activeTemplates.friction[key] = { ...defaultTemplates.friction[key], ...levels };\r\n            }\r\n        }\r\n    }\r\n    if (overrides.synthesis) {\r\n        activeTemplates.synthesis = { ...defaultTemplates.synthesis, ...overrides.synthesis };\r\n    }\r\n}\r\n\r\n/**\r\n * Restaure les templates par d√©faut\r\n */\r\nexport function resetTemplates(): void {\r\n    activeTemplates = { ...defaultTemplates };\r\n}\r\n","/**\r\n * PostureManager ‚Äî Syst√®me de postures KAIROS\r\n *\r\n * 3 postures : Accompagner (doux), Nommer (d√©faut), Provoquer (radical)\r\n * Recalibre simultan√©ment : oxygen thresholds, metrics thresholds, prompt tone\r\n * Persistance localStorage, pattern identique √† theme-manager.ts\r\n *\r\n * @exports PostureName, PostureMetricsConfig, initPosture, applyPosture, getCurrentPosture,\r\n *          getPostureConfig, setupPostureSelector\r\n */\r\n\r\nimport { createLogger } from './logger.js';\r\nimport { setCustomTemplates, resetTemplates, defaultTemplates } from '../data/prompt-templates.js';\r\n\r\nconst log = createLogger('PostureManager');\r\n\r\nconst STORAGE_KEY = 'kairos_posture';\r\nconst DEFAULT_POSTURE = 'nommer';\r\nconst VALID_POSTURES = ['accompagner', 'nommer', 'provoquer'] as const;\r\n\r\nexport type PostureName = (typeof VALID_POSTURES)[number];\r\n\r\n// ‚îÄ‚îÄ Interfaces de configuration par posture ‚îÄ‚îÄ\r\n\r\nexport interface PostureOxygenConfig {\r\n    moderateFrictionThreshold: number;\r\n    radicalFrictionThreshold: number;\r\n    stagnationMalus: number;\r\n    echoJaccardThreshold: number;\r\n}\r\n\r\nexport interface PostureMetricsConfig {\r\n    synthesisVignetteThresholdHigh: number;\r\n    synthesisVignetteThresholdMid: number;\r\n    synthesisVignetteThresholdLow: number;\r\n    synthesisDensityThreshold: number;\r\n    synthesisDensityMinNodes: number;\r\n}\r\n\r\ninterface PosturePromptConfig {\r\n    systemPromptSuffix: string;\r\n}\r\n\r\ninterface PostureConfig {\r\n    oxygen: PostureOxygenConfig;\r\n    metrics: PostureMetricsConfig;\r\n    prompt: PosturePromptConfig;\r\n}\r\n\r\n// ‚îÄ‚îÄ Couleurs associ√©es aux postures (pour le bouton toolbar) ‚îÄ‚îÄ\r\n\r\nconst POSTURE_COLORS: Record<PostureName, string> = {\r\n    accompagner: '#4db8a8',\r\n    nommer: '#b8a04d',\r\n    provoquer: '#c05050',\r\n};\r\n\r\nconst POSTURE_LABELS: Record<PostureName, string> = {\r\n    accompagner: 'Accompagner',\r\n    nommer: 'Nommer',\r\n    provoquer: 'Provoquer',\r\n};\r\n\r\n// ‚îÄ‚îÄ Configurations des 3 postures ‚îÄ‚îÄ\r\n\r\nconst POSTURE_CONFIGS: Record<PostureName, PostureConfig> = {\r\n    accompagner: {\r\n        oxygen: {\r\n            moderateFrictionThreshold: 35,\r\n            radicalFrictionThreshold: 15,\r\n            stagnationMalus: -8,\r\n            echoJaccardThreshold: 0.45,\r\n        },\r\n        metrics: {\r\n            synthesisVignetteThresholdHigh: 17,\r\n            synthesisVignetteThresholdMid: 10,\r\n            synthesisVignetteThresholdLow: 5,\r\n            synthesisDensityThreshold: 0.6,\r\n            synthesisDensityMinNodes: 8,\r\n        },\r\n        prompt: {\r\n            systemPromptSuffix:\r\n                '\\n\\nPOSTURE : Prolonge avant de contester. Si tu per√ßois une tension, nomme-la sans insister.',\r\n        },\r\n    },\r\n    nommer: {\r\n        oxygen: {\r\n            moderateFrictionThreshold: 50,\r\n            radicalFrictionThreshold: 30,\r\n            stagnationMalus: -15,\r\n            echoJaccardThreshold: 0.35,\r\n        },\r\n        metrics: {\r\n            synthesisVignetteThresholdHigh: 25,\r\n            synthesisVignetteThresholdMid: 15,\r\n            synthesisVignetteThresholdLow: 8,\r\n            synthesisDensityThreshold: 0.8,\r\n            synthesisDensityMinNodes: 12,\r\n        },\r\n        prompt: {\r\n            systemPromptSuffix: '',\r\n        },\r\n    },\r\n    provoquer: {\r\n        oxygen: {\r\n            moderateFrictionThreshold: 65,\r\n            radicalFrictionThreshold: 45,\r\n            stagnationMalus: -22,\r\n            echoJaccardThreshold: 0.25,\r\n        },\r\n        metrics: {\r\n            synthesisVignetteThresholdHigh: 37,\r\n            synthesisVignetteThresholdMid: 22,\r\n            synthesisVignetteThresholdLow: 12,\r\n            synthesisDensityThreshold: 1.2,\r\n            synthesisDensityMinNodes: 16,\r\n        },\r\n        prompt: {\r\n            systemPromptSuffix:\r\n                \"\\n\\nPOSTURE : Chaque op√©ration doit d√©placer le cadre, pas le confirmer. Ce que le graphe √©vite de formuler t'int√©resse plus que ce qu'il dit d√©j√†.\",\r\n        },\r\n    },\r\n};\r\n\r\n// ‚îÄ‚îÄ √âtat interne ‚îÄ‚îÄ\r\n\r\nlet _currentPosture: PostureName = DEFAULT_POSTURE;\r\n\r\n// ‚îÄ‚îÄ API publique ‚îÄ‚îÄ\r\n\r\n/**\r\n * Initialise la posture au chargement. Lit localStorage, retourne le nom.\r\n * N'applique PAS la posture (l'app doit appeler applyPosture apr√®s avoir init oxygen+metrics).\r\n */\r\nexport function initPosture(): PostureName {\r\n    const saved = localStorage.getItem(STORAGE_KEY) as PostureName | null;\r\n    _currentPosture = saved && (VALID_POSTURES as readonly string[]).includes(saved) ? saved : DEFAULT_POSTURE;\r\n    log.info(`Posture initiale : ${_currentPosture}`);\r\n    return _currentPosture;\r\n}\r\n\r\n/**\r\n * Applique une posture : persiste, recalibre oxygen + metrics, met √† jour les prompts.\r\n * `app` doit avoir `.oxygen` (OxygenManager) et `.metrics` (MetricsManager) initialis√©s.\r\n */\r\nexport function applyPosture(name: PostureName, app: any): void {\r\n    _currentPosture = name;\r\n    localStorage.setItem(STORAGE_KEY, name);\r\n\r\n    const config = POSTURE_CONFIGS[name];\r\n\r\n    // Recalibrer l'oxyg√®ne\r\n    if (app.oxygen?.updateConfig) {\r\n        app.oxygen.updateConfig(config.oxygen);\r\n    }\r\n\r\n    // Recalibrer les m√©triques\r\n    if (app.metrics) {\r\n        app.metrics.postureConfig = config.metrics;\r\n    }\r\n\r\n    // Mettre √† jour les prompts\r\n    if (config.prompt.systemPromptSuffix) {\r\n        setCustomTemplates({\r\n            systemPrompt: defaultTemplates.systemPrompt + config.prompt.systemPromptSuffix,\r\n        });\r\n    } else {\r\n        resetTemplates();\r\n    }\r\n\r\n    // Mettre √† jour l'indicateur actif dans le menu\r\n    updateActiveIndicator(name);\r\n\r\n    // Re-√©valuer avec les nouveaux seuils et rafra√Æchir l'affichage\r\n    if (app.oxygen?.evaluate && app.canvas) {\r\n        app.oxygen.evaluate(app.canvas.state.nodes, app.canvas.state.connections);\r\n    }\r\n    if (app.metrics?.recalculateDebounced) {\r\n        app.metrics.recalculateDebounced();\r\n    }\r\n\r\n    log.info(`Posture appliqu√©e : ${name}`);\r\n}\r\n\r\n/**\r\n * Retourne la posture actuellement active.\r\n */\r\nexport function getCurrentPosture(): PostureName {\r\n    return _currentPosture;\r\n}\r\n\r\n/**\r\n * Retourne la configuration compl√®te d'une posture.\r\n */\r\nexport function getPostureConfig(name: PostureName): PostureConfig {\r\n    return POSTURE_CONFIGS[name];\r\n}\r\n\r\n/**\r\n * Configure le s√©lecteur de posture dans la toolbar.\r\n * Cherche #btn-posture et #posture-menu dans le DOM.\r\n */\r\nexport function setupPostureSelector(app: any): void {\r\n    const btn = document.getElementById('btn-posture');\r\n    const menu = document.getElementById('posture-menu');\r\n    if (!btn || !menu) {\r\n        log.warn('Bouton ou menu posture introuvable dans le DOM');\r\n        return;\r\n    }\r\n\r\n    // Toggle menu\r\n    btn.addEventListener('click', (e: Event) => {\r\n        e.stopPropagation();\r\n        const isVisible = menu.classList.contains('visible');\r\n        if (isVisible) {\r\n            menu.classList.remove('visible');\r\n        } else {\r\n            updateActiveIndicator(_currentPosture);\r\n            menu.classList.add('visible');\r\n        }\r\n    });\r\n\r\n    // Click sur une option\r\n    menu.addEventListener('click', (e: Event) => {\r\n        const target = (e.target as HTMLElement).closest('.posture-option') as HTMLElement | null;\r\n        if (!target) return;\r\n\r\n        const posture = target.dataset.posture as PostureName;\r\n        if (posture && (VALID_POSTURES as readonly string[]).includes(posture)) {\r\n            applyPosture(posture, app);\r\n            menu.classList.remove('visible');\r\n            log.info(`Posture chang√©e : ${posture}`);\r\n        }\r\n    });\r\n\r\n    // Fermer le menu au clic ailleurs\r\n    document.addEventListener('click', () => {\r\n        menu.classList.remove('visible');\r\n    });\r\n\r\n    // Emp√™cher la fermeture quand on clique dans le menu\r\n    menu.addEventListener('click', (e: Event) => {\r\n        e.stopPropagation();\r\n    });\r\n\r\n    log.info('S√©lecteur de posture configur√©');\r\n}\r\n\r\n/**\r\n * Met √† jour la classe .active sur les options du menu + le label/couleur du bouton.\r\n */\r\nfunction updateActiveIndicator(activePosture: PostureName): void {\r\n    // Guard: pas de DOM complet (tests unitaires)\r\n    if (typeof document === 'undefined' || !document.getElementById) return;\r\n\r\n    // Menu options\r\n    const options = document.querySelectorAll('.posture-option');\r\n    options.forEach((opt) => {\r\n        const el = opt as HTMLElement;\r\n        if (el.dataset.posture === activePosture) {\r\n            el.classList.add('active');\r\n        } else {\r\n            el.classList.remove('active');\r\n        }\r\n    });\r\n\r\n    // Bouton toolbar : label + pastille couleur\r\n    const label = document.getElementById('posture-label');\r\n    if (label) label.textContent = POSTURE_LABELS[activePosture];\r\n\r\n    const swatch = document.getElementById('posture-btn-swatch');\r\n    if (swatch) swatch.style.background = POSTURE_COLORS[activePosture];\r\n}\r\n","/**\r\n * Adaptive - Syst√®me adaptatif (D√âVELOPPER/RELIER/SYNTH√âTISER)\r\n *\r\n * Responsabilit√© : Ex√©cution des op√©rations adaptatives, gestion friction\r\n *\r\n * D√©pendances :\r\n * - app.canvas : √âtat du canvas\r\n * - app.llm : LLMManager pour prompts et contexte\r\n * - app.webviewHandler : Injection prompts dans webview\r\n * - app.syntheses : Gestion des synth√®ses\r\n * - app.canvasAnalyzer : D√©tection circularit√©\r\n *\r\n * @exports executeAdaptiveOperation, handleResponseCaptured, updateDebugPanel,\r\n *          updateFrictionIndicator, updateSelectionLLMButton\r\n */\r\n\r\nimport type { LLMOperation, CircularityResult } from '../../types/kairos.js';\r\nimport type { OxygenResult } from '../../oxygen/oxygen.js';\r\nimport { getCurrentPosture } from '../../posture-manager.js';\r\n\r\ninterface ResponseCapturedDetail {\r\n    content?: string;\r\n    operation?: string;\r\n}\r\n\r\n/**\r\n * Mappe un OxygenResult vers un CircularityResult compatible avec buildFrictionBlock/buildAdaptivePrompt.\r\n * Utilis√© par executeAdaptiveOperation et sendContextualMessage.\r\n */\r\nexport function mapOxygenToCircularity(oxygenResult: OxygenResult): CircularityResult {\r\n    const threshold = 3;\r\n    let mappedScore = 0;\r\n    if (oxygenResult.frictionLevel === 'radical') {\r\n        mappedScore = Math.ceil(threshold * 1.5) + 1;\r\n    } else if (oxygenResult.frictionLevel === 'moderate') {\r\n        mappedScore = threshold + 1;\r\n    }\r\n    return {\r\n        score: mappedScore,\r\n        signals: oxygenResult.signals\r\n            ? Object.entries(oxygenResult.signals)\r\n                  .filter(([, s]) => (s as any).malus < 0 || (s as any).bonus > 0)\r\n                  .map(([name]) => name)\r\n            : [],\r\n        shouldInjectFriction: oxygenResult.shouldInjectFriction,\r\n        details: {\r\n            threshold,\r\n            oxygenScore: oxygenResult.score,\r\n            frictionLevel: oxygenResult.frictionLevel,\r\n        },\r\n    };\r\n}\r\n\r\n/**\r\n * Ex√©cute une op√©ration adaptative via le webview LLM\r\n */\r\nexport async function executeAdaptiveOperation(app: any, operation: LLMOperation): Promise<void> {\r\n    app.currentOperation = operation;\r\n\r\n    // R√©cup√©rer les vignettes s√©lectionn√©es (si pr√©sentes)\r\n    const selectedIds = app.canvas.interaction.selectedNodes;\r\n    console.log('[KAIROS DEBUG] selectedIds:', selectedIds, 'size:', selectedIds?.size);\r\n    const selectedVignettes =\r\n        selectedIds && selectedIds.size > 0 ? app.canvas.state.nodes.filter((n: any) => selectedIds.has(n.id)) : [];\r\n    console.log('[KAIROS DEBUG] selectedVignettes count:', selectedVignettes.length);\r\n\r\n    // Construire le contexte optimis√© (avec s√©lection si pr√©sente)\r\n    const contexte = app.llm.buildContexteOptimise(\r\n        operation,\r\n        app.canvas.state.nodes,\r\n        app.canvas.state.connections,\r\n        selectedVignettes,\r\n    );\r\n\r\n    // V√©rifier qu'on a des vignettes\r\n    if (contexte.vignettes.length === 0) {\r\n        if (operation === 'SYNTH√âTISER') {\r\n            app.showNotification('Aucune vignette connect√©e √† synth√©tiser');\r\n        } else if (operation === 'RELIER') {\r\n            app.showNotification('Aucune vignette √† relier');\r\n        } else {\r\n            app.showNotification(\"Canvas vide, cr√©ez d'abord des vignettes\");\r\n        }\r\n        return;\r\n    }\r\n\r\n    // Mettre √† jour l'historique AVANT la d√©tection (pour que les nouvelles vignettes soient prises en compte)\r\n    app.llm.updateCanvasHistory(app.canvas.state.nodes, app.canvas.state.connections);\r\n\r\n    // Oxyg√®ne : enregistrer le tour (D√âVELOPPER/RELIER) ou √©valuer sans avancer (SYNTH√âTISER)\r\n    // SYNTH√âTISER ne modifie pas le graphe ‚Üí evaluate() seul, pas de recordTurn()\r\n    let oxygenResult: OxygenResult | null = null;\r\n    if (app.oxygen) {\r\n        try {\r\n            if (operation === 'SYNTH√âTISER') {\r\n                oxygenResult = app.oxygen.evaluate(app.canvas.state.nodes, app.canvas.state.connections);\r\n            } else {\r\n                oxygenResult = await app.oxygen.recordTurn(app.canvas.state.nodes, app.canvas.state.connections);\r\n            }\r\n        } catch (e) {\r\n            console.warn('[Adaptive] Oxygen recordTurn/evaluate failed:', e);\r\n        }\r\n    }\r\n\r\n    // Notifier le panneau O‚ÇÇ apr√®s recordTurn\r\n    if (oxygenResult) {\r\n        document.dispatchEvent(new CustomEvent('oxygenUpdated'));\r\n    }\r\n\r\n    // Construire un CircularityResult compatible (pour buildAdaptivePrompt et buildFrictionBlock)\r\n    let circularityResult: CircularityResult;\r\n    if (oxygenResult) {\r\n        circularityResult = mapOxygenToCircularity(oxygenResult);\r\n    } else {\r\n        // Fallback: legacy circularity detection\r\n        circularityResult = app.llm.detectCircularity(app.canvas.state.nodes, app.canvas.state.connections, null, null);\r\n    }\r\n\r\n    // Mettre √† jour l'indicateur visuel\r\n    updateFrictionIndicator(app, circularityResult);\r\n\r\n    // D√©terminer le subMode depuis la suggestion du MetricsManager\r\n    const suggestion = app.metrics?.suggestionActive;\r\n    const subMode = (suggestion?.subMode as 'approfondir' | 'diverger') || 'approfondir';\r\n\r\n    // Construire le prompt adaptatif (avec friction si d√©tect√©e)\r\n    const syntheseReinjected = app.syntheses ? app.syntheses.getReinjectedSyntheses() : [];\r\n    const prompt = app.llm.buildAdaptivePrompt(operation, contexte, syntheseReinjected, circularityResult, subMode);\r\n\r\n    // Stocker les vignettes utilis√©es pour SYNTH√âTISER (pour l'archivage ult√©rieur)\r\n    if (operation === 'SYNTH√âTISER') {\r\n        app.lastSyntheseVignettes = contexte.vignettes;\r\n        console.log('[KAIROS] Vignettes stock√©es pour synth√®se:', app.lastSyntheseVignettes.length);\r\n    }\r\n\r\n    // Stocker le prompt comme lastUserInput pour la d√©tection de circularit√©\r\n    if (app.llm.canvasAnalyzer) {\r\n        app.llm.canvasAnalyzer.lastUserInput = prompt;\r\n    }\r\n    if (app.oxygen) {\r\n        app.oxygen.setUserInput(prompt);\r\n    }\r\n\r\n    // === Enregistrer dans le prompt log ===\r\n    const logEntryId = app.promptLog?.recordStart({\r\n        operation,\r\n        regime: contexte.regime,\r\n        provider: app.llmApiManager?.getProvider()?.name || app.webviewHandler?.currentProvider || 'unknown',\r\n        mode: app.llmApiManager ? 'api' : 'webview',\r\n        vignetteCount: contexte.vignettes?.length || contexte.selection?.length || 0,\r\n        selectedCount: selectedVignettes.length,\r\n        prompt,\r\n        systemPrompt: app.llm.buildSystemPrompt(operation),\r\n        friction: circularityResult\r\n            ? {\r\n                  score: circularityResult.score,\r\n                  threshold: (circularityResult as any).details?.threshold || 3,\r\n                  signals: circularityResult.signals || [],\r\n                  injected: circularityResult.shouldInjectFriction,\r\n              }\r\n            : undefined,\r\n    });\r\n\r\n    // Notification friction\r\n    if (circularityResult?.shouldInjectFriction) {\r\n        const signalNames = (circularityResult.signals || []).map((s: any) => s.name || s).join(', ');\r\n        app.showNotification?.(`\\u26A1 Friction inject√©e (score: ${circularityResult.score}) ‚Äî ${signalNames}`);\r\n    }\r\n\r\n    // === Utiliser LLMApiManager si disponible (API directe) ===\r\n    if (app.llmApiManager) {\r\n        try {\r\n            const result = await app.llmApiManager.executeOperation(operation, prompt, contexte);\r\n            // Enregistrer la r√©ponse dans le prompt log\r\n            if (logEntryId && result) {\r\n                await app.promptLog?.recordEnd(logEntryId, result.raw || '', result);\r\n            }\r\n        } catch (error) {\r\n            console.error('[KAIROS] Erreur LLMApiManager:', error);\r\n            // L'erreur est d√©j√† g√©r√©e par LLMApiManager (modal avec options)\r\n        }\r\n    }\r\n    // === FALLBACK : Mode webview uniquement (si pas de LLMApiManager) ===\r\n    else if (app.webviewHandler) {\r\n        // Tracker l'op√©ration pour adapter le comportement de capture\r\n        app.webviewHandler.currentOperation = operation;\r\n        app.webviewHandler.updateCaptureButtonText(operation);\r\n        const selectionInfo = selectedVignettes.length > 0 ? ' (s√©lection)' : '';\r\n        const success = await app.webviewHandler.injectPromptToWebview(prompt);\r\n        if (success) {\r\n            app.showNotification(\r\n                `${operation}: ${contexte.vignettes.length} vignette(s)${selectionInfo} ‚Üí envoyez dans le LLM`,\r\n            );\r\n        }\r\n    } else {\r\n        app.showNotification('WebviewHandler non disponible');\r\n    }\r\n\r\n    // Mettre √† jour le bandeau de suggestion\r\n    if (app.metrics) {\r\n        app.metrics.updateSuggestionBanner();\r\n    }\r\n}\r\n\r\n/**\r\n * G√®re la capture d'une r√©ponse depuis le webview\r\n * Cr√©e directement la synth√®se si l'op√©ration √©tait SYNTH√âTISER\r\n */\r\nexport function handleResponseCaptured(app: any, detail: ResponseCapturedDetail): void {\r\n    console.log('[KAIROS] R√©ponse captur√©e:', detail);\r\n\r\n    // Tracker la r√©ponse LLM pour la d√©tection de circularit√© (echo_llm)\r\n    if (detail.content && app.llm && app.llm.canvasAnalyzer) {\r\n        app.llm.canvasAnalyzer.lastLLMOutput = detail.content;\r\n        console.log('[KAIROS] lastLLMOutput stock√© pour d√©tection circularit√©');\r\n    }\r\n\r\n    // Tracker pour l'oxyg√®ne (echo detection)\r\n    if (detail.content && app.oxygen) {\r\n        app.oxygen.setLLMOutput(detail.content);\r\n    }\r\n\r\n    // V√©rifier si c'est une synth√®se (via detail.operation ou app.currentOperation)\r\n    const isSynthese = detail.operation === 'SYNTH√âTISER' || app.currentOperation === 'SYNTH√âTISER';\r\n\r\n    if (isSynthese && app.syntheses && detail.content) {\r\n        // Utiliser les vignettes envoy√©es au LLM, sinon fallback sur les connect√©es\r\n        let vignettesForSynthese: any[];\r\n        if (app.lastSyntheseVignettes && app.lastSyntheseVignettes.length > 0) {\r\n            vignettesForSynthese = app.lastSyntheseVignettes;\r\n        } else {\r\n            // Fallback: vignettes connect√©es (non rejet√©es)\r\n            const connections = app.canvas.state.connections || [];\r\n            const connectedIds = new Set<string>();\r\n            connections.forEach((c: any) => {\r\n                connectedIds.add(c.from);\r\n                connectedIds.add(c.to);\r\n            });\r\n            vignettesForSynthese = app.canvas.state.nodes.filter((v: any) => connectedIds.has(v.id));\r\n        }\r\n\r\n        if (vignettesForSynthese.length === 0) {\r\n            app.showNotification('Aucune vignette pour la synth√®se');\r\n            return;\r\n        }\r\n\r\n        // Cr√©er directement la synth√®se avec toutes les vignettes connect√©es\r\n        const synthese = app.syntheses.creerSyntheseDepuisReponse(detail.content, vignettesForSynthese);\r\n        if (synthese) {\r\n            app.syntheses.afficherModalArchivage(synthese);\r\n            app.lastSyntheseVignettes = null;\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Met √† jour l'indicateur visuel de friction (legacy, redirige vers debug panel)\r\n */\r\nexport function updateFrictionIndicator(app: any, circularityResult: CircularityResult | null = null): void {\r\n    updateDebugPanel(app, circularityResult);\r\n}\r\n\r\n/**\r\n * Met √† jour le debug panel (lecture seule des m√©triques sous-marines).\r\n * Pure reader : lit l'√©tat existant des managers, aucune logique propre.\r\n * Si la logique de calcul change, ce panel n'a pas besoin d'√™tre modifi√©.\r\n */\r\nexport function updateDebugPanel(app: any, _circularityResult: CircularityResult | null = null): void {\r\n    // === Strip oxyg√®ne (bordure gauche du canvas) ===\r\n    const strip = document.getElementById('oxygen-strip');\r\n    if (strip) {\r\n        const oxygenScore = app.oxygen?.getScore() ?? 50;\r\n        const lastResult = app.oxygen?.getLastResult();\r\n        const level = lastResult?.level ?? 'moderate';\r\n\r\n        strip.setAttribute('data-level', level);\r\n\r\n        const scoreEl = document.getElementById('oxygen-strip-score');\r\n        if (scoreEl) {\r\n            const delta = lastResult?.delta ?? 0;\r\n            let text = String(Math.round(oxygenScore));\r\n            if (delta > 0) text += ' \\u2191';\r\n            else if (delta < 0) text += ' \\u2193';\r\n            scoreEl.textContent = text;\r\n        }\r\n    }\r\n\r\n    // === Debug metrics strip (bandeau) ===\r\n    updateDebugMetricsStrip(app);\r\n}\r\n\r\n/**\r\n * Met √† jour la barre debug temporaire dans le bandeau (√† supprimer apr√®s calibrage)\r\n */\r\nfunction updateDebugMetricsStrip(app: any): void {\r\n    const strip = document.getElementById('debug-metrics-strip');\r\n    if (!strip) return;\r\n\r\n    const oxygenScore = app.oxygen?.getScore?.() ?? 50;\r\n    const lastResult = app.oxygen?.getLastResult?.();\r\n    const suggestion = app.metrics?.suggestionActive;\r\n\r\n    // O‚ÇÇ score + level\r\n    const elO2 = document.getElementById('dms-oxygen');\r\n    if (elO2) {\r\n        const level = lastResult?.level ?? 'moderate';\r\n        const state = oxygenScore >= 50 ? 'ok' : oxygenScore >= 30 ? 'warn' : 'bad';\r\n        elO2.textContent = `O‚ÇÇ ${Math.round(oxygenScore)} (${level})`;\r\n        elO2.setAttribute('data-state', state);\r\n    }\r\n\r\n    // subMode\r\n    const elMode = document.getElementById('dms-submode');\r\n    if (elMode) {\r\n        const sub = suggestion?.subMode || 'approfondir';\r\n        const op =\r\n            suggestion?.operation\r\n                ?.replace('D√âVELOPPER', 'DEV')\r\n                .replace('SYNTH√âTISER', 'SYNTH')\r\n                .replace('RELIER', 'REL') || '‚Äî';\r\n        elMode.textContent = `${op} ${sub === 'diverger' ? '‚Üó diverger' : '‚Üò approfondir'}`;\r\n        elMode.setAttribute('data-state', sub === 'diverger' ? 'warn' : 'ok');\r\n    }\r\n\r\n    // Friction\r\n    const elFric = document.getElementById('dms-friction');\r\n    if (elFric) {\r\n        const fl = lastResult?.frictionLevel ?? 'none';\r\n        const injected = lastResult?.shouldInjectFriction ?? false;\r\n        elFric.textContent = injected ? `friction ${fl}` : 'friction non';\r\n        elFric.setAttribute('data-state', fl === 'radical' ? 'bad' : fl === 'moderate' ? 'warn' : 'ok');\r\n    }\r\n\r\n    // Echo (canvas redundancy ‚Äî Jaccard max + seuil 0.35)\r\n    const elEcho = document.getElementById('dms-echo');\r\n    if (elEcho) {\r\n        const maxJ = lastResult?.signals?.llmEcho?.maxJaccard ?? 0;\r\n        const echoDetected = lastResult?.signals?.llmEcho?.overlap > 0;\r\n        const state = echoDetected ? 'bad' : maxJ > 0.25 ? 'warn' : 'ok';\r\n        elEcho.textContent = `J ${maxJ.toFixed(2)}${echoDetected ? ' !' : ''}`;\r\n        elEcho.setAttribute('data-state', state);\r\n    }\r\n\r\n    // Structure (ratio + components)\r\n    const elStruct = document.getElementById('dms-structure');\r\n    if (elStruct) {\r\n        const gs = lastResult?.signals?.graphStructure;\r\n        if (gs?.enabled) {\r\n            const state = gs.malus < 0 ? 'bad' : gs.bonus > 0 ? 'ok' : 'warn';\r\n            elStruct.textContent = `ratio ${gs.ratio.toFixed(1)} ¬∑ ${gs.components} comp`;\r\n            elStruct.setAttribute('data-state', state);\r\n        } else {\r\n            elStruct.textContent = 'struct < 8 nodes';\r\n            elStruct.setAttribute('data-state', 'ok');\r\n        }\r\n    }\r\n\r\n    // Posture (nom + seuils actifs)\r\n    const elPosture = document.getElementById('dms-posture');\r\n    if (elPosture) {\r\n        const posture = getCurrentPosture();\r\n        const cfg = app.oxygen?.config;\r\n        if (cfg) {\r\n            elPosture.textContent = `${posture} | mod:${cfg.moderateFrictionThreshold} rad:${cfg.radicalFrictionThreshold} echo:${cfg.echoJaccardThreshold}`;\r\n        } else {\r\n            elPosture.textContent = posture;\r\n        }\r\n    }\r\n\r\n    // Indicateur synth√®se pr√™te (O‚ÇÇ > 60 + ‚â• 8 connect√©es)\r\n    const elSynth = document.getElementById('dms-synthesis');\r\n    if (elSynth) {\r\n        const ready = app.metrics?.isSynthesisReady?.() ?? false;\r\n        elSynth.textContent = ready ? 'synth \\u25CF' : 'synth \\u2014';\r\n        elSynth.setAttribute('data-state', ready ? 'ok' : 'warn');\r\n    }\r\n}\r\n\r\n/**\r\n * Met √† jour le bouton flottant de s√©lection LLM\r\n */\r\nexport function updateSelectionLLMButton(app: any): void {\r\n    const button = document.getElementById('selection-llm-button');\r\n    const countSpan = document.getElementById('selection-llm-count');\r\n\r\n    if (!button) return;\r\n\r\n    const count = app.canvas.interaction.selectedNodes.size;\r\n\r\n    if (count > 0) {\r\n        button.classList.remove('hidden');\r\n        if (countSpan) countSpan.textContent = String(count);\r\n    } else {\r\n        button.classList.add('hidden');\r\n    }\r\n}\r\n","/**\r\n * Canvas ID Store ‚Äî Source unique du canvas actif\r\n *\r\n * Persiste l'ID du canvas actif dans localStorage.\r\n * Import√© par storage.ts, syntheses/storage.ts, oxygen.ts, analyzer/history.ts\r\n * pour remplacer le CANVAS_ID = 'default' en dur.\r\n */\r\n\r\nconst STORAGE_KEY = 'kairos_active_canvas_id';\r\n\r\nlet currentCanvasId: string = (() => {\r\n    try {\r\n        return localStorage.getItem(STORAGE_KEY) || 'default';\r\n    } catch {\r\n        return 'default';\r\n    }\r\n})();\r\n\r\nexport function getCanvasId(): string {\r\n    return currentCanvasId;\r\n}\r\n\r\nexport function setCanvasId(id: string): void {\r\n    currentCanvasId = id;\r\n    try {\r\n        localStorage.setItem(STORAGE_KEY, id);\r\n    } catch {\r\n        // localStorage indisponible (tests Node.js)\r\n    }\r\n}\r\n","/**\r\n * Validation - V√©rification d'int√©grit√© de l'√©tat du canvas\r\n *\r\n * Fonction pure qui v√©rifie 8 invariants sur les nodes et connexions,\r\n * et peut optionnellement r√©parer les donn√©es (mode repair).\r\n *\r\n * Invariants v√©rifi√©s :\r\n * 1. Pas d'IDs de nodes dupliqu√©s\r\n * 2. Pas d'IDs de connexions dupliqu√©s\r\n * 3. Connexions : from existe dans les nodes\r\n * 4. Connexions : to existe dans les nodes\r\n * 5. Pas d'auto-connexions (from === to)\r\n * 6. Pas de paires from+to dupliqu√©es\r\n * 7. Type de connexion valide\r\n * 8. Maximum 1 node avec status='priority'\r\n *\r\n * @exports validateCanvasState\r\n */\r\n\r\nimport type { KairosNode, KairosConnection } from '../types/kairos.js';\r\n\r\n// ‚îÄ‚îÄ Types ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n\r\nexport type ValidationSeverity = 'error' | 'warning';\r\n\r\nexport interface ValidationIssue {\r\n    code: string;\r\n    severity: ValidationSeverity;\r\n    message: string;\r\n    details?: {\r\n        nodeId?: string;\r\n        connectionId?: string;\r\n        from?: string;\r\n        to?: string;\r\n    };\r\n}\r\n\r\nexport interface ValidateOptions {\r\n    repair?: boolean;\r\n}\r\n\r\nexport interface ValidationResult {\r\n    valid: boolean;\r\n    errors: ValidationIssue[];\r\n    warnings: ValidationIssue[];\r\n    repaired?: {\r\n        nodes: KairosNode[];\r\n        connections: KairosConnection[];\r\n    };\r\n}\r\n\r\n// Types de connexion autoris√©s (miroir du type union KairosConnection['type'])\r\nconst VALID_CONNECTION_TYPES = new Set(['implies', 'resonance', 'conflicts', 'example']);\r\n\r\n// ‚îÄ‚îÄ Fonction principale ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n\r\nexport function validateCanvasState(\r\n    nodes: KairosNode[],\r\n    connections: KairosConnection[],\r\n    options: ValidateOptions = {},\r\n): ValidationResult {\r\n    const errors: ValidationIssue[] = [];\r\n    const warnings: ValidationIssue[] = [];\r\n\r\n    // ‚îÄ‚îÄ 1. Duplicate node IDs ‚îÄ‚îÄ\r\n    const nodeIdSet = new Set<string>();\r\n    const duplicateNodeIds = new Set<string>();\r\n    for (const node of nodes) {\r\n        if (nodeIdSet.has(node.id)) {\r\n            duplicateNodeIds.add(node.id);\r\n            errors.push({\r\n                code: 'DUPLICATE_NODE_ID',\r\n                severity: 'error',\r\n                message: `Node ID dupliqu√© : ${node.id}`,\r\n                details: { nodeId: node.id },\r\n            });\r\n        } else {\r\n            nodeIdSet.add(node.id);\r\n        }\r\n    }\r\n\r\n    // ‚îÄ‚îÄ 8. Multiple priority (check during node iteration) ‚îÄ‚îÄ\r\n    const priorityNodes: string[] = [];\r\n    for (const node of nodes) {\r\n        if (node.status === 'priority') {\r\n            priorityNodes.push(node.id);\r\n        }\r\n    }\r\n    if (priorityNodes.length > 1) {\r\n        warnings.push({\r\n            code: 'MULTIPLE_PRIORITY',\r\n            severity: 'warning',\r\n            message: `${priorityNodes.length} nodes avec status='priority' (max 1 attendu)`,\r\n            details: { nodeId: priorityNodes[1] },\r\n        });\r\n    }\r\n\r\n    // ‚îÄ‚îÄ Checks sur les connexions ‚îÄ‚îÄ\r\n    const connIdSet = new Set<string>();\r\n    const pairSet = new Set<string>();\r\n\r\n    for (const conn of connections) {\r\n        // ‚îÄ‚îÄ 2. Duplicate connection IDs ‚îÄ‚îÄ\r\n        if (connIdSet.has(conn.id)) {\r\n            errors.push({\r\n                code: 'DUPLICATE_CONNECTION_ID',\r\n                severity: 'error',\r\n                message: `Connexion ID dupliqu√© : ${conn.id}`,\r\n                details: { connectionId: conn.id },\r\n            });\r\n        } else {\r\n            connIdSet.add(conn.id);\r\n        }\r\n\r\n        // ‚îÄ‚îÄ 3. Orphan connection.from ‚îÄ‚îÄ\r\n        if (!nodeIdSet.has(conn.from)) {\r\n            errors.push({\r\n                code: 'ORPHAN_CONNECTION_FROM',\r\n                severity: 'error',\r\n                message: `Connexion ${conn.id} : from '${conn.from}' inexistant`,\r\n                details: { connectionId: conn.id, from: conn.from },\r\n            });\r\n        }\r\n\r\n        // ‚îÄ‚îÄ 4. Orphan connection.to ‚îÄ‚îÄ\r\n        if (!nodeIdSet.has(conn.to)) {\r\n            errors.push({\r\n                code: 'ORPHAN_CONNECTION_TO',\r\n                severity: 'error',\r\n                message: `Connexion ${conn.id} : to '${conn.to}' inexistant`,\r\n                details: { connectionId: conn.id, to: conn.to },\r\n            });\r\n        }\r\n\r\n        // ‚îÄ‚îÄ 5. Self-connection ‚îÄ‚îÄ\r\n        if (conn.from === conn.to) {\r\n            warnings.push({\r\n                code: 'SELF_CONNECTION',\r\n                severity: 'warning',\r\n                message: `Auto-connexion d√©tect√©e : ${conn.id} (${conn.from})`,\r\n                details: { connectionId: conn.id, from: conn.from, to: conn.to },\r\n            });\r\n        }\r\n\r\n        // ‚îÄ‚îÄ 6. Duplicate connection pair ‚îÄ‚îÄ\r\n        const pairKey = `${conn.from}|${conn.to}`;\r\n        if (pairSet.has(pairKey)) {\r\n            warnings.push({\r\n                code: 'DUPLICATE_CONNECTION_PAIR',\r\n                severity: 'warning',\r\n                message: `Paire de connexion dupliqu√©e : ${conn.from} ‚Üí ${conn.to}`,\r\n                details: { connectionId: conn.id, from: conn.from, to: conn.to },\r\n            });\r\n        } else {\r\n            pairSet.add(pairKey);\r\n        }\r\n\r\n        // ‚îÄ‚îÄ 7. Invalid connection type ‚îÄ‚îÄ\r\n        if (!VALID_CONNECTION_TYPES.has(conn.type)) {\r\n            warnings.push({\r\n                code: 'INVALID_CONNECTION_TYPE',\r\n                severity: 'warning',\r\n                message: `Type de connexion invalide : '${conn.type}' (connexion ${conn.id})`,\r\n                details: { connectionId: conn.id },\r\n            });\r\n        }\r\n    }\r\n\r\n    const result: ValidationResult = {\r\n        valid: errors.length === 0,\r\n        errors,\r\n        warnings,\r\n    };\r\n\r\n    // ‚îÄ‚îÄ Mode repair ‚îÄ‚îÄ\r\n    if (options.repair) {\r\n        result.repaired = repairState(nodes, connections);\r\n    }\r\n\r\n    return result;\r\n}\r\n\r\n// ‚îÄ‚îÄ R√©paration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n\r\nfunction repairState(\r\n    nodes: KairosNode[],\r\n    connections: KairosConnection[],\r\n): { nodes: KairosNode[]; connections: KairosConnection[] } {\r\n    // 1. D√©dupliquer les nodes (garder le premier)\r\n    const seenNodeIds = new Set<string>();\r\n    let repairedNodes = nodes.filter((n) => {\r\n        if (seenNodeIds.has(n.id)) return false;\r\n        seenNodeIds.add(n.id);\r\n        return true;\r\n    });\r\n\r\n    // 2. Max 1 priority (garder le premier)\r\n    let foundPriority = false;\r\n    repairedNodes = repairedNodes.map((n) => {\r\n        if (n.status === 'priority') {\r\n            if (foundPriority) return { ...n, status: 'neutral' as const };\r\n            foundPriority = true;\r\n        }\r\n        return n;\r\n    });\r\n\r\n    // 3. Set des IDs valides apr√®s d√©duplication\r\n    const validNodeIds = new Set(repairedNodes.map((n) => n.id));\r\n\r\n    // 4. Filtrer et d√©dupliquer les connexions\r\n    const seenConnIds = new Set<string>();\r\n    const seenPairs = new Set<string>();\r\n    const repairedConnections = connections\r\n        .filter((c) => {\r\n            // Duplicate ID\r\n            if (seenConnIds.has(c.id)) return false;\r\n            seenConnIds.add(c.id);\r\n            // Orphelines\r\n            if (!validNodeIds.has(c.from) || !validNodeIds.has(c.to)) return false;\r\n            // Auto-connexion\r\n            if (c.from === c.to) return false;\r\n            // Paire dupliqu√©e\r\n            const pairKey = `${c.from}|${c.to}`;\r\n            if (seenPairs.has(pairKey)) return false;\r\n            seenPairs.add(pairKey);\r\n            return true;\r\n        })\r\n        .map((c) => {\r\n            // Type invalide ‚Üí default 'implies'\r\n            if (!VALID_CONNECTION_TYPES.has(c.type)) {\r\n                return { ...c, type: 'implies' as const };\r\n            }\r\n            return c;\r\n        });\r\n\r\n    return { nodes: repairedNodes, connections: repairedConnections };\r\n}\r\n","// Persistance des donn√©es (SQLite via IPC)\r\n// Migration depuis localStorage vers SQLite\r\n\r\n// Types supprim√©s (StorageData utilise Record<string, any>)\r\n\r\nimport { getCanvasId } from './canvas-id-store.js';\r\nimport { validateCanvasState } from './canvas/validation.js';\r\n\r\ninterface StorageNode {\r\n    id: string;\r\n    text: string;\r\n    x: number;\r\n    y: number;\r\n    status: string;\r\n    tags: string[];\r\n    synthesized: boolean;\r\n    created: number;\r\n    modified: number;\r\n}\r\n\r\ninterface StorageConnection {\r\n    id: string;\r\n    from: string;\r\n    to: string;\r\n    type: string;\r\n    mechanism: string | null;\r\n}\r\n\r\ninterface StorageData {\r\n    vignettes?: Array<Record<string, any>>;\r\n    nodes?: Array<Record<string, any>>;\r\n    connections?: Array<Record<string, any>>;\r\n}\r\n\r\ninterface LoadResult {\r\n    nodes: Array<{\r\n        id: string;\r\n        text: string;\r\n        x: number;\r\n        y: number;\r\n        status: string;\r\n        tags: string[];\r\n        synthesized?: boolean;\r\n        created_at: number;\r\n        updated_at: number;\r\n    }>;\r\n    connections: Array<{\r\n        id: string;\r\n        from: string;\r\n        to: string;\r\n        type: string;\r\n        mechanism?: string | null;\r\n    }>;\r\n}\r\n\r\ninterface CanvasLoadedData {\r\n    vignettes: Array<{\r\n        id: string;\r\n        text: string;\r\n        x: number;\r\n        y: number;\r\n        status: string;\r\n        tags: string[];\r\n        synthesized: boolean;\r\n        created: number;\r\n        modified: number;\r\n    }>;\r\n    connections: Array<{\r\n        id: string;\r\n        from: string;\r\n        to: string;\r\n        type: string;\r\n        mechanism: string | null;\r\n    }>;\r\n}\r\n\r\nexport class StorageManager {\r\n    storageKey: string;\r\n    version: string;\r\n    canvasId: string;\r\n    _cachedData: StorageData | null;\r\n\r\n    constructor() {\r\n        this.storageKey = 'graph_canvas_data'; // Gard√© pour compatibilit√© migration\r\n        this.version = '2.0'; // Version SQLite\r\n        this.canvasId = getCanvasId();\r\n        this._cachedData = null; // Cache pour acc√®s synchrone\r\n    }\r\n\r\n    /**\r\n     * Sauvegarde les donn√©es du canvas dans SQLite\r\n     * @param {Object} data - Donn√©es √† sauvegarder { vignettes, connections, ... }\r\n     * @returns {Promise<boolean>}\r\n     */\r\n    async save(data: StorageData): Promise<boolean> {\r\n        try {\r\n            // Pr√©parer les nodes\r\n            const nodes: StorageNode[] = (data.vignettes || data.nodes || []).map((n: any) => ({\r\n                id: n.id,\r\n                text: n.text || '',\r\n                x: n.x || 0,\r\n                y: n.y || 0,\r\n                status: n.status || 'neutral',\r\n                tags: n.tags || [],\r\n                synthesized: n.synthesized || false,\r\n                created: n.created || n.createdAt || Date.now(),\r\n                modified: n.modified || n.updatedAt || Date.now(),\r\n            }));\r\n\r\n            // Pr√©parer les connections\r\n            const rawConnections: StorageConnection[] = (data.connections || []).map((c: any) => ({\r\n                id: c.id,\r\n                from: c.from || c.fromId,\r\n                to: c.to || c.toId,\r\n                type: c.type || 'implies',\r\n                mechanism: c.mechanism || null,\r\n            }));\r\n\r\n            // Valider et r√©parer l'int√©grit√© (orphelines, doublons, auto-connexions, etc.)\r\n            const validation = validateCanvasState(nodes as any, rawConnections as any, { repair: true });\r\n            if (!validation.valid) {\r\n                console.warn(`[Storage] State r√©par√© avant save : ${validation.errors.length} erreur(s), ${validation.warnings.length} warning(s)`);\r\n                for (const issue of validation.errors) {\r\n                    console.warn(`  [${issue.code}] ${issue.message}`);\r\n                }\r\n            }\r\n            const connections = validation.repaired?.connections ?? rawConnections;\r\n\r\n            // Sauvegarder via IPC\r\n            const result = await (window as any).fgraph.db.canvas.saveAll(this.canvasId, { nodes, connections });\r\n\r\n            // Mettre √† jour le cache\r\n            this._cachedData = data;\r\n\r\n            console.log('Donn√©es sauvegard√©es avec succ√®s', result);\r\n            return true;\r\n        } catch (error) {\r\n            console.error('Erreur lors de la sauvegarde:', error);\r\n            return false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Charge les donn√©es du canvas depuis SQLite\r\n     * @returns {Promise<CanvasLoadedData|null>}\r\n     */\r\n    async load(): Promise<CanvasLoadedData | null> {\r\n        try {\r\n            const result: LoadResult = await (window as any).fgraph.db.canvas.loadAll(this.canvasId);\r\n\r\n            if (!result || (!result.nodes?.length && !result.connections?.length)) {\r\n                console.log('Aucune donn√©e sauvegard√©e trouv√©e');\r\n                return null;\r\n            }\r\n\r\n            // Convertir au format attendu par l'app\r\n            const data: CanvasLoadedData = {\r\n                vignettes: result.nodes.map((n) => ({\r\n                    id: n.id,\r\n                    text: n.text,\r\n                    x: n.x,\r\n                    y: n.y,\r\n                    status: n.status,\r\n                    tags: n.tags,\r\n                    synthesized: n.synthesized || false,\r\n                    created: n.created_at,\r\n                    modified: n.updated_at,\r\n                })),\r\n                connections: result.connections.map((c) => ({\r\n                    id: c.id,\r\n                    from: c.from,\r\n                    to: c.to,\r\n                    type: c.type,\r\n                    mechanism: c.mechanism || null,\r\n                })),\r\n            };\r\n\r\n            // Mettre √† jour le cache\r\n            this._cachedData = data;\r\n\r\n            console.log('Donn√©es charg√©es avec succ√®s');\r\n            return data;\r\n        } catch (error) {\r\n            console.error('Erreur lors du chargement:', error);\r\n            return null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Efface toutes les donn√©es du canvas\r\n     * @returns {Promise<boolean>}\r\n     */\r\n    async clear(): Promise<boolean> {\r\n        try {\r\n            await (window as any).fgraph.db.nodes.replaceAll(this.canvasId, []);\r\n            await (window as any).fgraph.db.connections.replaceAll(this.canvasId, []);\r\n            this._cachedData = null;\r\n            console.log('Donn√©es effac√©es');\r\n            return true;\r\n        } catch (error) {\r\n            console.error(\"Erreur lors de l'effacement:\", error);\r\n            return false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * V√©rifie si des donn√©es de session existent (async)\r\n     * @returns {Promise<boolean>}\r\n     */\r\n    async hasData(): Promise<boolean> {\r\n        try {\r\n            const result: LoadResult = await (window as any).fgraph.db.canvas.loadAll(this.canvasId);\r\n            if (!result) return false;\r\n\r\n            const hasNodes: boolean = result.nodes && result.nodes.length > 0;\r\n            const hasConnections: boolean = result.connections && result.connections.length > 0;\r\n            return hasNodes || hasConnections;\r\n        } catch {\r\n            return false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Version synchrone de hasData (utilise le cache ou localStorage)\r\n     * Pour compatibilit√© avec le code legacy qui attend une r√©ponse synchrone\r\n     * @returns {boolean}\r\n     */\r\n    hasDataSync(): boolean {\r\n        // D'abord v√©rifier le cache\r\n        if (this._cachedData) {\r\n            const hasVignettes: boolean = (this._cachedData as any).vignettes?.length > 0;\r\n            const hasConnections: boolean = (this._cachedData as any).connections?.length > 0;\r\n            return hasVignettes || hasConnections;\r\n        }\r\n\r\n        // Fallback: v√©rifier localStorage (pour la p√©riode de transition)\r\n        try {\r\n            const savedData: string | null = localStorage.getItem(this.storageKey);\r\n            if (!savedData) return false;\r\n\r\n            const parsed: any = JSON.parse(savedData);\r\n            if (parsed.data) {\r\n                const hasVignettes: boolean = parsed.data.vignettes?.length > 0;\r\n                const hasNodes: boolean = parsed.data.nodes?.length > 0;\r\n                const hasPoles: boolean = parsed.data.poles?.length > 0;\r\n                const hasConnections: boolean = parsed.data.connections?.length > 0;\r\n                return hasVignettes || hasNodes || hasPoles || hasConnections;\r\n            }\r\n            return false;\r\n        } catch {\r\n            return false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Exporte les donn√©es en fichier JSON\r\n     */\r\n    async export(): Promise<void> {\r\n        const data: CanvasLoadedData | null = await this.load();\r\n        if (!data) return;\r\n\r\n        const blob: Blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });\r\n        const url: string = URL.createObjectURL(blob);\r\n\r\n        const a: HTMLAnchorElement = document.createElement('a');\r\n        a.href = url;\r\n        a.download = `graph_canvas_${Date.now()}.json`;\r\n        a.click();\r\n\r\n        URL.revokeObjectURL(url);\r\n    }\r\n\r\n    /**\r\n     * Importe des donn√©es depuis un fichier JSON\r\n     * @param {File} file - Fichier √† importer\r\n     * @returns {Promise<StorageData>}\r\n     */\r\n    import(file: File): Promise<StorageData> {\r\n        return new Promise((resolve, reject) => {\r\n            const reader: FileReader = new FileReader();\r\n\r\n            reader.onload = async (e: ProgressEvent<FileReader>) => {\r\n                try {\r\n                    const data: StorageData = JSON.parse(e.target!.result as string);\r\n                    await this.save(data);\r\n                    resolve(data);\r\n                } catch (error) {\r\n                    reject(error);\r\n                }\r\n            };\r\n\r\n            reader.onerror = reject;\r\n            reader.readAsText(file);\r\n        });\r\n    }\r\n\r\n    handleQuotaExceeded(): void {\r\n        // Plus pertinent avec SQLite - gard√© pour compatibilit√©\r\n        console.warn(\"Cette m√©thode n'est plus utilis√©e avec SQLite\");\r\n    }\r\n\r\n    migrate(oldData: any): any {\r\n        // Migration g√©r√©e par db-migration.js\r\n        console.log('Migration g√©r√©e par db-migration.js');\r\n        return oldData.data;\r\n    }\r\n}\r\n","/**\r\n * MiniMap - Navigation visuelle du canvas\r\n *\r\n * Responsabilit√© : Affiche une vue miniature du canvas avec tous les nodes\r\n * et permet la navigation rapide (clic, drag du viewport, double-clic zoom).\r\n *\r\n * D√©pendances :\r\n * - canvasManager : r√©f√©rence au CanvasManager pour acc√©der √† state et applyTransform\r\n *\r\n * √âl√©ments DOM requis :\r\n * - #minimap-canvas : canvas 2D pour le rendu\r\n * - #minimap-viewport : div repr√©sentant la zone visible\r\n * - #minimap-container : conteneur principal\r\n * - #minimap-resize-btn : bouton pour agrandir/r√©duire\r\n *\r\n * @exports MiniMap\r\n */\r\n\r\ninterface MinimapBounds {\r\n    minX: number;\r\n    minY: number;\r\n    maxX: number;\r\n    maxY: number;\r\n}\r\n\r\nexport class MiniMap {\r\n    canvas: HTMLCanvasElement | null;\r\n    viewport: HTMLElement | null;\r\n    container: HTMLElement | null;\r\n    resizeBtn: HTMLElement | null;\r\n    canvasManager: any;\r\n    ctx: CanvasRenderingContext2D | null;\r\n    isExpanded: boolean;\r\n    normalWidth: number;\r\n    normalHeight: number;\r\n    expandedWidth: number;\r\n    expandedHeight: number;\r\n    width: number;\r\n    height: number;\r\n    _animationFrameId: number | null;\r\n    scale: number;\r\n    isDragging: boolean;\r\n    dragStartX: number;\r\n    dragStartY: number;\r\n    initialPanX: number;\r\n    initialPanY: number;\r\n    worldWidth: number;\r\n    worldHeight: number;\r\n\r\n    constructor(canvasManager: any) {\r\n        this.canvas = document.getElementById('minimap-canvas') as HTMLCanvasElement | null;\r\n        this.viewport = document.getElementById('minimap-viewport');\r\n        this.container = document.getElementById('minimap-container');\r\n        this.resizeBtn = document.getElementById('minimap-resize-btn');\r\n        this.canvasManager = canvasManager;\r\n\r\n        if (!this.canvas || !this.viewport) {\r\n            console.error('Mini-map elements not found');\r\n            this.ctx = null;\r\n            this.isExpanded = false;\r\n            this.normalWidth = 200;\r\n            this.normalHeight = 150;\r\n            this.expandedWidth = 300;\r\n            this.expandedHeight = 225;\r\n            this.width = this.normalWidth;\r\n            this.height = this.normalHeight;\r\n            this._animationFrameId = null;\r\n            this.scale = 0.05;\r\n            this.isDragging = false;\r\n            this.dragStartX = 0;\r\n            this.dragStartY = 0;\r\n            this.initialPanX = 0;\r\n            this.initialPanY = 0;\r\n            this.worldWidth = 0;\r\n            this.worldHeight = 0;\r\n            return;\r\n        }\r\n\r\n        this.ctx = this.canvas.getContext('2d');\r\n\r\n        // Dimensions du canvas (taille normale)\r\n        this.isExpanded = false;\r\n        this.normalWidth = 200;\r\n        this.normalHeight = 150;\r\n        this.expandedWidth = 300;\r\n        this.expandedHeight = 225;\r\n        this.width = this.normalWidth;\r\n        this.height = this.normalHeight;\r\n        this.canvas.width = this.width;\r\n        this.canvas.height = this.height;\r\n\r\n        // Configuration\r\n        this._animationFrameId = null;\r\n        this.scale = 0.05; // √âchelle de la mini-map (ajust√©e dynamiquement)\r\n\r\n        // √âtat du drag\r\n        this.isDragging = false;\r\n        this.dragStartX = 0;\r\n        this.dragStartY = 0;\r\n        this.initialPanX = 0;\r\n        this.initialPanY = 0;\r\n        this.worldWidth = 0;\r\n        this.worldHeight = 0;\r\n\r\n        this.setupResizeButton();\r\n        this.setupEventListeners();\r\n        this.startAutoUpdate();\r\n    }\r\n\r\n    setupResizeButton(): void {\r\n        if (!this.resizeBtn || !this.container) return;\r\n\r\n        this.resizeBtn.addEventListener('click', (e) => {\r\n            e.stopPropagation();\r\n            this.toggleSize();\r\n        });\r\n    }\r\n\r\n    toggleSize(): void {\r\n        this.isExpanded = !this.isExpanded;\r\n        this.container!.classList.toggle('expanded', this.isExpanded);\r\n\r\n        // Mettre √† jour les dimensions\r\n        this.width = this.isExpanded ? this.expandedWidth : this.normalWidth;\r\n        this.height = this.isExpanded ? this.expandedHeight : this.normalHeight;\r\n        this.canvas!.width = this.width;\r\n        this.canvas!.height = this.height;\r\n\r\n        // Redessiner\r\n        this.update();\r\n    }\r\n\r\n    setupEventListeners(): void {\r\n        // Clic sur le canvas (hors viewport) pour centrer la vue\r\n        this.canvas!.addEventListener('click', (e) => {\r\n            if (this.isDragging) return; // Ignorer si on vient de drag\r\n\r\n            const rect = this.canvas!.getBoundingClientRect();\r\n            const x = e.clientX - rect.left;\r\n            const y = e.clientY - rect.top;\r\n\r\n            // Convertir les coordonn√©es mini-map vers coordonn√©es monde\r\n            const bounds = this.calculateBounds();\r\n            const zoom = this.canvasManager.state.zoom || 1;\r\n            const containerRect = this.canvasManager.polesContainer.getBoundingClientRect();\r\n\r\n            // Position cliqu√©e en coordonn√©es monde\r\n            const worldX = x / this.scale + bounds.minX;\r\n            const worldY = y / this.scale + bounds.minY;\r\n\r\n            // Centrer la vue sur ce point\r\n            // On veut que worldX,worldY soit au centre de l'√©cran\r\n            this.canvasManager.state.panX = -worldX * zoom + containerRect.width / 2;\r\n            this.canvasManager.state.panY = -worldY * zoom + containerRect.height / 2;\r\n\r\n            this.canvasManager.applyTransform();\r\n            this.update();\r\n        });\r\n\r\n        // Drag du viewport pour naviguer\r\n        this.viewport!.addEventListener('mousedown', (e) => {\r\n            e.stopPropagation();\r\n            this.isDragging = true;\r\n            this.dragStartX = e.clientX;\r\n            this.dragStartY = e.clientY;\r\n            this.initialPanX = this.canvasManager.state.panX;\r\n            this.initialPanY = this.canvasManager.state.panY;\r\n            this.viewport!.classList.add('dragging');\r\n        });\r\n\r\n        document.addEventListener('mousemove', (e) => {\r\n            if (!this.isDragging) return;\r\n\r\n            const deltaX = e.clientX - this.dragStartX;\r\n            const deltaY = e.clientY - this.dragStartY;\r\n            const zoom = this.canvasManager.state.zoom || 1;\r\n\r\n            // Convertir le delta de la mini-map vers le canvas principal\r\n            // delta en mini-map -> delta en monde -> delta en pixels √©cran (avec zoom)\r\n            const worldDeltaX = deltaX / this.scale;\r\n            const worldDeltaY = deltaY / this.scale;\r\n\r\n            this.canvasManager.state.panX = this.initialPanX - worldDeltaX * zoom;\r\n            this.canvasManager.state.panY = this.initialPanY - worldDeltaY * zoom;\r\n\r\n            this.canvasManager.applyTransform();\r\n            this.update();\r\n        });\r\n\r\n        document.addEventListener('mouseup', () => {\r\n            if (this.isDragging) {\r\n                this.isDragging = false;\r\n                this.viewport!.classList.remove('dragging');\r\n            }\r\n        });\r\n\r\n        // Double-clic pour zoomer sur une zone\r\n        this.canvas!.addEventListener('dblclick', (e) => {\r\n            const rect = this.canvas!.getBoundingClientRect();\r\n            const x = e.clientX - rect.left;\r\n            const y = e.clientY - rect.top;\r\n\r\n            // Convertir les coordonn√©es mini-map vers coordonn√©es monde\r\n            const bounds = this.calculateBounds();\r\n            const worldX = x / this.scale + bounds.minX;\r\n            const worldY = y / this.scale + bounds.minY;\r\n\r\n            // Nouveau zoom\r\n            const newZoom = Math.min(this.canvasManager.state.zoom * 1.2, 3);\r\n            const containerRect = this.canvasManager.polesContainer.getBoundingClientRect();\r\n\r\n            // Centrer et zoomer\r\n            this.canvasManager.state.panX = -worldX * newZoom + containerRect.width / 2;\r\n            this.canvasManager.state.panY = -worldY * newZoom + containerRect.height / 2;\r\n            this.canvasManager.state.zoom = newZoom;\r\n\r\n            this.canvasManager.applyTransform();\r\n            this.update();\r\n        });\r\n    }\r\n\r\n    startAutoUpdate(): void {\r\n        let lastUpdate = 0;\r\n        const UPDATE_INTERVAL = 500; // ms between updates\r\n\r\n        const tick = (timestamp: number): void => {\r\n            if (timestamp - lastUpdate >= UPDATE_INTERVAL) {\r\n                this.update();\r\n                lastUpdate = timestamp;\r\n            }\r\n            this._animationFrameId = requestAnimationFrame(tick);\r\n        };\r\n\r\n        this._animationFrameId = requestAnimationFrame(tick);\r\n        this.update(); // Mise √† jour initiale\r\n    }\r\n\r\n    calculateBounds(): MinimapBounds {\r\n        const nodes = this.canvasManager.state.nodes;\r\n        const zoom = this.canvasManager.state.zoom || 1;\r\n        const panX = this.canvasManager.state.panX || 0;\r\n        const panY = this.canvasManager.state.panY || 0;\r\n        const containerRect = this.canvasManager.polesContainer.getBoundingClientRect();\r\n\r\n        // Zone actuellement visible\r\n        const viewLeft = -panX / zoom;\r\n        const viewTop = -panY / zoom;\r\n        const viewRight = viewLeft + containerRect.width / zoom;\r\n        const viewBottom = viewTop + containerRect.height / zoom;\r\n\r\n        if (nodes.length === 0) {\r\n            // Si pas de nodes, montrer juste la zone visible avec une marge\r\n            return {\r\n                minX: viewLeft - 100,\r\n                minY: viewTop - 100,\r\n                maxX: viewRight + 100,\r\n                maxY: viewBottom + 100,\r\n            };\r\n        }\r\n\r\n        let minX = Infinity,\r\n            minY = Infinity;\r\n        let maxX = -Infinity,\r\n            maxY = -Infinity;\r\n\r\n        nodes.forEach((node: any) => {\r\n            minX = Math.min(minX, node.x);\r\n            minY = Math.min(minY, node.y);\r\n            maxX = Math.max(maxX, node.x + 300); // Largeur du node\r\n            maxY = Math.max(maxY, node.y + 120); // Hauteur du node\r\n        });\r\n\r\n        // Inclure aussi la zone visible actuelle dans les bounds\r\n        minX = Math.min(minX, viewLeft);\r\n        minY = Math.min(minY, viewTop);\r\n        maxX = Math.max(maxX, viewRight);\r\n        maxY = Math.max(maxY, viewBottom);\r\n\r\n        // Ajouter une marge\r\n        const margin = 100;\r\n        minX -= margin;\r\n        minY -= margin;\r\n        maxX += margin;\r\n        maxY += margin;\r\n\r\n        return { minX, minY, maxX, maxY };\r\n    }\r\n\r\n    update(): void {\r\n        const bounds = this.calculateBounds();\r\n        this.worldWidth = bounds.maxX - bounds.minX;\r\n        this.worldHeight = bounds.maxY - bounds.minY;\r\n\r\n        // Calculer l'√©chelle pour que tout soit visible\r\n        const scaleX = this.width / this.worldWidth;\r\n        const scaleY = this.height / this.worldHeight;\r\n        this.scale = Math.min(scaleX, scaleY);\r\n\r\n        // Lire les couleurs depuis les variables CSS du th√®me actif\r\n        const cs = getComputedStyle(document.documentElement);\r\n        const bgDeep = cs.getPropertyValue('--theme-bg-deep').trim() || '#1a1a1a';\r\n        const nodeFill = cs.getPropertyValue('--theme-node-bg-start').trim() || '#2a2a2a';\r\n        const nodeBorder = cs.getPropertyValue('--theme-border').trim() || '#3a3a3a';\r\n        const textSecondary = cs.getPropertyValue('--theme-text-secondary').trim() || '#8a8070';\r\n        const connImplies = cs.getPropertyValue('--theme-connection-implies').trim() || '#6a9ac0';\r\n        const connResonance = cs.getPropertyValue('--theme-connection-resonance').trim() || '#9a6ac0';\r\n        const badgeRedBg = cs.getPropertyValue('--theme-badge-red-bg').trim() || '#3a2a2a';\r\n\r\n        // Effacer le canvas\r\n        this.ctx!.fillStyle = bgDeep;\r\n        this.ctx!.fillRect(0, 0, this.width, this.height);\r\n\r\n        // Dessiner les nodes avec couleurs correspondant au CSS des vignettes\r\n        this.canvasManager.state.nodes.forEach((node: any) => {\r\n            const x = (node.x - bounds.minX) * this.scale;\r\n            const y = (node.y - bounds.minY) * this.scale;\r\n            const w = Math.max(300 * this.scale, 6); // Minimum 6px pour visibilit√©\r\n            const h = Math.max(120 * this.scale, 4); // Minimum 4px pour visibilit√©\r\n\r\n            // Couleurs align√©es avec le CSS des vignettes (border-left-color)\r\n            let borderColor: string, fillColor: string;\r\n            switch (node.status) {\r\n                case 'priority':\r\n                    borderColor = '#e74c3c'; // Rouge vif (status-priority)\r\n                    fillColor = badgeRedBg;\r\n                    break;\r\n                default: // \"neutral\"\r\n                    borderColor = textSecondary;\r\n                    fillColor = nodeFill;\r\n            }\r\n\r\n            // Dessiner le fond de la vignette\r\n            this.ctx!.fillStyle = fillColor;\r\n            this.ctx!.fillRect(x, y, w, h);\r\n\r\n            // Dessiner la bordure gauche color√©e (comme les vraies vignettes)\r\n            this.ctx!.fillStyle = borderColor;\r\n            this.ctx!.fillRect(x, y, Math.max(2, w * 0.05), h);\r\n\r\n            // Contour g√©n√©ral\r\n            this.ctx!.strokeStyle = nodeBorder;\r\n            this.ctx!.lineWidth = 0.5;\r\n            this.ctx!.strokeRect(x, y, w, h);\r\n        });\r\n\r\n        // Dessiner les connexions avec couleurs par type\r\n        const nodeMap = new Map<string, any>(this.canvasManager.state.nodes.map((n: any) => [n.id, n]));\r\n        this.canvasManager.state.connections.forEach((conn: any) => {\r\n            const fromNode = nodeMap.get(conn.from);\r\n            const toNode = nodeMap.get(conn.to);\r\n\r\n            if (fromNode && toNode) {\r\n                const x1 = (fromNode.x + 150 - bounds.minX) * this.scale;\r\n                const y1 = (fromNode.y + 60 - bounds.minY) * this.scale;\r\n                const x2 = (toNode.x + 150 - bounds.minX) * this.scale;\r\n                const y2 = (toNode.y + 60 - bounds.minY) * this.scale;\r\n\r\n                // Couleur et style selon le type de connexion\r\n                if (conn.type === 'resonance') {\r\n                    this.ctx!.strokeStyle = connResonance;\r\n                    this.ctx!.setLineDash([3, 2]); // Ligne pointill√©e\r\n                } else {\r\n                    this.ctx!.strokeStyle = connImplies;\r\n                    this.ctx!.setLineDash([]); // Ligne continue\r\n                }\r\n                this.ctx!.lineWidth = 1.5; // Plus √©pais\r\n\r\n                this.ctx!.beginPath();\r\n                this.ctx!.moveTo(x1, y1);\r\n                this.ctx!.lineTo(x2, y2);\r\n                this.ctx!.stroke();\r\n            }\r\n        });\r\n        // R√©initialiser le dash\r\n        this.ctx!.setLineDash([]);\r\n\r\n        // Mettre √† jour le viewport\r\n        this.updateViewport(bounds);\r\n    }\r\n\r\n    updateViewport(bounds: MinimapBounds): void {\r\n        const containerRect = this.canvasManager.polesContainer.getBoundingClientRect();\r\n        const zoom = this.canvasManager.state.zoom || 1;\r\n        const panX = this.canvasManager.state.panX || 0;\r\n        const panY = this.canvasManager.state.panY || 0;\r\n\r\n        // La transformation CSS est: translate(panX, panY) scale(zoom)\r\n        // Le point (0,0) du monde appara√Æt √† l'√©cran en (panX, panY)\r\n        // Donc le coin sup√©rieur gauche de l'√©cran (0,0) montre le point monde (-panX/zoom, -panY/zoom)\r\n        const worldViewLeft = -panX / zoom;\r\n        const worldViewTop = -panY / zoom;\r\n\r\n        // Taille visible en coordonn√©es monde\r\n        const screenWorldWidth = containerRect.width / zoom;\r\n        const screenWorldHeight = containerRect.height / zoom;\r\n\r\n        // Convertir en coordonn√©es mini-map (m√™me scale que les nodes)\r\n        const viewX = (worldViewLeft - bounds.minX) * this.scale;\r\n        const viewY = (worldViewTop - bounds.minY) * this.scale;\r\n        const viewW = screenWorldWidth * this.scale;\r\n        const viewH = screenWorldHeight * this.scale;\r\n\r\n        // Appliquer les positions\r\n        this.viewport!.style.left = `${viewX}px`;\r\n        this.viewport!.style.top = `${viewY}px`;\r\n        this.viewport!.style.width = `${Math.max(viewW, 10)}px`;\r\n        this.viewport!.style.height = `${Math.max(viewH, 10)}px`;\r\n    }\r\n\r\n    destroy(): void {\r\n        if (this._animationFrameId) {\r\n            cancelAnimationFrame(this._animationFrameId);\r\n        }\r\n    }\r\n}\r\n","/**\r\n * Connections - Gestion des connexions entre vignettes\r\n *\r\n * Responsabilit√© : Cr√©er, supprimer, rendre et mettre √† jour les connexions\r\n * SVG entre les vignettes. G√®re le mode connexion, la file d'attente pour\r\n * les imports, et le rendu optimis√© sans flicker.\r\n *\r\n * D√©pendances :\r\n * - canvasManager.state.connections, nodes, pendingConnections\r\n * - canvasManager.interaction.connectionMode, connectionFromNode\r\n * - canvasManager.svgConnections, polesContainer\r\n * - canvasManager.NODE_WIDTH, NODE_HEIGHT\r\n * - canvasManager.showConnectionContextMenu() (pour les event listeners)\r\n *\r\n * √âv√©nements √©mis :\r\n * - connectionCreated : nouvelle connexion cr√©√©e\r\n * - connectionsChanged : connexions modifi√©es\r\n *\r\n * @exports enterConnectionMode, exitConnectionMode, toggleConnectionModeWaiting,\r\n *          createConnection, deleteConnection, queueConnection, processPendingConnections,\r\n *          renderConnection, renderAllConnections, forceRefreshConnections,\r\n *          rebuildAllConnections, updateConnections, updateNodeConnections, getNodeCenter\r\n */\r\n\r\nimport type { KairosNode, KairosConnection } from '../types/kairos.js';\r\n\r\n/**\r\n * Construit/met √† jour le nodeMap pour des lookups O(1)\r\n * Utilise le flag _nodeMapDirty pour invalider le cache\r\n */\r\nfunction ensureNodeMap(cm: any): Map<string, KairosNode> {\r\n    if (!cm._nodeMap || cm._nodeMapDirty) {\r\n        cm._nodeMap = new Map<string, KairosNode>();\r\n        for (const n of cm.state.nodes) {\r\n            cm._nodeMap.set(n.id, n);\r\n        }\r\n        cm._nodeMapDirty = false;\r\n    }\r\n    return cm._nodeMap;\r\n}\r\n\r\n/**\r\n * Active le mode connexion depuis un node source\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {Object} fromNode - Node source\r\n */\r\nexport function enterConnectionMode(cm: any, fromNode: KairosNode): void {\r\n    cm.interaction.connectionMode = true;\r\n    cm.interaction.connectionFromNode = fromNode;\r\n\r\n    const nodeDiv = document.getElementById(fromNode.id);\r\n    if (nodeDiv) {\r\n        nodeDiv.style.boxShadow = '0 0 20px rgba(74, 124, 89, 0.8)';\r\n    }\r\n}\r\n\r\n/**\r\n * D√©sactive le mode connexion\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function exitConnectionMode(cm: any): void {\r\n    if (cm.interaction.connectionFromNode) {\r\n        const nodeDiv = document.getElementById(cm.interaction.connectionFromNode.id);\r\n        if (nodeDiv) {\r\n            nodeDiv.style.boxShadow = '';\r\n        }\r\n    }\r\n\r\n    cm.interaction.connectionMode = false;\r\n    cm.interaction.connectionFromNode = null;\r\n\r\n    // Retirer l'indication visuelle du mode \"en attente\"\r\n    cm.polesContainer.classList.remove('connection-mode-waiting');\r\n}\r\n\r\n/**\r\n * Toggle le mode connexion \"en attente\"\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function toggleConnectionModeWaiting(cm: any): void {\r\n    // Si on est d√©j√† en mode connexion avec un p√¥le source, annuler\r\n    if (cm.interaction.connectionMode && cm.interaction.connectionFromNode) {\r\n        exitConnectionMode(cm);\r\n        console.log('Mode connexion annul√©');\r\n        return;\r\n    }\r\n\r\n    // Sinon, activer le mode \"en attente de s√©lection\"\r\n    // Le prochain clic sur un p√¥le activera enterConnectionMode()\r\n    if (cm.polesContainer.classList.contains('connection-mode-waiting')) {\r\n        // D√©sactiver le mode en attente\r\n        cm.polesContainer.classList.remove('connection-mode-waiting');\r\n        cm.interaction.connectionMode = false;\r\n        console.log('Mode connexion d√©sactiv√©');\r\n    } else {\r\n        // Activer le mode en attente\r\n        cm.polesContainer.classList.add('connection-mode-waiting');\r\n        cm.interaction.connectionMode = true;\r\n        cm.interaction.connectionFromNode = null; // Pas encore de p√¥le source\r\n        console.log('Mode connexion activ√© - Cliquez sur un p√¥le pour commencer');\r\n    }\r\n}\r\n\r\n/**\r\n * Cr√©e une connexion entre deux nodes\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {Object} fromNode - Node source\r\n * @param {Object} toNode - Node cible\r\n * @param {string} type - Type de connexion ('implies', 'resonance', etc.)\r\n * @param {string} mechanism - M√©canisme textuel de la connexion (optionnel)\r\n */\r\nexport function createConnection(\r\n    cm: any,\r\n    fromNode: KairosNode,\r\n    toNode: KairosNode,\r\n    type: string = 'implies',\r\n    mechanism: string | null = null,\r\n): void {\r\n    if (fromNode.id === toNode.id) return; // Pas de connexion √† soi-m√™me\r\n\r\n    // V√©rifier si la connexion existe d√©j√†\r\n    const exists = cm.state.connections.some(\r\n        (conn: KairosConnection) => conn.from === fromNode.id && conn.to === toNode.id,\r\n    );\r\n\r\n    if (exists) {\r\n        console.log('Connexion d√©j√† existante');\r\n        return;\r\n    }\r\n\r\n    const connection = {\r\n        id: `c_${crypto.randomUUID()}`,\r\n        from: fromNode.id,\r\n        to: toNode.id,\r\n        type: type, // implies, tension, resonance, hypothesis, opposition\r\n        mechanism: mechanism || null, // M√©canisme textuel v2\r\n        created: new Date().toISOString(),\r\n    };\r\n\r\n    cm.state.connections.push(connection);\r\n    // Debounce le rendu pour √©viter les appels multiples lors d'imports en batch\r\n    scheduleConnectionRender(cm);\r\n\r\n    // √âmettre √©v√©nement pour tracking attracteurs\r\n    document.dispatchEvent(\r\n        new CustomEvent('connectionCreated', {\r\n            detail: { fromId: fromNode.id, toId: toNode.id, type: type, mechanism: mechanism },\r\n        }),\r\n    );\r\n}\r\n\r\n/**\r\n * Planifie un rendu des connexions avec debounce\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function scheduleConnectionRender(cm: any): void {\r\n    if (cm._connectionRenderTimeout) {\r\n        clearTimeout(cm._connectionRenderTimeout);\r\n    }\r\n    cm._connectionRenderTimeout = setTimeout(() => {\r\n        renderAllConnections(cm);\r\n        cm._connectionRenderTimeout = null;\r\n    }, 50); // Petit d√©lai pour batcher les appels multiples\r\n}\r\n\r\n/**\r\n * Met une connexion en file d'attente (utilis√© lors de l'import)\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {string} fromNodeId - ID du node source\r\n * @param {string} toNodeId - ID du node cible\r\n * @param {string} type - Type de connexion\r\n * @param {string} mechanism - M√©canisme textuel de la connexion (optionnel)\r\n */\r\nexport function queueConnection(\r\n    cm: any,\r\n    fromNodeId: string,\r\n    toNodeId: string,\r\n    type: string = 'implies',\r\n    mechanism: string | null = null,\r\n): void {\r\n    // V√©rifier que ce n'est pas une auto-connexion\r\n    if (fromNodeId === toNodeId) return;\r\n\r\n    // V√©rifier si la connexion existe d√©j√† ou est d√©j√† en attente\r\n    const existsInConnections = cm.state.connections.some(\r\n        (conn: KairosConnection) => conn.from === fromNodeId && conn.to === toNodeId,\r\n    );\r\n    const existsInPending = cm.state.pendingConnections.some(\r\n        (conn: KairosConnection) => conn.from === fromNodeId && conn.to === toNodeId,\r\n    );\r\n\r\n    if (existsInConnections || existsInPending) {\r\n        console.log(`Connexion ${fromNodeId} ‚Üí ${toNodeId} d√©j√† existante ou en attente`);\r\n        return;\r\n    }\r\n\r\n    const pendingConn = {\r\n        id: `c_${crypto.randomUUID()}`,\r\n        from: fromNodeId,\r\n        to: toNodeId,\r\n        type: type,\r\n        mechanism: mechanism || null, // M√©canisme textuel v2\r\n        created: new Date().toISOString(),\r\n    };\r\n\r\n    cm.state.pendingConnections.push(pendingConn);\r\n    console.log(`Connexion mise en attente: ${fromNodeId} ‚Üí ${toNodeId}${mechanism ? ` [${mechanism}]` : ''}`);\r\n}\r\n\r\n/**\r\n * Traite toutes les connexions en attente apr√®s stabilisation du DOM\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function processPendingConnections(cm: any): void {\r\n    if (cm.state.pendingConnections.length === 0) {\r\n        console.log('Aucune connexion en attente');\r\n        return;\r\n    }\r\n\r\n    console.log(`Traitement de ${cm.state.pendingConnections.length} connexions en attente...`);\r\n\r\n    // Attendre que le DOM soit stable avant de cr√©er les connexions\r\n    waitForDOMStable(cm).then(() => {\r\n        const processed: KairosConnection[] = [];\r\n        const failed: KairosConnection[] = [];\r\n\r\n        cm.state.pendingConnections.forEach((pending: KairosConnection) => {\r\n            const fromNode = cm.state.nodes.find((n: KairosNode) => n.id === pending.from);\r\n            const toNode = cm.state.nodes.find((n: KairosNode) => n.id === pending.to);\r\n\r\n            if (fromNode && toNode) {\r\n                // V√©rifier que les √©l√©ments DOM existent\r\n                const fromElement = document.getElementById(pending.from);\r\n                const toElement = document.getElementById(pending.to);\r\n\r\n                if (fromElement && toElement) {\r\n                    // Cr√©er la connexion directement (sans passer par createConnection qui a son propre debounce)\r\n                    cm.state.connections.push(pending);\r\n                    processed.push(pending);\r\n                } else {\r\n                    console.warn(`√âl√©ments DOM non trouv√©s pour connexion ${pending.from} ‚Üí ${pending.to}`);\r\n                    failed.push(pending);\r\n                }\r\n            } else {\r\n                console.warn(`Nodes non trouv√©s pour connexion ${pending.from} ‚Üí ${pending.to}`);\r\n                failed.push(pending);\r\n            }\r\n        });\r\n\r\n        // Vider la file d'attente\r\n        cm.state.pendingConnections = [];\r\n\r\n        // Rendre toutes les connexions\r\n        if (processed.length > 0) {\r\n            renderAllConnections(cm);\r\n            console.log(`‚úì ${processed.length} connexions cr√©√©es avec succ√®s`);\r\n\r\n            // √âmettre un √©v√©nement pour notifier le changement de connexions\r\n            document.dispatchEvent(\r\n                new CustomEvent('connectionsChanged', {\r\n                    detail: { count: processed.length, total: cm.state.connections.length },\r\n                }),\r\n            );\r\n        }\r\n\r\n        if (failed.length > 0) {\r\n            console.warn(`‚úó ${failed.length} connexions ont √©chou√©`);\r\n            document.dispatchEvent(\r\n                new CustomEvent('connectionsPendingResult', {\r\n                    detail: {\r\n                        processed: processed.length,\r\n                        failed: failed.length,\r\n                        total: processed.length + failed.length,\r\n                    },\r\n                }),\r\n            );\r\n        }\r\n    });\r\n}\r\n\r\n/**\r\n * Attend que le DOM soit stable (plus de changements pendant un certain temps)\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {number} timeout - Timeout en ms\r\n * @returns {Promise}\r\n */\r\nexport function waitForDOMStable(cm: any, timeout: number = 500): Promise<void> {\r\n    return new Promise((resolve) => {\r\n        let lastChangeTime = Date.now();\r\n        let resolved = false;\r\n\r\n        // Observer les changements dans le conteneur des vignettes\r\n        const observer = new MutationObserver(() => {\r\n            lastChangeTime = Date.now();\r\n        });\r\n\r\n        observer.observe(cm.polesContainer, {\r\n            childList: true,\r\n            subtree: true,\r\n            attributes: true,\r\n            attributeFilter: ['style', 'class'],\r\n        });\r\n\r\n        // V√©rifier p√©riodiquement si le DOM est stable\r\n        const checkStable = (): void => {\r\n            if (resolved) return;\r\n\r\n            const timeSinceLastChange = Date.now() - lastChangeTime;\r\n\r\n            if (timeSinceLastChange >= 100) {\r\n                // DOM stable depuis 100ms\r\n                resolved = true;\r\n                observer.disconnect();\r\n                console.log('DOM stable, traitement des connexions...');\r\n                resolve();\r\n            } else if (Date.now() - lastChangeTime < timeout) {\r\n                // Continuer √† v√©rifier\r\n                requestAnimationFrame(checkStable);\r\n            } else {\r\n                // Timeout atteint, forcer la r√©solution\r\n                resolved = true;\r\n                observer.disconnect();\r\n                console.log('Timeout atteint, for√ßage du traitement des connexions...');\r\n                resolve();\r\n            }\r\n        };\r\n\r\n        // D√©marrer la v√©rification apr√®s un court d√©lai initial\r\n        setTimeout(checkStable, 50);\r\n    });\r\n}\r\n\r\n/**\r\n * Supprime une connexion\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {Object} connection - Connexion √† supprimer\r\n */\r\nexport function deleteConnection(cm: any, connection: KairosConnection): void {\r\n    cm.state.connections = cm.state.connections.filter((c: KairosConnection) => c.id !== connection.id);\r\n    renderAllConnections(cm);\r\n\r\n    // √âmettre un √©v√©nement pour notifier le changement de connexions\r\n    document.dispatchEvent(\r\n        new CustomEvent('connectionsChanged', {\r\n            detail: { deleted: 1, total: cm.state.connections.length },\r\n        }),\r\n    );\r\n}\r\n\r\n/**\r\n * Rend toutes les connexions (mise √† jour optimis√©e sans flicker)\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function renderAllConnections(cm: any): void {\r\n    // R√©cup√©rer tous les paths existants (lignes visibles + hitbox)\r\n    const existingLines = cm.svgConnections.querySelectorAll('.connection-line');\r\n    const existingHitboxes = cm.svgConnections.querySelectorAll('.connection-hitbox');\r\n\r\n    const lineMap = new Map<string, SVGPathElement>();\r\n    existingLines.forEach((path: SVGPathElement) => {\r\n        const connId = path.getAttribute('data-connection-id');\r\n        if (connId) lineMap.set(connId, path);\r\n    });\r\n\r\n    const hitboxMap = new Map<string, SVGPathElement>();\r\n    existingHitboxes.forEach((path: SVGPathElement) => {\r\n        const connId = path.getAttribute('data-connection-id');\r\n        if (connId) hitboxMap.set(connId.replace('hitbox-', ''), path);\r\n    });\r\n\r\n    // Cr√©er un Set des IDs de connexions actuelles\r\n    const currentConnectionIds = new Set<string>(cm.state.connections.map((c: KairosConnection) => c.id));\r\n\r\n    // Supprimer les paths orphelins (connexions supprim√©es)\r\n    lineMap.forEach((path, connId) => {\r\n        if (!currentConnectionIds.has(connId)) {\r\n            path.remove();\r\n        }\r\n    });\r\n    hitboxMap.forEach((path, connId) => {\r\n        if (!currentConnectionIds.has(connId)) {\r\n            path.remove();\r\n        }\r\n    });\r\n\r\n    // Mettre √† jour ou cr√©er chaque connexion\r\n    const nodeMap = ensureNodeMap(cm);\r\n    cm.state.connections.forEach((conn: KairosConnection) => {\r\n        const fromNode = nodeMap.get(conn.from);\r\n        const toNode = nodeMap.get(conn.to);\r\n\r\n        if (!fromNode || !toNode) return;\r\n\r\n        const fromCenter = getNodeCenter(cm, fromNode);\r\n        const toCenter = getNodeCenter(cm, toNode);\r\n        const newD = calculatePathD(fromCenter, toCenter);\r\n\r\n        if (lineMap.has(conn.id)) {\r\n            // Path existe ‚Üí METTRE √Ä JOUR (pas recr√©er = pas de flicker)\r\n            lineMap.get(conn.id)!.setAttribute('d', newD);\r\n            // Mettre √† jour aussi la hitbox\r\n            const hitbox = hitboxMap.get(conn.id);\r\n            if (hitbox) hitbox.setAttribute('d', newD);\r\n        } else {\r\n            // Path n'existe pas ‚Üí CR√âER\r\n            renderConnection(cm, conn);\r\n        }\r\n    });\r\n}\r\n\r\n/**\r\n * Force le re-rendu de toutes les connexions\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function forceRefreshConnections(cm: any): void {\r\n    // Appel synchrone - le state est la source de v√©rit√©, pas besoin d'attendre le DOM\r\n    renderAllConnections(cm);\r\n}\r\n\r\n/**\r\n * Reconstruit toutes les connexions (supprime et recr√©e)\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function rebuildAllConnections(cm: any): void {\r\n    // Conserver les defs (markers)\r\n    const defs = cm.svgConnections.querySelector('defs');\r\n\r\n    // Vider le SVG\r\n    cm.svgConnections.innerHTML = '';\r\n\r\n    // R√©ajouter les defs si pr√©sents\r\n    if (defs) {\r\n        cm.svgConnections.appendChild(defs);\r\n    }\r\n\r\n    // Re-rendre toutes les connexions depuis le state\r\n    cm.state.connections.forEach((conn: KairosConnection) => renderConnection(cm, conn));\r\n}\r\n\r\n/**\r\n * Met √† jour les positions des connexions existantes sans recr√©er les paths\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function updateConnections(cm: any): void {\r\n    const nodeMap = ensureNodeMap(cm);\r\n    cm.state.connections.forEach((conn: KairosConnection) => {\r\n        const fromNode = nodeMap.get(conn.from);\r\n        const toNode = nodeMap.get(conn.to);\r\n\r\n        if (!fromNode || !toNode) return;\r\n\r\n        // Calculer les centres directement depuis le state\r\n        const fromCenter = getNodeCenter(cm, fromNode);\r\n        const toCenter = getNodeCenter(cm, toNode);\r\n        const newD = calculatePathD(fromCenter, toCenter);\r\n\r\n        // Trouver le path SVG existant et la hitbox\r\n        const path = cm.svgConnections.querySelector(`[data-connection-id=\"${conn.id}\"]`);\r\n        const hitbox = cm.svgConnections.querySelector(`[data-connection-id=\"hitbox-${conn.id}\"]`);\r\n\r\n        if (path) path.setAttribute('d', newD);\r\n        if (hitbox) hitbox.setAttribute('d', newD);\r\n    });\r\n}\r\n\r\n/**\r\n * Met √† jour les connexions d'un seul node (optimis√© pour le drag)\r\n * Utilise un nodeMap pour des lookups O(1) au lieu de .find() O(n)\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {string} nodeId - ID du node\r\n */\r\nexport function updateNodeConnections(cm: any, nodeId: string): void {\r\n    const nodeMap = ensureNodeMap(cm);\r\n\r\n    // Trouver les connexions li√©es √† ce node\r\n    const relatedConnections = cm.state.connections.filter(\r\n        (c: KairosConnection) => c.from === nodeId || c.to === nodeId,\r\n    );\r\n\r\n    // Mettre √† jour les paths SANS les supprimer/recr√©er (√©vite le flicker)\r\n    for (const conn of relatedConnections) {\r\n        const fromNode = nodeMap.get(conn.from);\r\n        const toNode = nodeMap.get(conn.to);\r\n\r\n        if (!fromNode || !toNode) continue;\r\n\r\n        const fromCenter = getNodeCenter(cm, fromNode);\r\n        const toCenter = getNodeCenter(cm, toNode);\r\n        const newD = calculatePathD(fromCenter, toCenter);\r\n\r\n        // Chercher le path existant\r\n        const existingPath = cm.svgConnections.querySelector(`[data-connection-id=\"${conn.id}\"]`);\r\n\r\n        if (existingPath) {\r\n            // Path existe ‚Üí juste mettre √† jour l'attribut d (pas de flicker)\r\n            existingPath.setAttribute('d', newD);\r\n        } else {\r\n            // Path n'existe pas ‚Üí le cr√©er\r\n            renderConnection(cm, conn);\r\n        }\r\n    }\r\n}\r\n\r\n// Cache des dimensions des nodes pour √©viter les reflows pendant le drag\r\nconst nodeSizeCache = new Map<string, { width: number; height: number }>();\r\n\r\n/**\r\n * Invalide le cache de dimensions d'un node (appeler apr√®s resize/cr√©ation/suppression)\r\n */\r\nexport function invalidateNodeSizeCache(nodeId?: string): void {\r\n    if (nodeId) {\r\n        nodeSizeCache.delete(nodeId);\r\n    } else {\r\n        nodeSizeCache.clear();\r\n    }\r\n}\r\n\r\n/**\r\n * Calcule le path SVG en courbe B√©zier entre deux points\r\n * Curvature verticale proportionnelle √† la distance Y (max 80px)\r\n */\r\nfunction calculatePathD(from: { x: number; y: number }, to: { x: number; y: number }): string {\r\n    const dy = to.y - from.y;\r\n    const curvature = Math.min(Math.abs(dy) * 0.4, 80);\r\n    const cx1 = from.x;\r\n    const cy1 = from.y + curvature;\r\n    const cx2 = to.x;\r\n    const cy2 = to.y - curvature;\r\n    return `M ${from.x} ${from.y} C ${cx1} ${cy1}, ${cx2} ${cy2}, ${to.x} ${to.y}`;\r\n}\r\n\r\n/**\r\n * Calcule le centre d'un node\r\n * Utilise un cache de dimensions pour √©viter les lectures offsetWidth/offsetHeight\r\n * qui forcent un reflow synchrone du navigateur √† chaque appel.\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {Object} node - Node dont on veut le centre\r\n * @returns {{x: number, y: number}}\r\n */\r\nexport function getNodeCenter(cm: any, node: KairosNode): { x: number; y: number } {\r\n    // V√©rification stricte des coordonn√©es depuis le state\r\n    const x = typeof node.x === 'number' && !isNaN(node.x) ? node.x : 0;\r\n    const y = typeof node.y === 'number' && !isNaN(node.y) ? node.y : 0;\r\n\r\n    let width = cm.NODE_WIDTH; // Fallback: 300\r\n    let height = cm.NODE_HEIGHT; // Fallback: 120\r\n\r\n    // Utiliser le cache si disponible\r\n    const cached = nodeSizeCache.get(node.id);\r\n    if (cached) {\r\n        width = cached.width;\r\n        height = cached.height;\r\n    } else {\r\n        // Lire les dimensions depuis le DOM (co√ªteux ‚Äî force reflow)\r\n        const element = document.getElementById(node.id);\r\n        if (element) {\r\n            width = element.offsetWidth || width;\r\n            height = element.offsetHeight || height;\r\n            nodeSizeCache.set(node.id, { width, height });\r\n        }\r\n    }\r\n\r\n    return {\r\n        x: x + width / 2,\r\n        y: y + height / 2,\r\n    };\r\n}\r\n\r\n/**\r\n * Rend une connexion individuelle (cr√©e les √©l√©ments SVG)\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {Object} connection - Connexion √† rendre\r\n */\r\nexport function renderConnection(cm: any, connection: KairosConnection): void {\r\n    const nodeMap = ensureNodeMap(cm);\r\n    const fromNode = nodeMap.get(connection.from);\r\n    const toNode = nodeMap.get(connection.to);\r\n\r\n    if (!fromNode || !toNode) {\r\n        console.warn('renderConnection: node non trouv√©', {\r\n            from: connection.from,\r\n            to: connection.to,\r\n            fromNode,\r\n            toNode,\r\n        });\r\n        return;\r\n    }\r\n\r\n    // Calculer les centres directement depuis le state (source de v√©rit√© unique)\r\n    const fromCenter = getNodeCenter(cm, fromNode);\r\n    const toCenter = getNodeCenter(cm, toNode);\r\n\r\n    const pathD = calculatePathD(fromCenter, toCenter);\r\n\r\n    // V√©rifier si la connexion implique des vignettes synth√©tis√©es\r\n    const isArchived = fromNode.synthesized || toNode.synthesized;\r\n\r\n    // Cr√©er une hitbox invisible plus large pour faciliter les clics\r\n    const hitbox = document.createElementNS('http://www.w3.org/2000/svg', 'path');\r\n    hitbox.classList.add('connection-hitbox');\r\n    if (isArchived) hitbox.classList.add('connection-archived');\r\n    hitbox.setAttribute('data-connection-id', `hitbox-${connection.id}`);\r\n    hitbox.setAttribute('d', pathD);\r\n\r\n    // Cr√©er le path visible\r\n    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');\r\n    path.classList.add('connection-line', `connection-${connection.type}`);\r\n    if (isArchived) path.classList.add('connection-archived');\r\n    path.setAttribute('data-connection-id', connection.id);\r\n    path.setAttribute('d', pathD);\r\n\r\n    // Gradient stroke + glow subtil\r\n    if (connection.type === 'implies') {\r\n        path.setAttribute('stroke', 'url(#grad-implies)');\r\n    } else if (connection.type === 'resonance') {\r\n        path.setAttribute('stroke', 'url(#grad-resonance)');\r\n    }\r\n    path.setAttribute('filter', 'url(#connection-glow)');\r\n\r\n    // Ajouter l'infobulle avec le m√©canisme si pr√©sent\r\n    if (connection.mechanism) {\r\n        const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');\r\n        title.textContent = connection.mechanism;\r\n        path.appendChild(title);\r\n        // Aussi sur la hitbox pour affichage m√™me sur zone large\r\n        const hitboxTitle = document.createElementNS('http://www.w3.org/2000/svg', 'title');\r\n        hitboxTitle.textContent = connection.mechanism;\r\n        hitbox.appendChild(hitboxTitle);\r\n    }\r\n\r\n    // Ajouter le marker appropri√©\r\n    const markerMap: Record<string, string> = {\r\n        implies: 'arrow-implies',\r\n        tension: 'arrow-tension',\r\n        resonance: 'arrow-resonance',\r\n        hypothesis: '',\r\n        opposition: 'arrow-tension',\r\n    };\r\n\r\n    if (markerMap[connection.type]) {\r\n        path.setAttribute('marker-end', `url(#${markerMap[connection.type]})`);\r\n    }\r\n\r\n    // √âv√©nement sur la hitbox pour afficher le menu contextuel\r\n    hitbox.addEventListener('click', (e: MouseEvent) => {\r\n        e.stopPropagation();\r\n        cm.showConnectionContextMenu(connection, e.clientX, e.clientY);\r\n    });\r\n    hitbox.addEventListener('mouseenter', () => {\r\n        path.classList.add('hovered');\r\n    });\r\n    hitbox.addEventListener('mouseleave', () => {\r\n        path.classList.remove('hovered');\r\n    });\r\n\r\n    // √âv√©nement aussi sur le path visible (redondance pour fiabilit√©)\r\n    path.addEventListener('click', (e: MouseEvent) => {\r\n        e.stopPropagation();\r\n        cm.showConnectionContextMenu(connection, e.clientX, e.clientY);\r\n    });\r\n\r\n    cm.svgConnections.appendChild(hitbox);\r\n    cm.svgConnections.appendChild(path);\r\n}\r\n","/**\r\n * Persistence - S√©rialisation et chargement des donn√©es du canvas\r\n *\r\n * Responsabilit√© : Convertir l'√©tat du canvas en objet s√©rialisable (getData),\r\n * restaurer l'√©tat depuis des donn√©es sauvegard√©es (loadData), et r√©initialiser\r\n * le canvas (clear).\r\n *\r\n * D√©pendances :\r\n * - canvasManager : instance de CanvasManager pour acc√©der √† state, DOM, et m√©thodes de rendu\r\n *\r\n * Format de donn√©es (version 2) :\r\n * - vignettes : tableau des nodes\r\n * - connections : tableau des connexions\r\n * - zoom, panX, panY : √©tat du viewport\r\n * - mode : mode actuel ('explorer', etc.)\r\n *\r\n * @exports getData, loadData, clearCanvas\r\n */\r\n\r\nimport type { KairosNode, CanvasData } from '../types/kairos.js';\r\nimport { invalidateNodeSizeCache } from './connections.js';\r\nimport { validateCanvasState } from './validation.js';\r\n\r\n/**\r\n * S√©rialise l'√©tat actuel du canvas\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @returns {Object} Donn√©es s√©rialisables\r\n */\r\nexport function getData(cm: any): CanvasData {\r\n    return {\r\n        version: 2, // Version du format de donn√©es\r\n        vignettes: cm.state.nodes, // Vignettes (id√©es individuelles)\r\n        // D√âSACTIV√â: poles: cm.state.poles, // Les p√¥les (conteneurs)\r\n        connections: cm.state.connections,\r\n        zoom: cm.state.zoom,\r\n        panX: cm.state.panX,\r\n        panY: cm.state.panY,\r\n        mode: cm.state.mode,\r\n    };\r\n}\r\n\r\n/**\r\n * Charge des donn√©es dans le canvas\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {Object} data - Donn√©es √† charger\r\n */\r\nexport function loadData(cm: any, data: CanvasData): void {\r\n    // CRITIQUE: Effacer tous les √©l√©ments existants du DOM avant de charger\r\n    cm.polesContainer.innerHTML = '';\r\n    // Effacer aussi les connexions SVG\r\n    const existingPaths: NodeListOf<Element> = cm.svgConnections.querySelectorAll('.connection-line');\r\n    existingPaths.forEach((path: Element) => path.remove());\r\n\r\n    // D√âSACTIV√â: Chargement des p√¥les-conteneurs\r\n    /*\r\n  if (\r\n    data.poles &&\r\n    Array.isArray(data.poles) &&\r\n    data.poles.length > 0 &&\r\n    data.poles[0].width\r\n  ) {\r\n    cm.state.poles = data.poles;\r\n    cm.state.poles.forEach((pole) => cm.renderPole(pole));\r\n  } else {\r\n    cm.state.poles = [];\r\n  }\r\n  */\r\n    cm.state.poles = []; // Tableau vide, fonctionnalit√© d√©sactiv√©e\r\n\r\n    // Charger les vignettes\r\n    let rawNodes: KairosNode[];\r\n    if (data.vignettes) {\r\n        // Nouveau format v2\r\n        rawNodes = data.vignettes;\r\n    } else if (\r\n        (data as any).poles &&\r\n        Array.isArray((data as any).poles) &&\r\n        (data as any).poles.length > 0 &&\r\n        !(data as any).poles[0].width\r\n    ) {\r\n        // Ancien format: poles = vignettes (compatibilit√©)\r\n        rawNodes = (data as any).poles;\r\n    } else {\r\n        rawNodes = [];\r\n    }\r\n    const rawConnections = data.connections || [];\r\n\r\n    // Valider et r√©parer l'int√©grit√© des donn√©es charg√©es\r\n    const validation = validateCanvasState(rawNodes, rawConnections, { repair: true });\r\n    if (!validation.valid) {\r\n        console.warn(`[loadData] Donn√©es r√©par√©es : ${validation.errors.length} erreur(s), ${validation.warnings.length} warning(s)`);\r\n        for (const issue of validation.errors) {\r\n            console.warn(`  [${issue.code}] ${issue.message}`);\r\n        }\r\n    }\r\n    cm.state.nodes = validation.repaired?.nodes ?? rawNodes;\r\n    cm.state.connections = validation.repaired?.connections ?? rawConnections;\r\n\r\n    // Mettre √† jour le compteur d'ID pour √©viter les collisions avec les IDs existants\r\n    cm.nodeIdCounter = cm.state.nodes.length;\r\n\r\n    // Invalider les caches apr√®s chargement\r\n    cm._nodeMapDirty = true;\r\n    invalidateNodeSizeCache();\r\n\r\n    cm.state.nodes.forEach((node: KairosNode) => cm.renderNode(node));\r\n    if (data.zoom != null) cm.state.zoom = data.zoom;\r\n    if (data.panX != null) cm.state.panX = data.panX;\r\n    if (data.panY != null) cm.state.panY = data.panY;\r\n    if (data.mode) cm.state.mode = data.mode;\r\n\r\n    // Appliquer la transformation\r\n    cm.applyTransform();\r\n\r\n    // Rendu des connexions apr√®s que le DOM soit stable\r\n    // (les nodes viennent d'√™tre rendus, il faut attendre leurs dimensions)\r\n    cm.forceRefreshConnections();\r\n\r\n    console.log('Donn√©es charg√©es:', data);\r\n}\r\n\r\n/**\r\n * R√©initialise compl√®tement le canvas\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function clearCanvas(cm: any): void {\r\n    // Fermer le modal d'√©dition s'il est ouvert\r\n    if (cm.editModal && cm.editModal.style.display === 'block') {\r\n        cm.interaction.isNewNodeBeingEdited = false; // Ne pas tenter de supprimer\r\n        cm.hideEditModal();\r\n    }\r\n\r\n    // R√©initialiser l'√©tat d'interaction\r\n    cm.interaction.selectedNodeForMenu = null;\r\n    cm.interaction.selectedNodes.clear();\r\n    cm.interaction.connectionMode = false;\r\n    cm.interaction.connectionFromNode = null;\r\n\r\n    cm.state.nodes = [];\r\n    cm.state.poles = []; // Gard√© pour compatibilit√©\r\n    cm.state.connections = [];\r\n    cm._nodeMapDirty = true;\r\n    invalidateNodeSizeCache();\r\n    cm.polesContainer.innerHTML = '';\r\n    cm.renderAllConnections();\r\n\r\n    // WORKAROUND ELECTRON: Reset focus apr√®s clear\r\n    if (document.activeElement) {\r\n        (document.activeElement as HTMLElement).blur();\r\n    }\r\n    window.focus();\r\n\r\n    if (cm.minimap) {\r\n        cm.minimap.update();\r\n    }\r\n}\r\n","/**\r\n * Filters - Filtrage des vignettes par statut\r\n *\r\n * Responsabilit√© : G√©rer la visibilit√© des vignettes et connexions\r\n * selon les filtres de statut actifs (neutral, priority).\r\n *\r\n * D√©pendances :\r\n * - canvasManager.state.statusFilters : Set des statuts visibles\r\n * - canvasManager.state.nodes : tableau des vignettes\r\n * - canvasManager.state.connections : tableau des connexions\r\n * - canvasManager.svgConnections : √©l√©ment SVG des connexions\r\n *\r\n * @exports toggleStatusFilter, applyFilters, updateConnectionsVisibility\r\n */\r\n\r\n/**\r\n * Active/d√©sactive un filtre de statut\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {string} status - 'all', 'neutral', ou 'priority'\r\n */\r\nexport function toggleStatusFilter(cm: any, status: string): void {\r\n    if (status === 'all') {\r\n        // Si on clique sur \"Tous\", activer/d√©sactiver tous les statuts\r\n        if (cm.state.statusFilters.size === 2) {\r\n            // Tous actifs ‚Üí tout d√©sactiver\r\n            cm.state.statusFilters.clear();\r\n        } else {\r\n            // Pas tous actifs ‚Üí tout activer\r\n            cm.state.statusFilters = new Set(['neutral', 'priority']);\r\n        }\r\n    } else {\r\n        // Toggle un statut sp√©cifique\r\n        if (cm.state.statusFilters.has(status)) {\r\n            cm.state.statusFilters.delete(status);\r\n        } else {\r\n            cm.state.statusFilters.add(status);\r\n        }\r\n    }\r\n\r\n    applyFilters(cm);\r\n}\r\n\r\n/**\r\n * Applique les filtres actuels aux vignettes\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function applyFilters(cm: any): void {\r\n    cm.state.nodes.forEach((node: any) => {\r\n        const nodeDiv = document.getElementById(node.id);\r\n        if (!nodeDiv) return;\r\n\r\n        const isVisible = cm.state.statusFilters.has(node.status);\r\n\r\n        if (isVisible) {\r\n            nodeDiv.classList.remove('filtered');\r\n        } else {\r\n            nodeDiv.classList.add('filtered');\r\n        }\r\n    });\r\n\r\n    // Mettre √† jour les connexions (cacher celles o√π les deux nodes sont invisibles)\r\n    updateConnectionsVisibility(cm);\r\n}\r\n\r\n/**\r\n * Met √† jour la visibilit√© des connexions selon les filtres\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function updateConnectionsVisibility(cm: any): void {\r\n    cm.state.connections.forEach((conn: any) => {\r\n        const fromNode = cm.state.nodes.find((n: any) => n.id === conn.from);\r\n        const toNode = cm.state.nodes.find((n: any) => n.id === conn.to);\r\n\r\n        const path = cm.svgConnections.querySelector(`[data-connection-id=\"${conn.id}\"]`);\r\n        if (!path) return;\r\n\r\n        const isFromVisible = fromNode && cm.state.statusFilters.has(fromNode.status);\r\n        const isToVisible = toNode && cm.state.statusFilters.has(toNode.status);\r\n\r\n        // Cacher la connexion si un des deux nodes est invisible\r\n        if (isFromVisible && isToVisible) {\r\n            path.style.display = '';\r\n        } else {\r\n            path.style.display = 'none';\r\n        }\r\n    });\r\n}\r\n","/**\r\n * SpatialGrid - Index spatial pour collisions O(1)\r\n *\r\n * Responsabilit√© : Divise le canvas en cellules pour acc√©l√©rer les lookups\r\n * de collision. Remplace les scans lin√©aires O(n) par des queries O(k)\r\n * o√π k = nombre de nodes dans les cellules voisines (typiquement < 5).\r\n *\r\n * Utilisation :\r\n *   const grid = new SpatialGrid(cellWidth, cellHeight);\r\n *   grid.build(nodes);\r\n *   const nearby = grid.queryRect(x, y, w, h);\r\n *\r\n * @exports SpatialGrid\r\n */\r\n\r\ninterface GridNode {\r\n    id: string;\r\n    x: number;\r\n    y: number;\r\n}\r\n\r\nexport class SpatialGrid {\r\n    private cellW: number;\r\n    private cellH: number;\r\n    private grid: Map<string, Set<string>> = new Map();\r\n    private nodePositions: Map<string, { x: number; y: number }> = new Map();\r\n\r\n    /**\r\n     * @param {number} cellWidth - Largeur d'une cellule (typiquement NODE_WIDTH + COLLISION_MARGIN)\r\n     * @param {number} cellHeight - Hauteur d'une cellule (typiquement NODE_HEIGHT + COLLISION_MARGIN)\r\n     */\r\n    constructor(cellWidth: number, cellHeight: number) {\r\n        this.cellW = cellWidth;\r\n        this.cellH = cellHeight;\r\n    }\r\n\r\n    /** Cl√© de cellule pour une position donn√©e */\r\n    private key(cx: number, cy: number): string {\r\n        return `${cx},${cy}`;\r\n    }\r\n\r\n    /** Coordonn√©es de cellule pour une position en pixels */\r\n    private cellCoords(x: number, y: number): [number, number] {\r\n        return [Math.floor(x / this.cellW), Math.floor(y / this.cellH)];\r\n    }\r\n\r\n    /** Construit la grille √† partir d'un tableau de nodes */\r\n    build(nodes: GridNode[]): void {\r\n        this.grid.clear();\r\n        this.nodePositions.clear();\r\n        for (const node of nodes) {\r\n            this.insert(node.id, node.x, node.y);\r\n        }\r\n    }\r\n\r\n    /** Ins√®re un node dans la grille */\r\n    insert(id: string, x: number, y: number): void {\r\n        const [cx, cy] = this.cellCoords(x, y);\r\n        const k = this.key(cx, cy);\r\n        if (!this.grid.has(k)) {\r\n            this.grid.set(k, new Set());\r\n        }\r\n        this.grid.get(k)!.add(id);\r\n        this.nodePositions.set(id, { x, y });\r\n    }\r\n\r\n    /** Retire un node de la grille */\r\n    remove(id: string): void {\r\n        const pos = this.nodePositions.get(id);\r\n        if (!pos) return;\r\n        const [cx, cy] = this.cellCoords(pos.x, pos.y);\r\n        const k = this.key(cx, cy);\r\n        const cell = this.grid.get(k);\r\n        if (cell) {\r\n            cell.delete(id);\r\n            if (cell.size === 0) this.grid.delete(k);\r\n        }\r\n        this.nodePositions.delete(id);\r\n    }\r\n\r\n    /** Met √† jour la position d'un node */\r\n    update(id: string, x: number, y: number): void {\r\n        this.remove(id);\r\n        this.insert(id, x, y);\r\n    }\r\n\r\n    /**\r\n     * Retourne les IDs des nodes dans les cellules qui chevauchent le rectangle donn√©.\r\n     * C'est un superset des collisions r√©elles ‚Äî un test AABB fin reste n√©cessaire.\r\n     */\r\n    queryRect(x: number, y: number, w: number, h: number): Set<string> {\r\n        const result = new Set<string>();\r\n        const [cx1, cy1] = this.cellCoords(x, y);\r\n        const [cx2, cy2] = this.cellCoords(x + w, y + h);\r\n\r\n        // Parcourir toutes les cellules couvertes + une marge de 1 cellule\r\n        for (let cx = cx1 - 1; cx <= cx2 + 1; cx++) {\r\n            for (let cy = cy1 - 1; cy <= cy2 + 1; cy++) {\r\n                const cell = this.grid.get(this.key(cx, cy));\r\n                if (cell) {\r\n                    for (const id of cell) {\r\n                        result.add(id);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        return result;\r\n    }\r\n\r\n    /** Nombre total de nodes index√©s */\r\n    get size(): number {\r\n        return this.nodePositions.size;\r\n    }\r\n}\r\n","/**\r\n * Layout - Positionnement automatique des vignettes\r\n *\r\n * Responsabilit√© : Calculer les positions des vignettes pour √©viter\r\n * les chevauchements, trouver des positions libres, et g√©rer le\r\n * positionnement lors des imports.\r\n *\r\n * D√©pendances :\r\n * - canvasManager.state.nodes : tableau des vignettes\r\n * - canvasManager.state.zoom, panX, panY : √©tat du viewport\r\n * - canvasManager.canvasArea : √©l√©ment DOM de la zone canvas\r\n * - canvasManager.NODE_WIDTH, NODE_HEIGHT, COLLISION_MARGIN : constantes\r\n *\r\n * @exports checkCollision, isPositionFree, findFreePosition, getVisibleBottomPosition,\r\n *          adjustPositionForCollisions, getSmartImportPosition, relocateSynthesizedNodes,\r\n *          animateNodesToPositions\r\n */\r\n\r\nimport { SpatialGrid } from './spatial-grid.js';\r\n\r\n// Constantes export√©es pour usage externe si n√©cessaire\r\nexport const NODE_WIDTH: number = 300;\r\nexport const NODE_HEIGHT: number = 120;\r\nexport const COLLISION_MARGIN: number = 20;\r\n\r\n/**\r\n * V√©rifie si deux rectangles se chevauchent\r\n * @param {number} x1, y1, w1, h1 - Premier rectangle\r\n * @param {number} x2, y2, w2, h2 - Second rectangle\r\n * @returns {boolean}\r\n */\r\nexport function checkCollision(\r\n    x1: number,\r\n    y1: number,\r\n    w1: number,\r\n    h1: number,\r\n    x2: number,\r\n    y2: number,\r\n    w2: number,\r\n    h2: number,\r\n): boolean {\r\n    return !(x1 + w1 < x2 || x2 + w2 < x1 || y1 + h1 < y2 || y2 + h2 < y1);\r\n}\r\n\r\n/**\r\n * V√©rifie si une position est libre (pas de collision avec les nodes existants)\r\n * Utilise le SpatialGrid si disponible (O(k) vs O(n))\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {number} x - Position X\r\n * @param {number} y - Position Y\r\n * @param {SpatialGrid} [grid] - Index spatial optionnel pour lookups rapides\r\n * @returns {boolean}\r\n */\r\nexport function isPositionFree(cm: any, x: number, y: number, grid?: SpatialGrid): boolean {\r\n    const width = cm.NODE_WIDTH + cm.COLLISION_MARGIN;\r\n    const height = cm.NODE_HEIGHT + cm.COLLISION_MARGIN;\r\n\r\n    if (grid) {\r\n        // Lookup spatial O(k) ‚Äî ne v√©rifier que les voisins\r\n        const candidates = grid.queryRect(x, y, width, height);\r\n        for (const id of candidates) {\r\n            const node = cm.state.nodes.find((n: any) => n.id === id);\r\n            if (node && checkCollision(x, y, width, height, node.x, node.y, width, height)) {\r\n                return false;\r\n            }\r\n        }\r\n        return true;\r\n    }\r\n\r\n    // Fallback lin√©aire O(n)\r\n    for (const node of cm.state.nodes) {\r\n        if (checkCollision(x, y, width, height, node.x, node.y, width, height)) {\r\n            return false;\r\n        }\r\n    }\r\n    return true;\r\n}\r\n\r\n/**\r\n * Trouve une position libre proche de (x, y) en utilisant une recherche en spirale\r\n * Construit un SpatialGrid automatiquement quand > 50 nodes (optimise les imports massifs)\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {number} startX - Position X de d√©part\r\n * @param {number} startY - Position Y de d√©part\r\n * @returns {{x: number, y: number}}\r\n */\r\nexport function findFreePosition(cm: any, startX: number, startY: number): { x: number; y: number } {\r\n    // Construire un index spatial pour les gros canvas (> 50 nodes)\r\n    const grid = cm.state.nodes.length > 50 ? buildSpatialGrid(cm) : undefined;\r\n\r\n    // Si la position initiale est libre, l'utiliser\r\n    if (isPositionFree(cm, startX, startY, grid)) {\r\n        return { x: startX, y: startY };\r\n    }\r\n\r\n    // Sinon, chercher en spirale\r\n    const step = 50; // Distance entre chaque tentative\r\n    const maxAttempts = 100; // Limite de s√©curit√©\r\n\r\n    for (let attempt = 1; attempt < maxAttempts; attempt++) {\r\n        // Calculer le rayon de la spirale\r\n        const radius = attempt * step;\r\n\r\n        // Essayer 8 positions autour du point central\r\n        const angles = [0, 45, 90, 135, 180, 225, 270, 315];\r\n\r\n        for (const angle of angles) {\r\n            const rad = (angle * Math.PI) / 180;\r\n            const x = Math.round(startX + radius * Math.cos(rad));\r\n            const y = Math.round(startY + radius * Math.sin(rad));\r\n\r\n            if (isPositionFree(cm, x, y, grid)) {\r\n                return { x, y };\r\n            }\r\n        }\r\n    }\r\n\r\n    // Si aucune position libre n'est trouv√©e, utiliser la position initiale\r\n    // (cas extr√™me peu probable)\r\n    return { x: startX, y: startY };\r\n}\r\n\r\n/**\r\n * Construit un SpatialGrid √† partir des nodes du canvas\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function buildSpatialGrid(cm: any): SpatialGrid {\r\n    const grid = new SpatialGrid(cm.NODE_WIDTH + cm.COLLISION_MARGIN, cm.NODE_HEIGHT + cm.COLLISION_MARGIN);\r\n    grid.build(cm.state.nodes);\r\n    return grid;\r\n}\r\n\r\n/**\r\n * Calcule une position en bas de l'√©cran visible pour les imports\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {number} index - Index de la vignette (pour disposition en grille)\r\n * @param {number} total - Nombre total de vignettes √† importer\r\n * @returns {{x: number, y: number}}\r\n */\r\nexport function getVisibleBottomPosition(cm: any, index: number = 0, total: number = 1): { x: number; y: number } {\r\n    const zoom = cm.state.zoom || 1;\r\n    const panX = cm.state.panX || 0;\r\n    const panY = cm.state.panY || 0;\r\n    const containerRect = cm.canvasArea.getBoundingClientRect();\r\n\r\n    // Dimensions d'une vignette\r\n    const nodeWidth = 280;\r\n    const nodeHeight = 120;\r\n    const margin = 30;\r\n\r\n    // Calculer la position visible en coordonn√©es canvas\r\n    // Le bas de l'√©cran visible en coordonn√©es canvas\r\n    const visibleBottom = (-panY + containerRect.height - nodeHeight - margin * 2) / zoom;\r\n    const visibleLeft = (-panX + margin) / zoom;\r\n    const visibleWidth = containerRect.width / zoom;\r\n\r\n    // Disposition en grille horizontale centr√©e\r\n    const cols = Math.min(total, Math.floor(visibleWidth / (nodeWidth + margin)));\r\n    const startX = visibleLeft + (visibleWidth - cols * (nodeWidth + margin)) / 2;\r\n\r\n    const col = index % cols;\r\n    const row = Math.floor(index / cols);\r\n\r\n    const x = startX + col * (nodeWidth + margin);\r\n    const y = visibleBottom - row * (nodeHeight + margin);\r\n\r\n    return { x: Math.round(x), y: Math.round(y) };\r\n}\r\n\r\n/**\r\n * Ajuste une position pour √©viter les collisions avec les autres nodes\r\n * Utilise le SpatialGrid quand > 50 nodes\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {number} x - Position X\r\n * @param {number} y - Position Y\r\n * @param {string} excludeNodeId - ID du node √† exclure (celui en cours de drag)\r\n * @returns {{x: number, y: number}}\r\n */\r\nexport function adjustPositionForCollisions(\r\n    cm: any,\r\n    x: number,\r\n    y: number,\r\n    excludeNodeId: string,\r\n): { x: number; y: number } {\r\n    const width = cm.NODE_WIDTH;\r\n    const height = cm.NODE_HEIGHT;\r\n    const pushDistance = 10; // Distance de \"pouss√©e\" √† chaque it√©ration\r\n\r\n    // Construire un index spatial pour les gros canvas\r\n    const grid = cm.state.nodes.length > 50 ? buildSpatialGrid(cm) : undefined;\r\n\r\n    let adjustedX = x;\r\n    let adjustedY = y;\r\n    let hasCollision = true;\r\n    const maxIterations = 20; // Limite pour √©viter les boucles infinies\r\n    let iterations = 0;\r\n\r\n    while (hasCollision && iterations < maxIterations) {\r\n        hasCollision = false;\r\n        iterations++;\r\n\r\n        // D√©terminer les candidats (spatial ou tous)\r\n        const candidates = grid\r\n            ? [...grid.queryRect(adjustedX, adjustedY, width, height)]\r\n                  .map((id) => cm.state.nodes.find((n: any) => n.id === id))\r\n                  .filter(Boolean)\r\n            : cm.state.nodes;\r\n\r\n        for (const node of candidates) {\r\n            // Ignorer le node en cours de drag\r\n            if (node.id === excludeNodeId) continue;\r\n\r\n            // V√©rifier la collision\r\n            if (checkCollision(adjustedX, adjustedY, width, height, node.x, node.y, width, height)) {\r\n                hasCollision = true;\r\n\r\n                // Calculer le vecteur de r√©pulsion\r\n                const centerX1 = adjustedX + width / 2;\r\n                const centerY1 = adjustedY + height / 2;\r\n                const centerX2 = node.x + width / 2;\r\n                const centerY2 = node.y + height / 2;\r\n\r\n                const deltaX = centerX1 - centerX2;\r\n                const deltaY = centerY1 - centerY2;\r\n                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);\r\n\r\n                // √âviter la division par z√©ro\r\n                if (distance < 1) {\r\n                    adjustedX += pushDistance;\r\n                    continue;\r\n                }\r\n\r\n                // Normaliser et pousser dans la direction oppos√©e\r\n                const pushX = (deltaX / distance) * pushDistance;\r\n                const pushY = (deltaY / distance) * pushDistance;\r\n\r\n                adjustedX += pushX;\r\n                adjustedY += pushY;\r\n            }\r\n        }\r\n    }\r\n\r\n    return { x: Math.round(adjustedX), y: Math.round(adjustedY) };\r\n}\r\n\r\n/**\r\n * Calcule une position intelligente pour une vignette import√©e par le LLM,\r\n * en la pla√ßant pr√®s de sa cible de connexion existante.\r\n * Fallback vers getVisibleBottomPosition si pas de cible.\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {string | null} connectionTargetId - ID du n≈ìud cible (si connu)\r\n * @param {number} index - Index dans le batch d'import\r\n * @param {number} total - Nombre total de vignettes dans le batch\r\n * @returns {{x: number, y: number}}\r\n */\r\nexport function getSmartImportPosition(\r\n    cm: any,\r\n    connectionTargetId: string | null,\r\n    index: number,\r\n    total: number,\r\n): { x: number; y: number } {\r\n    // Si on a une cible de connexion, placer pr√®s d'elle\r\n    if (connectionTargetId) {\r\n        const targetNode = cm.state.nodes.find((n: any) => n.id === connectionTargetId);\r\n        if (targetNode) {\r\n            // Offset bas-droite par rapport √† la cible, d√©cal√© par index pour √©viter l'empilement\r\n            const offsetX = 80 + (index % 2) * (NODE_WIDTH + COLLISION_MARGIN);\r\n            const offsetY = NODE_HEIGHT + 60 + Math.floor(index / 2) * (NODE_HEIGHT + COLLISION_MARGIN);\r\n            const idealX = targetNode.x + offsetX;\r\n            const idealY = targetNode.y + offsetY;\r\n            return findFreePosition(cm, idealX, idealY);\r\n        }\r\n    }\r\n\r\n    // Fallback : grille au bas du viewport\r\n    return getVisibleBottomPosition(cm, index, total);\r\n}\r\n\r\n// Constantes pour la relocalisation post-synth√®se\r\nconst SYNTHESIS_ZONE_GAP = 200; // Gap entre zone active et zone archiv√©e\r\nconst SYNTHESIS_STACK_GAP = 20; // Gap vertical entre vignettes archiv√©es\r\n\r\n/**\r\n * Relocalise les vignettes synth√©tis√©es en colonne √† droite de la zone active.\r\n * Regroupe TOUS les n≈ìuds synthesized (pas seulement les nouveaux) pour garder\r\n * la colonne compacte.\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {string[]} _newIds - IDs des vignettes nouvellement archiv√©es (pour animation)\r\n */\r\nexport function relocateSynthesizedNodes(cm: any, _newIds: string[]): void {\r\n    const allSynthesized = cm.state.nodes.filter((n: any) => n.synthesized);\r\n    if (allSynthesized.length === 0) return;\r\n\r\n    const activeNodes = cm.state.nodes.filter((n: any) => !n.synthesized);\r\n\r\n    // Bounding box de la zone active\r\n    let activeMaxX = 0;\r\n    let activeMinY = Infinity;\r\n    if (activeNodes.length > 0) {\r\n        for (const n of activeNodes) {\r\n            const right = n.x + NODE_WIDTH;\r\n            if (right > activeMaxX) activeMaxX = right;\r\n            if (n.y < activeMinY) activeMinY = n.y;\r\n        }\r\n    } else {\r\n        activeMinY = 0;\r\n    }\r\n\r\n    // Zone de relocalisation : colonne √† droite\r\n    const startX = activeMaxX + SYNTHESIS_ZONE_GAP;\r\n    const baseY = activeMinY;\r\n\r\n    // Calculer les nouvelles positions\r\n    const newPositions = new Map<string, { x: number; y: number }>();\r\n    allSynthesized.forEach((node: any, i: number) => {\r\n        newPositions.set(node.id, {\r\n            x: startX,\r\n            y: baseY + i * (NODE_HEIGHT + SYNTHESIS_STACK_GAP),\r\n        });\r\n    });\r\n\r\n    // Animer vers les nouvelles positions\r\n    animateNodesToPositions(cm, newPositions, 400);\r\n}\r\n\r\n/**\r\n * Anime les n≈ìuds vers de nouvelles positions avec transition CSS.\r\n * Met √† jour node.x/y dans le mod√®le de donn√©es, anime le DOM,\r\n * et synchronise les connexions SVG via requestAnimationFrame.\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {Map<string, {x: number, y: number}>} newPositions - Nouvelles positions par nodeId\r\n * @param {number} durationMs - Dur√©e de l'animation (d√©faut 500ms)\r\n * @param {Function} [onComplete] - Callback apr√®s animation\r\n */\r\nexport function animateNodesToPositions(\r\n    cm: any,\r\n    newPositions: Map<string, { x: number; y: number }>,\r\n    durationMs: number = 500,\r\n    onComplete?: () => void,\r\n): void {\r\n    const elements: HTMLElement[] = [];\r\n\r\n    // Appliquer les nouvelles positions (la transition CSS anime le mouvement)\r\n    for (const [nodeId, pos] of newPositions) {\r\n        const node = cm.state.nodes.find((n: any) => n.id === nodeId);\r\n        if (!node) continue;\r\n\r\n        node.x = Math.round(pos.x);\r\n        node.y = Math.round(pos.y);\r\n\r\n        const el = document.getElementById(nodeId);\r\n        if (el) {\r\n            el.classList.add('layout-animating');\r\n            elements.push(el);\r\n            el.style.left = `${node.x}px`;\r\n            el.style.top = `${node.y}px`;\r\n        }\r\n    }\r\n\r\n    // Synchroniser les connexions SVG pendant l'animation\r\n    let rafId: number;\r\n    const animateConnections = () => {\r\n        cm.renderAllConnections();\r\n        rafId = requestAnimationFrame(animateConnections);\r\n    };\r\n    rafId = requestAnimationFrame(animateConnections);\r\n\r\n    // Nettoyage apr√®s animation\r\n    setTimeout(() => {\r\n        cancelAnimationFrame(rafId);\r\n        elements.forEach((el) => el.classList.remove('layout-animating'));\r\n        cm.renderAllConnections();\r\n        if (cm.minimap) cm.minimap.update();\r\n        cm._nodeMapDirty = true;\r\n        onComplete?.();\r\n    }, durationMs + 50);\r\n}\r\n","/**\r\n * Collisions - D√©tection et r√©solution des chevauchements entre vignettes\r\n *\r\n * Responsabilit√© : D√©tecter les vignettes qui se chevauchent\r\n * et les r√©soudre automatiquement.\r\n *\r\n * Utilise SpatialGrid pour O(n) au lieu de O(n¬≤) quand > 50 nodes.\r\n *\r\n * D√©pendances :\r\n * - canvasManager.state.nodes : tableau des vignettes\r\n * - canvasManager.NODE_WIDTH, NODE_HEIGHT : dimensions des vignettes\r\n * - canvasManager.checkCollision() : test de collision rectangulaire\r\n * - canvasManager.findFreePosition() : recherche de position libre\r\n * - canvasManager.updateNodeElement() : mise √† jour du DOM\r\n *\r\n * @exports detectCollisions, resolveAllCollisions\r\n */\r\n\r\nimport { createLogger } from '../logger.js';\r\nimport { buildSpatialGrid } from './layout.js';\r\n\r\nconst log = createLogger('Collisions');\r\n\r\n/**\r\n * D√©tecte toutes les collisions entre vignettes\r\n * Utilise SpatialGrid quand > 50 nodes pour √©viter O(n¬≤)\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @returns {Array<{node1: Object, node2: Object}>} Liste des paires en collision\r\n */\r\nexport function detectCollisions(cm: any): Array<{ node1: any; node2: any }> {\r\n    const collisions: Array<{ node1: any; node2: any }> = [];\r\n    const nodes = cm.state.nodes;\r\n\r\n    // Pour les petits canvas, le scan O(n¬≤) est plus rapide que la construction du grid\r\n    if (nodes.length <= 50) {\r\n        for (let i = 0; i < nodes.length; i++) {\r\n            for (let j = i + 1; j < nodes.length; j++) {\r\n                const n1 = nodes[i];\r\n                const n2 = nodes[j];\r\n                if (\r\n                    cm.checkCollision(\r\n                        n1.x,\r\n                        n1.y,\r\n                        cm.NODE_WIDTH,\r\n                        cm.NODE_HEIGHT,\r\n                        n2.x,\r\n                        n2.y,\r\n                        cm.NODE_WIDTH,\r\n                        cm.NODE_HEIGHT,\r\n                    )\r\n                ) {\r\n                    collisions.push({ node1: n1, node2: n2 });\r\n                }\r\n            }\r\n        }\r\n        return collisions;\r\n    }\r\n\r\n    // Pour les gros canvas : SpatialGrid O(n*k) o√π k = voisins moyens\r\n    const grid = buildSpatialGrid(cm);\r\n    const checked = new Set<string>();\r\n\r\n    for (const n1 of nodes) {\r\n        const nearbyIds = grid.queryRect(n1.x, n1.y, cm.NODE_WIDTH, cm.NODE_HEIGHT);\r\n        for (const id of nearbyIds) {\r\n            if (id === n1.id) continue;\r\n            // √âviter les doublons (A,B) et (B,A)\r\n            const pairKey = n1.id < id ? `${n1.id}|${id}` : `${id}|${n1.id}`;\r\n            if (checked.has(pairKey)) continue;\r\n            checked.add(pairKey);\r\n\r\n            const n2 = nodes.find((n: any) => n.id === id);\r\n            if (\r\n                n2 &&\r\n                cm.checkCollision(n1.x, n1.y, cm.NODE_WIDTH, cm.NODE_HEIGHT, n2.x, n2.y, cm.NODE_WIDTH, cm.NODE_HEIGHT)\r\n            ) {\r\n                collisions.push({ node1: n1, node2: n2 });\r\n            }\r\n        }\r\n    }\r\n\r\n    return collisions;\r\n}\r\n\r\n/**\r\n * R√©sout automatiquement toutes les collisions en d√©pla√ßant les vignettes\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @returns {number} Nombre de vignettes d√©plac√©es\r\n */\r\nexport function resolveAllCollisions(cm: any): number {\r\n    const collisions = detectCollisions(cm);\r\n\r\n    if (collisions.length === 0) {\r\n        log.info('Aucune collision d√©tect√©e');\r\n        return 0;\r\n    }\r\n\r\n    log.info(`${collisions.length} collision(s) d√©tect√©e(s), r√©solution...`);\r\n\r\n    // Pour chaque collision, d√©placer le deuxi√®me node\r\n    const movedNodes = new Set<string>();\r\n\r\n    for (const { node2 } of collisions) {\r\n        // Ne d√©placer node2 que s'il n'a pas d√©j√† √©t√© d√©plac√©\r\n        if (!movedNodes.has(node2.id)) {\r\n            const newPos = cm.findFreePosition(node2.x, node2.y);\r\n            node2.x = newPos.x;\r\n            node2.y = newPos.y;\r\n            cm.updateNodeElement(node2);\r\n            movedNodes.add(node2.id);\r\n            log.debug(`Node ${node2.id} d√©plac√© vers (${newPos.x}, ${newPos.y})`);\r\n        }\r\n    }\r\n\r\n    return movedNodes.size;\r\n}\r\n","/**\r\n * Viewport - Gestion du zoom, pan et navigation dans le canvas\r\n *\r\n * Responsabilit√© : G√©rer les transformations CSS du canvas (zoom, pan),\r\n * la navigation √† la molette, le d√©placement par glisser, et le centrage sur un node.\r\n *\r\n * D√©pendances :\r\n * - canvasManager.state.zoom, panX, panY : √©tat du viewport\r\n * - canvasManager.interaction.isPanning, dragStartX, dragStartY : √©tat du pan\r\n * - canvasManager.polesContainer, svgConnections : √©l√©ments DOM √† transformer\r\n * - DOM element #current-zoom : affichage du niveau de zoom\r\n *\r\n * @exports handleZoom, applyTransform, startPan, updatePan, stopPan, centerOnNode\r\n */\r\n\r\n/**\r\n * G√®re le zoom √† la molette, centr√© sur la position de la souris\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {WheelEvent} e - √âv√©nement wheel\r\n */\r\nexport function handleZoom(cm: any, e: WheelEvent): void {\r\n    const oldZoom = cm.state.zoom;\r\n    const delta = e.deltaY > 0 ? 0.9 : 1.1;\r\n    const newZoom = Math.max(0.1, Math.min(3, oldZoom * delta));\r\n\r\n    // Position de la souris relative au canvas\r\n    const rect = cm.polesContainer.parentElement.getBoundingClientRect();\r\n    const mouseX = e.clientX - rect.left;\r\n    const mouseY = e.clientY - rect.top;\r\n\r\n    // Position de la souris dans l'espace du canvas (avant zoom)\r\n    const canvasX = (mouseX - cm.state.panX) / oldZoom;\r\n    const canvasY = (mouseY - cm.state.panY) / oldZoom;\r\n\r\n    // Ajuster le pan pour que le point sous la souris reste fixe apr√®s le zoom\r\n    cm.state.panX = mouseX - canvasX * newZoom;\r\n    cm.state.panY = mouseY - canvasY * newZoom;\r\n    cm.state.zoom = newZoom;\r\n\r\n    document.getElementById('current-zoom')!.textContent = `${Math.round(cm.state.zoom * 100)}%`;\r\n\r\n    applyTransform(cm);\r\n}\r\n\r\n/**\r\n * Applique la transformation CSS (translate + scale) aux conteneurs\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function applyTransform(cm: any): void {\r\n    const transform = `translate(${cm.state.panX}px, ${cm.state.panY}px) scale(${cm.state.zoom})`;\r\n    cm.polesContainer.style.transform = transform;\r\n    cm.svgConnections.style.transform = transform;\r\n\r\n    // Contre-zoom sur les vignettes au hover : revenir √† la taille naturelle\r\n    const nodeScale = Math.max(1, 1 / cm.state.zoom);\r\n    cm.polesContainer.style.setProperty('--node-scale', String(nodeScale));\r\n}\r\n\r\n/**\r\n * D√©marre le mode pan (glisser le canvas)\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {MouseEvent} e - √âv√©nement mousedown\r\n */\r\nexport function startPan(cm: any, e: MouseEvent): void {\r\n    cm.interaction.isPanning = true;\r\n    cm.interaction.dragStartX = e.clientX - cm.state.panX;\r\n    cm.interaction.dragStartY = e.clientY - cm.state.panY;\r\n\r\n    // Changer le curseur pour tout le container\r\n    cm.polesContainer.style.cursor = 'grabbing';\r\n    document.body.style.cursor = 'grabbing';\r\n}\r\n\r\n/**\r\n * Met √† jour la position pendant le pan\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {MouseEvent} e - √âv√©nement mousemove\r\n */\r\nexport function updatePan(cm: any, e: MouseEvent): void {\r\n    cm.state.panX = e.clientX - cm.interaction.dragStartX;\r\n    cm.state.panY = e.clientY - cm.interaction.dragStartY;\r\n\r\n    applyTransform(cm);\r\n}\r\n\r\n/**\r\n * Arr√™te le mode pan\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function stopPan(cm: any): void {\r\n    if (cm.interaction.panRafId) {\r\n        cancelAnimationFrame(cm.interaction.panRafId);\r\n        cm.interaction.panRafId = null;\r\n    }\r\n    cm.interaction.isPanning = false;\r\n    cm.polesContainer.style.cursor = '';\r\n    document.body.style.cursor = '';\r\n}\r\n\r\n/**\r\n * Centre la vue sur un node avec animation\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {Object} node - Node sur lequel centrer\r\n */\r\nexport function centerOnNode(cm: any, node: { x: number; y: number }): void {\r\n    const rect = cm.polesContainer.parentElement.getBoundingClientRect();\r\n    const centerX = rect.width / 2;\r\n    const centerY = rect.height / 2;\r\n\r\n    cm.state.panX = centerX - node.x * cm.state.zoom;\r\n    cm.state.panY = centerY - node.y * cm.state.zoom;\r\n\r\n    cm.polesContainer.style.transition = 'transform 0.3s ease';\r\n    cm.svgConnections.style.transition = 'transform 0.3s ease';\r\n    applyTransform(cm);\r\n\r\n    setTimeout(() => {\r\n        cm.polesContainer.style.transition = '';\r\n        cm.svgConnections.style.transition = '';\r\n    }, 300);\r\n}\r\n","/**\r\n * Tree Layout - R√©organisation hi√©rarchique du canvas\r\n *\r\n * Responsabilit√© : Algorithme d'arbre top-down bas√© sur les connexions `implies`.\r\n * Sugiyama-style : layering BFS, barycenter crossing minimization, positionnement centr√©.\r\n *\r\n * D√©pendances :\r\n * - canvasManager.state.nodes, canvasManager.state.connections\r\n * - animateNodesToPositions (layout.ts)\r\n * - applyTransform (viewport.ts)\r\n *\r\n * @exports applyTreeLayout, fitViewportToNodes\r\n */\r\n\r\nimport { createLogger } from '../logger.js';\r\nimport { NODE_WIDTH, NODE_HEIGHT, COLLISION_MARGIN, animateNodesToPositions } from './layout.js';\r\nimport { applyTransform } from './viewport.js';\r\n\r\nconst log = createLogger('TreeLayout');\r\n\r\n// Constantes du layout arbre\r\nexport const TREE_LAYER_GAP = 200; // Gap vertical entre couches de profondeur\r\nexport const TREE_NODE_GAP = 350; // Gap horizontal entre n≈ìuds fr√®res\r\nconst TREE_COMPONENT_GAP = 100; // Gap entre composantes d√©connect√©es\r\n\r\ninterface TreeNode {\r\n    id: string;\r\n    children: string[];\r\n    parents: string[];\r\n    depth: number;\r\n    order: number;\r\n}\r\n\r\n/**\r\n * Construit le graphe dirig√© √† partir des connexions `implies` uniquement.\r\n * Les connexions `resonance` sont ignor√©es pour la hi√©rarchie.\r\n */\r\nfunction buildImpliesGraph(\r\n    nodes: any[],\r\n    connections: any[],\r\n): { graph: Map<string, TreeNode>; roots: string[] } {\r\n    const graph = new Map<string, TreeNode>();\r\n\r\n    // Initialiser chaque n≈ìud (exclure les synthesized)\r\n    for (const node of nodes) {\r\n        if (node.synthesized) continue;\r\n        graph.set(node.id, {\r\n            id: node.id,\r\n            children: [],\r\n            parents: [],\r\n            depth: -1,\r\n            order: 0,\r\n        });\r\n    }\r\n\r\n    // Construire les ar√™tes implies\r\n    for (const conn of connections) {\r\n        if (conn.type !== 'implies') continue;\r\n        const parent = graph.get(conn.from);\r\n        const child = graph.get(conn.to);\r\n        if (parent && child) {\r\n            parent.children.push(conn.to);\r\n            child.parents.push(conn.from);\r\n        }\r\n    }\r\n\r\n    // Racines = n≈ìuds sans parent implies\r\n    const roots: string[] = [];\r\n    for (const [id, node] of graph) {\r\n        if (node.parents.length === 0) {\r\n            roots.push(id);\r\n        }\r\n    }\r\n\r\n    return { graph, roots };\r\n}\r\n\r\n/**\r\n * Assigne les couches de profondeur via BFS (longest path pour les DAG).\r\n * Cycle-safe : ignore les back-edges.\r\n */\r\nfunction assignLayers(\r\n    graph: Map<string, TreeNode>,\r\n    roots: string[],\r\n): Map<number, string[]> {\r\n    // D'abord, utiliser BFS pour assigner une profondeur initiale\r\n    const visited = new Set<string>();\r\n    const queue: Array<{ id: string; depth: number }> = [];\r\n\r\n    for (const root of roots) {\r\n        queue.push({ id: root, depth: 0 });\r\n    }\r\n\r\n    // Longest path : on prend la profondeur max pour chaque n≈ìud\r\n    while (queue.length > 0) {\r\n        const { id, depth } = queue.shift()!;\r\n        const node = graph.get(id);\r\n        if (!node) continue;\r\n\r\n        // Prendre la profondeur max (longest path)\r\n        if (depth > node.depth) {\r\n            node.depth = depth;\r\n        }\r\n\r\n        // Si d√©j√† visit√© avec une profondeur >= actuelle, ne pas re-explorer\r\n        // (sauf si on a trouv√© un chemin plus long)\r\n        if (visited.has(id) && depth <= node.depth && depth !== node.depth) {\r\n            continue;\r\n        }\r\n\r\n        visited.add(id);\r\n\r\n        for (const childId of node.children) {\r\n            const child = graph.get(childId);\r\n            if (!child) continue;\r\n            // Cycle detection : ne pas descendre si l'enfant est un anc√™tre\r\n            if (depth + 1 > child.depth) {\r\n                queue.push({ id: childId, depth: depth + 1 });\r\n            }\r\n        }\r\n    }\r\n\r\n    // N≈ìuds non atteints (composantes isol√©es dans le graphe implies)\r\n    for (const [, node] of graph) {\r\n        if (node.depth === -1) {\r\n            node.depth = 0;\r\n        }\r\n    }\r\n\r\n    // Grouper par couche\r\n    const layers = new Map<number, string[]>();\r\n    for (const [id, node] of graph) {\r\n        const layer = layers.get(node.depth) || [];\r\n        layer.push(id);\r\n        layers.set(node.depth, layer);\r\n    }\r\n\r\n    return layers;\r\n}\r\n\r\n/**\r\n * Heuristique barycentre pour minimiser les croisements d'ar√™tes.\r\n * 2 passes : haut‚Üíbas puis bas‚Üíhaut.\r\n */\r\nfunction minimizeCrossings(\r\n    layers: Map<number, string[]>,\r\n    graph: Map<string, TreeNode>,\r\n): void {\r\n    const maxDepth = Math.max(...layers.keys());\r\n\r\n    // Passe haut ‚Üí bas : barycentre par rapport aux parents\r\n    for (let d = 1; d <= maxDepth; d++) {\r\n        const layer = layers.get(d);\r\n        if (!layer || layer.length <= 1) continue;\r\n\r\n        const prevLayer = layers.get(d - 1);\r\n        if (!prevLayer) continue;\r\n\r\n        // Construire l'index de position des parents\r\n        const parentPos = new Map<string, number>();\r\n        prevLayer.forEach((id, i) => parentPos.set(id, i));\r\n\r\n        // Calculer le barycentre de chaque n≈ìud\r\n        const barycenters = new Map<string, number>();\r\n        for (const nodeId of layer) {\r\n            const node = graph.get(nodeId);\r\n            if (!node || node.parents.length === 0) {\r\n                barycenters.set(nodeId, Infinity); // Sans parent ‚Üí en fin de couche\r\n                continue;\r\n            }\r\n            let sum = 0;\r\n            let count = 0;\r\n            for (const parentId of node.parents) {\r\n                const pos = parentPos.get(parentId);\r\n                if (pos !== undefined) {\r\n                    sum += pos;\r\n                    count++;\r\n                }\r\n            }\r\n            barycenters.set(nodeId, count > 0 ? sum / count : Infinity);\r\n        }\r\n\r\n        // Trier par barycentre\r\n        layer.sort((a, b) => (barycenters.get(a) ?? Infinity) - (barycenters.get(b) ?? Infinity));\r\n    }\r\n\r\n    // Passe bas ‚Üí haut : barycentre par rapport aux enfants\r\n    for (let d = maxDepth - 1; d >= 0; d--) {\r\n        const layer = layers.get(d);\r\n        if (!layer || layer.length <= 1) continue;\r\n\r\n        const nextLayer = layers.get(d + 1);\r\n        if (!nextLayer) continue;\r\n\r\n        const childPos = new Map<string, number>();\r\n        nextLayer.forEach((id, i) => childPos.set(id, i));\r\n\r\n        const barycenters = new Map<string, number>();\r\n        for (const nodeId of layer) {\r\n            const node = graph.get(nodeId);\r\n            if (!node || node.children.length === 0) {\r\n                barycenters.set(nodeId, Infinity);\r\n                continue;\r\n            }\r\n            let sum = 0;\r\n            let count = 0;\r\n            for (const childId of node.children) {\r\n                const pos = childPos.get(childId);\r\n                if (pos !== undefined) {\r\n                    sum += pos;\r\n                    count++;\r\n                }\r\n            }\r\n            barycenters.set(nodeId, count > 0 ? sum / count : Infinity);\r\n        }\r\n\r\n        layer.sort((a, b) => (barycenters.get(a) ?? Infinity) - (barycenters.get(b) ?? Infinity));\r\n    }\r\n}\r\n\r\n/**\r\n * Calcule les positions x,y pour chaque n≈ìud d'une composante.\r\n * Chaque couche est centr√©e horizontalement par rapport √† la plus large.\r\n */\r\nfunction calculatePositions(\r\n    layers: Map<number, string[]>,\r\n    offsetX: number = 0,\r\n    offsetY: number = 0,\r\n): { positions: Map<string, { x: number; y: number }>; width: number; height: number } {\r\n    const positions = new Map<string, { x: number; y: number }>();\r\n    const maxDepth = Math.max(...layers.keys(), 0);\r\n\r\n    // Calculer la largeur de chaque couche et la largeur max\r\n    let maxLayerWidth = 0;\r\n    const layerWidths = new Map<number, number>();\r\n    for (let d = 0; d <= maxDepth; d++) {\r\n        const layer = layers.get(d);\r\n        if (!layer) continue;\r\n        const width = (layer.length - 1) * TREE_NODE_GAP;\r\n        layerWidths.set(d, width);\r\n        if (width > maxLayerWidth) maxLayerWidth = width;\r\n    }\r\n\r\n    // Positionner chaque n≈ìud, centr√© par rapport √† la couche la plus large\r\n    for (let d = 0; d <= maxDepth; d++) {\r\n        const layer = layers.get(d);\r\n        if (!layer) continue;\r\n        const layerWidth = layerWidths.get(d)!;\r\n        const layerOffsetX = (maxLayerWidth - layerWidth) / 2;\r\n\r\n        for (let i = 0; i < layer.length; i++) {\r\n            positions.set(layer[i], {\r\n                x: offsetX + layerOffsetX + i * TREE_NODE_GAP,\r\n                y: offsetY + d * TREE_LAYER_GAP,\r\n            });\r\n        }\r\n    }\r\n\r\n    const height = maxDepth * TREE_LAYER_GAP + NODE_HEIGHT;\r\n    return { positions, width: maxLayerWidth + NODE_WIDTH, height };\r\n}\r\n\r\n/**\r\n * D√©tecte les composantes connexes dans le graphe implies (non-orient√©).\r\n */\r\nfunction findConnectedComponents(graph: Map<string, TreeNode>): string[][] {\r\n    const visited = new Set<string>();\r\n    const components: string[][] = [];\r\n\r\n    for (const [startId] of graph) {\r\n        if (visited.has(startId)) continue;\r\n\r\n        const component: string[] = [];\r\n        const stack = [startId];\r\n\r\n        while (stack.length > 0) {\r\n            const id = stack.pop()!;\r\n            if (visited.has(id)) continue;\r\n            visited.add(id);\r\n            component.push(id);\r\n\r\n            const node = graph.get(id);\r\n            if (!node) continue;\r\n\r\n            // Non-orient√© : parents + enfants\r\n            for (const neighborId of [...node.children, ...node.parents]) {\r\n                if (!visited.has(neighborId) && graph.has(neighborId)) {\r\n                    stack.push(neighborId);\r\n                }\r\n            }\r\n        }\r\n\r\n        components.push(component);\r\n    }\r\n\r\n    return components;\r\n}\r\n\r\n/**\r\n * Orchestre le layout de toutes les composantes connexes.\r\n * Chaque composante est layout√©e ind√©pendamment puis plac√©e c√¥te √† c√¥te.\r\n */\r\nfunction layoutAllComponents(\r\n    nodes: any[],\r\n    connections: any[],\r\n): Map<string, { x: number; y: number }> {\r\n    const { graph, roots } = buildImpliesGraph(nodes, connections);\r\n\r\n    if (graph.size === 0) return new Map();\r\n\r\n    const components = findConnectedComponents(graph);\r\n    const allPositions = new Map<string, { x: number; y: number }>();\r\n\r\n    // S√©parer les composantes √† ‚â•2 n≈ìuds (arbres) des n≈ìuds isol√©s\r\n    const treeComponents = components.filter((c) => c.length > 1);\r\n    const isolatedNodes = components.filter((c) => c.length === 1).map((c) => c[0]);\r\n\r\n    let currentOffsetX = 0;\r\n    let maxTreeHeight = 0;\r\n\r\n    for (const component of treeComponents) {\r\n        // Construire un sous-graphe pour cette composante\r\n        const subGraph = new Map<string, TreeNode>();\r\n        for (const id of component) {\r\n            subGraph.set(id, graph.get(id)!);\r\n        }\r\n\r\n        // Trouver les racines de cette composante\r\n        const componentRoots = component.filter((id) => {\r\n            const node = subGraph.get(id)!;\r\n            return node.parents.length === 0;\r\n        });\r\n\r\n        // Si pas de racine (cycle pur), prendre le premier n≈ìud\r\n        const effectiveRoots = componentRoots.length > 0 ? componentRoots : [component[0]];\r\n\r\n        // Layering\r\n        const layers = assignLayers(subGraph, effectiveRoots);\r\n\r\n        // Minimiser les croisements\r\n        minimizeCrossings(layers, subGraph);\r\n\r\n        // Calculer les positions\r\n        const { positions, width, height } = calculatePositions(layers, currentOffsetX, 0);\r\n\r\n        // Ajouter au r√©sultat global\r\n        for (const [id, pos] of positions) {\r\n            allPositions.set(id, pos);\r\n        }\r\n\r\n        currentOffsetX += width + TREE_COMPONENT_GAP;\r\n        if (height > maxTreeHeight) maxTreeHeight = height;\r\n    }\r\n\r\n    // N≈ìuds isol√©s : rang√©e en bas sous les arbres\r\n    if (isolatedNodes.length > 0) {\r\n        const isolatedY = maxTreeHeight > 0 ? maxTreeHeight + TREE_LAYER_GAP : 0;\r\n        const isolatedGap = NODE_WIDTH + COLLISION_MARGIN;\r\n\r\n        isolatedNodes.forEach((id, i) => {\r\n            allPositions.set(id, {\r\n                x: i * isolatedGap,\r\n                y: isolatedY,\r\n            });\r\n        });\r\n    }\r\n\r\n    return allPositions;\r\n}\r\n\r\n/**\r\n * Applique le layout arbre hi√©rarchique au canvas.\r\n * R√©organise toutes les vignettes non-synthesized en arbre top-down\r\n * bas√© sur les connexions `implies`.\r\n *\r\n * Guard : abort si des vignettes newlyImported existent (mode assist√©).\r\n *\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function applyTreeLayout(cm: any): void {\r\n    const activeNodes = cm.state.nodes.filter((n: any) => !n.synthesized);\r\n\r\n    if (activeNodes.length === 0) {\r\n        log.info('Aucune vignette active pour le layout');\r\n        return;\r\n    }\r\n\r\n    // Guard mode assist√© : vignettes en attente de validation\r\n    const hasNewlyImported = cm.state.nodes.some((n: any) => n.newlyImported);\r\n    if (hasNewlyImported) {\r\n        log.info('Layout bloqu√© : vignettes newlyImported en attente');\r\n        return;\r\n    }\r\n\r\n    log.info(`Layout arbre : ${activeNodes.length} vignettes, ${cm.state.connections.length} connexions`);\r\n\r\n    // Calculer les nouvelles positions\r\n    const newPositions = layoutAllComponents(activeNodes, cm.state.connections);\r\n\r\n    if (newPositions.size === 0) {\r\n        log.info('Aucune position calcul√©e');\r\n        return;\r\n    }\r\n\r\n    // Animer vers les nouvelles positions, puis recadrer le viewport\r\n    animateNodesToPositions(cm, newPositions, 500, () => {\r\n        fitViewportToNodes(cm);\r\n    });\r\n}\r\n\r\n/**\r\n * Recadre le viewport pour afficher tous les n≈ìuds avec un padding confortable.\r\n * Animation fluide via transition CSS (m√™me pattern que centerOnNode).\r\n *\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function fitViewportToNodes(cm: any): void {\r\n    const nodes = cm.state.nodes.filter((n: any) => !n.synthesized);\r\n    if (nodes.length === 0) return;\r\n\r\n    // Bounding box de tous les n≈ìuds actifs\r\n    let minX = Infinity,\r\n        minY = Infinity,\r\n        maxX = -Infinity,\r\n        maxY = -Infinity;\r\n    for (const node of nodes) {\r\n        if (node.x < minX) minX = node.x;\r\n        if (node.y < minY) minY = node.y;\r\n        if (node.x + NODE_WIDTH > maxX) maxX = node.x + NODE_WIDTH;\r\n        if (node.y + NODE_HEIGHT > maxY) maxY = node.y + NODE_HEIGHT;\r\n    }\r\n\r\n    // Obtenir les dimensions du conteneur\r\n    const containerRect = cm.canvasArea.getBoundingClientRect();\r\n    const containerWidth = containerRect.width;\r\n    const containerHeight = containerRect.height;\r\n\r\n    // Garder le zoom actuel, centrer le pan sur le contenu\r\n    const zoom = cm.state.zoom;\r\n    const centerX = (minX + maxX) / 2;\r\n    const centerY = (minY + maxY) / 2;\r\n    const newPanX = containerWidth / 2 - centerX * zoom;\r\n    const newPanY = containerHeight / 2 - centerY * zoom;\r\n\r\n    // Appliquer avec transition (zoom inchang√©, seul le pan bouge)\r\n    cm.state.panX = newPanX;\r\n    cm.state.panY = newPanY;\r\n\r\n    cm.polesContainer.style.transition = 'transform 0.3s ease';\r\n    cm.svgConnections.style.transition = 'transform 0.3s ease';\r\n    applyTransform(cm);\r\n\r\n    setTimeout(() => {\r\n        cm.polesContainer.style.transition = '';\r\n        cm.svgConnections.style.transition = '';\r\n    }, 300);\r\n}\r\n\r\n// Exports pour les tests unitaires\r\nexport { buildImpliesGraph, assignLayers, minimizeCrossings, calculatePositions, findConnectedComponents };\r\n","/**\r\n * Selection - Gestion de la s√©lection multiple des vignettes\r\n *\r\n * Responsabilit√© : G√©rer la s√©lection/d√©s√©lection de vignettes,\r\n * mettre √† jour l'affichage visuel, et cr√©er la toolbar de s√©lection.\r\n *\r\n * D√©pendances :\r\n * - canvasManager.state.nodes, connections\r\n * - canvasManager.interaction.selectedNodes\r\n * - canvasManager.deleteSelectedNodes() (pour le bouton supprimer)\r\n *\r\n * √âv√©nements √©mis :\r\n * - nodeSelected : vignette s√©lectionn√©e/d√©s√©lectionn√©e\r\n * - selectionChanged : nombre de s√©lections chang√©\r\n *\r\n * @exports toggleNodeSelection, updateNodeSelectionVisual, clearSelection,\r\n *          selectAllNodes, getConnectedNodes, updateSelectionToolbar, createSelectionToolbar\r\n */\r\n\r\n/**\r\n * Toggle la s√©lection d'un node\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {Object} node - Node √† s√©lectionner/d√©s√©lectionner\r\n * @param {boolean} isSelected - √âtat de s√©lection souhait√©\r\n */\r\nexport function toggleNodeSelection(cm: any, node: { id: string }, isSelected: boolean): void {\r\n    if (isSelected) {\r\n        cm.interaction.selectedNodes.add(node.id);\r\n    } else {\r\n        cm.interaction.selectedNodes.delete(node.id);\r\n    }\r\n    updateNodeSelectionVisual(cm, node);\r\n    updateSelectionToolbar(cm);\r\n\r\n    // √âmettre √©v√©nement pour tracking attracteurs\r\n    document.dispatchEvent(\r\n        new CustomEvent('nodeSelected', {\r\n            detail: { nodeId: node.id, selected: isSelected },\r\n        }),\r\n    );\r\n}\r\n\r\n/**\r\n * Met √† jour l'affichage visuel d'un node selon son √©tat de s√©lection\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {Object} node - Node √† mettre √† jour\r\n */\r\nexport function updateNodeSelectionVisual(cm: any, node: { id: string }): void {\r\n    const nodeDiv = document.getElementById(node.id);\r\n    if (!nodeDiv) return;\r\n\r\n    if (cm.interaction.selectedNodes.has(node.id)) {\r\n        nodeDiv.classList.add('selected');\r\n    } else {\r\n        nodeDiv.classList.remove('selected');\r\n    }\r\n}\r\n\r\n/**\r\n * D√©s√©lectionne toutes les vignettes\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function clearSelection(cm: any): void {\r\n    cm.interaction.selectedNodes.forEach((nodeId: string) => {\r\n        const nodeDiv = document.getElementById(nodeId);\r\n        if (nodeDiv) {\r\n            nodeDiv.classList.remove('selected');\r\n            const checkbox = nodeDiv.querySelector('.node-checkbox') as HTMLInputElement | null;\r\n            if (checkbox) checkbox.checked = false;\r\n        }\r\n    });\r\n    cm.interaction.selectedNodes.clear();\r\n    updateSelectionToolbar(cm);\r\n}\r\n\r\n/**\r\n * S√©lectionne toutes les vignettes\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function selectAllNodes(cm: any): void {\r\n    cm.state.nodes.forEach((node: { id: string }) => {\r\n        cm.interaction.selectedNodes.add(node.id);\r\n        updateNodeSelectionVisual(cm, node);\r\n        const nodeDiv = document.getElementById(node.id);\r\n        if (nodeDiv) {\r\n            const checkbox = nodeDiv.querySelector('.node-checkbox') as HTMLInputElement | null;\r\n            if (checkbox) checkbox.checked = true;\r\n        }\r\n    });\r\n    updateSelectionToolbar(cm);\r\n}\r\n\r\n/**\r\n * R√©cup√®re les IDs des vignettes connect√©es √† un ensemble de nodes\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {Set} nodeIds - Set des IDs de nodes\r\n * @returns {Set} Set des IDs des nodes connect√©s\r\n */\r\nexport function getConnectedNodes(cm: any, nodeIds: Set<string>): Set<string> {\r\n    const connectedIds = new Set<string>();\r\n\r\n    nodeIds.forEach((nodeId) => {\r\n        cm.state.connections.forEach((conn: { from: string; to: string }) => {\r\n            if (conn.from === nodeId && !nodeIds.has(conn.to)) {\r\n                connectedIds.add(conn.to);\r\n            }\r\n            if (conn.to === nodeId && !nodeIds.has(conn.from)) {\r\n                connectedIds.add(conn.from);\r\n            }\r\n        });\r\n    });\r\n\r\n    return connectedIds;\r\n}\r\n\r\nlet _selectionToolbarTimeout: ReturnType<typeof setTimeout> | null = null;\r\n\r\n/**\r\n * Met √† jour la toolbar de s√©lection avec debounce (50ms)\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function updateSelectionToolbar(cm: any): void {\r\n    if (_selectionToolbarTimeout) clearTimeout(_selectionToolbarTimeout);\r\n    _selectionToolbarTimeout = setTimeout(() => _updateSelectionToolbarNow(cm), 50);\r\n}\r\n\r\nfunction _updateSelectionToolbarNow(cm: any): void {\r\n    let toolbar = document.getElementById('selection-toolbar');\r\n    const count = cm.interaction.selectedNodes.size;\r\n\r\n    if (count > 0) {\r\n        if (!toolbar) {\r\n            toolbar = createSelectionToolbar(cm);\r\n        }\r\n        toolbar.querySelector('.selection-count')!.textContent =\r\n            `${count} vignette${count > 1 ? 's' : ''} s√©lectionn√©e${count > 1 ? 's' : ''}`;\r\n        toolbar.style.display = 'flex';\r\n    } else {\r\n        if (toolbar) {\r\n            toolbar.style.display = 'none';\r\n        }\r\n    }\r\n\r\n    // Mettre √† jour l'indicateur dans le panneau chat (si l'app est initialis√©e)\r\n    const chatIndicator = document.getElementById('selection-count-indicator');\r\n    if (chatIndicator) {\r\n        chatIndicator.textContent = count;\r\n    }\r\n\r\n    // Dispatch un √©v√©nement custom pour notifier l'app\r\n    document.dispatchEvent(new CustomEvent('selectionChanged', { detail: { count } }));\r\n}\r\n\r\n/**\r\n * Cr√©e la toolbar de s√©lection\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @returns {HTMLElement} L'√©l√©ment toolbar cr√©√©\r\n */\r\nexport function createSelectionToolbar(cm: any): HTMLElement {\r\n    const toolbar = document.createElement('div');\r\n    toolbar.id = 'selection-toolbar';\r\n    toolbar.style.cssText = `\r\n    position: absolute;\r\n    top: 80px;\r\n    left: 20px;\r\n    background: var(--theme-btn-success);\r\n    border: 1px solid var(--theme-btn-success-hover);\r\n    border-radius: 8px;\r\n    padding: 10px 15px;\r\n    display: none;\r\n    gap: 10px;\r\n    align-items: center;\r\n    z-index: 100;\r\n  `;\r\n\r\n    const countSpan = document.createElement('span');\r\n    countSpan.className = 'selection-count';\r\n    countSpan.style.cssText = 'color: var(--theme-text-on-accent); font-size: 13px; font-weight: 600;';\r\n\r\n    // Bouton supprimer\r\n    const deleteBtn = document.createElement('button');\r\n    deleteBtn.textContent = 'üóëÔ∏è Supprimer';\r\n    deleteBtn.title = 'Supprimer les vignettes s√©lectionn√©es';\r\n    deleteBtn.style.cssText = `\r\n    background: var(--theme-btn-danger);\r\n    border: 1px solid var(--theme-btn-danger-hover);\r\n    color: var(--theme-text-on-accent);\r\n    padding: 6px 12px;\r\n    border-radius: 4px;\r\n    cursor: pointer;\r\n    font-size: 12px;\r\n    margin-left: 10px;\r\n  `;\r\n    deleteBtn.addEventListener('click', () => cm.deleteSelectedNodes());\r\n    deleteBtn.addEventListener('mouseenter', () => {\r\n        deleteBtn.style.background = 'var(--theme-btn-danger-hover)';\r\n    });\r\n    deleteBtn.addEventListener('mouseleave', () => {\r\n        deleteBtn.style.background = 'var(--theme-btn-danger)';\r\n    });\r\n\r\n    const clearBtn = document.createElement('button');\r\n    clearBtn.textContent = '‚úï';\r\n    clearBtn.title = 'D√©s√©lectionner tout';\r\n    clearBtn.style.cssText = `\r\n    background: transparent;\r\n    border: none;\r\n    color: var(--theme-text-on-accent);\r\n    padding: 4px 8px;\r\n    cursor: pointer;\r\n    font-size: 16px;\r\n  `;\r\n    clearBtn.addEventListener('click', () => clearSelection(cm));\r\n\r\n    toolbar.appendChild(countSpan);\r\n    toolbar.appendChild(deleteBtn);\r\n    toolbar.appendChild(clearBtn);\r\n\r\n    document.querySelector('.canvas-area')!.appendChild(toolbar);\r\n    return toolbar;\r\n}\r\n","/**\r\n * Menus - Gestion des menus contextuels et modaux\r\n *\r\n * Responsabilit√© : Cr√©er, afficher et masquer les menus contextuels\r\n * (contextMenu, nodeMenu, connectionTypeMenu, connectionContextMenu)\r\n * et le modal d'√©dition (editModal).\r\n *\r\n * D√©pendances :\r\n * - canvasManager.contextMenu, nodeMenu, editModal, connectionTypeMenu, connectionContextMenu\r\n * - canvasManager.interaction.selectedNodeForMenu, pendingConnection, etc.\r\n * - canvasManager.createNode(), updateNodeElement(), deleteNode(), enterConnectionMode(), etc.\r\n *\r\n * √âv√©nements √©mis :\r\n * - nodeEditStart, nodeCreated, nodeEdited\r\n *\r\n * @exports createContextMenu, showContextMenu, hideContextMenu,\r\n *          createNodeMenu, showNodeMenu, hideNodeMenu, handleNodeMenuAction,\r\n *          createEditModal, showCreateModal, showEditModal, hideEditModal, saveEditModal,\r\n *          blurAllNodeElements, setWebviewInert,\r\n *          createConnectionTypeMenu, showConnectionTypeMenu, hideConnectionTypeMenu, handleConnectionTypeSelection,\r\n *          createConnectionContextMenu, showConnectionContextMenu, hideConnectionContextMenu\r\n */\r\n\r\n// ===== CONTEXT MENU (clic droit sur canvas) =====\r\n\r\n/**\r\n * Cr√©e le menu contextuel du canvas\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function createContextMenu(cm: any): void {\r\n    cm.contextMenu = document.createElement('div');\r\n    cm.contextMenu.style.cssText = `\r\n    position: fixed;\r\n    background: var(--theme-bg-elevated);\r\n    border: 1px solid var(--theme-border-hover);\r\n    border-radius: 6px;\r\n    padding: 8px 0;\r\n    display: none;\r\n    z-index: 1000;\r\n    min-width: 180px;\r\n  `;\r\n\r\n    const menuOptions = [\r\n        {\r\n            text: 'üìù Cr√©er une vignette',\r\n            action: () => {\r\n                const x = parseInt(cm.contextMenu.dataset.x, 10);\r\n                const y = parseInt(cm.contextMenu.dataset.y, 10);\r\n                console.log('Cr√©ation vignette √†:', { x, y });\r\n                hideContextMenu(cm);\r\n                cm.showCreateModal(x, y);\r\n            },\r\n        },\r\n    ];\r\n\r\n    menuOptions.forEach(({ text, action }) => {\r\n        const option = document.createElement('div');\r\n        option.textContent = text;\r\n        option.style.cssText = `\r\n      padding: 8px 16px;\r\n      cursor: pointer;\r\n      color: var(--theme-text-primary);\r\n      font-size: 14px;\r\n    `;\r\n        option.addEventListener('mouseenter', () => (option.style.background = 'var(--theme-bg-hover)'));\r\n        option.addEventListener('mouseleave', () => (option.style.background = ''));\r\n        option.addEventListener('click', action);\r\n        cm.contextMenu.appendChild(option);\r\n    });\r\n\r\n    document.body.appendChild(cm.contextMenu);\r\n}\r\n\r\n/**\r\n * Affiche le menu contextuel\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {number} canvasX - Coordonn√©e X dans le canvas\r\n * @param {number} canvasY - Coordonn√©e Y dans le canvas\r\n * @param {number} screenX - Coordonn√©e X √©cran\r\n * @param {number} screenY - Coordonn√©e Y √©cran\r\n */\r\nexport function showContextMenu(cm: any, canvasX: number, canvasY: number, screenX: number, screenY: number): void {\r\n    cm.contextMenu.dataset.x = Math.round(canvasX);\r\n    cm.contextMenu.dataset.y = Math.round(canvasY);\r\n    cm.contextMenu.style.left = `${screenX}px`;\r\n    cm.contextMenu.style.top = `${screenY}px`;\r\n    cm.contextMenu.style.display = 'block';\r\n    console.log('Menu contextuel:', { canvasX, canvasY, screenX, screenY });\r\n}\r\n\r\n/**\r\n * Masque le menu contextuel\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function hideContextMenu(cm: any): void {\r\n    cm.contextMenu.style.display = 'none';\r\n}\r\n\r\n// ===== NODE MENU (menu ‚ãÆ des vignettes) =====\r\n\r\n/**\r\n * Cr√©e le menu des nodes (vignettes)\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function createNodeMenu(cm: any): void {\r\n    cm.nodeMenu = document.createElement('div');\r\n    cm.nodeMenu.style.cssText = `\r\n    position: fixed;\r\n    background: var(--theme-bg-elevated);\r\n    border: 1px solid var(--theme-border-hover);\r\n    border-radius: 6px;\r\n    padding: 8px 0;\r\n    display: none;\r\n    z-index: 1000;\r\n    min-width: 180px;\r\n  `;\r\n\r\n    const options = [\r\n        { text: '‚úèÔ∏è √âditer', action: 'edit' },\r\n        { text: 'üîó Connecter', action: 'connect' },\r\n        { text: 'üóëÔ∏è Supprimer', action: 'delete' },\r\n    ];\r\n\r\n    options.forEach((opt) => {\r\n        const option = document.createElement('div');\r\n        option.textContent = opt.text;\r\n        option.style.cssText = `\r\n      padding: 8px 16px;\r\n      cursor: pointer;\r\n      color: var(--theme-text-primary);\r\n      font-size: 14px;\r\n    `;\r\n        option.addEventListener('mouseenter', () => (option.style.background = 'var(--theme-bg-hover)'));\r\n        option.addEventListener('mouseleave', () => (option.style.background = ''));\r\n        option.addEventListener('click', (e) => {\r\n            e.stopPropagation();\r\n            e.preventDefault();\r\n            const node = cm.interaction.selectedNodeForMenu;\r\n            hideNodeMenu(cm);\r\n            handleNodeMenuAction(cm, opt.action, node);\r\n        });\r\n\r\n        cm.nodeMenu.appendChild(option);\r\n    });\r\n\r\n    document.body.appendChild(cm.nodeMenu);\r\n}\r\n\r\n/**\r\n * Affiche le menu d'un node\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {Object} node - Node concern√©\r\n * @param {number} x - Position X\r\n * @param {number} y - Position Y\r\n */\r\nexport function showNodeMenu(cm: any, node: any, x: number, y: number): void {\r\n    cm.interaction.selectedNodeForMenu = node;\r\n    cm.nodeMenu.style.left = `${x}px`;\r\n    cm.nodeMenu.style.top = `${y}px`;\r\n    cm.nodeMenu.style.display = 'block';\r\n}\r\n\r\n/**\r\n * Masque le menu de node\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function hideNodeMenu(cm: any): void {\r\n    cm.nodeMenu.style.display = 'none';\r\n    if (cm.editModal && cm.editModal.style.display !== 'block') {\r\n        cm.interaction.selectedNodeForMenu = null;\r\n    }\r\n}\r\n\r\n/**\r\n * G√®re les actions du menu de node\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {string} action - Action √† ex√©cuter\r\n * @param {Object} node - Node concern√©\r\n */\r\nexport async function handleNodeMenuAction(cm: any, action: string, node: any): Promise<void> {\r\n    if (!node) return;\r\n\r\n    switch (action) {\r\n        case 'edit':\r\n            cm.showEditModal(node);\r\n            break;\r\n        case 'connect':\r\n            cm.enterConnectionMode(node);\r\n            cm.polesContainer.classList.add('connection-mode-waiting');\r\n            break;\r\n        case 'delete':\r\n            if (confirm('Supprimer ce n≈ìud ?')) {\r\n                await cm.deleteNode(node);\r\n            }\r\n            break;\r\n    }\r\n}\r\n\r\n// ===== EDIT MODAL =====\r\n\r\n/**\r\n * Cr√©e le modal d'√©dition\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function createEditModal(cm: any): void {\r\n    cm.editModal = document.createElement('div');\r\n    cm.editModal.style.cssText = `\r\n    position: fixed;\r\n    top: 50%;\r\n    left: 50%;\r\n    transform: translate(-50%, -50%);\r\n    background: var(--theme-bg-elevated);\r\n    border: 1px solid var(--theme-border-hover);\r\n    border-radius: 8px;\r\n    padding: 20px;\r\n    display: none;\r\n    z-index: 1001;\r\n    min-width: 400px;\r\n    max-width: 600px;\r\n  `;\r\n\r\n    cm.editModal.innerHTML = `\r\n    <h3 style=\"color: var(--theme-text-primary); margin-bottom: 15px;\">√âditer </h3>\r\n    <textarea id=\"edit-modal-textarea\" class=\"pole-text-input\" tabindex=\"0\" autofocus spellcheck=\"true\" placeholder=\"Texte du p√¥le...\" style=\"\r\n      width: 100%;\r\n      min-height: 100px;\r\n      background: var(--theme-bg-surface);\r\n      border: 1px solid var(--theme-border-hover);\r\n      color: var(--theme-text-primary);\r\n      padding: 10px;\r\n      border-radius: 6px;\r\n      font-family: inherit;\r\n      font-size: 14px;\r\n      margin-bottom: 10px;\r\n      resize: vertical;\r\n    \"></textarea>\r\n\r\n    <label style=\"display: block; color: var(--theme-text-primary); margin-bottom: 6px; font-size: 13px;\">Statut</label>\r\n    <select class=\"pole-status-select\" style=\"\r\n      width: 100%;\r\n      background: var(--theme-bg-surface);\r\n      border: 1px solid var(--theme-border-hover);\r\n      color: var(--theme-text-primary);\r\n      padding: 10px;\r\n      border-radius: 6px;\r\n      font-family: inherit;\r\n      font-size: 14px;\r\n      margin-bottom: 10px;\r\n      cursor: pointer;\r\n    \">\r\n      <option value=\"neutral\">\\u25CB Neutre</option>\r\n      <option value=\"priority\">\\uD83C\\uDFAF Priorit√©</option>\r\n    </select>\r\n\r\n    <input class=\"pole-tags-input\" placeholder=\"Tags (s√©par√©s par des espaces, ex: #tech #ai)\" style=\"\r\n      width: 100%;\r\n      background: var(--theme-bg-surface);\r\n      border: 1px solid var(--theme-border-hover);\r\n      color: var(--theme-text-primary);\r\n      padding: 10px;\r\n      border-radius: 6px;\r\n      font-family: inherit;\r\n      font-size: 14px;\r\n      margin-bottom: 15px;\r\n    \">\r\n    <div style=\"display: flex; gap: 10px; justify-content: flex-end;\">\r\n      <button class=\"modal-cancel-btn\" style=\"\r\n        background: var(--theme-btn-bg);\r\n        border: 1px solid var(--theme-border-hover);\r\n        color: var(--theme-text-primary);\r\n        padding: 8px 16px;\r\n        border-radius: 6px;\r\n        cursor: pointer;\r\n      \">Annuler</button>\r\n      <button class=\"modal-save-btn\" style=\"\r\n        background: var(--theme-btn-success);\r\n        border: 1px solid var(--theme-btn-success-hover);\r\n        color: var(--theme-text-on-accent);\r\n        padding: 8px 16px;\r\n        border-radius: 6px;\r\n        cursor: pointer;\r\n      \">Sauvegarder</button>\r\n    </div>\r\n  `;\r\n\r\n    document.body.appendChild(cm.editModal);\r\n\r\n    const cancelBtn = cm.editModal.querySelector('.modal-cancel-btn');\r\n    const saveBtn = cm.editModal.querySelector('.modal-save-btn');\r\n\r\n    cancelBtn.addEventListener('mousedown', (e: MouseEvent) => {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n    });\r\n    cancelBtn.addEventListener('click', (e: MouseEvent) => {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n        cm.hideEditModal();\r\n    });\r\n\r\n    saveBtn.addEventListener('mousedown', (e: MouseEvent) => {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n    });\r\n    saveBtn.addEventListener('click', (e: MouseEvent) => {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n        cm.saveEditModal();\r\n    });\r\n\r\n    cm.editModal.addEventListener('click', (e: MouseEvent) => e.stopPropagation());\r\n    cm.editModal.addEventListener('mousedown', (e: MouseEvent) => e.stopPropagation());\r\n\r\n    cm.editModal.addEventListener('keydown', (e: KeyboardEvent) => {\r\n        if (e.ctrlKey && e.key === 'Enter') {\r\n            e.preventDefault();\r\n            cm.saveEditModal();\r\n        }\r\n        if (e.key === 'Escape') {\r\n            e.preventDefault();\r\n            cm.hideEditModal();\r\n        }\r\n    });\r\n}\r\n\r\n/**\r\n * Ouvre le modal pour cr√©er une nouvelle vignette\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {number} x - Position X\r\n * @param {number} y - Position Y\r\n */\r\nexport async function showCreateModal(cm: any, x: number, y: number): Promise<void> {\r\n    cm.interaction.pendingNodePosition = { x, y };\r\n    cm.interaction.isCreatingNewNode = true;\r\n    cm.interaction.selectedNodeForMenu = null;\r\n    cm.interaction.isNewNodeBeingEdited = false;\r\n\r\n    blurAllNodeElements(cm);\r\n    await blurWebview(cm);\r\n    setWebviewInert(cm, true);\r\n\r\n    const textInput = cm.editModal.querySelector('.pole-text-input') as HTMLTextAreaElement;\r\n    const statusSelect = cm.editModal.querySelector('.pole-status-select') as HTMLSelectElement | null;\r\n    const tagsInput = cm.editModal.querySelector('.pole-tags-input') as HTMLInputElement;\r\n\r\n    textInput.value = '';\r\n    textInput.placeholder = 'Entrez le texte de la vignette...';\r\n    if (statusSelect) statusSelect.value = 'neutral';\r\n    tagsInput.value = '';\r\n    cm.editModal.style.display = 'block';\r\n\r\n    const focusTextInput = async () => {\r\n        if (window.fgraph && window.fgraph.focusMainWindow) {\r\n            await window.fgraph.focusMainWindow();\r\n        }\r\n        textInput.focus();\r\n        console.log('[Canvas] Focus textarea, activeElement:', document.activeElement?.tagName);\r\n    };\r\n\r\n    setTimeout(focusTextInput, 100);\r\n}\r\n\r\n/**\r\n * Ouvre le modal pour √©diter une vignette existante\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {Object} node - Node √† √©diter\r\n */\r\nexport async function showEditModal(cm: any, node: any): Promise<void> {\r\n    cm.interaction.selectedNodeForMenu = node;\r\n    cm.interaction.isCreatingNewNode = false;\r\n    cm.interaction.pendingNodePosition = null;\r\n\r\n    document.dispatchEvent(new CustomEvent('nodeEditStart', { detail: { nodeId: node.id } }));\r\n\r\n    setWebviewInert(cm, true);\r\n\r\n    const textInput = cm.editModal.querySelector('.pole-text-input') as HTMLTextAreaElement;\r\n    const statusSelect = cm.editModal.querySelector('.pole-status-select') as HTMLSelectElement | null;\r\n    const tagsInput = cm.editModal.querySelector('.pole-tags-input') as HTMLInputElement;\r\n\r\n    textInput.value = node.text || '';\r\n    textInput.placeholder = 'Texte du p√¥le...';\r\n    if (statusSelect) statusSelect.value = node.status || 'neutral';\r\n    tagsInput.value = node.tags.join(' ');\r\n    cm.editModal.style.display = 'block';\r\n\r\n    setTimeout(async () => {\r\n        if (window.fgraph && window.fgraph.focusMainWindow) {\r\n            await window.fgraph.focusMainWindow();\r\n        }\r\n        textInput.focus();\r\n        console.log('[Canvas] Edit modal focus, activeElement:', document.activeElement?.tagName);\r\n    }, 100);\r\n}\r\n\r\n/**\r\n * Ferme le modal d'√©dition\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function hideEditModal(cm: any): void {\r\n    cm.editModal.style.display = 'none';\r\n    cm.interaction.selectedNodeForMenu = null;\r\n    cm.interaction.isCreatingNewNode = false;\r\n    cm.interaction.pendingNodePosition = null;\r\n    setWebviewInert(cm, false);\r\n}\r\n\r\n/**\r\n * Sauvegarde le contenu du modal d'√©dition\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function saveEditModal(cm: any): void {\r\n    const newText = (cm.editModal.querySelector('.pole-text-input') as HTMLTextAreaElement).value;\r\n    const newStatus = (cm.editModal.querySelector('.pole-status-select') as HTMLSelectElement).value;\r\n    const tagsInput = (cm.editModal.querySelector('.pole-tags-input') as HTMLInputElement).value;\r\n\r\n    const parsedTags = tagsInput\r\n        .split(/\\s+/)\r\n        .map((t) => t.trim())\r\n        .filter((t) => t.startsWith('#') && t.length > 1);\r\n\r\n    // Cr√©ation de nouvelle vignette\r\n    if (cm.interaction.isCreatingNewNode && cm.interaction.pendingNodePosition) {\r\n        const { x, y } = cm.interaction.pendingNodePosition;\r\n        const newNode = cm.createNode(x, y, newText, newStatus, parsedTags);\r\n\r\n        console.log('Nouvelle vignette cr√©√©e via modal:', newNode.id);\r\n\r\n        document.dispatchEvent(new CustomEvent('nodeCreated', { detail: { nodeId: newNode.id } }));\r\n\r\n        hideEditModal(cm);\r\n        return;\r\n    }\r\n\r\n    // √âdition d'une vignette existante\r\n    const node = cm.interaction.selectedNodeForMenu;\r\n    if (!node) {\r\n        console.error('Aucun node s√©lectionn√© pour la sauvegarde');\r\n        return;\r\n    }\r\n\r\n    node.text = newText;\r\n    node.status = newStatus;\r\n    node.tags = parsedTags;\r\n\r\n    cm.updateNodeElement(node);\r\n\r\n    document.dispatchEvent(new CustomEvent('nodeEdited', { detail: { nodeId: node.id } }));\r\n\r\n    cm.interaction.isNewNodeBeingEdited = false;\r\n    hideEditModal(cm);\r\n}\r\n\r\n// ===== HELPER FUNCTIONS =====\r\n\r\n/**\r\n * Blur tous les √©l√©ments focusables dans les nodes\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function blurAllNodeElements(cm: any): void {\r\n    const focusables = cm.polesContainer.querySelectorAll('input, select, button, [tabindex]');\r\n    focusables.forEach((el: HTMLElement) => el.blur());\r\n    console.log('[Canvas] Blurred', focusables.length, 'focusable elements in nodes');\r\n}\r\n\r\n/**\r\n * Blur la webview\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nasync function blurWebview(_cm: any): Promise<void> {\r\n    const webview = document.getElementById('llm-webview') as any;\r\n    if (webview) {\r\n        try {\r\n            webview.blur();\r\n            webview\r\n                .executeJavaScript(\r\n                    `\r\n        if (document.activeElement) {\r\n          document.activeElement.blur();\r\n        }\r\n        document.body.focus();\r\n      `,\r\n                )\r\n                .catch(() => {});\r\n            console.log('[Canvas] Webview blurred');\r\n        } catch (e) {\r\n            console.warn('[Canvas] Could not blur webview:', e);\r\n        }\r\n    }\r\n\r\n    if ((window as any).fgraph && (window as any).fgraph.focusMainWindow) {\r\n        try {\r\n            await (window as any).fgraph.focusMainWindow();\r\n        } catch (e) {\r\n            console.warn('[Canvas] Could not focus main window:', e);\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Active/d√©sactive l'attribut inert sur la webview\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {boolean} inert - √âtat inert souhait√©\r\n */\r\nexport function setWebviewInert(cm: any, inert: boolean): void {\r\n    const webview = document.getElementById('llm-webview');\r\n    const webviewContainer = document.querySelector('.llm-panel');\r\n\r\n    if (webview) {\r\n        if (inert) {\r\n            webview.setAttribute('inert', '');\r\n            if (webviewContainer) webviewContainer.setAttribute('inert', '');\r\n            console.log('[Canvas] Webview set to inert');\r\n        } else {\r\n            webview.removeAttribute('inert');\r\n            if (webviewContainer) webviewContainer.removeAttribute('inert');\r\n            console.log('[Canvas] Webview inert removed');\r\n        }\r\n    }\r\n}\r\n\r\n// ===== CONNECTION TYPE MENU =====\r\n\r\n/**\r\n * Cr√©e le menu de choix du type de connexion\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function createConnectionTypeMenu(cm: any): void {\r\n    cm.connectionTypeMenu = document.createElement('div');\r\n    cm.connectionTypeMenu.style.cssText = `\r\n    position: fixed;\r\n    background: var(--theme-bg-elevated);\r\n    border: 1px solid var(--theme-border-hover);\r\n    border-radius: 6px;\r\n    padding: 8px 0;\r\n    display: none;\r\n    z-index: 1000;\r\n    min-width: 200px;\r\n  `;\r\n\r\n    const connectionTypes = [\r\n        { text: '‚Üí Implique', type: 'implies', description: 'Relation de cause √† effet' },\r\n        { text: '‚Üî R√©sonance', type: 'resonance', description: 'Renforce mutuellement' },\r\n    ];\r\n\r\n    connectionTypes.forEach((ct) => {\r\n        const option = document.createElement('div');\r\n        option.style.cssText = `\r\n      padding: 8px 16px;\r\n      cursor: pointer;\r\n      color: var(--theme-text-primary);\r\n      font-size: 14px;\r\n      border-bottom: 1px solid var(--theme-border-hover);\r\n    `;\r\n        option.innerHTML = `\r\n      <div style=\"font-weight: 600; margin-bottom: 4px;\">${ct.text}</div>\r\n      <div style=\"font-size: 11px; color: var(--theme-text-muted);\">${ct.description}</div>\r\n    `;\r\n\r\n        option.addEventListener('mouseenter', () => (option.style.background = 'var(--theme-bg-hover)'));\r\n        option.addEventListener('mouseleave', () => (option.style.background = ''));\r\n        option.addEventListener('click', () => {\r\n            handleConnectionTypeSelection(cm, ct.type);\r\n            hideConnectionTypeMenu(cm);\r\n        });\r\n\r\n        cm.connectionTypeMenu.appendChild(option);\r\n    });\r\n\r\n    const lastChild = cm.connectionTypeMenu.lastChild as HTMLElement | null;\r\n    if (lastChild) lastChild.style.borderBottom = 'none';\r\n\r\n    document.body.appendChild(cm.connectionTypeMenu);\r\n}\r\n\r\n/**\r\n * Affiche le menu de type de connexion\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {Object} fromNode - Node source\r\n * @param {Object} toNode - Node cible\r\n * @param {number} x - Position X\r\n * @param {number} y - Position Y\r\n */\r\nexport function showConnectionTypeMenu(cm: any, fromNode: any, toNode: any, x: number, y: number): void {\r\n    cm.interaction.pendingConnection = { fromNode, toNode };\r\n    cm.connectionTypeMenu.style.left = `${x}px`;\r\n    cm.connectionTypeMenu.style.top = `${y}px`;\r\n    cm.connectionTypeMenu.style.display = 'block';\r\n}\r\n\r\n/**\r\n * Masque le menu de type de connexion\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function hideConnectionTypeMenu(cm: any): void {\r\n    cm.connectionTypeMenu.style.display = 'none';\r\n    cm.interaction.pendingConnection = null;\r\n    // Sortir du mode connexion quand le menu est ferm√© (clic ailleurs, Escape, etc.)\r\n    cm.exitConnectionMode();\r\n}\r\n\r\n/**\r\n * G√®re la s√©lection du type de connexion\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {string} type - Type de connexion\r\n */\r\nexport function handleConnectionTypeSelection(cm: any, type: string): void {\r\n    if (!cm.interaction.pendingConnection) return;\r\n\r\n    const { fromNode, toNode } = cm.interaction.pendingConnection;\r\n    hideConnectionTypeMenu(cm);\r\n    cm.createConnection(fromNode, toNode, type);\r\n    cm.exitConnectionMode();\r\n}\r\n\r\n// ===== CONNECTION CONTEXT MENU =====\r\n\r\n/**\r\n * Cr√©e le menu contextuel des connexions\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function createConnectionContextMenu(cm: any): void {\r\n    cm.connectionContextMenu = document.createElement('div');\r\n    cm.connectionContextMenu.style.cssText = `\r\n    position: fixed;\r\n    background: var(--theme-bg-elevated);\r\n    border: 1px solid var(--theme-border-hover);\r\n    border-radius: 6px;\r\n    padding: 8px 0;\r\n    display: none;\r\n    z-index: 1000;\r\n    min-width: 150px;\r\n  `;\r\n\r\n    const deleteOption = document.createElement('div');\r\n    deleteOption.textContent = 'üóëÔ∏è Supprimer le lien';\r\n    deleteOption.style.cssText = `\r\n    padding: 8px 16px;\r\n    cursor: pointer;\r\n    color: var(--theme-text-primary);\r\n    font-size: 14px;\r\n  `;\r\n    deleteOption.addEventListener('mouseenter', () => (deleteOption.style.background = 'var(--theme-bg-hover)'));\r\n    deleteOption.addEventListener('mouseleave', () => (deleteOption.style.background = ''));\r\n    deleteOption.addEventListener('click', () => {\r\n        if (cm.interaction.selectedConnectionForMenu) {\r\n            cm.deleteConnection(cm.interaction.selectedConnectionForMenu);\r\n        }\r\n        hideConnectionContextMenu(cm);\r\n    });\r\n\r\n    cm.connectionContextMenu.appendChild(deleteOption);\r\n    document.body.appendChild(cm.connectionContextMenu);\r\n}\r\n\r\n/**\r\n * Affiche le menu contextuel d'une connexion\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {Object} connection - Connexion concern√©e\r\n * @param {number} x - Position X\r\n * @param {number} y - Position Y\r\n */\r\nexport function showConnectionContextMenu(cm: any, connection: any, x: number, y: number): void {\r\n    cm.interaction.selectedConnectionForMenu = connection;\r\n    cm.connectionContextMenu.style.left = `${x}px`;\r\n    cm.connectionContextMenu.style.top = `${y}px`;\r\n    cm.connectionContextMenu.style.display = 'block';\r\n}\r\n\r\n/**\r\n * Masque le menu contextuel de connexion\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function hideConnectionContextMenu(cm: any): void {\r\n    if (cm.connectionContextMenu) {\r\n        cm.connectionContextMenu.style.display = 'none';\r\n    }\r\n    cm.interaction.selectedConnectionForMenu = null;\r\n}\r\n","/**\r\n * Interactions - Gestion du drag & drop des vignettes\r\n *\r\n * Responsabilit√© : G√©rer le d√©placement des vignettes (simple et multiple),\r\n * d√©tecter le seuil de mouvement, mettre √† jour les connexions pendant le drag.\r\n *\r\n * D√©pendances :\r\n * - canvasManager.state.nodes, panX, panY, zoom\r\n * - canvasManager.interaction.isDragging, draggedNode, draggedNodes, selectedNodes\r\n * - canvasManager.canvasArea : √©l√©ment DOM de la zone canvas\r\n * - canvasManager.updateNodeConnections(), updateConnections()\r\n *\r\n * √âv√©nements √©mis :\r\n * - nodeDragStart : d√©but de d√©placement d'une vignette\r\n * - nodeDragEnd : fin de d√©placement d'une vignette\r\n *\r\n * @exports getNodeFromElement, startDragNode, cleanupDrag\r\n */\r\n\r\n/**\r\n * Trouve le node √† partir de l'√©l√©ment DOM cliqu√©\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {HTMLElement} element - √âl√©ment DOM cliqu√©\r\n * @returns {Object|null} Node correspondant ou null\r\n */\r\nexport function getNodeFromElement(cm: any, element: HTMLElement): any | null {\r\n    // Remonter jusqu'√† trouver un √©l√©ment .pole\r\n    const poleElement = element.closest('.pole');\r\n    if (!poleElement) return null;\r\n\r\n    // Trouver le node correspondant √† cet ID\r\n    return cm.state.nodes.find((n: any) => n.id === poleElement.id);\r\n}\r\n\r\n/**\r\n * D√©marre le drag d'un node (simple ou multiple)\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {MouseEvent} e - √âv√©nement mousedown\r\n * @param {Object} node - Node √† d√©placer\r\n */\r\nexport function startDragNode(cm: any, e: MouseEvent, node: any): void {\r\n    if (e.button !== 0 || e.ctrlKey) return; // Seulement clic gauche sans ctrl\r\n    if (!node || !node.id) return; // V√©rifier que le node est valide\r\n\r\n    // Si un drag est d√©j√† en cours, nettoyer d'abord\r\n    if (\r\n        cm.interaction.draggedNode ||\r\n        cm.interaction.isDragging ||\r\n        cm.interaction.dragMoveListener ||\r\n        cm.interaction.dragUpListener\r\n    ) {\r\n        cleanupDrag(cm);\r\n    }\r\n\r\n    // Stopper tout pan en cours (√©tat r√©siduel possible si mouseup rat√©)\r\n    if (cm.interaction.isPanning) {\r\n        cm.stopPan();\r\n    }\r\n\r\n    // D√©terminer si on fait un d√©placement multiple\r\n    // (si la vignette dragu√©e fait partie de la s√©lection et qu'il y a plus d'une vignette s√©lectionn√©e)\r\n    const isMultiDrag = cm.interaction.selectedNodes.has(node.id) && cm.interaction.selectedNodes.size > 1;\r\n\r\n    // Stocker les nodes √† d√©placer et leurs positions initiales\r\n    let nodesToDrag: any[];\r\n    if (isMultiDrag) {\r\n        nodesToDrag = cm.state.nodes.filter((n: any) => cm.interaction.selectedNodes.has(n.id));\r\n        console.log(`startDragNode: d√©placement multiple de ${nodesToDrag.length} vignettes`);\r\n    } else {\r\n        nodesToDrag = [node];\r\n        console.log('startDragNode pour:', node.id.substring(0, 20), 'pos:', node.x, node.y);\r\n    }\r\n\r\n    // Stocker les positions initiales de tous les nodes √† d√©placer\r\n    const initialPositions = new Map<string, { x: number; y: number }>();\r\n    nodesToDrag.forEach((n: any) => {\r\n        initialPositions.set(n.id, { x: n.x, y: n.y });\r\n    });\r\n\r\n    // Stocker la position initiale de la souris pour d√©tecter un mouvement intentionnel\r\n    const startMouseX = e.clientX;\r\n    const startMouseY = e.clientY;\r\n    const DRAG_THRESHOLD = 3; // Distance minimale en pixels pour d√©marrer le drag\r\n\r\n    cm.interaction.isDragging = false; // Pas encore en drag\r\n    cm.interaction.draggedNode = node;\r\n    cm.interaction.draggedNodes = nodesToDrag; // Nouveau: liste des nodes √† d√©placer\r\n\r\n    // Calculer le rect de la zone canvas (pas du container transform√©)\r\n    const canvasRect = cm.canvasArea.getBoundingClientRect();\r\n    // Offset de la souris par rapport √† la position du node principal (en coordonn√©es canvas)\r\n    const mouseCanvasX = (e.clientX - canvasRect.left - cm.state.panX) / cm.state.zoom;\r\n    const mouseCanvasY = (e.clientY - canvasRect.top - cm.state.panY) / cm.state.zoom;\r\n    cm.interaction.dragStartX = mouseCanvasX - node.x;\r\n    cm.interaction.dragStartY = mouseCanvasY - node.y;\r\n\r\n    // Obtenir les √©l√©ments DOM de tous les nodes √† d√©placer\r\n    const nodeElements = new Map<string, HTMLElement>();\r\n    nodesToDrag.forEach((n: any) => {\r\n        const el = document.getElementById(n.id);\r\n        if (el) {\r\n            nodeElements.set(n.id, el);\r\n            el.style.zIndex = '9999'; // Mettre au-dessus\r\n        }\r\n    });\r\n\r\n    // Variables locales pour le drag\r\n    let lastMouseX = e.clientX;\r\n    let lastMouseY = e.clientY;\r\n    let hasDragStarted = false;\r\n\r\n    const onMouseMove = (e: MouseEvent) => {\r\n        lastMouseX = e.clientX;\r\n        lastMouseY = e.clientY;\r\n\r\n        // V√©rifier si on a boug√© assez pour d√©marrer le drag\r\n        const distanceMoved = Math.sqrt(Math.pow(lastMouseX - startMouseX, 2) + Math.pow(lastMouseY - startMouseY, 2));\r\n\r\n        // D√©marrer le drag seulement si on a d√©pass√© le seuil\r\n        if (!hasDragStarted && distanceMoved > DRAG_THRESHOLD) {\r\n            hasDragStarted = true;\r\n            cm.interaction.isDragging = true;\r\n            // Ajouter la classe dragging √† tous les nodes\r\n            nodeElements.forEach((el) => el.classList.add('dragging'));\r\n            // √âmettre l'√©v√©nement de d√©but de drag pour l'historique (sauvegarder AVANT le d√©placement)\r\n            document.dispatchEvent(\r\n                new CustomEvent('nodeDragStart', {\r\n                    detail: { nodeId: node.id, isMultiDrag },\r\n                }),\r\n            );\r\n        }\r\n\r\n        // Ne mettre √† jour que si le drag a vraiment commenc√©\r\n        if (!hasDragStarted) return;\r\n\r\n        // Annuler l'ancienne frame si elle existe\r\n        if (cm.interaction.dragRafId) {\r\n            cancelAnimationFrame(cm.interaction.dragRafId);\r\n        }\r\n\r\n        // Planifier la mise √† jour pour la prochaine frame\r\n        cm.interaction.dragRafId = requestAnimationFrame(() => {\r\n            if (cm.interaction.isDragging && cm.interaction.draggedNode) {\r\n                // Calculer le delta de d√©placement depuis la position initiale du node principal\r\n                const mouseCanvasX = (lastMouseX - canvasRect.left - cm.state.panX) / cm.state.zoom;\r\n                const mouseCanvasY = (lastMouseY - canvasRect.top - cm.state.panY) / cm.state.zoom;\r\n\r\n                const newMainX = Math.round(mouseCanvasX - cm.interaction.dragStartX);\r\n                const newMainY = Math.round(mouseCanvasY - cm.interaction.dragStartY);\r\n\r\n                // Calculer le delta par rapport √† la position initiale du node principal\r\n                const initialMainPos = initialPositions.get(node.id)!;\r\n                const deltaX = newMainX - initialMainPos.x;\r\n                const deltaY = newMainY - initialMainPos.y;\r\n\r\n                // Mettre √† jour tous les nodes √† d√©placer\r\n                nodesToDrag.forEach((n: any) => {\r\n                    const initialPos = initialPositions.get(n.id)!;\r\n                    n.x = initialPos.x + deltaX;\r\n                    n.y = initialPos.y + deltaY;\r\n\r\n                    // Mise √† jour directe du style CSS\r\n                    const el = nodeElements.get(n.id);\r\n                    if (el) {\r\n                        el.style.left = `${n.x}px`;\r\n                        el.style.top = `${n.y}px`;\r\n                    }\r\n\r\n                    // Mettre √† jour les connexions de ce node\r\n                    cm.updateNodeConnections(n.id);\r\n                });\r\n            }\r\n        });\r\n    };\r\n\r\n    const onMouseUp = (_e: MouseEvent) => {\r\n        // Retirer la classe dragging et reset z-index de tous les nodes\r\n        nodeElements.forEach((el) => {\r\n            el.classList.remove('dragging');\r\n            el.style.zIndex = '';\r\n        });\r\n\r\n        // Mettre √† jour les connexions une derni√®re fois\r\n        if (cm.interaction.draggedNode && hasDragStarted) {\r\n            cm.updateConnections();\r\n            // √âmettre un √©v√©nement pour signaler la fin du drag\r\n            document.dispatchEvent(\r\n                new CustomEvent('nodeDragEnd', {\r\n                    detail: {\r\n                        nodeId: cm.interaction.draggedNode.id,\r\n                        isMultiDrag,\r\n                        nodeIds: nodesToDrag.map((n: any) => n.id),\r\n                    },\r\n                }),\r\n            );\r\n        }\r\n\r\n        // Nettoyer\r\n        cleanupDrag(cm);\r\n    };\r\n\r\n    // Stocker les r√©f√©rences aux listeners pour pouvoir les nettoyer\r\n    cm.interaction.dragMoveListener = onMouseMove;\r\n    cm.interaction.dragUpListener = onMouseUp;\r\n\r\n    document.addEventListener('mousemove', onMouseMove);\r\n    document.addEventListener('mouseup', onMouseUp);\r\n}\r\n\r\n/**\r\n * Nettoie l'√©tat du drag et retire les listeners\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function cleanupDrag(cm: any): void {\r\n    // Annuler toute animation en cours\r\n    if (cm.interaction.dragRafId) {\r\n        cancelAnimationFrame(cm.interaction.dragRafId);\r\n        cm.interaction.dragRafId = null;\r\n    }\r\n\r\n    // Retirer la classe dragging de tous les nodes d√©plac√©s\r\n    if (cm.interaction.draggedNodes && cm.interaction.draggedNodes.length > 0) {\r\n        cm.interaction.draggedNodes.forEach((node: any) => {\r\n            const el = document.getElementById(node.id);\r\n            if (el) {\r\n                el.classList.remove('dragging');\r\n                el.style.zIndex = '';\r\n            }\r\n        });\r\n    } else if (cm.interaction.draggedNode) {\r\n        // Fallback pour un seul node\r\n        const oldNodeElement = document.getElementById(cm.interaction.draggedNode.id);\r\n        if (oldNodeElement) {\r\n            oldNodeElement.classList.remove('dragging');\r\n            oldNodeElement.style.zIndex = '';\r\n        }\r\n    }\r\n\r\n    // Retirer les listeners\r\n    if (cm.interaction.dragMoveListener) {\r\n        document.removeEventListener('mousemove', cm.interaction.dragMoveListener);\r\n        cm.interaction.dragMoveListener = null;\r\n    }\r\n    if (cm.interaction.dragUpListener) {\r\n        document.removeEventListener('mouseup', cm.interaction.dragUpListener);\r\n        cm.interaction.dragUpListener = null;\r\n    }\r\n\r\n    // R√©initialiser l'√©tat\r\n    cm.interaction.isDragging = false;\r\n    cm.interaction.draggedNode = null;\r\n    cm.interaction.draggedNodes = [];\r\n}\r\n","/**\r\n * Nodes - Gestion des vignettes (cr√©ation, rendu, mise √† jour, suppression)\r\n *\r\n * Responsabilit√© : Cr√©er, afficher, mettre √† jour et supprimer les vignettes\r\n * sur le canvas. G√®re aussi le cycle des statuts et le refresh forc√©.\r\n *\r\n * D√©pendances :\r\n * - canvasManager.state.nodes, connections\r\n * - canvasManager.interaction.selectedNodes, selectedNodeForMenu\r\n * - canvasManager.polesContainer : conteneur DOM des vignettes\r\n * - canvasManager.findFreePosition(), renderAllConnections(), updateSelectionToolbar()\r\n * - canvasManager.toggleNodeSelection(), startDragNode(), getNodeFromElement()\r\n * - canvasManager.centerOnNode(), enterConnectionMode(), showNodeMenu()\r\n * - canvasManager.showConnectionTypeMenu()\r\n *\r\n * √âv√©nements √©mis :\r\n * - nodeCreated : vignette cr√©√©e\r\n * - nodeDeleted : vignette supprim√©e\r\n *\r\n * @exports createNode, renderNode, updateNodeElement, deleteNode, deleteSelectedNodes,\r\n *          blurWebview, forceRefreshCanvas, getStatusIcon, cycleNodeStatus\r\n */\r\n\r\nimport type { KairosNode, KairosConnection } from '../types/kairos.js';\r\nimport { invalidateNodeSizeCache } from './connections.js';\r\n\r\ninterface CreateNodeOptions {\r\n    newlyImported?: boolean;\r\n}\r\n\r\n/**\r\n * Configure l'event delegation sur polesContainer pour les √©v√©nements des n≈ìuds.\r\n * Appel√© une seule fois (guard via cm._nodeDelegationSetUp).\r\n * √âlimine la fuite m√©moire li√©e aux listeners individuels par n≈ìud.\r\n */\r\nfunction ensureNodeEventDelegation(cm: any): void {\r\n    if (cm._nodeDelegationSetUp) return;\r\n    cm._nodeDelegationSetUp = true;\r\n\r\n    // mousedown ‚Äî gestion du drag\r\n    cm.polesContainer.addEventListener('mousedown', (e: MouseEvent) => {\r\n        const target = e.target as HTMLElement;\r\n        if (\r\n            target.tagName === 'SELECT' ||\r\n            target.tagName === 'INPUT' ||\r\n            target.classList.contains('pole-menu') ||\r\n            target.classList.contains('pole-connect-btn')\r\n        ) {\r\n            return;\r\n        }\r\n        const nodeDiv = target.closest('.pole') as HTMLElement | null;\r\n        if (!nodeDiv) return;\r\n        e.stopPropagation();\r\n        const currentNode = cm.state.nodes.find((n: KairosNode) => n.id === nodeDiv.id);\r\n        if (currentNode) {\r\n            cm.startDragNode(e, currentNode);\r\n        }\r\n    });\r\n\r\n    // dblclick ‚Äî centrer sur le n≈ìud\r\n    cm.polesContainer.addEventListener('dblclick', (e: MouseEvent) => {\r\n        const nodeDiv = (e.target as HTMLElement).closest('.pole') as HTMLElement | null;\r\n        if (!nodeDiv) return;\r\n        e.stopPropagation();\r\n        const actualNode = cm.getNodeFromElement(e.target);\r\n        if (actualNode) cm.centerOnNode(actualNode);\r\n    });\r\n\r\n    // click ‚Äî s√©lection, connexion, friction, import halo\r\n    cm.polesContainer.addEventListener('click', (e: MouseEvent) => {\r\n        const nodeDiv = (e.target as HTMLElement).closest('.pole') as HTMLElement | null;\r\n        if (!nodeDiv) return;\r\n        // Ignorer les clics sur √©l√©ments interactifs (g√©r√©s par leurs propres handlers)\r\n        const target = e.target as HTMLElement;\r\n        if (\r\n            target.tagName === 'SELECT' ||\r\n            target.tagName === 'INPUT' ||\r\n            target.classList.contains('pole-menu') ||\r\n            target.classList.contains('pole-connect-btn')\r\n        ) {\r\n            return;\r\n        }\r\n        e.stopPropagation();\r\n        const actualNode: KairosNode | null = cm.getNodeFromElement(e.target);\r\n        if (!actualNode) return;\r\n\r\n        // Retirer le halo d'import si pr√©sent\r\n        if (actualNode.newlyImported) {\r\n            actualNode.newlyImported = false;\r\n            nodeDiv.classList.remove('newly-imported');\r\n        }\r\n\r\n        // Stopper le pulse friction\r\n        if (nodeDiv.classList.contains('friction-vignette') && !nodeDiv.classList.contains('friction-seen')) {\r\n            nodeDiv.classList.add('friction-seen');\r\n        }\r\n\r\n        // Ctrl+Clic pour s√©lection multiple\r\n        if (e.ctrlKey) {\r\n            const checkbox = nodeDiv.querySelector('.node-checkbox') as HTMLInputElement | null;\r\n            const isCurrentlySelected = cm.interaction.selectedNodes.has(actualNode.id);\r\n            cm.toggleNodeSelection(actualNode, !isCurrentlySelected);\r\n            if (checkbox) checkbox.checked = !isCurrentlySelected;\r\n            return;\r\n        }\r\n\r\n        if (cm.interaction.connectionMode) {\r\n            if (!cm.interaction.connectionFromNode) {\r\n                cm.enterConnectionMode(actualNode);\r\n                cm.polesContainer.classList.remove('connection-mode-waiting');\r\n            } else {\r\n                cm.showConnectionTypeMenu(cm.interaction.connectionFromNode, actualNode, e.clientX, e.clientY);\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\n/**\r\n * Cr√©e une nouvelle vignette\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {number} x - Position X\r\n * @param {number} y - Position Y\r\n * @param {string} text - Texte de la vignette\r\n * @param {string} status - Statut (neutral, priority)\r\n * @param {Array} tags - Tags\r\n * @param {boolean} skipAutoPosition - D√©sactiver le positionnement auto\r\n * @param {Object} options - Options suppl√©mentaires\r\n * @returns {Object} Node cr√©√©\r\n */\r\nexport function createNode(\r\n    cm: any,\r\n    x: number,\r\n    y: number,\r\n    text: string = '',\r\n    status: string = 'neutral',\r\n    tags: string[] = [],\r\n    skipAutoPosition: boolean = false,\r\n    options: CreateNodeOptions = {},\r\n): KairosNode {\r\n    // Trouver une position libre si le positionnement automatique est activ√©\r\n    let finalPos = { x, y };\r\n    if (!skipAutoPosition) {\r\n        finalPos = cm.findFreePosition(x, y);\r\n        console.log(`Position ajust√©e: (${x}, ${y}) ‚Üí (${finalPos.x}, ${finalPos.y})`);\r\n    }\r\n\r\n    const node: KairosNode = {\r\n        id: `n_${crypto.randomUUID()}`,\r\n        x: Math.round(finalPos.x),\r\n        y: Math.round(finalPos.y),\r\n        text: text,\r\n        status: status as KairosNode['status'], // neutral, priority\r\n        tags: tags,\r\n        poleId: null, // ID du p√¥le parent (null si vignette libre)\r\n        created: new Date().toISOString() as unknown as number,\r\n        imported: false,\r\n        newlyImported: options.newlyImported || false, // Halo pour import r√©cent\r\n    } as KairosNode;\r\n\r\n    console.log('Node cr√©√©:', node);\r\n\r\n    cm.state.nodes.push(node);\r\n    cm._nodeMapDirty = true;\r\n    renderNode(cm, node);\r\n\r\n    // √âmettre √©v√©nement pour tracking attracteurs\r\n    document.dispatchEvent(\r\n        new CustomEvent('nodeCreated', {\r\n            detail: { nodeId: node.id },\r\n        }),\r\n    );\r\n\r\n    return node;\r\n}\r\n\r\n/**\r\n * Rend une vignette dans le DOM\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {Object} node - Node √† rendre\r\n */\r\nexport function renderNode(cm: any, node: KairosNode): void {\r\n    const nodeDiv = document.createElement('div');\r\n    let className = `pole status-${node.status}${node.reinjected ? ' reinjected' : ''}${node.synthesized ? ' synthesized' : ''}`;\r\n\r\n    // Ajouter classe pour les vignettes issues de captures\r\n    if (node.captureSource) {\r\n        className += ' from-capture';\r\n        nodeDiv.setAttribute('data-capture-role', node.captureSource.role || 'assistant');\r\n    }\r\n\r\n    // Ajouter classe pour les vignettes nouvellement import√©es (halo)\r\n    if (node.newlyImported) {\r\n        className += ' newly-imported';\r\n    }\r\n\r\n    // Ajouter classe pour les vignettes friction (anti-circularit√©)\r\n    // D√©tection par isFriction ou par tag #friction\r\n    const hasFrictionTag =\r\n        node.tags && node.tags.some((t) => t.toLowerCase() === '#friction' || t.toLowerCase() === 'friction');\r\n    if (node.isFriction || hasFrictionTag) {\r\n        className += ' friction-vignette';\r\n    }\r\n\r\n    nodeDiv.className = className;\r\n\r\n    nodeDiv.id = node.id;\r\n    nodeDiv.style.left = `${node.x}px`;\r\n    nodeDiv.style.top = `${node.y}px`;\r\n\r\n    // En-t√™te\r\n    const header = document.createElement('div');\r\n    header.className = 'pole-header';\r\n\r\n    // Case √† cocher pour s√©lection multiple\r\n    const checkbox = document.createElement('input') as HTMLInputElement;\r\n    checkbox.type = 'checkbox';\r\n    checkbox.className = 'node-checkbox';\r\n    checkbox.tabIndex = -1; // √âviter capture focus clavier\r\n    checkbox.checked = cm.interaction.selectedNodes.has(node.id);\r\n    checkbox.addEventListener('click', (e: Event) => {\r\n        e.stopPropagation();\r\n    });\r\n    checkbox.addEventListener('change', (e: Event) => {\r\n        e.stopPropagation();\r\n        cm.toggleNodeSelection(node, checkbox.checked);\r\n    });\r\n\r\n    // Select de statut\r\n    const statusSelect = document.createElement('select') as HTMLSelectElement;\r\n    statusSelect.className = 'pole-status-select-inline';\r\n    statusSelect.tabIndex = -1; // √âviter capture focus clavier\r\n    statusSelect.innerHTML = `\r\n          <option value=\"neutral\">\\u25CB</option>\r\n          <option value=\"priority\">\\uD83C\\uDFAF</option>\r\n      `;\r\n    statusSelect.value = node.status || 'neutral';\r\n    statusSelect.addEventListener('click', (e: Event) => {\r\n        e.stopPropagation();\r\n    });\r\n    statusSelect.addEventListener('change', (e: Event) => {\r\n        e.stopPropagation();\r\n        // Passe par cycleNodeStatus (hooked) pour le single-priority + save + history\r\n        cm.cycleNodeStatus(node);\r\n        // Synchroniser le select (cycleNodeStatus a mis √† jour node.status)\r\n        statusSelect.value = node.status;\r\n    });\r\n\r\n    // Bouton de connexion (visible au survol)\r\n    const connectBtn = document.createElement('span');\r\n    connectBtn.className = 'pole-connect-btn';\r\n    connectBtn.textContent = 'üîó';\r\n    connectBtn.title = 'Cr√©er une connexion (L)';\r\n    connectBtn.addEventListener('click', (e: Event) => {\r\n        e.stopPropagation();\r\n        cm.enterConnectionMode(node);\r\n        cm.polesContainer.classList.add('connection-mode-waiting');\r\n    });\r\n\r\n    const menu = document.createElement('span');\r\n    menu.className = 'pole-menu';\r\n    menu.textContent = '‚ãÆ';\r\n    menu.addEventListener('click', (e: MouseEvent) => {\r\n        e.stopPropagation();\r\n        cm.showNodeMenu(node, e.clientX, e.clientY);\r\n    });\r\n\r\n    header.appendChild(checkbox);\r\n    header.appendChild(statusSelect);\r\n    header.appendChild(connectBtn);\r\n    header.appendChild(menu);\r\n\r\n    // M√©tadonn√©es capture (si applicable)\r\n    let captureMeta: HTMLDivElement | null = null;\r\n    if (node.captureSource) {\r\n        captureMeta = document.createElement('div');\r\n        captureMeta.className = 'capture-meta-bar';\r\n\r\n        const platformIcons: Record<string, string> = {\r\n            claude: 'üü†',\r\n            chatgpt: 'üü¢',\r\n            openai: 'üü¢',\r\n            gemini: 'üîµ',\r\n            unknown: 'üí¨',\r\n        };\r\n        const platformIcon = platformIcons[node.captureSource.platform?.toLowerCase()] || platformIcons.unknown;\r\n\r\n        const roleLabels: Record<string, string> = {\r\n            user: 'User',\r\n            thinking: 'Thinking',\r\n            assistant: 'Assistant',\r\n        };\r\n        const roleLabel = roleLabels[node.captureSource.role] || 'Message';\r\n\r\n        captureMeta.innerHTML = `\r\n      <span class=\"capture-meta-platform\">${platformIcon} ${node.captureSource.platform || 'unknown'}</span>\r\n      <span class=\"capture-meta-role capture-role-${node.captureSource.role}\">${roleLabel}</span>\r\n    `;\r\n    }\r\n\r\n    // Contenu\r\n    const content = document.createElement('div');\r\n    content.className = 'pole-content';\r\n    content.textContent = node.text || 'Nouvelle vignette';\r\n\r\n    // Tags\r\n    const tagsContainer = document.createElement('div');\r\n    tagsContainer.className = 'pole-tags';\r\n    node.tags.forEach((tag) => {\r\n        const tagSpan = document.createElement('span');\r\n        tagSpan.className = 'pole-tag';\r\n        tagSpan.textContent = tag;\r\n        tagsContainer.appendChild(tagSpan);\r\n    });\r\n\r\n    // Accent bar gradient (premier enfant ‚Äî bande color√©e en haut du n≈ìud)\r\n    const accentBar = document.createElement('div');\r\n    accentBar.className = 'node-accent-bar';\r\n    nodeDiv.appendChild(accentBar);\r\n\r\n    // Ports de connexion (visibles au hover)\r\n    ['top', 'bottom', 'left', 'right'].forEach((pos) => {\r\n        const port = document.createElement('div');\r\n        port.className = `node-port port-${pos}`;\r\n        nodeDiv.appendChild(port);\r\n    });\r\n\r\n    nodeDiv.appendChild(header);\r\n    if (captureMeta) {\r\n        nodeDiv.appendChild(captureMeta);\r\n    }\r\n    nodeDiv.appendChild(content);\r\n    nodeDiv.appendChild(tagsContainer);\r\n\r\n    // Event delegation : les √©v√©nements mousedown/click/dblclick sont g√©r√©s\r\n    // par un seul listener sur polesContainer (voir ensureNodeEventDelegation)\r\n    ensureNodeEventDelegation(cm);\r\n\r\n    cm.polesContainer.appendChild(nodeDiv);\r\n}\r\n\r\n/**\r\n * Met √† jour l'affichage d'une vignette\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {Object} node - Node √† mettre √† jour\r\n */\r\nexport function updateNodeElement(cm: any, node: KairosNode): void {\r\n    const nodeDiv = document.getElementById(node.id);\r\n    if (!nodeDiv) return;\r\n\r\n    // Mettre √† jour la classe de statut en pr√©servant TOUTES les classes dynamiques\r\n    const isSelected = cm.interaction.selectedNodes.has(node.id);\r\n    const isReinjected = node.reinjected ? ' reinjected' : '';\r\n    const isSynthesized = node.synthesized ? ' synthesized' : '';\r\n    const isFromCapture = node.captureSource ? ' from-capture' : '';\r\n    const isNewlyImported = node.newlyImported ? ' newly-imported' : '';\r\n    const hasFrictionTag =\r\n        node.tags && node.tags.some((t) => t.toLowerCase() === '#friction' || t.toLowerCase() === 'friction');\r\n    const isFriction = node.isFriction || hasFrictionTag ? ' friction-vignette' : '';\r\n    nodeDiv.className = `pole status-${node.status}${isSelected ? ' selected' : ''}${isReinjected}${isSynthesized}${isFromCapture}${isNewlyImported}${isFriction}`;\r\n\r\n    // Mettre √† jour l'attribut de r√¥le pour les captures\r\n    if (node.captureSource) {\r\n        nodeDiv.setAttribute('data-capture-role', node.captureSource.role || 'assistant');\r\n\r\n        // Ajouter/mettre √† jour la barre de m√©tadonn√©es si elle n'existe pas\r\n        let captureMeta = nodeDiv.querySelector('.capture-meta-bar') as HTMLElement | null;\r\n        if (!captureMeta) {\r\n            captureMeta = document.createElement('div');\r\n            captureMeta.className = 'capture-meta-bar';\r\n\r\n            // Ins√©rer apr√®s le header\r\n            const header = nodeDiv.querySelector('.pole-header');\r\n            if (header && header.nextSibling) {\r\n                nodeDiv.insertBefore(captureMeta, header.nextSibling);\r\n            } else {\r\n                nodeDiv.appendChild(captureMeta);\r\n            }\r\n        }\r\n\r\n        const platformIcons: Record<string, string> = {\r\n            claude: 'üü†',\r\n            chatgpt: 'üü¢',\r\n            openai: 'üü¢',\r\n            gemini: 'üîµ',\r\n            unknown: 'üí¨',\r\n        };\r\n        const platformIcon = platformIcons[node.captureSource.platform?.toLowerCase()] || platformIcons.unknown;\r\n\r\n        const roleLabels: Record<string, string> = {\r\n            user: 'User',\r\n            thinking: 'Thinking',\r\n            assistant: 'Assistant',\r\n        };\r\n        const roleLabel = roleLabels[node.captureSource.role] || 'Message';\r\n\r\n        captureMeta.innerHTML = `\r\n      <span class=\"capture-meta-platform\">${platformIcon} ${node.captureSource.platform || 'unknown'}</span>\r\n      <span class=\"capture-meta-role capture-role-${node.captureSource.role}\">${roleLabel}</span>\r\n    `;\r\n    }\r\n\r\n    // Mettre √† jour la position\r\n    nodeDiv.style.left = `${node.x}px`;\r\n    nodeDiv.style.top = `${node.y}px`;\r\n\r\n    // Mettre √† jour le badge de statut\r\n    const statusBadge = nodeDiv.querySelector('.pole-status-badge');\r\n    if (statusBadge) {\r\n        statusBadge.textContent = getStatusIcon(node.status);\r\n    }\r\n\r\n    // Mettre √† jour le select de statut (important pour single-priority)\r\n    const statusSelect = nodeDiv.querySelector('.pole-status-select-inline') as HTMLSelectElement | null;\r\n    if (statusSelect && statusSelect.value !== node.status) {\r\n        statusSelect.value = node.status;\r\n    }\r\n\r\n    // Mettre √† jour le contenu\r\n    const content = nodeDiv.querySelector('.pole-content');\r\n    if (content) {\r\n        content.textContent = node.text || 'Nouvelle vignette';\r\n        // Le texte peut changer la hauteur ‚Äî invalider le cache de dimensions\r\n        invalidateNodeSizeCache(node.id);\r\n    }\r\n\r\n    // Mettre √† jour les tags\r\n    const tagsContainer = nodeDiv.querySelector('.pole-tags');\r\n    if (tagsContainer) {\r\n        tagsContainer.innerHTML = '';\r\n        node.tags.forEach((tag) => {\r\n            const tagSpan = document.createElement('span');\r\n            tagSpan.className = 'pole-tag';\r\n            tagSpan.textContent = tag;\r\n            tagsContainer.appendChild(tagSpan);\r\n        });\r\n    }\r\n\r\n    // Redessiner les connexions\r\n    cm.renderAllConnections();\r\n}\r\n\r\n/**\r\n * Supprime une vignette\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n * @param {Object} node - Node √† supprimer\r\n * @param {boolean} skipBlurWebview - Ne pas blur la webview (pour suppression en lot)\r\n */\r\nexport async function deleteNode(cm: any, node: KairosNode, skipBlurWebview: boolean = false): Promise<void> {\r\n    console.log('[Canvas] deleteNode called for:', node.id);\r\n\r\n    const nodeEl = document.getElementById(node.id);\r\n\r\n    // Si le node supprim√© est en cours d'√©dition, fermer le modal\r\n    if (cm.interaction.selectedNodeForMenu && cm.interaction.selectedNodeForMenu.id === node.id) {\r\n        cm.interaction.isNewNodeBeingEdited = false;\r\n        cm.editModal.style.display = 'none';\r\n        cm.interaction.selectedNodeForMenu = null;\r\n    }\r\n\r\n    // Retirer de la s√©lection si s√©lectionn√©\r\n    if (cm.interaction.selectedNodes.has(node.id)) {\r\n        cm.interaction.selectedNodes.delete(node.id);\r\n    }\r\n\r\n    // Supprimer les connexions li√©es de l'√©tat\r\n    cm.state.connections = cm.state.connections.filter(\r\n        (conn: KairosConnection) => conn.from !== node.id && conn.to !== node.id,\r\n    );\r\n\r\n    // Supprimer le node de l'√©tat\r\n    cm.state.nodes = cm.state.nodes.filter((n: KairosNode) => n.id !== node.id);\r\n    cm._nodeMapDirty = true;\r\n    invalidateNodeSizeCache(node.id);\r\n    console.log('[Canvas] Node removed from state, remaining nodes:', cm.state.nodes.length);\r\n\r\n    // Redessiner les connexions\r\n    cm.renderAllConnections();\r\n\r\n    // √âmettre l'√©v√©nement de suppression\r\n    document.dispatchEvent(new CustomEvent('nodeDeleted', { detail: { nodeId: node.id } }));\r\n\r\n    // ELECTRON FIX: Cacher d'abord, supprimer le DOM apr√®s un d√©lai\r\n    // Cela laisse Electron stabiliser son contexte de focus\r\n    if (nodeEl) {\r\n        nodeEl.style.visibility = 'hidden';\r\n        nodeEl.style.pointerEvents = 'none';\r\n\r\n        setTimeout(() => {\r\n            nodeEl.remove();\r\n            console.log('[Canvas] DOM element removed after delay');\r\n        }, 150);\r\n    }\r\n\r\n    // Mettre √† jour la toolbar de s√©lection (affichage dynamique)\r\n    cm.updateSelectionToolbar();\r\n\r\n    // ELECTRON FIX: Forcer le blur de la webview pour lib√©rer le focus clavier\r\n    // skipBlurWebview permet d'√©viter les appels multiples lors de suppression en lot\r\n    if (!skipBlurWebview) {\r\n        blurWebview(cm);\r\n    }\r\n}\r\n\r\n/**\r\n * Supprime toutes les vignettes s√©lectionn√©es\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport async function deleteSelectedNodes(cm: any): Promise<void> {\r\n    const selectedIds: string[] = Array.from(cm.interaction.selectedNodes);\r\n    const count = selectedIds.length;\r\n\r\n    if (count === 0) return;\r\n\r\n    const confirmMsg = count === 1 ? 'Supprimer cette vignette ?' : `Supprimer ces ${count} vignettes ?`;\r\n\r\n    if (!confirm(confirmMsg)) return;\r\n\r\n    console.log(`[Canvas] Deleting ${count} selected nodes`);\r\n\r\n    // Sauvegarder AVANT la suppression pour le undo (un seul √©tat pour tout le lot)\r\n    // Note: on utilise cm.deleteNode() (pas la fonction locale) pour passer par le hook\r\n    // de assisted-app.ts qui g√®re saveData + metrics + history\r\n    for (const nodeId of selectedIds) {\r\n        const node = cm.state.nodes.find((n: KairosNode) => n.id === nodeId);\r\n        if (node) {\r\n            await cm.deleteNode(node, true); // true = skip blur, passe par le hook\r\n        }\r\n    }\r\n\r\n    // Un seul blur √† la fin\r\n    blurWebview(cm);\r\n\r\n    console.log(`[Canvas] Deleted ${count} nodes`);\r\n}\r\n\r\n/**\r\n * Force le blur de la webview LLM pour √©viter qu'elle capture les √©v√©nements clavier\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport async function blurWebview(_cm: any): Promise<void> {\r\n    const webview = document.getElementById('llm-webview') as HTMLElement | null;\r\n    if (webview) {\r\n        try {\r\n            // Blur l'√©l√©ment webview lui-m√™me\r\n            webview.blur();\r\n\r\n            // Ex√©cuter un blur dans le contexte de la webview\r\n            (webview as any)\r\n                .executeJavaScript(\r\n                    `\r\n        if (document.activeElement) {\r\n          document.activeElement.blur();\r\n        }\r\n        document.body.focus();\r\n      `,\r\n                )\r\n                .catch(() => {});\r\n\r\n            console.log('[Canvas] Webview blurred after deletion');\r\n        } catch (e) {\r\n            console.warn('[Canvas] Could not blur webview:', e);\r\n        }\r\n    }\r\n\r\n    // Appel IPC pour forcer le focus sur la fen√™tre principale\r\n    if ((window as any).fgraph && (window as any).fgraph.focusMainWindow) {\r\n        try {\r\n            await (window as any).fgraph.focusMainWindow();\r\n            console.log('[Canvas] Main window focus requested via IPC');\r\n        } catch (e) {\r\n            console.warn('[Canvas] Could not focus main window:', e);\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Force un refresh complet du canvas en recr√©ant tous les √©l√©ments DOM\r\n * Workaround pour le bug de focus Electron apr√®s suppression\r\n * @param {CanvasManager} cm - Instance du CanvasManager\r\n */\r\nexport function forceRefreshCanvas(cm: any): void {\r\n    console.log('[Canvas] Force refresh - recreating all DOM elements');\r\n\r\n    // Invalider tous les caches\r\n    cm._nodeMapDirty = true;\r\n    invalidateNodeSizeCache();\r\n\r\n    // 1. Vider le container des nodes\r\n    cm.polesContainer.innerHTML = '';\r\n\r\n    // 2. Vider les connexions SVG\r\n    cm.svgConnections.innerHTML = '';\r\n\r\n    // 3. Re-rendre tous les nodes depuis l'√©tat\r\n    cm.state.nodes.forEach((node: KairosNode) => renderNode(cm, node));\r\n\r\n    // 4. Re-rendre toutes les connexions\r\n    cm.renderAllConnections();\r\n\r\n    // 5. Reset focus sur le renderer principal\r\n    window.focus();\r\n    document.body.focus();\r\n\r\n    console.log('[Canvas] Force refresh complete');\r\n}\r\n\r\n/**\r\n * Retourne l'ic√¥ne correspondant √† un statut\r\n * @param {string} status - Statut du node\r\n * @returns {string} Ic√¥ne\r\n */\r\nexport function getStatusIcon(status: string): string {\r\n    const icons: Record<string, string> = {\r\n        neutral: '\\u25CB', // U+25CB White circle\r\n        priority: '\\uD83C\\uDFAF', // U+1F3AF Target emoji\r\n    };\r\n    return icons[status] || '\\u25CB';\r\n}\r\n\r\n/**\r\n * Fait cycler le statut d'un node.\r\n * Contrainte structurelle : une seule vignette prioritaire √† la fois.\r\n * Si le node passe en priorit√©, toute autre vignette prioritaire revient en neutre.\r\n */\r\nexport function cycleNodeStatus(cm: any, node: KairosNode): void {\r\n    const statusCycle: KairosNode['status'][] = ['neutral', 'priority'];\r\n    const currentIndex = statusCycle.indexOf(node.status);\r\n    const newStatus = statusCycle[(currentIndex + 1) % statusCycle.length];\r\n\r\n    if (newStatus === 'priority') {\r\n        // R√©voquer toute priorit√© existante (contrainte : 1 seule ancre)\r\n        for (const other of cm.state.nodes) {\r\n            if (other.id !== node.id && other.status === 'priority') {\r\n                other.status = 'neutral';\r\n                updateNodeElement(cm, other);\r\n            }\r\n        }\r\n    }\r\n\r\n    node.status = newStatus;\r\n    updateNodeElement(cm, node);\r\n}\r\n","// Gestion du canvas (nodes/vignettes, connexions)\r\n\r\nimport type { KairosNode, KairosConnection, CanvasData } from './types/kairos.js';\r\n\r\nimport { MiniMap } from './canvas/minimap.js';\r\nimport { getData as _getData, loadData as _loadData, clearCanvas } from './canvas/persistence.js';\r\nimport {\r\n    toggleStatusFilter as _toggleStatusFilter,\r\n    applyFilters as _applyFilters,\r\n    updateConnectionsVisibility as _updateConnectionsVisibility,\r\n} from './canvas/filters.js';\r\nimport {\r\n    detectCollisions as _detectCollisions,\r\n    resolveAllCollisions as _resolveAllCollisions,\r\n} from './canvas/collisions.js';\r\nimport {\r\n    checkCollision as _checkCollision,\r\n    isPositionFree as _isPositionFree,\r\n    findFreePosition as _findFreePosition,\r\n    getVisibleBottomPosition as _getVisibleBottomPosition,\r\n    adjustPositionForCollisions as _adjustPositionForCollisions,\r\n    getSmartImportPosition as _getSmartImportPosition,\r\n    relocateSynthesizedNodes as _relocateSynthesizedNodes,\r\n    animateNodesToPositions as _animateNodesToPositions,\r\n} from './canvas/layout.js';\r\nimport {\r\n    applyTreeLayout as _applyTreeLayout,\r\n    fitViewportToNodes as _fitViewportToNodes,\r\n} from './canvas/tree-layout.js';\r\nimport {\r\n    handleZoom as _handleZoom,\r\n    applyTransform as _applyTransform,\r\n    startPan as _startPan,\r\n    updatePan as _updatePan,\r\n    stopPan as _stopPan,\r\n    centerOnNode as _centerOnNode,\r\n} from './canvas/viewport.js';\r\nimport {\r\n    enterConnectionMode as _enterConnectionMode,\r\n    exitConnectionMode as _exitConnectionMode,\r\n    toggleConnectionModeWaiting as _toggleConnectionModeWaiting,\r\n    createConnection as _createConnection,\r\n    deleteConnection as _deleteConnection,\r\n    queueConnection as _queueConnection,\r\n    processPendingConnections as _processPendingConnections,\r\n    renderConnection as _renderConnection,\r\n    renderAllConnections as _renderAllConnections,\r\n    forceRefreshConnections as _forceRefreshConnections,\r\n    rebuildAllConnections as _rebuildAllConnections,\r\n    updateConnections as _updateConnections,\r\n    updateNodeConnections as _updateNodeConnections,\r\n    getNodeCenter as _getNodeCenter,\r\n    scheduleConnectionRender as _scheduleConnectionRender,\r\n    waitForDOMStable as _waitForDOMStable,\r\n} from './canvas/connections.js';\r\nimport {\r\n    toggleNodeSelection as _toggleNodeSelection,\r\n    updateNodeSelectionVisual as _updateNodeSelectionVisual,\r\n    clearSelection as _clearSelection,\r\n    selectAllNodes as _selectAllNodes,\r\n    getConnectedNodes as _getConnectedNodes,\r\n    updateSelectionToolbar as _updateSelectionToolbar,\r\n    createSelectionToolbar as _createSelectionToolbar,\r\n} from './canvas/selection.js';\r\nimport {\r\n    createContextMenu as _createContextMenu,\r\n    showContextMenu as _showContextMenu,\r\n    hideContextMenu as _hideContextMenu,\r\n    createNodeMenu as _createNodeMenu,\r\n    showNodeMenu as _showNodeMenu,\r\n    hideNodeMenu as _hideNodeMenu,\r\n    handleNodeMenuAction as _handleNodeMenuAction,\r\n    createEditModal as _createEditModal,\r\n    showCreateModal as _showCreateModal,\r\n    showEditModal as _showEditModal,\r\n    hideEditModal as _hideEditModal,\r\n    saveEditModal as _saveEditModal,\r\n    blurAllNodeElements as _blurAllNodeElements,\r\n    setWebviewInert as _setWebviewInert,\r\n    createConnectionTypeMenu as _createConnectionTypeMenu,\r\n    showConnectionTypeMenu as _showConnectionTypeMenu,\r\n    hideConnectionTypeMenu as _hideConnectionTypeMenu,\r\n    handleConnectionTypeSelection as _handleConnectionTypeSelection,\r\n    createConnectionContextMenu as _createConnectionContextMenu,\r\n    showConnectionContextMenu as _showConnectionContextMenu,\r\n    hideConnectionContextMenu as _hideConnectionContextMenu,\r\n} from './canvas/menus.js';\r\nimport {\r\n    getNodeFromElement as _getNodeFromElement,\r\n    startDragNode as _startDragNode,\r\n    cleanupDrag as _cleanupDrag,\r\n} from './canvas/interactions.js';\r\nimport {\r\n    createNode as _createNode,\r\n    renderNode as _renderNode,\r\n    updateNodeElement as _updateNodeElement,\r\n    deleteNode as _deleteNode,\r\n    deleteSelectedNodes as _deleteSelectedNodes,\r\n    blurWebview as _blurWebview,\r\n    forceRefreshCanvas as _forceRefreshCanvas,\r\n    getStatusIcon as _getStatusIcon,\r\n    cycleNodeStatus as _cycleNodeStatus,\r\n} from './canvas/nodes.js';\r\n\r\ninterface PendingConnection {\r\n    fromId: string;\r\n    toId: string;\r\n    type: string;\r\n    mechanism: string | null;\r\n}\r\n\r\ninterface CanvasStateInternal {\r\n    nodes: KairosNode[];\r\n    poles: any[];\r\n    connections: KairosConnection[];\r\n    pendingConnections: PendingConnection[];\r\n    zoom: number;\r\n    panX: number;\r\n    panY: number;\r\n    mode: string;\r\n    statusFilters: Set<string>;\r\n}\r\n\r\ninterface InteractionState {\r\n    isDragging: boolean;\r\n    isPanning: boolean;\r\n    draggedNode: KairosNode | null;\r\n    draggedNodes: KairosNode[];\r\n    dragStartX: number;\r\n    dragStartY: number;\r\n    connectionMode: boolean;\r\n    connectionFromNode: KairosNode | null;\r\n    selectedNodeForMenu: KairosNode | null;\r\n    selectedConnectionForMenu: KairosConnection | null;\r\n    selectedNodes: Set<string>;\r\n    dragMoveListener: ((e: MouseEvent) => void) | null;\r\n    dragUpListener: ((e: MouseEvent) => void) | null;\r\n    dragRafId: number | null;\r\n    panRafId: number | null;\r\n}\r\n\r\nexport class CanvasManager {\r\n    polesContainer: HTMLElement | null;\r\n    svgConnections: SVGElement | null;\r\n    canvasArea: HTMLElement | null;\r\n    state: CanvasStateInternal;\r\n    interaction: InteractionState;\r\n    contextMenu: HTMLElement | null;\r\n    nodeMenu: HTMLElement | null;\r\n    editModal: HTMLElement | null;\r\n    connectionTypeMenu: HTMLElement | null;\r\n    connectionContextMenu: HTMLElement | null;\r\n    minimap: MiniMap | null;\r\n    nodeIdCounter: number;\r\n\r\n    constructor() {\r\n        this.polesContainer = document.getElementById('poles-container');\r\n        this.svgConnections = document.getElementById('connections') as unknown as SVGElement | null;\r\n        this.canvasArea = document.querySelector('.canvas-area');\r\n\r\n        // √âtat du canvas\r\n        this.state = {\r\n            nodes: [], // Vignettes individuelles (id√©es)\r\n            poles: [], // Conteneurs qui regroupent des nodes\r\n            connections: [],\r\n            pendingConnections: [], // Connexions en attente de rendu (apr√®s stabilisation DOM)\r\n            zoom: 1.0,\r\n            panX: 0,\r\n            panY: 0,\r\n            mode: 'explorer',\r\n            statusFilters: new Set(['neutral', 'priority']), // Tous actifs par d√©faut\r\n        };\r\n\r\n        // √âtat de l'interaction\r\n        this.interaction = {\r\n            isDragging: false,\r\n            isPanning: false,\r\n            draggedNode: null,\r\n            draggedNodes: [], // Liste des nodes √† d√©placer (pour d√©placement multiple)\r\n            dragStartX: 0,\r\n            dragStartY: 0,\r\n            connectionMode: false,\r\n            connectionFromNode: null,\r\n            selectedNodeForMenu: null,\r\n            selectedConnectionForMenu: null, // Connexion s√©lectionn√©e pour le menu contextuel\r\n            selectedNodes: new Set(), // Vignettes s√©lectionn√©es (IDs)\r\n            // R√©f√©rences aux listeners de drag pour pouvoir les nettoyer\r\n            dragMoveListener: null,\r\n            dragUpListener: null,\r\n            dragRafId: null,\r\n            panRafId: null,\r\n        };\r\n\r\n        this.contextMenu = null;\r\n        this.nodeMenu = null; // Renomm√© de poleMenu\r\n        this.editModal = null;\r\n        this.connectionTypeMenu = null;\r\n        this.connectionContextMenu = null; // Menu pour clic sur une connexion\r\n        this.minimap = null;\r\n\r\n        // Compteur unique pour les IDs de nodes (√©vite les collisions avec Date.now())\r\n        this.nodeIdCounter = 0;\r\n\r\n        // Cache de lookup nodes par ID (invalid√© par _nodeMapDirty)\r\n        (this as any)._nodeMap = null;\r\n        (this as any)._nodeMapDirty = true;\r\n\r\n        this.init();\r\n    }\r\n    // ===== CONNEXIONS =====\r\n    // Impl√©mentation dans ./canvas/connections.js\r\n\r\n    updateNodeConnections(nodeId: string): void {\r\n        _updateNodeConnections(this, nodeId);\r\n    }\r\n\r\n    init(): void {\r\n        this.setupEventListeners();\r\n        this.createContextMenu();\r\n        this.createNodeMenu(); // Renomm√© de createPoleMenu\r\n        this.createEditModal();\r\n        this.createConnectionTypeMenu();\r\n        this.createConnectionContextMenu();\r\n        this.minimap = new MiniMap(this);\r\n        console.log('CanvasManager initialis√©');\r\n    }\r\n\r\n    setupEventListeners(): void {\r\n        // Clic droit pour cr√©er un p√¥le (sur canvas-area pour couvrir toute la zone)\r\n        this.canvasArea!.addEventListener('contextmenu', (e: MouseEvent) => {\r\n            // Ne pas afficher le menu si on clique sur une vignette ou un √©l√©ment interactif\r\n            if ((e.target as HTMLElement).closest('.pole')) {\r\n                return; // Laisser le menu de la vignette se g√©rer\r\n            }\r\n            e.preventDefault();\r\n            // Convertir les coordonn√©es √©cran en coordonn√©es canvas\r\n            const rect: DOMRect = this.canvasArea!.getBoundingClientRect();\r\n            const x: number = (e.clientX - rect.left - this.state.panX) / this.state.zoom;\r\n            const y: number = (e.clientY - rect.top - this.state.panY) / this.state.zoom;\r\n            this.showContextMenu(x, y, e.clientX, e.clientY);\r\n        });\r\n\r\n        // Pan avec clic milieu ou clic gauche sur le fond (pas sur un p√¥le)\r\n        this.canvasArea!.addEventListener('mousedown', (e: MouseEvent) => {\r\n            // Clic milieu - pan depuis n'importe o√π\r\n            if (e.button === 1) {\r\n                e.preventDefault();\r\n                this.startPan(e);\r\n                return;\r\n            }\r\n\r\n            // Clic gauche sur le fond (canvas-area, poles-container, ou SVG connections)\r\n            // mais pas sur une vignette, un p√¥le ou une connexion\r\n            if (e.button === 0) {\r\n                const isBackground: boolean =\r\n                    e.target === this.canvasArea ||\r\n                    e.target === this.polesContainer ||\r\n                    e.target === this.svgConnections;\r\n                if (isBackground && !this.interaction.draggedNode && !this.interaction.isDragging) {\r\n                    e.preventDefault();\r\n                    // Si en mode connexion, annuler au lieu de pan\r\n                    if (this.interaction.connectionMode) {\r\n                        this.exitConnectionMode();\r\n                        return;\r\n                    }\r\n                    this.startPan(e);\r\n                }\r\n            }\r\n        });\r\n\r\n        document.addEventListener('mousemove', (e: MouseEvent) => {\r\n            if (this.interaction.isPanning && !this.interaction.isDragging && !this.interaction.draggedNode) {\r\n                if (this.interaction.panRafId) {\r\n                    cancelAnimationFrame(this.interaction.panRafId);\r\n                }\r\n                this.interaction.panRafId = requestAnimationFrame(() => {\r\n                    this.interaction.panRafId = null;\r\n                    if (this.interaction.isPanning) {\r\n                        this.updatePan(e);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n\r\n        document.addEventListener('mouseup', () => {\r\n            if (this.interaction.isPanning) {\r\n                this.stopPan();\r\n            }\r\n        });\r\n\r\n        // Zoom avec molette - Sur le document entier pour capturer partout\r\n        document.addEventListener(\r\n            'wheel',\r\n            (e: WheelEvent) => {\r\n                // V√©rifier si la souris est sur la zone canvas\r\n                const canvasArea: HTMLElement | null = document.querySelector('.canvas-area');\r\n                if (canvasArea && canvasArea.contains(e.target as Node)) {\r\n                    e.preventDefault();\r\n                    this.handleZoom(e);\r\n                }\r\n            },\r\n            { passive: false },\r\n        );\r\n\r\n        // Raccourci clavier L pour activer le mode connexion\r\n        document.addEventListener('keydown', (e: KeyboardEvent) => {\r\n            // Ignorer si on est dans un input/textarea\r\n            if (\r\n                (e.target as HTMLElement).tagName === 'INPUT' ||\r\n                (e.target as HTMLElement).tagName === 'TEXTAREA' ||\r\n                (e.target as HTMLElement).tagName === 'SELECT'\r\n            ) {\r\n                return;\r\n            }\r\n\r\n            // Touche L pour activer le mode connexion\r\n            if (e.key === 'l' || e.key === 'L') {\r\n                e.preventDefault();\r\n                this.toggleConnectionModeWaiting();\r\n            }\r\n\r\n            // √âchap pour annuler le mode connexion et fermer les menus\r\n            if (e.key === 'Escape') {\r\n                if (this.interaction.connectionMode) {\r\n                    this.exitConnectionMode();\r\n                }\r\n                // Fermer tous les menus ouverts\r\n                this.hideContextMenu();\r\n                this.hideNodeMenu();\r\n                this.hideConnectionTypeMenu();\r\n                this.hideConnectionContextMenu();\r\n            }\r\n        });\r\n\r\n        // Fermer les menus en cliquant ailleurs\r\n        document.addEventListener('click', (e: MouseEvent) => {\r\n            // IMPORTANT: Ne jamais toucher au modal d'√©dition ici\r\n            // Le modal a ses propres boutons (Annuler/Sauvegarder) pour se fermer.\r\n            // Si on laisse ce gestionnaire global fermer le modal, il peut appeler hideEditModal()\r\n            // qui r√©initialise selectedPoleForMenu √† null AVANT que le bouton Sauvegarder\r\n            // ne puisse traiter son clic, causant l'erreur \"Aucun p√¥le s√©lectionn√©\".\r\n            // Solution: Sortir imm√©diatement si le clic est dans le modal.\r\n            if (this.editModal && this.editModal.contains(e.target as Node)) {\r\n                return;\r\n            }\r\n\r\n            // Fermer les autres menus contextuels si on clique ailleurs\r\n            if (this.contextMenu && !this.contextMenu.contains(e.target as Node)) {\r\n                this.hideContextMenu();\r\n            }\r\n            if (this.nodeMenu && !this.nodeMenu.contains(e.target as Node)) {\r\n                this.hideNodeMenu();\r\n            }\r\n            if (this.connectionTypeMenu && !this.connectionTypeMenu.contains(e.target as Node)) {\r\n                this.hideConnectionTypeMenu();\r\n            }\r\n            if (this.connectionContextMenu && !this.connectionContextMenu.contains(e.target as Node)) {\r\n                this.hideConnectionContextMenu();\r\n            }\r\n        });\r\n    }\r\n\r\n    // ===== LAYOUT / POSITIONNEMENT =====\r\n    // Impl√©mentation dans ./canvas/layout.js\r\n\r\n    // Constantes pour le positionnement automatique (conserv√©es comme getters pour compatibilit√©)\r\n    get NODE_WIDTH(): number {\r\n        return 300;\r\n    }\r\n    get NODE_HEIGHT(): number {\r\n        return 120;\r\n    }\r\n    get COLLISION_MARGIN(): number {\r\n        return 20;\r\n    }\r\n\r\n    checkCollision(\r\n        x1: number,\r\n        y1: number,\r\n        w1: number,\r\n        h1: number,\r\n        x2: number,\r\n        y2: number,\r\n        w2: number,\r\n        h2: number,\r\n    ): boolean {\r\n        return _checkCollision(x1, y1, w1, h1, x2, y2, w2, h2);\r\n    }\r\n\r\n    isPositionFree(x: number, y: number): boolean {\r\n        return _isPositionFree(this, x, y);\r\n    }\r\n\r\n    findFreePosition(startX: number, startY: number): { x: number; y: number } {\r\n        return _findFreePosition(this, startX, startY);\r\n    }\r\n\r\n    getVisibleBottomPosition(index: number = 0, total: number = 1): { x: number; y: number } {\r\n        return _getVisibleBottomPosition(this, index, total);\r\n    }\r\n\r\n    getSmartImportPosition(\r\n        connectionTargetId: string | null,\r\n        index: number,\r\n        total: number,\r\n    ): { x: number; y: number } {\r\n        return _getSmartImportPosition(this, connectionTargetId, index, total);\r\n    }\r\n\r\n    relocateSynthesizedNodes(synthesizedIds: string[]): void {\r\n        _relocateSynthesizedNodes(this, synthesizedIds);\r\n    }\r\n\r\n    animateNodesToPositions(\r\n        newPositions: Map<string, { x: number; y: number }>,\r\n        durationMs: number = 500,\r\n        onComplete?: () => void,\r\n    ): void {\r\n        _animateNodesToPositions(this, newPositions, durationMs, onComplete);\r\n    }\r\n\r\n    applyTreeLayout(): void {\r\n        _applyTreeLayout(this);\r\n    }\r\n\r\n    fitViewportToNodes(): void {\r\n        _fitViewportToNodes(this);\r\n    }\r\n\r\n    // ===== NODES / VIGNETTES =====\r\n    // Impl√©mentation dans ./canvas/nodes.js\r\n\r\n    createNode(\r\n        x: number,\r\n        y: number,\r\n        text: string = '',\r\n        status: string = 'neutral',\r\n        tags: string[] = [],\r\n        skipAutoPosition: boolean = false,\r\n        options: Record<string, any> = {},\r\n    ): KairosNode {\r\n        return _createNode(this, x, y, text, status, tags, skipAutoPosition, options);\r\n    }\r\n\r\n    renderNode(node: KairosNode): void {\r\n        _renderNode(this, node);\r\n    }\r\n\r\n    updateNodeElement(node: KairosNode): void {\r\n        _updateNodeElement(this, node);\r\n    }\r\n\r\n    async deleteNode(node: KairosNode, skipBlurWebview: boolean = false): Promise<void> {\r\n        await _deleteNode(this, node, skipBlurWebview);\r\n    }\r\n\r\n    async deleteSelectedNodes(): Promise<void> {\r\n        await _deleteSelectedNodes(this);\r\n    }\r\n\r\n    async _blurWebview(): Promise<void> {\r\n        await _blurWebview(this);\r\n    }\r\n\r\n    forceRefreshCanvas(): void {\r\n        _forceRefreshCanvas(this);\r\n    }\r\n\r\n    getStatusIcon(status: string): string {\r\n        return _getStatusIcon(status);\r\n    }\r\n\r\n    cycleNodeStatus(node: KairosNode): void {\r\n        _cycleNodeStatus(this, node);\r\n    }\r\n\r\n    // ===== S√âLECTION MULTIPLE =====\r\n    // Impl√©mentation dans ./canvas/selection.js\r\n\r\n    toggleNodeSelection(node: KairosNode, isSelected: boolean): void {\r\n        _toggleNodeSelection(this, node, isSelected);\r\n    }\r\n\r\n    updateNodeSelectionVisual(node: KairosNode): void {\r\n        _updateNodeSelectionVisual(this, node);\r\n    }\r\n\r\n    clearSelection(): void {\r\n        _clearSelection(this);\r\n    }\r\n\r\n    selectAllNodes(): void {\r\n        _selectAllNodes(this);\r\n    }\r\n\r\n    getConnectedNodes(nodeIds: Set<string>): Set<string> {\r\n        return _getConnectedNodes(this, nodeIds);\r\n    }\r\n\r\n    updateSelectionToolbar(): void {\r\n        _updateSelectionToolbar(this);\r\n    }\r\n\r\n    createSelectionToolbar(): HTMLElement {\r\n        return _createSelectionToolbar(this);\r\n    }\r\n\r\n    // ===== DRAG & DROP =====\r\n    // Impl√©mentation dans ./canvas/interactions.js\r\n\r\n    adjustPositionForCollisions(x: number, y: number, excludeNodeId: string): { x: number; y: number } {\r\n        return _adjustPositionForCollisions(this, x, y, excludeNodeId);\r\n    }\r\n\r\n    getNodeFromElement(element: HTMLElement): KairosNode | null {\r\n        return _getNodeFromElement(this, element);\r\n    }\r\n\r\n    startDragNode(e: MouseEvent, node: KairosNode): void {\r\n        _startDragNode(this, e, node);\r\n    }\r\n\r\n    cleanupDrag(): void {\r\n        _cleanupDrag(this);\r\n    }\r\n\r\n    enterConnectionMode(fromNode: KairosNode): void {\r\n        _enterConnectionMode(this, fromNode);\r\n    }\r\n\r\n    exitConnectionMode(): void {\r\n        _exitConnectionMode(this);\r\n    }\r\n\r\n    toggleConnectionModeWaiting(): void {\r\n        _toggleConnectionModeWaiting(this);\r\n    }\r\n\r\n    createConnection(\r\n        fromNode: KairosNode,\r\n        toNode: KairosNode,\r\n        type: string = 'implies',\r\n        mechanism: string | null = null,\r\n    ): void {\r\n        _createConnection(this, fromNode, toNode, type, mechanism);\r\n    }\r\n\r\n    _scheduleConnectionRender(): void {\r\n        _scheduleConnectionRender(this);\r\n    }\r\n\r\n    queueConnection(\r\n        fromNodeId: string,\r\n        toNodeId: string,\r\n        type: string = 'implies',\r\n        mechanism: string | null = null,\r\n    ): void {\r\n        _queueConnection(this, fromNodeId, toNodeId, type, mechanism);\r\n    }\r\n\r\n    processPendingConnections(): void {\r\n        _processPendingConnections(this);\r\n    }\r\n\r\n    _waitForDOMStable(timeout: number = 500): Promise<void> {\r\n        return _waitForDOMStable(this, timeout);\r\n    }\r\n\r\n    deleteConnection(connection: KairosConnection): void {\r\n        _deleteConnection(this, connection);\r\n    }\r\n\r\n    renderAllConnections(): void {\r\n        _renderAllConnections(this);\r\n    }\r\n\r\n    forceRefreshConnections(): void {\r\n        _forceRefreshConnections(this);\r\n    }\r\n\r\n    rebuildAllConnections(): void {\r\n        _rebuildAllConnections(this);\r\n    }\r\n\r\n    updateConnections(): void {\r\n        _updateConnections(this);\r\n    }\r\n\r\n    _getNodeCenter(node: KairosNode): { x: number; y: number } {\r\n        return _getNodeCenter(this, node);\r\n    }\r\n\r\n    renderConnection(connection: KairosConnection): void {\r\n        _renderConnection(this, connection);\r\n    }\r\n\r\n    // ===== NAVIGATION =====\r\n    // Impl√©mentation dans ./canvas/viewport.js\r\n\r\n    handleZoom(e: WheelEvent): void {\r\n        _handleZoom(this, e);\r\n    }\r\n\r\n    applyTransform(): void {\r\n        _applyTransform(this);\r\n    }\r\n\r\n    startPan(e: MouseEvent): void {\r\n        _startPan(this, e);\r\n    }\r\n\r\n    updatePan(e: MouseEvent): void {\r\n        _updatePan(this, e);\r\n    }\r\n\r\n    stopPan(): void {\r\n        _stopPan(this);\r\n    }\r\n\r\n    centerOnNode(node: KairosNode): void {\r\n        _centerOnNode(this, node);\r\n    }\r\n\r\n    // ===== MENUS =====\r\n    // Impl√©mentation dans ./canvas/menus.js\r\n\r\n    createContextMenu(): void {\r\n        _createContextMenu(this);\r\n    }\r\n\r\n    showContextMenu(canvasX: number, canvasY: number, screenX: number, screenY: number): void {\r\n        _showContextMenu(this, canvasX, canvasY, screenX, screenY);\r\n    }\r\n\r\n    hideContextMenu(): void {\r\n        _hideContextMenu(this);\r\n    }\r\n\r\n    createNodeMenu(): void {\r\n        _createNodeMenu(this);\r\n    }\r\n\r\n    showNodeMenu(node: KairosNode, x: number, y: number): void {\r\n        _showNodeMenu(this, node, x, y);\r\n    }\r\n\r\n    hideNodeMenu(): void {\r\n        _hideNodeMenu(this);\r\n    }\r\n\r\n    async handleNodeMenuAction(action: string, node: KairosNode): Promise<void> {\r\n        await _handleNodeMenuAction(this, action, node);\r\n    }\r\n\r\n    createEditModal(): void {\r\n        _createEditModal(this);\r\n    }\r\n\r\n    async showCreateModal(x: number, y: number): Promise<void> {\r\n        await _showCreateModal(this, x, y);\r\n    }\r\n\r\n    _blurAllNodeElements(): void {\r\n        _blurAllNodeElements(this);\r\n    }\r\n\r\n    _setWebviewInert(inert: boolean): void {\r\n        _setWebviewInert(this, inert);\r\n    }\r\n\r\n    async showEditModal(node: KairosNode): Promise<void> {\r\n        await _showEditModal(this, node);\r\n    }\r\n\r\n    hideEditModal(): void {\r\n        _hideEditModal(this);\r\n    }\r\n\r\n    saveEditModal(): void {\r\n        _saveEditModal(this);\r\n    }\r\n\r\n    createConnectionTypeMenu(): void {\r\n        _createConnectionTypeMenu(this);\r\n    }\r\n\r\n    showConnectionTypeMenu(fromNode: KairosNode, toNode: KairosNode, x: number, y: number): void {\r\n        _showConnectionTypeMenu(this, fromNode, toNode, x, y);\r\n    }\r\n\r\n    hideConnectionTypeMenu(): void {\r\n        _hideConnectionTypeMenu(this);\r\n    }\r\n\r\n    handleConnectionTypeSelection(type: string): void {\r\n        _handleConnectionTypeSelection(this, type);\r\n    }\r\n\r\n    createConnectionContextMenu(): void {\r\n        _createConnectionContextMenu(this);\r\n    }\r\n\r\n    showConnectionContextMenu(connection: KairosConnection, x: number, y: number): void {\r\n        _showConnectionContextMenu(this, connection, x, y);\r\n    }\r\n\r\n    hideConnectionContextMenu(): void {\r\n        _hideConnectionContextMenu(this);\r\n    }\r\n\r\n    // ===== GESTION DES COLLISIONS =====\r\n    // Impl√©mentation dans ./canvas/collisions.js\r\n\r\n    detectCollisions(): Array<{ node1: KairosNode; node2: KairosNode }> {\r\n        return _detectCollisions(this);\r\n    }\r\n\r\n    resolveAllCollisions(): number {\r\n        return _resolveAllCollisions(this);\r\n    }\r\n\r\n    // ===== FILTRAGE PAR STATUT =====\r\n    // Impl√©mentation dans ./canvas/filters.js\r\n\r\n    toggleStatusFilter(status: string): void {\r\n        _toggleStatusFilter(this, status);\r\n    }\r\n\r\n    applyFilters(): void {\r\n        _applyFilters(this);\r\n    }\r\n\r\n    updateConnectionsVisibility(): void {\r\n        _updateConnectionsVisibility(this);\r\n    }\r\n\r\n    // ===== DONN√âES =====\r\n    // Impl√©mentation dans ./canvas/persistence.js\r\n\r\n    getData(): CanvasData {\r\n        return _getData(this);\r\n    }\r\n\r\n    loadData(data: CanvasData): void {\r\n        _loadData(this, data);\r\n    }\r\n\r\n    clear(): void {\r\n        clearCanvas(this);\r\n    }\r\n}\r\n\r\n// MiniMap import√©e depuis ./canvas/minimap.js\r\n","/**\r\n * HistoryManager - Gestion de l'historique Undo/Redo\r\n * Sauvegarde les √©tats complets du canvas (nodes + connections)\r\n */\r\n\r\nimport type { KairosNode, KairosConnection } from './types/kairos.js';\r\n\r\ninterface HistoryState {\r\n    nodes: KairosNode[];\r\n    connections: KairosConnection[];\r\n}\r\n\r\ninterface HistoryEntry {\r\n    data: HistoryState;\r\n    action: string;\r\n    timestamp: number;\r\n}\r\n\r\ninterface HistoryStats {\r\n    undoCount: number;\r\n    redoCount: number;\r\n    maxSize: number;\r\n}\r\n\r\n/** Minimal interface for the app object passed to HistoryManager */\r\ninterface HistoryApp {\r\n    canvas: {\r\n        state: {\r\n            nodes: KairosNode[];\r\n            connections: KairosConnection[];\r\n        };\r\n        polesContainer: HTMLElement;\r\n        renderNode(node: KairosNode): void;\r\n        renderAllConnections(): void;\r\n        minimap?: { update(): void } | null;\r\n    };\r\n    saveData(): void | Promise<void>;\r\n    showNotification(message: string): void;\r\n    metrics?: { recalculateDebounced(): void } | null;\r\n}\r\n\r\nexport class HistoryManager {\r\n    app: HistoryApp;\r\n    maxSize: number;\r\n    undoStack: HistoryEntry[];\r\n    redoStack: HistoryEntry[];\r\n    isRestoring: boolean;\r\n\r\n    constructor(app: HistoryApp, maxSize: number = 50) {\r\n        this.app = app;\r\n        this.maxSize = maxSize;\r\n        this.undoStack = []; // √âtats pass√©s\r\n        this.redoStack = []; // √âtats annul√©s\r\n        this.isRestoring = false; // Flag pour √©viter les sauvegardes pendant restore\r\n\r\n        this.setupKeyboardShortcuts();\r\n    }\r\n\r\n    /**\r\n     * Configure les raccourcis clavier Ctrl+Z et Ctrl+Y\r\n     */\r\n    setupKeyboardShortcuts(): void {\r\n        document.addEventListener('keydown', (e: KeyboardEvent) => {\r\n            // Ignorer si on est dans un input/textarea\r\n            if ((e.target as HTMLElement).tagName === 'INPUT' || (e.target as HTMLElement).tagName === 'TEXTAREA') {\r\n                return;\r\n            }\r\n\r\n            // Ctrl+Z : Undo\r\n            if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {\r\n                e.preventDefault();\r\n                this.undo();\r\n            }\r\n\r\n            // Ctrl+Y ou Ctrl+Shift+Z : Redo\r\n            if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'z')) {\r\n                e.preventDefault();\r\n                this.redo();\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Sauvegarde l'√©tat actuel avant une modification\r\n     * @param {string} actionName - Nom de l'action pour debug (optionnel)\r\n     */\r\n    saveState(actionName: string = ''): void {\r\n        // Ne pas sauvegarder pendant une restauration\r\n        if (this.isRestoring) return;\r\n\r\n        const state: HistoryState = this.captureState();\r\n\r\n        // √âviter les doublons cons√©cutifs\r\n        if (this.undoStack.length > 0) {\r\n            const lastState: HistoryEntry = this.undoStack[this.undoStack.length - 1];\r\n            if (this.statesAreEqual(lastState.data, state)) {\r\n                return;\r\n            }\r\n        }\r\n\r\n        this.undoStack.push({\r\n            data: state,\r\n            action: actionName,\r\n            timestamp: Date.now(),\r\n        });\r\n\r\n        // Limiter la taille de la pile\r\n        if (this.undoStack.length > this.maxSize) {\r\n            this.undoStack.shift();\r\n        }\r\n\r\n        // Effacer la pile redo (nouvelle branche d'historique)\r\n        this.redoStack = [];\r\n\r\n        this.updateUI();\r\n\r\n        if (actionName) {\r\n            console.log(`[History] Saved: ${actionName} (${this.undoStack.length} √©tats)`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Capture l'√©tat actuel du canvas\r\n     */\r\n    captureState(): HistoryState {\r\n        return {\r\n            nodes: JSON.parse(JSON.stringify(this.app.canvas.state.nodes)),\r\n            connections: JSON.parse(JSON.stringify(this.app.canvas.state.connections)),\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Compare deux √©tats pour √©viter les doublons\r\n     */\r\n    statesAreEqual(state1: HistoryState, state2: HistoryState): boolean {\r\n        return JSON.stringify(state1) === JSON.stringify(state2);\r\n    }\r\n\r\n    /**\r\n     * Annule la derni√®re action (Undo)\r\n     */\r\n    undo(): void {\r\n        if (this.undoStack.length === 0) {\r\n            this.app.showNotification('Rien √† annuler');\r\n            return;\r\n        }\r\n\r\n        // Sauvegarder l'√©tat actuel dans redo avant de restaurer\r\n        const currentState: HistoryState = this.captureState();\r\n        this.redoStack.push({\r\n            data: currentState,\r\n            action: 'undo',\r\n            timestamp: Date.now(),\r\n        });\r\n\r\n        // R√©cup√©rer et restaurer l'√©tat pr√©c√©dent\r\n        const previousState: HistoryEntry = this.undoStack.pop()!;\r\n        this.restoreState(previousState.data);\r\n\r\n        this.updateUI();\r\n        this.app.showNotification('Action annul√©e \\u21A9');\r\n        console.log(`[History] Undo: ${previousState.action || 'unknown'}`);\r\n    }\r\n\r\n    /**\r\n     * R√©tablit la derni√®re action annul√©e (Redo)\r\n     */\r\n    redo(): void {\r\n        if (this.redoStack.length === 0) {\r\n            this.app.showNotification('Rien √† r√©tablir');\r\n            return;\r\n        }\r\n\r\n        // Sauvegarder l'√©tat actuel dans undo avant de restaurer\r\n        const currentState: HistoryState = this.captureState();\r\n        this.undoStack.push({\r\n            data: currentState,\r\n            action: 'redo',\r\n            timestamp: Date.now(),\r\n        });\r\n\r\n        // R√©cup√©rer et restaurer l'√©tat redo\r\n        const redoState: HistoryEntry = this.redoStack.pop()!;\r\n        this.restoreState(redoState.data);\r\n\r\n        this.updateUI();\r\n        this.app.showNotification('Action r√©tablie \\u21AA');\r\n        console.log('[History] Redo');\r\n    }\r\n\r\n    /**\r\n     * Restaure un √©tat complet\r\n     */\r\n    async restoreState(state: HistoryState): Promise<void> {\r\n        this.isRestoring = true;\r\n\r\n        try {\r\n            // Restaurer les donn√©es\r\n            this.app.canvas.state.nodes = JSON.parse(JSON.stringify(state.nodes));\r\n            this.app.canvas.state.connections = JSON.parse(JSON.stringify(state.connections));\r\n\r\n            // Vider le DOM des nodes existants\r\n            this.app.canvas.polesContainer.innerHTML = '';\r\n\r\n            // Re-rendre chaque node\r\n            this.app.canvas.state.nodes.forEach((node: KairosNode) => {\r\n                this.app.canvas.renderNode(node);\r\n            });\r\n\r\n            // Re-rendre les connexions\r\n            this.app.canvas.renderAllConnections();\r\n\r\n            // Sauvegarder (await pour maintenir isRestoring jusqu'√† la fin)\r\n            await this.app.saveData();\r\n\r\n            // Mettre √† jour les m√©triques\r\n            if (this.app.metrics) {\r\n                this.app.metrics.recalculateDebounced();\r\n            }\r\n\r\n            // Mettre √† jour la mini-map\r\n            if (this.app.canvas.minimap) {\r\n                this.app.canvas.minimap.update();\r\n            }\r\n        } finally {\r\n            this.isRestoring = false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Met √† jour l'UI des boutons Undo/Redo\r\n     */\r\n    updateUI(): void {\r\n        const undoBtn: HTMLButtonElement | null = document.getElementById('btn-undo') as HTMLButtonElement | null;\r\n        const redoBtn: HTMLButtonElement | null = document.getElementById('btn-redo') as HTMLButtonElement | null;\r\n\r\n        if (undoBtn) {\r\n            undoBtn.disabled = this.undoStack.length === 0;\r\n            undoBtn.title = this.undoStack.length > 0 ? `Annuler (${this.undoStack.length})` : 'Rien √† annuler';\r\n        }\r\n\r\n        if (redoBtn) {\r\n            redoBtn.disabled = this.redoStack.length === 0;\r\n            redoBtn.title = this.redoStack.length > 0 ? `R√©tablir (${this.redoStack.length})` : 'Rien √† r√©tablir';\r\n        }\r\n    }\r\n\r\n    /**\r\n     * R√©initialise l'historique (appel√© lors d'un clear ou import)\r\n     */\r\n    clear(): void {\r\n        this.undoStack = [];\r\n        this.redoStack = [];\r\n        this.updateUI();\r\n        console.log('[History] Cleared');\r\n    }\r\n\r\n    /**\r\n     * Retourne les statistiques de l'historique\r\n     */\r\n    getStats(): HistoryStats {\r\n        return {\r\n            undoCount: this.undoStack.length,\r\n            redoCount: this.redoStack.length,\r\n            maxSize: this.maxSize,\r\n        };\r\n    }\r\n}\r\n","/**\r\n * KAIROS - Int√©gration LLM Multi-Provider\r\n * Support : Claude, ChatGPT, Gemini, DeepSeek, Grok\r\n * Utilise Electron IPC pour les appels API (bypass CORS)\r\n */\r\n\r\nimport type { KairosNode, KairosConnection, CircularityResult } from '../types/kairos.js';\r\nimport { getTemplates, interpolateTemplate } from '../../data/prompt-templates.js';\r\n\r\ninterface ProviderConfig {\r\n    name: string;\r\n    apiUrl: string;\r\n    apiKey: string | null;\r\n    model: string;\r\n    icon: string;\r\n}\r\n\r\ninterface Providers {\r\n    claude: ProviderConfig;\r\n    openai: ProviderConfig;\r\n    gemini: ProviderConfig;\r\n    deepseek: ProviderConfig;\r\n    grok: ProviderConfig;\r\n    [key: string]: ProviderConfig;\r\n}\r\n\r\ninterface GraphContext {\r\n    vignetteCount: number;\r\n    vignettesText: string;\r\n    connectionsText?: string;\r\n}\r\n\r\ninterface LLMResponse {\r\n    text: string;\r\n    usage?: Record<string, unknown>;\r\n}\r\n\r\ninterface FrictionLog {\r\n    timestamp: number;\r\n    operation: string;\r\n    score: number;\r\n    signals: string[];\r\n}\r\n\r\ninterface VoisinageEntry {\r\n    node: KairosNode;\r\n    connectionsToSelection: (KairosConnection & { selectionNodeId: string })[];\r\n}\r\n\r\ninterface ContexteOptimise {\r\n    regime: 'full' | 'branch';\r\n    vignettes?: KairosNode[];\r\n    connections?: KairosConnection[];\r\n    selection?: KairosNode[] | null;\r\n    voisinage?: VoisinageEntry[] | null;\r\n    connectionsInternes?: KairosConnection[] | null;\r\n    totalCanvasNodes: number;\r\n}\r\n\r\ninterface CanvasAnalyzerLike {\r\n    lastUserInput: string;\r\n    lastLLMOutput: string;\r\n    detectCircularity(): CircularityResult;\r\n    injectFriction(basePrompt: string, circularityResult: CircularityResult, operation: string): string;\r\n    updateHistory(vignettes: KairosNode[], connections: KairosConnection[]): void;\r\n    history: any;\r\n    behaviorLogs: any;\r\n    reset(): void;\r\n    analyze(userInput?: string): any;\r\n    getCanvasTopKeywords?(topN?: number): Array<{ keyword: string; count: number }>;\r\n}\r\n\r\ninterface CanvasHistoryLike {\r\n    state: unknown;\r\n    init(): void;\r\n    update(vignettes: KairosNode[], connections: KairosConnection[]): void;\r\n    recordFrictionInjection(log: FrictionLog): void;\r\n    getFrictionStats(): Record<string, unknown> | null;\r\n    reset(): void;\r\n}\r\n\r\ndeclare const CircularityDetector: {\r\n    detect(\r\n        vignettes: KairosNode[],\r\n        state: unknown,\r\n        connections: KairosConnection[],\r\n        lastUserInput: string,\r\n        lastLLMOutput: string,\r\n    ): CircularityResult;\r\n};\r\n\r\ndeclare const FrictionInjector: {\r\n    createFrictionLog(circularityResult: CircularityResult, operation: string): FrictionLog;\r\n    buildPromptWithFriction(basePrompt: string, circularityResult: CircularityResult): string;\r\n};\r\n\r\nexport class LLMManager {\r\n    canvasAnalyzer: CanvasAnalyzerLike | null;\r\n    canvasHistory: CanvasHistoryLike | null;\r\n    frictionEnabled: boolean;\r\n    lastFrictionLog: FrictionLog | null;\r\n    providers: Providers;\r\n    currentProvider: string;\r\n    private _ready: Promise<void>;\r\n\r\n    constructor() {\r\n        // CanvasAnalyzer unifi√© (nouveau syst√®me)\r\n        this.canvasAnalyzer = null;\r\n\r\n        // Reference vers CanvasHistory pour la detection de circularite (legacy)\r\n        this.canvasHistory = null;\r\n        this.frictionEnabled = true;\r\n        this.lastFrictionLog = null;\r\n\r\n        this.providers = {\r\n            claude: {\r\n                name: 'Claude (Anthropic)',\r\n                apiUrl: 'https://api.anthropic.com/v1/messages',\r\n                apiKey: null,\r\n                model: 'claude-sonnet-4-20250514',\r\n                icon: 'C',\r\n            },\r\n            openai: {\r\n                name: 'ChatGPT (OpenAI)',\r\n                apiUrl: 'https://api.openai.com/v1/chat/completions',\r\n                apiKey: null,\r\n                model: 'gpt-4o',\r\n                icon: 'G',\r\n            },\r\n            gemini: {\r\n                name: 'Gemini (Google)',\r\n                apiUrl: 'https://generativelanguage.googleapis.com/v1beta/models',\r\n                apiKey: null,\r\n                model: 'gemini-1.5-pro',\r\n                icon: 'Ge',\r\n            },\r\n            deepseek: {\r\n                name: 'DeepSeek',\r\n                apiUrl: 'https://api.deepseek.com/chat/completions',\r\n                apiKey: null,\r\n                model: 'deepseek-chat',\r\n                icon: 'D',\r\n            },\r\n            grok: {\r\n                name: 'Grok (xAI)',\r\n                apiUrl: 'https://api.x.ai/v1/chat/completions',\r\n                apiKey: null,\r\n                model: 'grok-2',\r\n                icon: 'X',\r\n            },\r\n        };\r\n        this.currentProvider = 'claude';\r\n\r\n        // Charger la configuration sauvegard√©e (async, stocke la Promise)\r\n        this._ready = this.loadConfig();\r\n    }\r\n\r\n    /**\r\n     * Attend que la configuration (cl√©s API) soit charg√©e depuis le secure storage.\r\n     * √Ä appeler avant d'acc√©der aux cl√©s (ex: avant d'ouvrir le modal config).\r\n     */\r\n    whenReady(): Promise<void> {\r\n        return this._ready;\r\n    }\r\n\r\n    /**\r\n     * Trie les vignettes topologiquement selon les connexions\r\n     * Les sources (d√©but du flux) sont en premier, les cibles en dernier\r\n     */\r\n    sortNodesTopologically(nodes: KairosNode[], connections: KairosConnection[] = []): KairosNode[] {\r\n        if (nodes.length <= 1 || connections.length === 0) {\r\n            // Pas de connexions : trier par ordre de cr√©ation (ID contient timestamp)\r\n            return [...nodes].sort((a, b) => {\r\n                const tsA = parseInt(a.id.split('_')[1]) || 0;\r\n                const tsB = parseInt(b.id.split('_')[1]) || 0;\r\n                return tsA - tsB;\r\n            });\r\n        }\r\n\r\n        const nodeIds = new Set(nodes.map((n) => n.id));\r\n        const nodeMap = new Map<string, KairosNode>(nodes.map((n) => [n.id, n]));\r\n\r\n        // Filtrer les connexions pertinentes (implies seulement, pas resonance)\r\n        const relevantConnections = connections.filter(\r\n            (c) => nodeIds.has(c.from) && nodeIds.has(c.to) && c.type !== 'resonance',\r\n        );\r\n\r\n        // Calculer le degr√© entrant de chaque n≈ìud\r\n        const inDegree = new Map<string, number>();\r\n        const adjacency = new Map<string, string[]>();\r\n\r\n        for (const node of nodes) {\r\n            inDegree.set(node.id, 0);\r\n            adjacency.set(node.id, []);\r\n        }\r\n\r\n        for (const conn of relevantConnections) {\r\n            inDegree.set(conn.to, (inDegree.get(conn.to) || 0) + 1);\r\n            adjacency.get(conn.from)?.push(conn.to);\r\n        }\r\n\r\n        // Tri topologique (Kahn's algorithm)\r\n        const sorted: KairosNode[] = [];\r\n        const queue: string[] = [];\r\n\r\n        // Commencer par les n≈ìuds sans d√©pendances entrantes (sources)\r\n        for (const [id, degree] of inDegree) {\r\n            if (degree === 0) queue.push(id);\r\n        }\r\n\r\n        // Trier la queue par timestamp pour un ordre d√©terministe\r\n        queue.sort((a, b) => {\r\n            const tsA = parseInt(a.split('_')[1]) || 0;\r\n            const tsB = parseInt(b.split('_')[1]) || 0;\r\n            return tsA - tsB;\r\n        });\r\n\r\n        while (queue.length > 0) {\r\n            const nodeId = queue.shift()!;\r\n            const node = nodeMap.get(nodeId);\r\n            if (node) sorted.push(node);\r\n\r\n            for (const targetId of adjacency.get(nodeId) || []) {\r\n                const newDegree = (inDegree.get(targetId) || 1) - 1;\r\n                inDegree.set(targetId, newDegree);\r\n                if (newDegree === 0) {\r\n                    queue.push(targetId);\r\n                    queue.sort((a, b) => {\r\n                        const tsA = parseInt(a.split('_')[1]) || 0;\r\n                        const tsB = parseInt(b.split('_')[1]) || 0;\r\n                        return tsA - tsB;\r\n                    });\r\n                }\r\n            }\r\n        }\r\n\r\n        // Ajouter les n≈ìuds non trait√©s (cycles ou isol√©s)\r\n        for (const node of nodes) {\r\n            if (!sorted.includes(node)) {\r\n                sorted.push(node);\r\n            }\r\n        }\r\n\r\n        return sorted;\r\n    }\r\n\r\n    /**\r\n     * Charge la configuration depuis le stockage s√©curis√© Electron ou localStorage\r\n     */\r\n    async loadConfig(): Promise<void> {\r\n        try {\r\n            // Essayer le stockage s√©curis√© Electron d'abord\r\n            if (window.fgraph && window.fgraph.secureGet) {\r\n                for (const provider of Object.keys(this.providers)) {\r\n                    const result = await window.fgraph.secureGet(`${provider}_api_key`);\r\n                    if (result.success && result.value) {\r\n                        this.providers[provider].apiKey = result.value;\r\n                    }\r\n                }\r\n\r\n                // Charger le provider actuel et les mod√®les depuis localStorage\r\n                const configStr = localStorage.getItem('fgraph_llm_config');\r\n                if (configStr) {\r\n                    const config = JSON.parse(configStr);\r\n                    if (config.currentProvider) this.currentProvider = config.currentProvider;\r\n                    for (const provider of Object.keys(this.providers)) {\r\n                        if (config[provider]?.model) {\r\n                            this.providers[provider].model = config[provider].model;\r\n                        }\r\n                    }\r\n                }\r\n            } else {\r\n                // Fallback localStorage (pas d'API Electron)\r\n                const configStr = localStorage.getItem('fgraph_llm_config');\r\n                if (configStr) {\r\n                    const parsed = JSON.parse(configStr);\r\n                    for (const provider of Object.keys(this.providers)) {\r\n                        if (parsed[provider]) {\r\n                            this.providers[provider].apiKey = parsed[provider].apiKey || null;\r\n                            this.providers[provider].model = parsed[provider].model || this.providers[provider].model;\r\n                        }\r\n                    }\r\n                    if (parsed.currentProvider) {\r\n                        this.currentProvider = parsed.currentProvider;\r\n                    }\r\n                }\r\n            }\r\n        } catch (error) {\r\n            console.error('Erreur lors du chargement de la config LLM:', error);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sauvegarde la configuration\r\n     */\r\n    async saveConfig(): Promise<void> {\r\n        try {\r\n            if (window.fgraph && window.fgraph.secureSet) {\r\n                // Stocker les cl√©s API de mani√®re s√©curis√©e\r\n                for (const provider of Object.keys(this.providers)) {\r\n                    if (this.providers[provider].apiKey) {\r\n                        await window.fgraph.secureSet(`${provider}_api_key`, this.providers[provider].apiKey!);\r\n                    }\r\n                }\r\n\r\n                // Stocker les mod√®les et le provider actuel dans localStorage\r\n                const config: Record<string, any> = { currentProvider: this.currentProvider };\r\n                for (const provider of Object.keys(this.providers)) {\r\n                    config[provider] = { model: this.providers[provider].model };\r\n                }\r\n                localStorage.setItem('fgraph_llm_config', JSON.stringify(config));\r\n            } else {\r\n                // Fallback localStorage\r\n                const config: Record<string, any> = { currentProvider: this.currentProvider };\r\n                for (const provider of Object.keys(this.providers)) {\r\n                    config[provider] = {\r\n                        apiKey: this.providers[provider].apiKey,\r\n                        model: this.providers[provider].model,\r\n                    };\r\n                }\r\n                localStorage.setItem('fgraph_llm_config', JSON.stringify(config));\r\n            }\r\n        } catch (error) {\r\n            console.error('Erreur lors de la sauvegarde de la config LLM:', error);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * D√©finit la cl√© API pour un provider\r\n     */\r\n    setApiKey(provider: string, key: string): void {\r\n        if (this.providers[provider]) {\r\n            this.providers[provider].apiKey = key;\r\n            this.saveConfig();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * D√©finit le mod√®le pour un provider\r\n     */\r\n    setModel(provider: string, model: string): void {\r\n        if (this.providers[provider]) {\r\n            this.providers[provider].model = model;\r\n            this.saveConfig();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Change le provider actuel\r\n     */\r\n    setProvider(provider: string): void {\r\n        if (this.providers[provider]) {\r\n            this.currentProvider = provider;\r\n            this.saveConfig();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * V√©rifie si le provider actuel est configur√©\r\n     */\r\n    isConfigured(): boolean {\r\n        return !!this.providers[this.currentProvider].apiKey;\r\n    }\r\n\r\n    /**\r\n     * Retourne les infos du provider actuel\r\n     */\r\n    getCurrentProvider(): ProviderConfig & { id: string } {\r\n        return {\r\n            id: this.currentProvider,\r\n            ...this.providers[this.currentProvider],\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Construit un contexte optimis√© selon l'op√©ration adaptative (v2)\r\n     * Retourne un objet structur√© avec r√©gime, s√©lection, voisinage et connexions\r\n     */\r\n    buildContexteOptimise(\r\n        operation: string,\r\n        vignettes: KairosNode[],\r\n        connections: KairosConnection[],\r\n        vignetteSelectionnees: KairosNode[] = [],\r\n    ): ContexteOptimise {\r\n        console.log('[LLM DEBUG] buildContexteOptimise v2 called');\r\n        console.log('[LLM DEBUG] operation:', operation);\r\n        console.log('[LLM DEBUG] vignetteSelectionnees.length:', vignetteSelectionnees.length);\r\n        console.log('[LLM DEBUG] total vignettes:', vignettes.length);\r\n\r\n        // D√©tecter le r√©gime\r\n        const regime = this.detectRegime(vignetteSelectionnees);\r\n        console.log('[LLM DEBUG] R√©gime d√©tect√©:', regime);\r\n\r\n        // === R√âGIME B : Branche s√©lectionn√©e ===\r\n        if (regime === 'branch') {\r\n            const selection = [...vignetteSelectionnees];\r\n            const selectionIds = new Set(selection.map((v) => v.id));\r\n\r\n            // Connexions INTERNES (entre n≈ìuds s√©lectionn√©s uniquement)\r\n            const connectionsInternes = connections.filter((c) => selectionIds.has(c.from) && selectionIds.has(c.to));\r\n\r\n            // Voisinage : n≈ìuds non s√©lectionn√©s mais connect√©s √† la s√©lection\r\n            // Exclure les vignettes archiv√©es du voisinage (sauf si explicitement s√©lectionn√©es)\r\n            const vignettesActives = vignettes.filter((v) => !v.synthesized || selectionIds.has(v.id));\r\n            const voisinage = this.getVoisinage(selection, vignettesActives, connections);\r\n\r\n            console.log('[LLM DEBUG] R√©gime B - S√©lection:', selection.length, 'vignettes');\r\n            console.log('[LLM DEBUG] R√©gime B - Voisinage (actif):', voisinage.length, 'vignettes');\r\n            console.log('[LLM DEBUG] R√©gime B - Connexions internes:', connectionsInternes.length);\r\n\r\n            return {\r\n                regime: 'branch',\r\n                selection,\r\n                voisinage,\r\n                connectionsInternes,\r\n                connections, // Toutes les connexions (pour RELIER existantes)\r\n                vignettes: selection, // Compatibilit√©\r\n                totalCanvasNodes: vignettesActives.length,\r\n            };\r\n        }\r\n\r\n        // === R√âGIME A : Graphe entier ===\r\n        // Filtrer les vignettes archiv√©es (synthesized) pour toutes les op√©rations\r\n        // Ces vignettes ne font plus partie du graphe actif\r\n        const vignettesActives = vignettes.filter((v) => !v.synthesized);\r\n\r\n        console.log('[LLM DEBUG] Vignettes actives (non-archiv√©es):', vignettesActives.length, '/', vignettes.length);\r\n\r\n        let vignettesFiltered: KairosNode[] = [];\r\n\r\n        switch (operation) {\r\n            case 'D√âVELOPPER':\r\n                // Vignettes actives, tri√©es topologiquement (sources en premier)\r\n                vignettesFiltered = this.sortNodesTopologically(vignettesActives, connections);\r\n                break;\r\n            case 'RELIER':\r\n                // Vignettes actives, tri√©es topologiquement\r\n                vignettesFiltered = this.sortNodesTopologically(vignettesActives, connections);\r\n                break;\r\n            case 'SYNTH√âTISER':\r\n                // Toutes les vignettes actives, tri√©es topologiquement\r\n                // Les connexions servent de fil conducteur mais les id√©es isol√©es ont aussi du sens\r\n                vignettesFiltered = this.sortNodesTopologically(vignettesActives, connections);\r\n                break;\r\n            default:\r\n                vignettesFiltered = vignettesActives;\r\n        }\r\n\r\n        console.log('[LLM DEBUG] Final vignettes count:', vignettesFiltered.length);\r\n\r\n        // Connexions entre les vignettes filtr√©es\r\n        const vignettesIds = new Set(vignettesFiltered.map((v) => v.id));\r\n        const connectionsFiltered = connections.filter((c) => vignettesIds.has(c.from) && vignettesIds.has(c.to));\r\n\r\n        return {\r\n            regime: 'full',\r\n            vignettes: vignettesFiltered,\r\n            connections: connectionsFiltered,\r\n            selection: null,\r\n            voisinage: null,\r\n            connectionsInternes: null,\r\n            totalCanvasNodes: vignettesActives.length,\r\n        };\r\n    }\r\n\r\n    /**\r\n     * √âchantillonne les vignettes\r\n     */\r\n    echantillonner(vignettes: KairosNode[], limit: number, prioritaires: KairosNode[] = []): KairosNode[] {\r\n        const prioritairesIds = new Set(prioritaires.map((v) => v.id));\r\n        const result = vignettes.filter((v) => prioritairesIds.has(v.id));\r\n        const autres = vignettes\r\n            .filter((v) => !prioritairesIds.has(v.id))\r\n            .sort((a, b) => new Date(b.created as any).getTime() - new Date(a.created as any).getTime());\r\n        result.push(...autres.slice(0, limit - result.length));\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * Calcule le nombre de vignettes √† g√©n√©rer selon la densit√© du canvas\r\n     */\r\n    getAdaptiveVignetteCount(totalVignettes: number): string {\r\n        if (totalVignettes < 10) {\r\n            return '3-5'; // Canvas peu dense : explorer largement\r\n        }\r\n        return '2-3'; // Canvas mod√©r√© √† dense : pas de cap artificiel\r\n    }\r\n\r\n    /**\r\n     * D√©tecte le r√©gime de l'op√©ration (A ou B)\r\n     */\r\n    detectRegime(vignetteSelectionnees: KairosNode[] = []): 'full' | 'branch' {\r\n        return vignetteSelectionnees.length > 0 ? 'branch' : 'full';\r\n    }\r\n\r\n    /**\r\n     * Identifie les vignettes VOISINAGE (connect√©es √† la s√©lection mais non s√©lectionn√©es)\r\n     */\r\n    getVoisinage(\r\n        selection: KairosNode[],\r\n        allVignettes: KairosNode[],\r\n        connections: KairosConnection[],\r\n    ): VoisinageEntry[] {\r\n        const selectionIds = new Set(selection.map((v) => v.id));\r\n        const voisinageMap = new Map<string, VoisinageEntry>();\r\n\r\n        for (const conn of connections) {\r\n            const fromInSelection = selectionIds.has(conn.from);\r\n            const toInSelection = selectionIds.has(conn.to);\r\n\r\n            // Si une extr√©mit√© est dans la s√©lection et l'autre non\r\n            if (fromInSelection && !toInSelection) {\r\n                const voisinNode = allVignettes.find((v) => v.id === conn.to);\r\n                if (voisinNode) {\r\n                    if (!voisinageMap.has(conn.to)) {\r\n                        voisinageMap.set(conn.to, { node: voisinNode, connectionsToSelection: [] });\r\n                    }\r\n                    voisinageMap.get(conn.to)!.connectionsToSelection.push({\r\n                        ...conn,\r\n                        selectionNodeId: conn.from,\r\n                    });\r\n                }\r\n            } else if (!fromInSelection && toInSelection) {\r\n                const voisinNode = allVignettes.find((v) => v.id === conn.from);\r\n                if (voisinNode) {\r\n                    if (!voisinageMap.has(conn.from)) {\r\n                        voisinageMap.set(conn.from, { node: voisinNode, connectionsToSelection: [] });\r\n                    }\r\n                    voisinageMap.get(conn.from)!.connectionsToSelection.push({\r\n                        ...conn,\r\n                        selectionNodeId: conn.to,\r\n                    });\r\n                }\r\n            }\r\n        }\r\n\r\n        return Array.from(voisinageMap.values());\r\n    }\r\n\r\n    /**\r\n     * Formate une vignette selon le format v2\r\n     */\r\n    formatVignetteV2(v: KairosNode, index: number, statusOverride: string | null = null): string {\r\n        const statusMap: Record<string, string> = { neutral: '\\u25CB', priority: '\\uD83C\\uDFAF' };\r\n        const status = statusOverride || statusMap[v.status] || '\\u25CB';\r\n        const tags = v.tags && v.tags.length > 0 ? ` | ${v.tags.join(' ')}` : '';\r\n        return `${index}. [${v.text}] ${status}${tags}`;\r\n    }\r\n\r\n    /**\r\n     * Formate une connexion selon le format v2 (avec m√©canisme textuel)\r\n     */\r\n    formatConnectionV2(conn: KairosConnection, nodeMap: Map<string, KairosNode>): string | null {\r\n        const fromNode = nodeMap.get(conn.from);\r\n        const toNode = nodeMap.get(conn.to);\r\n        if (!fromNode || !toNode) return null;\r\n        const symbol = conn.type === 'resonance' ? '\\u2194' : '\\u2192';\r\n        const mechanism = conn.mechanism ? ` [${conn.mechanism}]` : '';\r\n        return `- \"${fromNode.text}\" ${symbol} \"${toNode.text}\"${mechanism}`;\r\n    }\r\n\r\n    /**\r\n     * Construit le prompt adaptatif selon l'op√©ration v2\r\n     * Architecture en 3 couches : grammaire, donn√©es, instructions\r\n     */\r\n    buildAdaptivePrompt(\r\n        operation: string,\r\n        contexte: ContexteOptimise,\r\n        syntheseReinjected: any[] = [],\r\n        circularityResult: CircularityResult | null = null,\r\n        subMode: 'approfondir' | 'diverger' = 'approfondir',\r\n    ): string {\r\n        let prompt = '';\r\n\r\n        // === 1. SYNTH√àSES R√âINJECT√âES (optionnel) ===\r\n        if (syntheseReinjected.length > 0 && (operation === 'D√âVELOPPER' || operation === 'SYNTH√âTISER')) {\r\n            prompt += '[SYNTH√àSES R√âINJECT√âES]\\nExplorations pass√©es :\\n';\r\n            syntheseReinjected.forEach((synth) => {\r\n                const nbVignettes = synth.vignettesSourceIds?.length || 0;\r\n                const date = new Date(synth.dateCreation).toLocaleDateString('fr-FR');\r\n                prompt += `Synth√®se \"${synth.titre}\" (${nbVignettes} vignettes, ${date}) :\\n`;\r\n                prompt += `${synth.texte}\\n`;\r\n            });\r\n            prompt += '---\\n\\n';\r\n        }\r\n\r\n        // === 2. DONN√âES DU GRAPHE (selon le r√©gime) ===\r\n        const regime = contexte.regime;\r\n        const nodeMap = new Map<string, KairosNode>();\r\n\r\n        if (regime === 'branch') {\r\n            // R√âGIME B : Branche s√©lectionn√©e\r\n            prompt += this.buildGraphDataRegimeB(contexte, nodeMap);\r\n        } else {\r\n            // R√âGIME A : Graphe entier\r\n            prompt += this.buildGraphDataRegimeA(contexte, nodeMap);\r\n        }\r\n\r\n        // === 2b. CADRAGE STRUCTUREL (toujours actif, anti-arborescence) ===\r\n        const templates = getTemplates();\r\n        const framingKey = operation as keyof typeof templates.structuralFraming;\r\n        if (templates.structuralFraming[framingKey]) {\r\n            prompt += templates.structuralFraming[framingKey] + '\\n';\r\n        }\r\n\r\n        // === 3. INSTRUCTION DE L'OP√âRATION (selon op√©ration + r√©gime + subMode) ===\r\n        prompt += this.buildOperationInstruction(operation, contexte, regime, subMode);\r\n\r\n        // === 4. FRICTION (si score >= seuil) ===\r\n        if (circularityResult && circularityResult.shouldInjectFriction) {\r\n            prompt = this.applyFriction(prompt, circularityResult, operation);\r\n        }\r\n\r\n        return prompt;\r\n    }\r\n\r\n    /**\r\n     * Construit les donn√©es du graphe pour le r√©gime A (graphe entier)\r\n     */\r\n    buildGraphDataRegimeA(contexte: ContexteOptimise, nodeMap: Map<string, KairosNode>): string {\r\n        let data = 'Graphe actuel :\\n\\n';\r\n\r\n        // Ancre structurelle (si pr√©sente)\r\n        const anchor = contexte.vignettes!.find((v) => v.status === 'priority');\r\n        if (anchor) {\r\n            data += `ANCRE DU GRAPHE : \"${anchor.text}\"\\nToutes les vignettes et connexions doivent √™tre lues en rapport √† cet objectif structurant.\\n\\n`;\r\n        }\r\n\r\n        // Vignettes\r\n        contexte.vignettes!.forEach((v, idx) => {\r\n            nodeMap.set(v.id, v);\r\n            data += this.formatVignetteV2(v, idx + 1) + '\\n';\r\n        });\r\n\r\n        // Connexions\r\n        if (contexte.connections && contexte.connections.length > 0) {\r\n            data += '\\nCONNEXIONS :\\n';\r\n            contexte.connections.forEach((conn) => {\r\n                const line = this.formatConnectionV2(conn, nodeMap);\r\n                if (line) data += line + '\\n';\r\n            });\r\n        }\r\n\r\n        data += '\\n---\\n\\n';\r\n        return data;\r\n    }\r\n\r\n    /**\r\n     * Construit les donn√©es du graphe pour le r√©gime B (branche s√©lectionn√©e)\r\n     */\r\n    buildGraphDataRegimeB(contexte: ContexteOptimise, nodeMap: Map<string, KairosNode>): string {\r\n        let data = '';\r\n\r\n        // Ancre structurelle (si pr√©sente dans la s√©lection ou le voisinage)\r\n        const anchorInSelection = contexte.selection!.find((v) => v.status === 'priority');\r\n        const anchorInVoisinage = contexte.voisinage?.find((v) => v.node.status === 'priority');\r\n        const anchorText = anchorInSelection?.text || anchorInVoisinage?.node.text;\r\n        if (anchorText) {\r\n            data += `ANCRE DU GRAPHE : \"${anchorText}\"\\nCette branche doit √™tre lue en rapport √† cet objectif structurant.\\n\\n`;\r\n        }\r\n\r\n        data += 'S√âLECTION (focus) :\\n';\r\n\r\n        // S√©lection (marqu√©e ‚úì)\r\n        contexte.selection!.forEach((v, idx) => {\r\n            nodeMap.set(v.id, v);\r\n            data += this.formatVignetteV2(v, idx + 1, '\\u2713') + '\\n';\r\n        });\r\n\r\n        // Connexions internes\r\n        if (contexte.connectionsInternes && contexte.connectionsInternes.length > 0) {\r\n            data += '\\nCONNEXIONS INTERNES :\\n';\r\n            contexte.connectionsInternes.forEach((conn) => {\r\n                const line = this.formatConnectionV2(conn, nodeMap);\r\n                if (line) data += line + '\\n';\r\n            });\r\n        }\r\n\r\n        // Voisinage\r\n        if (contexte.voisinage && contexte.voisinage.length > 0) {\r\n            data += '\\nVOISINAGE (hors s√©lection mais connect√©) :\\n';\r\n            const startIndex = contexte.selection!.length + 1;\r\n            contexte.voisinage.forEach((v, idx) => {\r\n                nodeMap.set(v.node.id, v.node);\r\n                data += this.formatVignetteV2(v.node, startIndex + idx, '\\u25CB') + '\\n';\r\n                // Afficher les connexions vers la s√©lection\r\n                v.connectionsToSelection.forEach((conn) => {\r\n                    const selNode = nodeMap.get(conn.selectionNodeId);\r\n                    if (selNode) {\r\n                        const symbol = conn.type === 'resonance' ? '\\u2194' : '\\u2192';\r\n                        const mechanism = conn.mechanism ? ` [${conn.mechanism}]` : '';\r\n                        data += `   ${symbol} \"${selNode.text}\"${mechanism}\\n`;\r\n                    }\r\n                });\r\n            });\r\n        }\r\n\r\n        data += '\\n---\\n\\n';\r\n        return data;\r\n    }\r\n\r\n    /**\r\n     * Construit l'instruction de l'op√©ration selon op√©ration + r√©gime\r\n     * Instructions copi√©es mot pour mot de Prompts_llmv.2.md\r\n     */\r\n    buildOperationInstruction(\r\n        operation: string,\r\n        contexte: ContexteOptimise,\r\n        regime: string,\r\n        subMode: 'approfondir' | 'diverger' = 'approfondir',\r\n    ): string {\r\n        const targetCount = this.getAdaptiveVignetteCount(contexte.totalCanvasNodes);\r\n\r\n        switch (operation) {\r\n            case 'D√âVELOPPER':\r\n                if (subMode === 'diverger') {\r\n                    return regime === 'branch'\r\n                        ? this.buildDevelopDivergeInstructionB()\r\n                        : this.buildDevelopDivergeInstructionA();\r\n                }\r\n                return regime === 'branch'\r\n                    ? this.buildDevelopInstructionB(targetCount)\r\n                    : this.buildDevelopInstructionA(targetCount);\r\n\r\n            case 'RELIER': {\r\n                const isolatedCount = this.countIsolatedNodes(contexte);\r\n                const connectionTarget = this.getAdaptiveConnectionCount(contexte.totalCanvasNodes, isolatedCount);\r\n                return regime === 'branch'\r\n                    ? this.buildLinkInstructionB(connectionTarget, isolatedCount)\r\n                    : this.buildLinkInstructionA(connectionTarget, isolatedCount);\r\n            }\r\n\r\n            case 'SYNTH√âTISER':\r\n                return regime === 'branch' ? this.buildSynthesizeInstructionB() : this.buildSynthesizeInstructionA();\r\n\r\n            default:\r\n                return '';\r\n        }\r\n    }\r\n\r\n    /**\r\n     * D√âVELOPPER-APPROFONDIR - R√©gime A (graphe entier)\r\n     */\r\n    buildDevelopInstructionA(targetCount: string): string {\r\n        return interpolateTemplate(getTemplates().operations['D√âVELOPPER'].deepen.full, { targetCount });\r\n    }\r\n\r\n    /**\r\n     * D√âVELOPPER-APPROFONDIR - R√©gime B (branche s√©lectionn√©e)\r\n     */\r\n    buildDevelopInstructionB(targetCount: string): string {\r\n        return interpolateTemplate(getTemplates().operations['D√âVELOPPER'].deepen.branch, { targetCount });\r\n    }\r\n\r\n    /**\r\n     * D√âVELOPPER-DIVERGER - R√©gime A (graphe entier)\r\n     */\r\n    buildDevelopDivergeInstructionA(): string {\r\n        const topKeywords = this.canvasAnalyzer?.getCanvasTopKeywords?.(10) || [];\r\n        const topKeywordsCanvas =\r\n            topKeywords.length > 0\r\n                ? topKeywords.map((k: any) => `- \"${k.keyword}\" (${k.count} occurrences)`).join('\\n')\r\n                : '(aucun mot-cl√© dominant d√©tect√©)';\r\n        return interpolateTemplate(getTemplates().operations['D√âVELOPPER'].diverge.full, { topKeywordsCanvas });\r\n    }\r\n\r\n    /**\r\n     * D√âVELOPPER-DIVERGER - R√©gime B (branche s√©lectionn√©e)\r\n     */\r\n    buildDevelopDivergeInstructionB(): string {\r\n        const topKeywords = this.canvasAnalyzer?.getCanvasTopKeywords?.(10) || [];\r\n        const topKeywordsCanvas =\r\n            topKeywords.length > 0\r\n                ? topKeywords.map((k: any) => `- \"${k.keyword}\" (${k.count} occurrences)`).join('\\n')\r\n                : '(aucun mot-cl√© dominant d√©tect√©)';\r\n        return interpolateTemplate(getTemplates().operations['D√âVELOPPER'].diverge.branch, { topKeywordsCanvas });\r\n    }\r\n\r\n    /**\r\n     * Compte les n≈ìuds isol√©s (sans aucune connexion) dans le contexte\r\n     */\r\n    countIsolatedNodes(contexte: ContexteOptimise): number {\r\n        const nodes = contexte.regime === 'branch' ? contexte.selection || [] : contexte.vignettes || [];\r\n        const connections =\r\n            contexte.regime === 'branch' ? contexte.connectionsInternes || [] : contexte.connections || [];\r\n\r\n        const connectedIds = new Set<string>();\r\n        for (const c of connections) {\r\n            connectedIds.add(c.from);\r\n            connectedIds.add(c.to);\r\n        }\r\n\r\n        return nodes.filter((n) => !connectedIds.has(n.id)).length;\r\n    }\r\n\r\n    /**\r\n     * Calcule le nombre adaptatif de connexions √† proposer\r\n     */\r\n    getAdaptiveConnectionCount(totalVignettes: number, isolatedCount: number): string {\r\n        if (isolatedCount > 5) {\r\n            return '5-8'; // Beaucoup d'isol√©s : connecter massivement\r\n        } else if (isolatedCount > 2) {\r\n            return '3-5'; // Quelques isol√©s : connecter activement\r\n        } else if (totalVignettes > 15) {\r\n            return '2-4'; // Graphe dense sans isol√©s : renforcer la structure\r\n        } else {\r\n            return '1-3'; // Petit graphe connect√©\r\n        }\r\n    }\r\n\r\n    /**\r\n     * RELIER - R√©gime A (graphe entier)\r\n     * Note: Les connexions existantes sont d√©j√† list√©es dans buildGraphDataRegimeA\r\n     */\r\n    buildLinkInstructionA(connectionTarget: string, isolatedCount: number): string {\r\n        return interpolateTemplate(getTemplates().operations['RELIER'].full, {\r\n            connectionTarget,\r\n            isolatedCount: String(isolatedCount),\r\n        });\r\n    }\r\n\r\n    /**\r\n     * RELIER - R√©gime B (branche s√©lectionn√©e)\r\n     * Note: Les connexions internes sont d√©j√† list√©es dans buildGraphDataRegimeB\r\n     */\r\n    buildLinkInstructionB(connectionTarget: string, isolatedCount: number): string {\r\n        return interpolateTemplate(getTemplates().operations['RELIER'].branch, {\r\n            connectionTarget,\r\n            isolatedCount: String(isolatedCount),\r\n        });\r\n    }\r\n\r\n    /**\r\n     * SYNTH√âTISER - R√©gime A (graphe entier)\r\n     */\r\n    buildSynthesizeInstructionA(): string {\r\n        return getTemplates().operations['SYNTH√âTISER'].full;\r\n    }\r\n\r\n    /**\r\n     * SYNTH√âTISER - R√©gime B (branche s√©lectionn√©e)\r\n     */\r\n    buildSynthesizeInstructionB(): string {\r\n        return getTemplates().operations['SYNTH√âTISER'].branch;\r\n    }\r\n\r\n    /**\r\n     * Construit le prompt syst√®me v2 - Grammaire de lecture du graphe\r\n     * Commun aux 3 op√©rations (D√âVELOPPER, RELIER, SYNTH√âTISER)\r\n     */\r\n    buildSystemPrompt(operation: string, graphContext: GraphContext | null = null): string {\r\n        const templates = getTemplates();\r\n        let systemPrompt = templates.systemPrompt;\r\n\r\n        // Mode chat : ajouter l'√©tat du canvas\r\n        if (operation === 'chat' && graphContext && graphContext.vignetteCount > 0) {\r\n            systemPrompt += `\\n\\n--- √âTAT DU CANVAS ---\\n`;\r\n            systemPrompt += `${graphContext.vignetteCount} vignette(s) :\\n${graphContext.vignettesText}`;\r\n            if (graphContext.connectionsText) {\r\n                systemPrompt += `\\n\\nConnexions :\\n${graphContext.connectionsText}`;\r\n            }\r\n            systemPrompt += `\\n--- FIN ---`;\r\n            systemPrompt += templates.systemPromptChatSuffix;\r\n        } else if (operation === 'chat') {\r\n            systemPrompt += templates.systemPromptChatEmpty;\r\n        }\r\n\r\n        return systemPrompt;\r\n    }\r\n\r\n    /**\r\n     * Envoie une requ√™te au LLM via Electron IPC\r\n     */\r\n    async query(\r\n        userMessage: string,\r\n        graphContext: GraphContext | null,\r\n        operation: string = 'chat',\r\n    ): Promise<LLMResponse> {\r\n        const provider = this.providers[this.currentProvider];\r\n\r\n        if (!provider.apiKey) {\r\n            throw new Error(`Cl√© API ${provider.name} non configur√©e. Cliquez sur \\u2699 pour configurer.`);\r\n        }\r\n\r\n        const isChat = operation === 'chat';\r\n        const systemPrompt = this.buildSystemPrompt(operation, isChat ? graphContext : null);\r\n\r\n        let messageToSend = userMessage;\r\n        if (!isChat && graphContext && graphContext.vignetteCount > 0) {\r\n            let contextMessage = `Mes vignettes actuelles :\\n${graphContext.vignettesText}`;\r\n            if (graphContext.connectionsText) {\r\n                contextMessage += `\\n\\nConnexions :\\n${graphContext.connectionsText}`;\r\n            }\r\n            messageToSend = contextMessage + '\\n\\n---\\n\\n' + userMessage;\r\n        }\r\n\r\n        try {\r\n            const messages = [{ role: 'user', content: messageToSend }];\r\n\r\n            let response: LLMResponse;\r\n\r\n            // Utiliser Electron IPC si disponible\r\n            if (window.fgraph && window.fgraph.llmQuery) {\r\n                const ipcResponse = await window.fgraph.llmQuery({\r\n                    provider: this.currentProvider,\r\n                    apiKey: provider.apiKey,\r\n                    model: provider.model,\r\n                    messages: messages,\r\n                    systemPrompt: systemPrompt,\r\n                    options: { max_tokens: 2048 },\r\n                });\r\n\r\n                if (!(ipcResponse as any).success) {\r\n                    throw new Error((ipcResponse as any).error || 'Erreur LLM');\r\n                }\r\n\r\n                response = { text: (ipcResponse as any).content, usage: (ipcResponse as any).usage };\r\n            } else {\r\n                // Fallback fetch direct (CORS peut bloquer)\r\n                response = await this.callProviderDirect(systemPrompt, messages, provider);\r\n            }\r\n\r\n            return response;\r\n        } catch (error) {\r\n            console.error('Erreur LLM:', error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Appel direct (fallback si pas d'IPC Electron)\r\n     */\r\n    async callProviderDirect(\r\n        systemPrompt: string,\r\n        messages: Array<{ role: string; content: string }>,\r\n        provider: ProviderConfig,\r\n    ): Promise<LLMResponse> {\r\n        switch (this.currentProvider) {\r\n            case 'claude':\r\n                return await this.callClaude(systemPrompt, messages, provider);\r\n            case 'openai':\r\n            case 'deepseek':\r\n            case 'grok':\r\n                return await this.callOpenAICompatible(systemPrompt, messages, provider);\r\n            case 'gemini':\r\n                return await this.callGemini(systemPrompt, messages, provider);\r\n            default:\r\n                throw new Error(`Provider ${this.currentProvider} non support√©`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Appel API Claude (Anthropic)\r\n     */\r\n    async callClaude(\r\n        systemPrompt: string,\r\n        messages: Array<{ role: string; content: string }>,\r\n        provider: ProviderConfig,\r\n    ): Promise<LLMResponse> {\r\n        const response = await fetch(provider.apiUrl, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n                'x-api-key': provider.apiKey!,\r\n                'anthropic-version': '2023-06-01',\r\n                'anthropic-dangerous-direct-browser-access': 'true',\r\n            },\r\n            body: JSON.stringify({\r\n                model: provider.model,\r\n                max_tokens: 2048,\r\n                system: systemPrompt,\r\n                messages: messages,\r\n            }),\r\n        });\r\n\r\n        if (!response.ok) {\r\n            const error = await response.json().catch(() => ({}));\r\n            throw new Error(error.error?.message || `Erreur Claude: ${response.status}`);\r\n        }\r\n\r\n        const data = await response.json();\r\n        return { text: data.content[0].text, usage: data.usage };\r\n    }\r\n\r\n    /**\r\n     * Appel API OpenAI-compatible (OpenAI, DeepSeek, Grok)\r\n     */\r\n    async callOpenAICompatible(\r\n        systemPrompt: string,\r\n        messages: Array<{ role: string; content: string }>,\r\n        provider: ProviderConfig,\r\n    ): Promise<LLMResponse> {\r\n        const fullMessages = [{ role: 'system', content: systemPrompt }, ...messages];\r\n\r\n        const response = await fetch(provider.apiUrl, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n                Authorization: `Bearer ${provider.apiKey}`,\r\n            },\r\n            body: JSON.stringify({\r\n                model: provider.model,\r\n                max_tokens: 2048,\r\n                messages: fullMessages,\r\n            }),\r\n        });\r\n\r\n        if (!response.ok) {\r\n            const error = await response.json().catch(() => ({}));\r\n            throw new Error(error.error?.message || `Erreur ${provider.name}: ${response.status}`);\r\n        }\r\n\r\n        const data = await response.json();\r\n        return { text: data.choices[0].message.content, usage: data.usage };\r\n    }\r\n\r\n    /**\r\n     * Appel API Gemini (Google)\r\n     */\r\n    async callGemini(\r\n        systemPrompt: string,\r\n        messages: Array<{ role: string; content: string }>,\r\n        provider: ProviderConfig,\r\n    ): Promise<LLMResponse> {\r\n        const url = `${provider.apiUrl}/${provider.model}:generateContent?key=${provider.apiKey}`;\r\n\r\n        // Convertir les messages au format Gemini\r\n        const contents = messages.map((m) => ({\r\n            role: m.role === 'assistant' ? 'model' : 'user',\r\n            parts: [{ text: m.content }],\r\n        }));\r\n\r\n        const response = await fetch(url, {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n                contents: contents,\r\n                systemInstruction: { parts: [{ text: systemPrompt }] },\r\n                generationConfig: { maxOutputTokens: 2048 },\r\n            }),\r\n        });\r\n\r\n        if (!response.ok) {\r\n            const error = await response.json().catch(() => ({}));\r\n            throw new Error(error.error?.message || `Erreur Gemini: ${response.status}`);\r\n        }\r\n\r\n        const data = await response.json();\r\n        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';\r\n        return { text, usage: data.usageMetadata };\r\n    }\r\n\r\n    // ==========================================\r\n    // FRICTION - Detection de circularite\r\n    // ==========================================\r\n\r\n    /**\r\n     * Configure le CanvasAnalyzer unifi√© (nouveau syst√®me)\r\n     */\r\n    setCanvasAnalyzer(analyzer: CanvasAnalyzerLike): void {\r\n        this.canvasAnalyzer = analyzer;\r\n        console.log('[LLM] CanvasAnalyzer configur√© (syst√®me unifi√©)');\r\n    }\r\n\r\n    /**\r\n     * Initialise le module de friction avec CanvasHistory (legacy)\r\n     */\r\n    initFriction(canvasHistory: CanvasHistoryLike): void {\r\n        this.canvasHistory = canvasHistory;\r\n        if (canvasHistory) {\r\n            canvasHistory.init();\r\n            console.log('[LLM] Module friction initialise (legacy)');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Active/desactive l'injection de friction\r\n     */\r\n    setFrictionEnabled(enabled: boolean): void {\r\n        this.frictionEnabled = enabled;\r\n        console.log('[LLM] Friction:', enabled ? 'activee' : 'desactivee');\r\n    }\r\n\r\n    /**\r\n     * Detecte la circularite et retourne le resultat\r\n     * Utilise CanvasAnalyzer si disponible, sinon fallback legacy\r\n     */\r\n    detectCircularity(\r\n        vignettes: KairosNode[],\r\n        connections: KairosConnection[],\r\n        lastUserInput: string = '',\r\n        lastLLMOutput: string = '',\r\n    ): CircularityResult {\r\n        if (!this.frictionEnabled) {\r\n            return { score: 0, signals: [], shouldInjectFriction: false, details: {} };\r\n        }\r\n\r\n        // Nouveau syst√®me unifi√© (CanvasAnalyzer)\r\n        if (this.canvasAnalyzer) {\r\n            // Mettre √† jour le contexte\r\n            this.canvasAnalyzer.lastUserInput = lastUserInput || '';\r\n            this.canvasAnalyzer.lastLLMOutput = lastLLMOutput || '';\r\n\r\n            return this.canvasAnalyzer.detectCircularity();\r\n        }\r\n\r\n        // Fallback legacy\r\n        if (!this.canvasHistory || typeof CircularityDetector === 'undefined') {\r\n            return { score: 0, signals: [], shouldInjectFriction: false, details: {} };\r\n        }\r\n\r\n        return CircularityDetector.detect(\r\n            vignettes,\r\n            this.canvasHistory.state,\r\n            connections,\r\n            lastUserInput,\r\n            lastLLMOutput,\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Applique la friction au prompt si necessaire\r\n     * Utilise CanvasAnalyzer si disponible, sinon fallback legacy\r\n     */\r\n    applyFriction(basePrompt: string, circularityResult: CircularityResult, operation: string): string {\r\n        if (!circularityResult.shouldInjectFriction) {\r\n            return basePrompt;\r\n        }\r\n\r\n        // Nouveau syst√®me unifi√© (CanvasAnalyzer)\r\n        if (this.canvasAnalyzer) {\r\n            this.lastFrictionLog = {\r\n                timestamp: Date.now(),\r\n                operation,\r\n                score: circularityResult.score,\r\n                signals: circularityResult.signals,\r\n            };\r\n            console.log('[LLM] Friction inject√©e (CanvasAnalyzer):', this.lastFrictionLog);\r\n\r\n            return this.canvasAnalyzer.injectFriction(basePrompt, circularityResult, operation);\r\n        }\r\n\r\n        // Fallback legacy\r\n        if (typeof FrictionInjector === 'undefined') {\r\n            return basePrompt;\r\n        }\r\n\r\n        this.lastFrictionLog = FrictionInjector.createFrictionLog(circularityResult, operation);\r\n        console.log('[LLM] Friction injectee (legacy):', this.lastFrictionLog);\r\n\r\n        if (this.canvasHistory) {\r\n            this.canvasHistory.recordFrictionInjection(this.lastFrictionLog);\r\n        }\r\n\r\n        return FrictionInjector.buildPromptWithFriction(basePrompt, circularityResult);\r\n    }\r\n\r\n    /**\r\n     * Met a jour l'historique du canvas apres une operation\r\n     * Utilise CanvasAnalyzer si disponible, sinon fallback legacy\r\n     */\r\n    updateCanvasHistory(vignettes: KairosNode[], connections: KairosConnection[]): void {\r\n        // Nouveau syst√®me unifi√©\r\n        if (this.canvasAnalyzer) {\r\n            this.canvasAnalyzer.updateHistory(vignettes, connections);\r\n\r\n            return;\r\n        }\r\n\r\n        // Fallback legacy\r\n        if (this.canvasHistory) {\r\n            this.canvasHistory.update(vignettes, connections);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Retourne les statistiques de friction\r\n     */\r\n    getFrictionStats(): Record<string, unknown> | null {\r\n        // Nouveau syst√®me unifi√©\r\n        if (this.canvasAnalyzer) {\r\n            return {\r\n                history: this.canvasAnalyzer.history,\r\n                behaviorLogs: this.canvasAnalyzer.behaviorLogs,\r\n            };\r\n        }\r\n\r\n        // Fallback legacy\r\n        if (this.canvasHistory) {\r\n            return this.canvasHistory.getFrictionStats();\r\n        }\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * Reset l'historique de friction\r\n     */\r\n    resetFrictionHistory(): void {\r\n        // Nouveau syst√®me unifi√©\r\n        if (this.canvasAnalyzer) {\r\n            this.canvasAnalyzer.reset();\r\n            return;\r\n        }\r\n\r\n        // Fallback legacy\r\n        if (this.canvasHistory) {\r\n            this.canvasHistory.reset();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Effectue une analyse compl√®te du canvas (nouveau syst√®me)\r\n     */\r\n    analyzeCanvas(userInput: string = ''): Record<string, unknown> {\r\n        if (this.canvasAnalyzer) {\r\n            return this.canvasAnalyzer.analyze(userInput);\r\n        }\r\n\r\n        // Fallback: retourne une analyse basique avec les anciens modules\r\n        return {\r\n            attractors: [],\r\n            circularity: this.detectCircularity([], [], userInput, ''),\r\n            shouldInjectFriction: false,\r\n            recommendations: [],\r\n        };\r\n    }\r\n}\r\n","// Syst√®me de m√©triques et d√©cisions adaptatives pour F-Graph Canvas\r\n\r\nimport type { CanvasManagerLike } from '../types/kairos.js';\r\nimport type { PostureMetricsConfig } from '../posture-manager.js';\r\n\r\ninterface Metriques {\r\n    totalVignettes: number;\r\n    vignettesActives: number;\r\n    vignettePrioritaires: number;\r\n    vignetteNeutres: number;\r\n    vignetteConnectees: number;\r\n    connexionsTotal: number;\r\n    connexionsImplique: number;\r\n    connexionsResonance: number;\r\n    vignetteIsolees: number;\r\n    densiteConnexions: number;\r\n    ratioPriorite: number;\r\n}\r\n\r\ninterface OperationSuggestion {\r\n    operation: string | null;\r\n    raison: string;\r\n    priorite: string;\r\n    subMode?: 'approfondir' | 'diverger';\r\n    timestamp?: number;\r\n}\r\n\r\nexport class MetricsManager {\r\n    canvas: CanvasManagerLike;\r\n    analyzer: any;\r\n    metriques: Metriques;\r\n    suggestionActive: OperationSuggestion | null;\r\n    _debounceTimer: ReturnType<typeof setTimeout> | null;\r\n    _debounceDelay: number;\r\n\r\n    oxygen: any; // OxygenManager ‚Äî set by assisted-app.ts after init\r\n\r\n    // Posture-configurable thresholds (defaults = \"Nommer\" posture)\r\n    postureConfig: PostureMetricsConfig = {\r\n        synthesisVignetteThresholdHigh: 25,\r\n        synthesisVignetteThresholdMid: 15,\r\n        synthesisVignetteThresholdLow: 8,\r\n        synthesisDensityThreshold: 0.8,\r\n        synthesisDensityMinNodes: 12,\r\n    };\r\n\r\n    constructor(canvasManager: CanvasManagerLike) {\r\n        this.canvas = canvasManager;\r\n        this.analyzer = null;\r\n        this.oxygen = null;\r\n        this.metriques = this.calculateMetrics();\r\n        this.suggestionActive = null;\r\n\r\n        // Debounce pour √©viter les recalculs excessifs\r\n        this._debounceTimer = null;\r\n        this._debounceDelay = 100; // ms\r\n    }\r\n\r\n    /**\r\n     * V√©rifie si les conditions sont r√©unies pour proposer une synth√®se (indicateur UI).\r\n     * Ne prescrit pas l'op√©ration ‚Äî l'utilisateur d√©cide via le menu.\r\n     * Condition : O‚ÇÇ > 60 ET vignettes connect√©es >= 8\r\n     */\r\n    isSynthesisReady(): boolean {\r\n        const oxygenScore = this.oxygen?.getScore?.() ?? 50;\r\n        return oxygenScore > 60 && this.metriques.vignetteConnectees >= 8;\r\n    }\r\n\r\n    /**\r\n     * Calcule toutes les m√©triques du canvas\r\n     */\r\n    calculateMetrics(): Metriques {\r\n        const nodes = this.canvas.state.nodes;\r\n        const connections = this.canvas.state.connections;\r\n\r\n        // Exclure les vignettes archiv√©es (synthesized) des m√©triques actives\r\n        const activeNodes = nodes.filter((n) => !n.synthesized);\r\n        const activeNodeIds = new Set(activeNodes.map((n) => n.id));\r\n\r\n        // Compter les vignettes par statut (actives uniquement)\r\n        const vignettePrioritaires = activeNodes.filter((n) => n.status === 'priority').length;\r\n        const vignetteNeutres = activeNodes.filter((n) => n.status === 'neutral').length;\r\n\r\n        // Exclure les connexions impliquant des vignettes archiv√©es\r\n        const activeConnections = connections.filter((c) => activeNodeIds.has(c.from) && activeNodeIds.has(c.to));\r\n\r\n        // Compter les connexions par type (actives uniquement)\r\n        const connexionsImplique = activeConnections.filter((c) => c.type === 'implies').length;\r\n        const connexionsResonance = activeConnections.filter((c) => c.type === 'resonance').length;\r\n\r\n        // Calculer les vignettes connect√©es et isol√©es (actives uniquement)\r\n        const connectedNodeIds = new Set<string>();\r\n        activeConnections.forEach((c) => {\r\n            connectedNodeIds.add(c.from);\r\n            connectedNodeIds.add(c.to);\r\n        });\r\n\r\n        // Vignettes connect√©es (actives uniquement)\r\n        const vignetteConnectees = activeNodes.filter((n) => connectedNodeIds.has(n.id)).length;\r\n\r\n        const vignetteIsolees = activeNodes.filter((n) => !connectedNodeIds.has(n.id)).length;\r\n\r\n        // Calculer les ratios\r\n        const totalVignettes = activeNodes.length;\r\n        const vignettesActives = totalVignettes;\r\n        const connexionsTotal = activeConnections.length;\r\n        const densiteConnexions = vignettesActives > 0 ? connexionsTotal / vignettesActives : 0;\r\n        const ratioPriorite = totalVignettes > 0 ? vignettePrioritaires / totalVignettes : 0;\r\n\r\n        this.metriques = {\r\n            totalVignettes,\r\n            vignettesActives,\r\n            vignettePrioritaires,\r\n            vignetteNeutres,\r\n            vignetteConnectees, // Vignettes avec au moins une connexion\r\n            connexionsTotal,\r\n            connexionsImplique,\r\n            connexionsResonance,\r\n            vignetteIsolees,\r\n            densiteConnexions: Math.round(densiteConnexions * 100) / 100,\r\n            ratioPriorite: Math.round(ratioPriorite * 100) / 100,\r\n        };\r\n\r\n        return this.metriques;\r\n    }\r\n\r\n    /**\r\n     * Recalcule les m√©triques avec debounce\r\n     */\r\n    recalculateDebounced(): void {\r\n        if (this._debounceTimer) {\r\n            clearTimeout(this._debounceTimer);\r\n        }\r\n        this._debounceTimer = setTimeout(() => {\r\n            this.calculateMetrics();\r\n            this.updateMetricsDisplay();\r\n            // Re-√©valuer oxygen sur les actions manuelles (create/delete node/connection)\r\n            if (this.oxygen && this.canvas) {\r\n                this.oxygen.evaluate(this.canvas.state.nodes, this.canvas.state.connections);\r\n                document.dispatchEvent(new CustomEvent('oxygenUpdated'));\r\n            }\r\n            this.updateSuggestionBanner();\r\n        }, this._debounceDelay);\r\n    }\r\n\r\n    /**\r\n     * D√©cide l'op√©ration LLM sugg√©r√©e selon la dynamique du canvas\r\n     * Utilise la diversit√© s√©mantique + circularit√© comme crit√®res primaires,\r\n     * avec fallback sur l'ancienne logique quantitative.\r\n     */\r\n    decideOperation(): OperationSuggestion {\r\n        const m = this.metriques;\r\n\r\n        // V√©rifier s'il y a une s√©lection active\r\n        const selectedIds = this.canvas.interaction?.selectedNodes;\r\n        const selectionCount = selectedIds?.size || 0;\r\n\r\n        // === MODE S√âLECTION : adapter la suggestion √† la s√©lection (inchang√©) ===\r\n        if (selectionCount > 0) {\r\n            return this.decideOperationForSelection(selectionCount, selectedIds!);\r\n        }\r\n\r\n        // === MODE GLOBAL : logique bas√©e sur la dynamique du canvas ===\r\n\r\n        const total = m.totalVignettes;\r\n        const ratioIsolees = total > 0 ? m.vignetteIsolees / total : 0;\r\n\r\n        // PRIORIT√â 1 : Bootstrap (inchang√©)\r\n        if (total < 3) {\r\n            return {\r\n                operation: 'D√âVELOPPER',\r\n                raison: 'Canvas en construction ‚Äî ajoutons des id√©es et tissons des liens.',\r\n                priorite: 'haute',\r\n            };\r\n        }\r\n\r\n        // PRIORIT√â 2 : Oxygen stale ‚Üí forcer DIVERGER (m√™me sans historique de diversit√©)\r\n        const oxygenScore = this.oxygen?.getScore?.() ?? 50;\r\n        if (oxygenScore < 50 && total >= 5) {\r\n            return {\r\n                operation: 'D√âVELOPPER',\r\n                subMode: 'diverger',\r\n                raison: `Canvas stale (O‚ÇÇ ${Math.round(oxygenScore)}) ‚Äî explorer un territoire adjacent.`,\r\n                priorite: oxygenScore < 30 ? 'urgente' : 'haute',\r\n            };\r\n        }\r\n\r\n        // Donn√©es de diversit√© (si analyzer disponible)\r\n        const analyzer = this.analyzer;\r\n        if (!analyzer) {\r\n            return this._decideOperationLegacy();\r\n        }\r\n\r\n        const trend = analyzer.diversityTrend();\r\n        const circularity = analyzer.detectCircularity();\r\n\r\n        // PRIORIT√â 3 : Donn√©es insuffisantes ‚Üí fallback quantitatif\r\n        if (trend === 'insufficient_data') {\r\n            return this._decideOperationLegacy();\r\n        }\r\n\r\n        // PRIORIT√â 4 : Convergence d√©tect√©e ‚Üí D√âVELOPPER en mode DIVERGER\r\n        if (trend === 'converging') {\r\n            if (circularity.score > 1) {\r\n                const circularityThreshold = analyzer.config?.circularityThreshold ?? 3;\r\n                if (circularity.score > circularityThreshold) {\r\n                    return {\r\n                        operation: 'D√âVELOPPER',\r\n                        subMode: 'diverger',\r\n                        raison: 'Le canvas converge et tourne ‚Äî bifurcation n√©cessaire.',\r\n                        priorite: 'urgente',\r\n                    };\r\n                }\r\n                return {\r\n                    operation: 'D√âVELOPPER',\r\n                    subMode: 'diverger',\r\n                    raison: 'Le canvas se referme ‚Äî explorer un territoire adjacent.',\r\n                    priorite: 'haute',\r\n                };\r\n            }\r\n            return {\r\n                operation: 'D√âVELOPPER',\r\n                subMode: 'diverger',\r\n                raison: 'Tendance √† la convergence ‚Äî varier les angles.',\r\n                priorite: 'moyenne',\r\n            };\r\n        }\r\n\r\n        // PRIORIT√â 5 : Exploration active ‚Üí structurer\r\n        if (trend === 'exploring' || trend === 'stable') {\r\n            if (ratioIsolees > 0.3 && total >= 5) {\r\n                return {\r\n                    operation: 'RELIER',\r\n                    raison: 'Exploration active ‚Äî cr√©er des ponts entre les clusters.',\r\n                    priorite: 'moyenne',\r\n                };\r\n            }\r\n\r\n            if (m.densiteConnexions > this.postureConfig.synthesisDensityThreshold && total >= this.postureConfig.synthesisDensityMinNodes) {\r\n                return {\r\n                    operation: 'D√âVELOPPER',\r\n                    subMode: 'approfondir',\r\n                    raison: 'Canvas dense et diversifi√© ‚Äî approfondissons.',\r\n                    priorite: 'moyenne',\r\n                };\r\n            }\r\n        }\r\n\r\n        // PRIORIT√â 6 : Rien √† signaler\r\n        if (trend === 'stable' && circularity.score <= 1) {\r\n            return {\r\n                operation: null,\r\n                raison: 'Le canvas explore naturellement. Continuez.',\r\n                priorite: 'normale',\r\n            };\r\n        }\r\n\r\n        // D√âFAUT\r\n        return {\r\n            operation: 'D√âVELOPPER',\r\n            subMode: 'approfondir',\r\n            raison: 'Approfondir et relier les pistes existantes.',\r\n            priorite: 'normale',\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Ancienne logique quantitative ‚Äî conserv√©e comme fallback\r\n     * pour les cas avec donn√©es insuffisantes (< 3 points de diversit√©).\r\n     */\r\n    private _decideOperationLegacy(): OperationSuggestion {\r\n        const m = this.metriques;\r\n\r\n        if (m.vignetteConnectees >= this.postureConfig.synthesisVignetteThresholdHigh) {\r\n            return {\r\n                operation: 'D√âVELOPPER',\r\n                subMode: 'approfondir',\r\n                raison: 'Canvas riche ‚Äî approfondissons les pistes.',\r\n                priorite: 'haute',\r\n            };\r\n        }\r\n\r\n        if (m.vignetteConnectees >= this.postureConfig.synthesisVignetteThresholdMid) {\r\n            return {\r\n                operation: 'D√âVELOPPER',\r\n                subMode: 'approfondir',\r\n                raison: `${m.vignetteConnectees} id√©es connect√©es, poursuivons l'exploration.`,\r\n                priorite: 'moyenne',\r\n            };\r\n        }\r\n\r\n        const ratioIsolees = m.totalVignettes > 0 ? m.vignetteIsolees / m.totalVignettes : 0;\r\n        if (ratioIsolees > 0.3 && m.vignettesActives >= 5) {\r\n            return {\r\n                operation: 'RELIER',\r\n                raison: `${m.vignetteIsolees} id√©es isol√©es √† connecter`,\r\n                priorite: 'moyenne',\r\n            };\r\n        }\r\n\r\n        if (m.densiteConnexions < 0.5 && m.vignettesActives >= 5) {\r\n            return {\r\n                operation: 'D√âVELOPPER',\r\n                raison: 'Les id√©es sont peu connect√©es ‚Äî d√©veloppons et relions.',\r\n                priorite: 'moyenne',\r\n            };\r\n        }\r\n\r\n        return {\r\n            operation: 'D√âVELOPPER',\r\n            raison: 'D√©veloppons et connectons de nouvelles id√©es.',\r\n            priorite: 'normale',\r\n        };\r\n    }\r\n\r\n    /**\r\n     * D√©cide l'op√©ration pour une s√©lection de vignettes\r\n     */\r\n    decideOperationForSelection(count: number, selectedIds: Set<string>): OperationSuggestion {\r\n        const connections = this.canvas.state.connections;\r\n        const selectedSet = selectedIds instanceof Set ? selectedIds : new Set(selectedIds);\r\n        const internalConnections = connections.filter(\r\n            (c) => selectedSet.has(c.from) && selectedSet.has(c.to),\r\n        ).length;\r\n        const maxPossible = (count * (count - 1)) / 2;\r\n        const connectivityRatio = maxPossible > 0 ? internalConnections / maxPossible : 0;\r\n\r\n        // S√©lection peu connect√©e ‚Üí suggestion RELIER\r\n        if (connectivityRatio < 0.3 && count >= 5) {\r\n            return {\r\n                operation: 'RELIER',\r\n                raison: `${count} vignettes s√©lectionn√©es ‚Äî peu connect√©es entre elles.`,\r\n                priorite: 'moyenne',\r\n            };\r\n        }\r\n\r\n        // D√©faut ‚Üí suggestion D√âVELOPPER (l'utilisateur choisit via le menu)\r\n        return {\r\n            operation: 'D√âVELOPPER',\r\n            raison: `${count} vignette${count > 1 ? 's' : ''} s√©lectionn√©e${count > 1 ? 's' : ''} ‚Äî d√©veloppons et relions.`,\r\n            priorite: 'normale',\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Met √† jour la suggestion active (recalcul direct, pas de choix manuel)\r\n     */\r\n    updateSuggestion(): OperationSuggestion {\r\n        this.suggestionActive = this.decideOperation();\r\n        this.suggestionActive.timestamp = Date.now();\r\n        return this.suggestionActive;\r\n    }\r\n\r\n    /**\r\n     * Met √† jour l'affichage des m√©triques dans l'UI\r\n     */\r\n    updateMetricsDisplay(): void {\r\n        const metriquesText = document.getElementById('metriques-texte');\r\n        if (!metriquesText) return;\r\n\r\n        const m = this.metriques;\r\n        let text = `${m.totalVignettes} vignette${m.totalVignettes > 1 ? 's' : ''}, ${m.connexionsTotal} connexion${m.connexionsTotal > 1 ? 's' : ''}`;\r\n\r\n        if (m.vignettePrioritaires > 0) {\r\n            text += ` (${m.vignettePrioritaires} prioritaire${m.vignettePrioritaires > 1 ? 's' : ''})`;\r\n        }\r\n\r\n        if (m.vignetteIsolees > 0) {\r\n            text += ` \\u2022 ${m.vignetteIsolees} isol√©e${m.vignetteIsolees > 1 ? 's' : ''}`;\r\n        }\r\n\r\n        metriquesText.textContent = text;\r\n    }\r\n\r\n    /**\r\n     * Met √† jour l'affichage du bandeau de suggestion\r\n     */\r\n    updateSuggestionBanner(): void {\r\n        const bannerText = document.getElementById('suggestion-texte');\r\n        const banner = document.getElementById('bandeau-suggestion');\r\n\r\n        if (!bannerText || !banner) return;\r\n\r\n        const suggestion = this.updateSuggestion();\r\n\r\n        // Cas operation null : message neutre\r\n        if (!suggestion.operation) {\r\n            bannerText.textContent = `\\u2726 ${suggestion.raison}`;\r\n            banner.style.background = '';\r\n            return;\r\n        }\r\n\r\n        // Emoji selon l'op√©ration\r\n        const emojis: Record<string, string> = {\r\n            D√âVELOPPER: '\\uD83C\\uDF31',\r\n            RELIER: '\\uD83D\\uDD17',\r\n            SYNTH√âTISER: '\\uD83D\\uDCE6',\r\n        };\r\n\r\n        const emoji = emojis[suggestion.operation] || '\\uD83D\\uDCA1';\r\n        const subModeLabel = suggestion.subMode === 'diverger' ? ' (diverger)' : '';\r\n\r\n        // Bandeau informatif : emoji + raison (sans nom d'op√©ration prescriptif)\r\n        bannerText.textContent = `${emoji} ${suggestion.raison}`;\r\n\r\n        // R√©initialiser le style inline ‚Äî le CSS g√®re la couleur via var(--theme-bandeau-bg)\r\n        banner.style.background = '';\r\n\r\n        // Classe urgente sur le bandeau (CSS dans assisted.css avec !important)\r\n        if (suggestion.priorite === 'urgente') {\r\n            banner.classList.add('urgente');\r\n        } else {\r\n            banner.classList.remove('urgente');\r\n        }\r\n\r\n        // Badge synth√®se pr√™te (indicateur subtil sur le bouton SYNTH√âTISER)\r\n        const synthBadge = document.getElementById('synthesis-ready-badge');\r\n        if (synthBadge) {\r\n            synthBadge.classList.toggle('hidden', !this.isSynthesisReady());\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Retourne les m√©triques actuelles\r\n     */\r\n    getMetrics(): Metriques {\r\n        return this.metriques;\r\n    }\r\n\r\n    /**\r\n     * Retourne la suggestion active\r\n     */\r\n    getSuggestion(): OperationSuggestion | null {\r\n        return this.suggestionActive;\r\n    }\r\n\r\n    /**\r\n     * Formate les m√©triques pour l'affichage\r\n     */\r\n    formatMetricsForDisplay(): { summary: string; connections: string; isolated: string } {\r\n        const m = this.metriques;\r\n        return {\r\n            summary: `${m.totalVignettes} vignettes (${m.vignettePrioritaires} prioritaires, ${m.vignetteNeutres} neutres)`,\r\n            connections: `${m.connexionsTotal} connexions (densit√©: ${m.densiteConnexions})`,\r\n            isolated: `${m.vignetteIsolees} isol√©es`,\r\n        };\r\n    }\r\n}\r\n","/**\r\n * Config - Configuration et constantes du CanvasAnalyzer\r\n *\r\n * Responsabilit√© : Seuils, poids, patterns, stopwords\r\n *\r\n * @exports DEFAULT_CONFIG, SIGNALS, EMPTY_VALIDATION_PATTERNS, STOPWORDS, STORAGE_KEY\r\n */\r\n\r\nexport const STORAGE_KEY: string = 'kairos_canvas_analyzer';\r\n\r\n/**\r\n * Configuration par d√©faut\r\n */\r\nexport const DEFAULT_CONFIG = {\r\n    // Circularit√©\r\n    circularityThreshold: 3,\r\n    minTurnsBetweenFriction: 3,\r\n    stagnationThreshold: 3,\r\n    tagSaturationThreshold: 5,\r\n    echoSimilarityThreshold: 0.6,\r\n\r\n    // Diversit√© s√©mantique\r\n    diversityConvergenceThreshold: -0.1,\r\n    diversityExplorationThreshold: 0.1,\r\n    diversityHistoryMax: 50,\r\n\r\n};\r\n\r\n/**\r\n * Signaux de circularit√© avec poids\r\n */\r\nexport const SIGNALS: Record<string, { weight: number; description: string }> = {\r\n    reformulation: { weight: 2, description: \"Vignette s√©mantiquement proche d'une existante\" },\r\n    boucle_connexion: { weight: 3, description: 'Connexion qui forme un cycle A ‚Üí B ‚Üí C ‚Üí A' },\r\n    stagnation: { weight: 2, description: '3+ tours sans concept nouveau' },\r\n    validation_vide: { weight: 1, description: \"R√©ponse utilisateur type 'oui', 'ok'\" },\r\n    tags_satures: { weight: 1, description: 'M√™me tag sur >5 vignettes' },\r\n    echo_llm: { weight: 2, description: \"LLM r√©p√®te une formulation de l'utilisateur\" },\r\n};\r\n\r\n/**\r\n * Patterns de validation vide\r\n */\r\nexport const EMPTY_VALIDATION_PATTERNS: RegExp[] = [\r\n    /^(oui|ok|d'accord|ouais|yep|yes|yeah)[\\s!.]*$/i,\r\n    /^c'est [√ßc]a[\\s!.]*$/i,\r\n    /^exactement[\\s!.]*$/i,\r\n    /^parfait[\\s!.]*$/i,\r\n    /^bien[\\s!.]*$/i,\r\n    /^super[\\s!.]*$/i,\r\n    /^cool[\\s!.]*$/i,\r\n    /^je vois[\\s!.]*$/i,\r\n    /^(hm+|ah|oh)[\\s!.]*$/i,\r\n];\r\n\r\n/**\r\n * Stopwords pour extraction de mots-cl√©s\r\n */\r\nexport const STOPWORDS: Set<string> = new Set([\r\n    'le',\r\n    'la',\r\n    'les',\r\n    'un',\r\n    'une',\r\n    'de',\r\n    'du',\r\n    'des',\r\n    'et',\r\n    'ou',\r\n    'est',\r\n    'sont',\r\n    'dans',\r\n    'pour',\r\n    'qui',\r\n    'que',\r\n    'sur',\r\n    'par',\r\n    'avec',\r\n    'sans',\r\n    'ce',\r\n    'cette',\r\n    'ces',\r\n    'au',\r\n    'aux',\r\n    'en',\r\n    'ne',\r\n    'pas',\r\n    'plus',\r\n    'moins',\r\n    'tout',\r\n    'tous',\r\n    'toute',\r\n    'toutes',\r\n    'autre',\r\n    'autres',\r\n    'meme',\r\n    'comme',\r\n    'mais',\r\n    'donc',\r\n    'car',\r\n    'ni',\r\n    'si',\r\n    'se',\r\n    'son',\r\n    'sa',\r\n    'ses',\r\n    'leur',\r\n    'leurs',\r\n    'nous',\r\n    'vous',\r\n    'ils',\r\n    'elles',\r\n    'lui',\r\n    'elle',\r\n    'il',\r\n    'on',\r\n    'je',\r\n    'tu',\r\n    'etre',\r\n    'avoir',\r\n    'faire',\r\n    'dit',\r\n    'fait',\r\n    'peut',\r\n    'faut',\r\n    'doit',\r\n    'vers',\r\n    'chez',\r\n]);\r\n\r\n/**\r\n * Cr√©e un √©tat d'historique initial\r\n */\r\nexport function createInitialHistory() {\r\n    return {\r\n        vignettes: [],\r\n        connections: [],\r\n        turns: 0,\r\n        turnsWithoutNewConcept: 0,\r\n        lastFrictionInjection: -Infinity,\r\n        frictionLogs: [],\r\n        frictionBonus: false,\r\n        attractorScores: new Map(),\r\n        diversityHistory: [],\r\n    };\r\n}\r\n\r\n/**\r\n * Cr√©e un √©tat de tracking comportemental initial\r\n */\r\nexport function createInitialBehaviorLogs() {\r\n    return {\r\n        selections: new Map(), // nodeId -> { count, timestamps[] }\r\n        llmSends: new Map(), // nodeId -> { count, timestamps[], operations[] }\r\n        captures: new Map(), // nodeId -> { count, timestamps[] }\r\n        degreeHistory: new Map(), // nodeId -> [{ timestamp, degree }]\r\n        connectionEvents: [] as Array<{ timestamp: number; fromId: string; toId: string; type: string }>,\r\n    };\r\n}\r\n","/**\r\n * Chargeur de referentiels JSON pour le module Friction - KAIROS\r\n * Charge les fichiers depuis f-graph/variables/friction/\r\n *\r\n * @module referentielsLoader\r\n * @version 1.0\r\n * @date 2026-02-01\r\n */\r\n\r\ninterface ReferentielsData {\r\n    initiateurs: Record<string, any> | null;\r\n    reponses: Record<string, any> | null;\r\n    parasitaire: Record<string, any> | null;\r\n    seuils: Record<string, any> | null;\r\n}\r\n\r\ninterface WeightedItem {\r\n    pattern: string;\r\n    weight: number;\r\n    category: string;\r\n}\r\n\r\ninterface FileSpec {\r\n    key: keyof ReferentielsData;\r\n    file: string;\r\n}\r\n\r\ninterface FileResult {\r\n    key: keyof ReferentielsData;\r\n    data: Record<string, any> | null;\r\n}\r\n\r\ndeclare const CircularityDetector: {\r\n    REFERENTIELS?: Record<string, any>;\r\n    [key: string]: any;\r\n};\r\n\r\nexport const ReferentielsLoader: {\r\n    BASE_PATH: string;\r\n    referentiels: ReferentielsData;\r\n    loaded: boolean;\r\n    loading: boolean;\r\n    loadAll(): Promise<boolean>;\r\n    applyToDetector(): void;\r\n    extractAllItems(referentiel: Record<string, any> | null): any[];\r\n    extractItemsWithWeights(referentiel: Record<string, any> | null): WeightedItem[];\r\n    getInitiateurs(): WeightedItem[];\r\n    getParasitaires(): WeightedItem[];\r\n    getSeuils(): Record<string, any> | null;\r\n    detectInitiateurs(text: string): WeightedItem[];\r\n    detectParasitaires(text: string): WeightedItem[];\r\n} = {\r\n    /**\r\n     * Chemin relatif vers les referentiels (depuis kairos/src/renderer/)\r\n     */\r\n    BASE_PATH: 'data/variables/friction/',\r\n\r\n    /**\r\n     * Referentiels charges\r\n     */\r\n    referentiels: {\r\n        initiateurs: null,\r\n        reponses: null,\r\n        parasitaire: null,\r\n        seuils: null,\r\n    },\r\n\r\n    /**\r\n     * Statut de chargement\r\n     */\r\n    loaded: false,\r\n    loading: false,\r\n\r\n    /**\r\n     * Charge tous les referentiels\r\n     */\r\n    async loadAll(): Promise<boolean> {\r\n        if (this.loaded) return true;\r\n        if (this.loading) {\r\n            // Attendre que le chargement en cours se termine\r\n            while (this.loading) {\r\n                await new Promise<void>((r) => setTimeout(r, 50));\r\n            }\r\n            return this.loaded;\r\n        }\r\n\r\n        this.loading = true;\r\n        console.log('[ReferentielsLoader] Chargement des referentiels friction...');\r\n\r\n        try {\r\n            const files: FileSpec[] = [\r\n                { key: 'initiateurs', file: 'initiateurs_friction.json' },\r\n                { key: 'reponses', file: 'reponses_friction.json' },\r\n                { key: 'parasitaire', file: 'friction_parasitaire.json' },\r\n                { key: 'seuils', file: 'seuils.json' },\r\n            ];\r\n\r\n            const results: FileResult[] = await Promise.all(\r\n                files.map(async ({ key, file }): Promise<FileResult> => {\r\n                    try {\r\n                        const response = await fetch(this.BASE_PATH + file);\r\n                        if (!response.ok) {\r\n                            console.warn(`[ReferentielsLoader] ${file}: ${response.status}`);\r\n                            return { key, data: null };\r\n                        }\r\n                        const data = await response.json();\r\n                        return { key, data };\r\n                    } catch (e: any) {\r\n                        console.warn(`[ReferentielsLoader] Erreur ${file}:`, e.message);\r\n                        return { key, data: null };\r\n                    }\r\n                }),\r\n            );\r\n\r\n            // Stocker les resultats\r\n            for (const { key, data } of results) {\r\n                this.referentiels[key] = data;\r\n            }\r\n\r\n            // Verifier qu'au moins un referentiel est charge\r\n            const loadedCount = Object.values(this.referentiels).filter(Boolean).length;\r\n            this.loaded = loadedCount > 0;\r\n\r\n            console.log(`[ReferentielsLoader] ${loadedCount}/4 referentiels charges`);\r\n\r\n            // Appliquer les referentiels a CircularityDetector\r\n            if (this.loaded) {\r\n                this.applyToDetector();\r\n            }\r\n\r\n            return this.loaded;\r\n        } catch (error) {\r\n            console.error('[ReferentielsLoader] Erreur globale:', error);\r\n            return false;\r\n        } finally {\r\n            this.loading = false;\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Applique les referentiels charges a CircularityDetector\r\n     */\r\n    applyToDetector(): void {\r\n        if (typeof CircularityDetector === 'undefined') {\r\n            console.warn('[ReferentielsLoader] CircularityDetector non disponible');\r\n            return;\r\n        }\r\n\r\n        // Extraire les patterns de validation vide depuis les referentiels\r\n        if (this.referentiels.parasitaire) {\r\n            // Les patterns de bruit_sans_signal sont disponibles dans referentiels.parasitaire\r\n            // mais ne sont pas ajout√©s ici car les patterns de base suffisent\r\n        }\r\n\r\n        // Appliquer les seuils\r\n        if (this.referentiels.seuils) {\r\n            const seuils = this.referentiels.seuils;\r\n\r\n            // Seuil de friction\r\n            if (seuils.conversion_score?.moyenne?.points_min) {\r\n                // Le seuil dans seuils.json est pour le score de friction\r\n                // On peut l'utiliser pour calibrer FRICTION_THRESHOLD\r\n                console.log('[ReferentielsLoader] Seuils friction appliques');\r\n            }\r\n        }\r\n\r\n        // Exposer les patterns d'initiateurs pour detection avancee\r\n        if (this.referentiels.initiateurs) {\r\n            CircularityDetector.REFERENTIELS = CircularityDetector.REFERENTIELS || {};\r\n            CircularityDetector.REFERENTIELS.initiateurs = this.referentiels.initiateurs;\r\n        }\r\n\r\n        // Exposer les patterns parasitaires\r\n        if (this.referentiels.parasitaire) {\r\n            CircularityDetector.REFERENTIELS = CircularityDetector.REFERENTIELS || {};\r\n            CircularityDetector.REFERENTIELS.parasitaire = this.referentiels.parasitaire;\r\n        }\r\n\r\n        console.log('[ReferentielsLoader] Referentiels appliques a CircularityDetector');\r\n    },\r\n\r\n    /**\r\n     * Extrait tous les items d'un referentiel (aplatit les categories)\r\n     */\r\n    extractAllItems(referentiel: Record<string, any> | null): any[] {\r\n        if (!referentiel) return [];\r\n\r\n        const items: any[] = [];\r\n        for (const [key, value] of Object.entries(referentiel)) {\r\n            if (key === '_meta') continue;\r\n            if (value && Array.isArray(value.items)) {\r\n                items.push(...value.items);\r\n            }\r\n        }\r\n        return items;\r\n    },\r\n\r\n    /**\r\n     * Extrait les items avec leurs poids\r\n     */\r\n    extractItemsWithWeights(referentiel: Record<string, any> | null): WeightedItem[] {\r\n        if (!referentiel) return [];\r\n\r\n        const items: WeightedItem[] = [];\r\n        for (const [category, value] of Object.entries(referentiel)) {\r\n            if (category === '_meta') continue;\r\n            if (value && Array.isArray(value.items)) {\r\n                const weight: number = value.poids || 1.0;\r\n                for (const pattern of value.items) {\r\n                    items.push({ pattern, weight, category });\r\n                }\r\n            }\r\n        }\r\n        return items;\r\n    },\r\n\r\n    /**\r\n     * Retourne les patterns d'initiateurs de friction\r\n     */\r\n    getInitiateurs(): WeightedItem[] {\r\n        return this.extractItemsWithWeights(this.referentiels.initiateurs);\r\n    },\r\n\r\n    /**\r\n     * Retourne les patterns parasitaires\r\n     */\r\n    getParasitaires(): WeightedItem[] {\r\n        return this.extractItemsWithWeights(this.referentiels.parasitaire);\r\n    },\r\n\r\n    /**\r\n     * Retourne les seuils configures\r\n     */\r\n    getSeuils(): Record<string, any> | null {\r\n        return this.referentiels.seuils;\r\n    },\r\n\r\n    /**\r\n     * Verifie si un texte contient un pattern d'initiateur\r\n     */\r\n    detectInitiateurs(text: string): WeightedItem[] {\r\n        if (!text || !this.referentiels.initiateurs) return [];\r\n\r\n        const textLower = text.toLowerCase();\r\n        const detected: WeightedItem[] = [];\r\n\r\n        for (const item of this.getInitiateurs()) {\r\n            if (textLower.includes(item.pattern.toLowerCase())) {\r\n                detected.push(item);\r\n            }\r\n        }\r\n\r\n        return detected;\r\n    },\r\n\r\n    /**\r\n     * Verifie si un texte contient un pattern parasitaire\r\n     */\r\n    detectParasitaires(text: string): WeightedItem[] {\r\n        if (!text || !this.referentiels.parasitaire) return [];\r\n\r\n        const textLower = text.toLowerCase();\r\n        const detected: WeightedItem[] = [];\r\n\r\n        for (const item of this.getParasitaires()) {\r\n            if (textLower.includes(item.pattern.toLowerCase())) {\r\n                detected.push(item);\r\n            }\r\n        }\r\n\r\n        return detected;\r\n    },\r\n};\r\n","/**\r\n * Diversity - Indice de diversit√© s√©mantique du canvas\r\n *\r\n * Responsabilit√© : Calculer et historiser la diversit√© s√©mantique,\r\n * d√©tecter la tendance (convergence/exploration), extraire les tags dominants.\r\n *\r\n * Utilise les TAGS des vignettes en priorit√©, avec fallback sur les mots-cl√©s\r\n * du texte (Jaccard) quand un n≈ìud n'a pas de tags.\r\n *\r\n * D√©pendances :\r\n * - config.js : DEFAULT_CONFIG (seuils diversit√©), STOPWORDS\r\n *\r\n * @exports calculateDiversity, diversityTrend, getCanvasTopKeywords, bootstrapDiversityHistory\r\n */\r\n\r\nimport { DEFAULT_CONFIG, STOPWORDS } from './config.js';\r\n\r\nexport interface DiversityResult {\r\n    currentDistance: number;\r\n    nodeId?: string;\r\n    timestamp: number;\r\n}\r\n\r\nexport type DiversityTrend = 'converging' | 'exploring' | 'stable' | 'insufficient_data';\r\n\r\nexport interface TopKeyword {\r\n    keyword: string;\r\n    count: number;\r\n}\r\n\r\n/**\r\n * Normalise les tags d'une vignette pour la comparaison.\r\n * Retire le pr√©fixe #, lowercase, d√©duplique.\r\n */\r\nfunction normalizeTags(tags: string[] | undefined): string[] {\r\n    if (!tags || tags.length === 0) return [];\r\n    return [...new Set(tags.map((t) => t.replace(/^#/, '').toLowerCase().trim()).filter((t) => t.length > 0))];\r\n}\r\n\r\n/**\r\n * Extrait les mots-cl√©s significatifs d'un texte (fallback quand pas de tags).\r\n * Retire diacritiques, stopwords, mots courts (‚â§3 chars).\r\n */\r\nfunction extractKeywords(text: string): string[] {\r\n    if (!text) return [];\r\n    return text\r\n        .toLowerCase()\r\n        .normalize('NFD')\r\n        .replace(/[\\u0300-\\u036f]/g, '')\r\n        .split(/\\W+/)\r\n        .filter((w) => w.length > 3 && !STOPWORDS.has(w));\r\n}\r\n\r\n/**\r\n * Calcule la distance Jaccard entre deux ensembles de mots.\r\n * 0.0 = identiques, 1.0 = rien en commun.\r\n */\r\nfunction jaccardDistance(setA: string[], setB: string[]): number {\r\n    if (setA.length === 0 && setB.length === 0) return 1.0;\r\n    const a = new Set(setA);\r\n    const b = new Set(setB);\r\n    const intersection = [...a].filter((w) => b.has(w)).length;\r\n    const union = new Set([...a, ...b]).size;\r\n    return union > 0 ? 1 - intersection / union : 1.0;\r\n}\r\n\r\n/**\r\n * Calcule la diversit√© s√©mantique du dernier n≈ìud ajout√© par rapport aux existants.\r\n * Priorit√© aux TAGS ; fallback sur mots-cl√©s du texte (Jaccard) si pas de tags.\r\n * currentDistance proche de 1.0 = tr√®s diff√©rent (exploration)\r\n * currentDistance proche de 0.0 = tr√®s similaire (convergence)\r\n */\r\nexport function calculateDiversity(analyzer: any): DiversityResult {\r\n    const nodes = analyzer.canvas?.state?.nodes || [];\r\n\r\n    if (nodes.length < 2) {\r\n        return { currentDistance: 1.0, timestamp: Date.now() };\r\n    }\r\n\r\n    // Dernier n≈ìud = dernier du tableau (SQLite retourne en ordre rowid)\r\n    const latestNode = nodes[nodes.length - 1];\r\n    const latestTags = normalizeTags(latestNode.tags);\r\n    const latestKeywords = latestTags.length === 0 ? extractKeywords(latestNode.text) : [];\r\n\r\n    // Ni tags ni mots-cl√©s exploitables ‚Üí √©tat neutre\r\n    if (latestTags.length === 0 && latestKeywords.length === 0) {\r\n        return { currentDistance: 1.0, timestamp: Date.now() };\r\n    }\r\n\r\n    const distances: number[] = [];\r\n\r\n    for (const node of nodes) {\r\n        if (node.id === latestNode.id) continue;\r\n        const otherTags = normalizeTags(node.tags);\r\n\r\n        // Comparaison par tags si les deux n≈ìuds en ont\r\n        if (latestTags.length > 0 && otherTags.length > 0) {\r\n            const overlap = latestTags.filter((t) => otherTags.includes(t));\r\n            const maxLen = Math.max(latestTags.length, otherTags.length);\r\n            distances.push(1 - overlap.length / maxLen);\r\n            continue;\r\n        }\r\n\r\n        // Fallback : comparaison par mots-cl√©s du texte (Jaccard)\r\n        const wordsA = latestTags.length > 0 ? latestTags : latestKeywords;\r\n        const wordsB = otherTags.length > 0 ? otherTags : extractKeywords(node.text);\r\n        if (wordsB.length === 0) continue;\r\n\r\n        distances.push(jaccardDistance(wordsA, wordsB));\r\n    }\r\n\r\n    if (distances.length === 0) {\r\n        return { currentDistance: 1.0, timestamp: Date.now() };\r\n    }\r\n\r\n    const currentDistance = distances.reduce((a, b) => a + b, 0) / distances.length;\r\n\r\n    return {\r\n        currentDistance,\r\n        nodeId: latestNode.id,\r\n        timestamp: Date.now(),\r\n    };\r\n}\r\n\r\n/**\r\n * Calcule la tendance de diversit√© √† partir de l'historique.\r\n * Moyenne glissante pond√©r√©e sur les 8 derniers points (r√©cent = poids fort).\r\n * Minimum 5 points requis pour √©viter le bruit.\r\n */\r\nexport function diversityTrend(analyzer: any): DiversityTrend {\r\n    const history: DiversityResult[] = analyzer.history.diversityHistory || [];\r\n\r\n    if (history.length < 5) {\r\n        return 'insufficient_data';\r\n    }\r\n\r\n    // Prendre les 8 derniers points (ou moins)\r\n    const recent = history.slice(-8);\r\n\r\n    // Poids lin√©aires croissants : les points r√©cents comptent plus\r\n    const weights = recent.map((_, i) => i + 1);\r\n    const totalWeight = weights.reduce((a, b) => a + b, 0);\r\n    const midWeight = totalWeight / 2;\r\n\r\n    let cumWeight = 0;\r\n    let firstWeightedSum = 0;\r\n    let secondWeightedSum = 0;\r\n    let firstWeightTotal = 0;\r\n    let secondWeightTotal = 0;\r\n\r\n    for (let i = 0; i < recent.length; i++) {\r\n        cumWeight += weights[i];\r\n        if (cumWeight <= midWeight) {\r\n            firstWeightedSum += recent[i].currentDistance * weights[i];\r\n            firstWeightTotal += weights[i];\r\n        } else {\r\n            secondWeightedSum += recent[i].currentDistance * weights[i];\r\n            secondWeightTotal += weights[i];\r\n        }\r\n    }\r\n\r\n    const firstMean = firstWeightTotal > 0 ? firstWeightedSum / firstWeightTotal : 0;\r\n    const secondMean = secondWeightTotal > 0 ? secondWeightedSum / secondWeightTotal : 0;\r\n    const diff = secondMean - firstMean;\r\n    const config = analyzer.config || DEFAULT_CONFIG;\r\n\r\n    if (diff < (config.diversityConvergenceThreshold ?? -0.1)) {\r\n        return 'converging';\r\n    }\r\n    if (diff > (config.diversityExplorationThreshold ?? 0.1)) {\r\n        return 'exploring';\r\n    }\r\n    return 'stable';\r\n}\r\n\r\n/**\r\n * Extrait les tags les plus fr√©quents sur tout le canvas.\r\n * Utilis√© par le prompt D√âVELOPPER-DIVERGER pour indiquer au LLM quels th√®mes √©viter.\r\n * Conserve le nom `getCanvasTopKeywords` pour compatibilit√© API.\r\n */\r\nexport function getCanvasTopKeywords(analyzer: any, topN: number = 10): TopKeyword[] {\r\n    const nodes = analyzer.canvas?.state?.nodes || [];\r\n    const frequencyMap: Record<string, number> = {};\r\n\r\n    for (const node of nodes) {\r\n        const tags = normalizeTags(node.tags);\r\n        for (const tag of tags) {\r\n            frequencyMap[tag] = (frequencyMap[tag] || 0) + 1;\r\n        }\r\n    }\r\n\r\n    return Object.entries(frequencyMap)\r\n        .sort((a, b) => b[1] - a[1])\r\n        .slice(0, topN)\r\n        .map(([keyword, count]) => ({ keyword, count }));\r\n}\r\n\r\n/**\r\n * Peuple r√©troactivement le diversityHistory pour les canvas existants.\r\n * Appel√© √† l'init quand diversityHistory est vide mais le canvas a des n≈ìuds.\r\n * Simule l'ajout chronologique de chaque n≈ìud pour reconstituer la tendance.\r\n * Les n≈ìuds sont d√©j√† en ordre d'insertion (SQLite rowid).\r\n */\r\nexport function bootstrapDiversityHistory(analyzer: any): number {\r\n    const nodes = analyzer.canvas?.state?.nodes || [];\r\n    if (nodes.length < 3) return 0;\r\n\r\n    // D√©j√† peupl√© : ne pas re-bootstrapper\r\n    const existing = analyzer.history.diversityHistory || [];\r\n    if (existing.length >= 3) return 0;\r\n\r\n    const results: DiversityResult[] = [];\r\n\r\n    // Pour chaque n≈ìud √† partir du 2√®me, calculer sa diversit√© vs les pr√©c√©dents\r\n    for (let i = 1; i < nodes.length; i++) {\r\n        const currentNode = nodes[i];\r\n        const currentTags = normalizeTags(currentNode.tags);\r\n        const currentKeywords = currentTags.length === 0 ? extractKeywords(currentNode.text) : [];\r\n\r\n        // Ni tags ni mots-cl√©s ‚Üí ignorer\r\n        if (currentTags.length === 0 && currentKeywords.length === 0) continue;\r\n\r\n        const distances: number[] = [];\r\n\r\n        for (let j = 0; j < i; j++) {\r\n            const prevTags = normalizeTags(nodes[j].tags);\r\n\r\n            // Comparaison par tags si les deux en ont\r\n            if (currentTags.length > 0 && prevTags.length > 0) {\r\n                const overlap = currentTags.filter((t) => prevTags.includes(t));\r\n                const maxLen = Math.max(currentTags.length, prevTags.length);\r\n                distances.push(1 - overlap.length / maxLen);\r\n                continue;\r\n            }\r\n\r\n            // Fallback texte (Jaccard)\r\n            const wordsA = currentTags.length > 0 ? currentTags : currentKeywords;\r\n            const wordsB = prevTags.length > 0 ? prevTags : extractKeywords(nodes[j].text);\r\n            if (wordsB.length === 0) continue;\r\n\r\n            distances.push(jaccardDistance(wordsA, wordsB));\r\n        }\r\n\r\n        if (distances.length > 0) {\r\n            results.push({\r\n                currentDistance: distances.reduce((a, b) => a + b, 0) / distances.length,\r\n                nodeId: currentNode.id,\r\n                timestamp: Date.now(),\r\n            });\r\n        }\r\n    }\r\n\r\n    if (results.length === 0) return 0;\r\n\r\n    // Limiter au max configur√©\r\n    const maxEntries = analyzer.config?.diversityHistoryMax ?? DEFAULT_CONFIG.diversityHistoryMax;\r\n    analyzer.history.diversityHistory = results.slice(-maxEntries);\r\n\r\n    console.log(`[CanvasAnalyzer] Bootstrap diversit√© : ${results.length} points calcul√©s pour ${nodes.length} n≈ìuds`);\r\n    return results.length;\r\n}\r\n","/**\r\n * History - Gestion de l'historique et persistance du CanvasAnalyzer\r\n *\r\n * Responsabilit√© : Load/save SQLite via IPC, migration, tracking tours\r\n *\r\n * D√©pendances :\r\n * - config.js : STORAGE_KEY, createInitialHistory, createInitialBehaviorLogs\r\n * - window.fgraph.db.attractors : API IPC pour les attracteurs\r\n * - ReferentielsLoader : chargement des r√©f√©rentiels friction\r\n *\r\n * @exports saveHistory, loadHistory, migrateOldStorage, recordTurn, updateHistory,\r\n *          reset, loadReferentiels, setupEventListeners,\r\n *          trackSelection, trackLLMSend, trackCapture, trackConnectionEvent\r\n */\r\n\r\nimport { DEFAULT_CONFIG, createInitialHistory, createInitialBehaviorLogs } from './config.js';\r\nimport { ReferentielsLoader } from '../friction/referentielsLoader.js';\r\nimport { calculateDiversity } from './diversity.js';\r\nimport { getCanvasId } from '../../canvas-id-store.js';\r\n\r\n/**\r\n * Sauvegarde l'historique dans SQLite\r\n */\r\nexport async function saveHistory(analyzer: any): Promise<void> {\r\n    try {\r\n        const data = {\r\n            history: {\r\n                ...analyzer.history,\r\n                attractorScores: Object.fromEntries(analyzer.history.attractorScores),\r\n                diversityHistory: analyzer.history.diversityHistory || [],\r\n            },\r\n            behaviorLogs: {\r\n                selections: Object.fromEntries(analyzer.behaviorLogs.selections),\r\n                llmSends: Object.fromEntries(analyzer.behaviorLogs.llmSends),\r\n                captures: Object.fromEntries(analyzer.behaviorLogs.captures),\r\n                degreeHistory: Object.fromEntries(analyzer.behaviorLogs.degreeHistory),\r\n                connectionEvents: analyzer.behaviorLogs.connectionEvents,\r\n            },\r\n        };\r\n        await window.fgraph.db.attractors.upsert(getCanvasId(), data);\r\n    } catch (e: any) {\r\n        console.warn('[CanvasAnalyzer] Erreur sauvegarde:', e.message);\r\n    }\r\n}\r\n\r\n/**\r\n * Charge l'historique depuis SQLite\r\n */\r\nexport async function loadHistory(analyzer: any): Promise<void> {\r\n    try {\r\n        const data: any = await window.fgraph.db.attractors.getData(getCanvasId());\r\n\r\n        if (data && Object.keys(data).length > 0) {\r\n            if (data.history) {\r\n                analyzer.history = {\r\n                    ...analyzer.history,\r\n                    ...data.history,\r\n                    attractorScores: new Map(Object.entries(data.history.attractorScores || {})),\r\n                    diversityHistory: data.history.diversityHistory || [],\r\n                };\r\n            }\r\n\r\n            if (data.behaviorLogs) {\r\n                analyzer.behaviorLogs = {\r\n                    selections: new Map(Object.entries(data.behaviorLogs.selections || {})),\r\n                    llmSends: new Map(Object.entries(data.behaviorLogs.llmSends || {})),\r\n                    captures: new Map(Object.entries(data.behaviorLogs.captures || {})),\r\n                    degreeHistory: new Map(Object.entries(data.behaviorLogs.degreeHistory || {})),\r\n                    connectionEvents: data.behaviorLogs.connectionEvents || [],\r\n                };\r\n            }\r\n        }\r\n    } catch (e: any) {\r\n        console.warn('[CanvasAnalyzer] Erreur chargement:', e.message);\r\n        await reset(analyzer);\r\n    }\r\n}\r\n\r\n/**\r\n * Migre les anciennes cl√©s localStorage vers SQLite (une seule fois)\r\n * Note: La migration principale est g√©r√©e par db-migration.js\r\n * Cette fonction g√®re uniquement le cas o√π l'analyzer aurait des donn√©es r√©siduelles\r\n */\r\nexport async function migrateOldStorage(_analyzer: any): Promise<void> {\r\n    // La migration est maintenant g√©r√©e par db-migration.js\r\n    // Cette fonction est conserv√©e pour compatibilit√© mais ne fait rien\r\n    console.log('[CanvasAnalyzer] Migration g√©r√©e par db-migration.js');\r\n}\r\n\r\n/**\r\n * Enregistre un tour (appel√© apr√®s chaque action canvas)\r\n */\r\nexport async function recordTurn(analyzer: any): Promise<void> {\r\n    const currentNodes = analyzer.canvas?.state?.nodes || [];\r\n    const currentConnections = analyzer.canvas?.state?.connections || [];\r\n\r\n    const previousIds = new Set(analyzer.history.vignettes.map((v: any) => v.id));\r\n    let hasNewConcept = false;\r\n    let hasNewFrictionVignette = false;\r\n\r\n    for (const node of currentNodes) {\r\n        if (!previousIds.has(node.id)) {\r\n            hasNewConcept = true;\r\n            if (isFrictionVignette(node)) {\r\n                hasNewFrictionVignette = true;\r\n                console.log('[CanvasAnalyzer] Nouvelle vignette friction:', node.id);\r\n            }\r\n        }\r\n    }\r\n\r\n    // Bonus friction si nouvelle vignette friction\r\n    if (hasNewFrictionVignette) {\r\n        analyzer.history.frictionBonus = true;\r\n        document.dispatchEvent(new CustomEvent('frictionVignetteAccepted'));\r\n        console.log('[CanvasAnalyzer] Bonus friction activ√©');\r\n    }\r\n\r\n    // Compteur de stagnation\r\n    if (hasNewConcept) {\r\n        analyzer.history.turnsWithoutNewConcept = 0;\r\n    } else {\r\n        analyzer.history.turnsWithoutNewConcept++;\r\n    }\r\n\r\n    // Sauvegarder le snapshot\r\n    analyzer.history.vignettes = currentNodes.map((v: any) => ({\r\n        id: v.id,\r\n        text: v.text,\r\n        tags: v.tags ? [...v.tags] : [],\r\n        status: v.status,\r\n    }));\r\n\r\n    analyzer.history.connections = currentConnections.map((c: any) => ({\r\n        id: c.id,\r\n        from: c.from,\r\n        to: c.to,\r\n        type: c.type,\r\n    }));\r\n\r\n    analyzer.history.turns++;\r\n    await saveHistory(analyzer);\r\n\r\n    console.log(\r\n        `[CanvasAnalyzer] Tour ${analyzer.history.turns}, stagnation: ${analyzer.history.turnsWithoutNewConcept}`,\r\n    );\r\n}\r\n\r\n/**\r\n * Met √† jour l'historique avec les vignettes et connexions pass√©es\r\n * (appel√© par LLMManager.updateCanvasHistory)\r\n */\r\nexport async function updateHistory(analyzer: any, vignettes: any[], connections: any[]): Promise<void> {\r\n    const previousIds = new Set(analyzer.history.vignettes.map((v: any) => v.id));\r\n    let hasNewConcept = false;\r\n    let hasNewFrictionVignette = false;\r\n\r\n    console.log(\r\n        `[CanvasAnalyzer] updateHistory: ${vignettes.length} vignettes, previousIds: ${previousIds.size}, diversityHistory: ${(analyzer.history.diversityHistory || []).length}`,\r\n    );\r\n\r\n    for (const node of vignettes) {\r\n        if (!previousIds.has(node.id)) {\r\n            hasNewConcept = true;\r\n            console.log(`[CanvasAnalyzer] Nouveau concept d√©tect√©: ${node.id}`);\r\n            if (isFrictionVignette(node)) {\r\n                hasNewFrictionVignette = true;\r\n                console.log('[CanvasAnalyzer] Nouvelle vignette friction d√©tect√©e:', node.id);\r\n            }\r\n        }\r\n    }\r\n\r\n    // Bonus friction si nouvelle vignette friction\r\n    if (hasNewFrictionVignette) {\r\n        analyzer.history.frictionBonus = true;\r\n        document.dispatchEvent(new CustomEvent('frictionVignetteAccepted'));\r\n    }\r\n\r\n    // Compteur de stagnation\r\n    if (hasNewConcept) {\r\n        analyzer.history.turnsWithoutNewConcept = 0;\r\n    } else {\r\n        analyzer.history.turnsWithoutNewConcept++;\r\n    }\r\n\r\n    // Sauvegarder le snapshot\r\n    analyzer.history.vignettes = vignettes.map((v: any) => ({\r\n        id: v.id,\r\n        text: v.text,\r\n        tags: v.tags ? [...v.tags] : [],\r\n        status: v.status,\r\n    }));\r\n\r\n    analyzer.history.connections = connections.map((c: any) => ({\r\n        id: c.id,\r\n        from: c.from,\r\n        to: c.to,\r\n        type: c.type,\r\n    }));\r\n\r\n    analyzer.history.turns++;\r\n\r\n    // Calculer la diversit√© s√©mantique et l'ajouter √† l'historique\r\n    if (hasNewConcept) {\r\n        const diversityResult = calculateDiversity(analyzer);\r\n        if (!analyzer.history.diversityHistory) {\r\n            analyzer.history.diversityHistory = [];\r\n        }\r\n        analyzer.history.diversityHistory.push(diversityResult);\r\n        const maxEntries = analyzer.config?.diversityHistoryMax ?? DEFAULT_CONFIG.diversityHistoryMax;\r\n        if (analyzer.history.diversityHistory.length > maxEntries) {\r\n            analyzer.history.diversityHistory = analyzer.history.diversityHistory.slice(-maxEntries);\r\n        }\r\n        console.log(\r\n            `[CanvasAnalyzer] Diversit√© calcul√©e: distance=${diversityResult.currentDistance.toFixed(3)}, total=${analyzer.history.diversityHistory.length}`,\r\n        );\r\n    } else {\r\n        console.log('[CanvasAnalyzer] Pas de nouveau concept, diversit√© non calcul√©e');\r\n    }\r\n\r\n    await saveHistory(analyzer);\r\n}\r\n\r\n/**\r\n * R√©initialise l'historique\r\n */\r\nexport async function reset(analyzer: any): Promise<void> {\r\n    analyzer.history = createInitialHistory();\r\n    analyzer.behaviorLogs = createInitialBehaviorLogs();\r\n    analyzer.lastLLMOutput = '';\r\n    analyzer.lastUserInput = '';\r\n\r\n    await saveHistory(analyzer);\r\n    console.log('[CanvasAnalyzer] Reset');\r\n}\r\n\r\n/**\r\n * Charge les r√©f√©rentiels\r\n */\r\nexport async function loadReferentiels(analyzer: any): Promise<void> {\r\n    try {\r\n        const loaded = await ReferentielsLoader.loadAll();\r\n        if (loaded) {\r\n            analyzer.referentiels = ReferentielsLoader.referentiels;\r\n            console.log('[CanvasAnalyzer] R√©f√©rentiels charg√©s');\r\n        }\r\n    } catch (e: any) {\r\n        console.warn('[CanvasAnalyzer] R√©f√©rentiels non charg√©s:', e.message);\r\n    }\r\n}\r\n\r\n/**\r\n * Configure les event listeners pour le tracking\r\n */\r\nexport function setupEventListeners(analyzer: any): void {\r\n    // S√©lection de node\r\n    document.addEventListener('nodeSelected', (e: any) => {\r\n        trackSelection(analyzer, e.detail.nodeId);\r\n    });\r\n\r\n    // Cr√©ation de connexion\r\n    document.addEventListener('connectionCreated', (e: any) => {\r\n        trackConnectionEvent(analyzer, e.detail.fromId, e.detail.toId, 'created');\r\n    });\r\n\r\n    // Envoi au LLM\r\n    document.addEventListener('llmSend', (e: any) => {\r\n        if (e.detail.nodeId) {\r\n            trackLLMSend(analyzer, e.detail.nodeId, e.detail.operation);\r\n        }\r\n    });\r\n\r\n    // Capture de r√©ponse\r\n    document.addEventListener('captureTracked', (e: any) => {\r\n        if (e.detail.nodeId) {\r\n            trackCapture(analyzer, e.detail.nodeId);\r\n        }\r\n    });\r\n}\r\n\r\n/**\r\n * Track une s√©lection de node\r\n */\r\nexport function trackSelection(analyzer: any, nodeId: string): void {\r\n    const data = analyzer.behaviorLogs.selections.get(nodeId) || { count: 0, timestamps: [] };\r\n    data.count++;\r\n    data.timestamps.push(Date.now());\r\n    if (data.timestamps.length > 50) data.timestamps = data.timestamps.slice(-50);\r\n    analyzer.behaviorLogs.selections.set(nodeId, data);\r\n}\r\n\r\n/**\r\n * Track un envoi au LLM\r\n */\r\nexport function trackLLMSend(analyzer: any, nodeId: string, operation: string): void {\r\n    const data = analyzer.behaviorLogs.llmSends.get(nodeId) || { count: 0, timestamps: [], operations: [] };\r\n    data.count++;\r\n    data.timestamps.push(Date.now());\r\n    data.operations.push(operation);\r\n    if (data.timestamps.length > 50) {\r\n        data.timestamps = data.timestamps.slice(-50);\r\n        data.operations = data.operations.slice(-50);\r\n    }\r\n    analyzer.behaviorLogs.llmSends.set(nodeId, data);\r\n}\r\n\r\n/**\r\n * Track une capture de r√©ponse\r\n */\r\nexport function trackCapture(analyzer: any, nodeId: string): void {\r\n    const data = analyzer.behaviorLogs.captures.get(nodeId) || { count: 0, timestamps: [] };\r\n    data.count++;\r\n    data.timestamps.push(Date.now());\r\n    if (data.timestamps.length > 50) data.timestamps = data.timestamps.slice(-50);\r\n    analyzer.behaviorLogs.captures.set(nodeId, data);\r\n}\r\n\r\n/**\r\n * Track un √©v√©nement de connexion\r\n */\r\nexport function trackConnectionEvent(analyzer: any, fromId: string, toId: string, type: string): void {\r\n    analyzer.behaviorLogs.connectionEvents.push({\r\n        timestamp: Date.now(),\r\n        fromId,\r\n        toId,\r\n        type,\r\n    });\r\n    if (analyzer.behaviorLogs.connectionEvents.length > 100) {\r\n        analyzer.behaviorLogs.connectionEvents = analyzer.behaviorLogs.connectionEvents.slice(-100);\r\n    }\r\n}\r\n\r\n/**\r\n * V√©rifie si une vignette est une vignette friction (helper interne)\r\n */\r\nfunction isFrictionVignette(node: any): boolean {\r\n    if (!node) return false;\r\n    const textMatch = node.text?.includes('[FRICTION]');\r\n    const tagMatch = node.tags?.some(\r\n        (t: string) => t === 'friction' || t === '#friction' || t.toLowerCase() === 'friction',\r\n    );\r\n    return textMatch || tagMatch;\r\n}\r\n","/**\r\n * Friction - D√©tection de circularit√© et injection de friction\r\n *\r\n * Responsabilit√© : Circularit√©, stagnation, echo LLM, injection prompts\r\n *\r\n * D√©pendances :\r\n * - config.js : SIGNALS, EMPTY_VALIDATION_PATTERNS, STOPWORDS\r\n * - history.js : saveHistory\r\n *\r\n * @exports detectCircularity, detectReformulations, isSemanticallyClose,\r\n *          hasConnectionCycle, isNodeInCycle, detectSaturatedTags, nodeHasSaturatedTag,\r\n *          isEmptyValidation, detectLLMEcho, isFrictionVignette, canInjectFriction,\r\n *          buildFrictionBlock, injectFriction, generateRecommendations, extractKeywords\r\n */\r\n\r\nimport { SIGNALS, EMPTY_VALIDATION_PATTERNS, STOPWORDS } from './config.js';\r\nimport { saveHistory } from './history.js';\r\nimport { getTemplates, interpolateTemplate } from '../../../data/prompt-templates.js';\r\n\r\n/**\r\n * D√©tecte la circularit√© dans le canvas\r\n */\r\nexport function detectCircularity(analyzer: any): any {\r\n    const nodes = analyzer.canvas?.state?.nodes || [];\r\n    const connections = analyzer.canvas?.state?.connections || [];\r\n    const signals: string[] = [];\r\n    let score = 0;\r\n\r\n    // 1. Reformulation\r\n    const reformulations = detectReformulations(analyzer, nodes);\r\n    if (reformulations.length > 0) {\r\n        signals.push(`reformulation (${reformulations.length})`);\r\n        score += SIGNALS.reformulation.weight * reformulations.length;\r\n    }\r\n\r\n    // 2. Boucle de connexions\r\n    if (hasConnectionCycle(connections)) {\r\n        signals.push('boucle_connexion');\r\n        score += SIGNALS.boucle_connexion.weight;\r\n    }\r\n\r\n    // 3. Stagnation\r\n    if (analyzer.history.turnsWithoutNewConcept >= analyzer.config.stagnationThreshold) {\r\n        signals.push(`stagnation (${analyzer.history.turnsWithoutNewConcept} tours)`);\r\n        score += SIGNALS.stagnation.weight;\r\n    }\r\n\r\n    // 4. Validation vide\r\n    if (analyzer.lastUserInput && isEmptyValidation(analyzer.lastUserInput)) {\r\n        signals.push('validation_vide');\r\n        score += SIGNALS.validation_vide.weight;\r\n    }\r\n\r\n    // 5. Tags satur√©s\r\n    const saturatedTags = detectSaturatedTags(analyzer, nodes);\r\n    if (saturatedTags.length > 0) {\r\n        signals.push(`tags_satur√©s (${saturatedTags.join(', ')})`);\r\n        score += SIGNALS.tags_satures.weight * saturatedTags.length;\r\n    }\r\n\r\n    // 6. Echo LLM\r\n    if (analyzer.lastUserInput && analyzer.lastLLMOutput && detectLLMEcho(analyzer)) {\r\n        signals.push('echo_llm');\r\n        score += SIGNALS.echo_llm.weight;\r\n    }\r\n\r\n    // Appliquer bonus anti-circularit√© (vignette [FRICTION] ajout√©e)\r\n    let frictionBonusApplied = false;\r\n    if (analyzer.history.frictionBonus) {\r\n        score = Math.max(0, score - 1);\r\n        frictionBonusApplied = true;\r\n        analyzer.history.frictionBonus = false;\r\n        console.log('[CanvasAnalyzer] Bonus friction appliqu√© (-1)');\r\n    }\r\n\r\n    return {\r\n        score,\r\n        signals,\r\n        shouldInjectFriction: score > analyzer.config.circularityThreshold && canInjectFriction(analyzer),\r\n        frictionBonusApplied,\r\n        details: {\r\n            threshold: analyzer.config.circularityThreshold,\r\n            cooldownActive: !canInjectFriction(analyzer),\r\n        },\r\n    };\r\n}\r\n\r\n/**\r\n * D√©tecte les reformulations (vignettes s√©mantiquement proches)\r\n */\r\nexport function detectReformulations(analyzer: any, nodes: any[]): Array<[string, string]> {\r\n    const reformulations: Array<[string, string]> = [];\r\n\r\n    for (let i = 0; i < nodes.length; i++) {\r\n        for (let j = i + 1; j < nodes.length; j++) {\r\n            if (isSemanticallyClose(analyzer, nodes[i].text, nodes[j].text)) {\r\n                reformulations.push([nodes[i].id, nodes[j].id]);\r\n            }\r\n        }\r\n    }\r\n\r\n    return reformulations;\r\n}\r\n\r\n/**\r\n * V√©rifie si deux textes sont s√©mantiquement proches\r\n */\r\nexport function isSemanticallyClose(analyzer: any, text1: string, text2: string): boolean {\r\n    const kw1 = extractKeywords(text1);\r\n    const kw2 = extractKeywords(text2);\r\n\r\n    if (kw1.length < 2 || kw2.length < 2) return false;\r\n\r\n    const overlap = kw1.filter((k) => kw2.includes(k));\r\n    const similarity = overlap.length / Math.max(kw1.length, kw2.length);\r\n\r\n    return similarity > analyzer.config.echoSimilarityThreshold;\r\n}\r\n\r\n/**\r\n * D√©tecte les cycles dans le graphe de connexions\r\n */\r\nexport function hasConnectionCycle(connections: any[]): boolean {\r\n    if (!connections || connections.length < 3) return false;\r\n\r\n    const graph = new Map<string, string[]>();\r\n    for (const conn of connections) {\r\n        if (!graph.has(conn.from)) graph.set(conn.from, []);\r\n        graph.get(conn.from)!.push(conn.to);\r\n\r\n        if (conn.type === 'resonance') {\r\n            if (!graph.has(conn.to)) graph.set(conn.to, []);\r\n            graph.get(conn.to)!.push(conn.from);\r\n        }\r\n    }\r\n\r\n    const visited = new Set<string>();\r\n    const recursionStack = new Set<string>();\r\n\r\n    const hasCycle = (node: string): boolean => {\r\n        visited.add(node);\r\n        recursionStack.add(node);\r\n\r\n        for (const neighbor of graph.get(node) || []) {\r\n            if (!visited.has(neighbor)) {\r\n                if (hasCycle(neighbor)) return true;\r\n            } else if (recursionStack.has(neighbor)) {\r\n                return true;\r\n            }\r\n        }\r\n\r\n        recursionStack.delete(node);\r\n        return false;\r\n    };\r\n\r\n    for (const node of graph.keys()) {\r\n        if (!visited.has(node) && hasCycle(node)) {\r\n            return true;\r\n        }\r\n    }\r\n\r\n    return false;\r\n}\r\n\r\n/**\r\n * V√©rifie si un node sp√©cifique est dans un cycle\r\n */\r\nexport function isNodeInCycle(analyzer: any, nodeId: string): boolean {\r\n    const connections = analyzer.canvas?.state?.connections || [];\r\n    if (connections.length < 3) return false;\r\n\r\n    const graph = new Map<string, Set<string>>();\r\n    for (const conn of connections) {\r\n        if (!graph.has(conn.from)) graph.set(conn.from, new Set());\r\n        graph.get(conn.from)!.add(conn.to);\r\n\r\n        if (conn.type === 'resonance') {\r\n            if (!graph.has(conn.to)) graph.set(conn.to, new Set());\r\n            graph.get(conn.to)!.add(conn.from);\r\n        }\r\n    }\r\n\r\n    const neighbors = graph.get(nodeId);\r\n    if (!neighbors || neighbors.size === 0) return false;\r\n\r\n    for (const neighbor of neighbors) {\r\n        const visited = new Set([nodeId]);\r\n        const queue = [neighbor];\r\n\r\n        while (queue.length > 0) {\r\n            const current = queue.shift()!;\r\n            if (current === nodeId) return true;\r\n\r\n            if (visited.has(current)) continue;\r\n            visited.add(current);\r\n\r\n            for (const next of graph.get(current) || new Set()) {\r\n                if (!visited.has(next) || next === nodeId) {\r\n                    queue.push(next);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    return false;\r\n}\r\n\r\n/**\r\n * D√©tecte les tags satur√©s (>5 occurrences)\r\n */\r\nexport function detectSaturatedTags(analyzer: any, nodes: any[]): string[] {\r\n    const tagCounts = new Map<string, number>();\r\n\r\n    for (const node of nodes) {\r\n        for (const tag of node.tags || []) {\r\n            const normalized = tag.toLowerCase().replace(/^#/, '');\r\n            tagCounts.set(normalized, (tagCounts.get(normalized) || 0) + 1);\r\n        }\r\n    }\r\n\r\n    return [...tagCounts.entries()]\r\n        .filter(([_tag, count]) => count > analyzer.config.tagSaturationThreshold)\r\n        .map(([tag]) => `#${tag}`);\r\n}\r\n\r\n/**\r\n * V√©rifie si un node a un tag satur√©\r\n */\r\nexport function nodeHasSaturatedTag(analyzer: any, node: any, nodes: any[]): boolean {\r\n    const nodeTags = node.tags || [];\r\n    if (nodeTags.length === 0) return false;\r\n\r\n    const tagCounts = new Map<string, number>();\r\n    for (const n of nodes) {\r\n        for (const tag of n.tags || []) {\r\n            const normalized = tag.toLowerCase().replace(/^#/, '');\r\n            tagCounts.set(normalized, (tagCounts.get(normalized) || 0) + 1);\r\n        }\r\n    }\r\n\r\n    for (const tag of nodeTags) {\r\n        const normalized = tag.toLowerCase().replace(/^#/, '');\r\n        if ((tagCounts.get(normalized) || 0) > analyzer.config.tagSaturationThreshold) {\r\n            return true;\r\n        }\r\n    }\r\n\r\n    return false;\r\n}\r\n\r\n/**\r\n * V√©rifie si l'input est une validation vide\r\n */\r\nexport function isEmptyValidation(input: string): boolean {\r\n    return EMPTY_VALIDATION_PATTERNS.some((pattern) => pattern.test(input.trim()));\r\n}\r\n\r\n/**\r\n * D√©tecte si le LLM fait echo √† l'utilisateur\r\n */\r\nexport function detectLLMEcho(analyzer: any): boolean {\r\n    const userKeywords = extractKeywords(analyzer.lastUserInput);\r\n    const llmKeywords = extractKeywords(analyzer.lastLLMOutput);\r\n\r\n    if (userKeywords.length < 3) return false;\r\n\r\n    const overlap = userKeywords.filter((k) => llmKeywords.includes(k));\r\n    const similarity = overlap.length / userKeywords.length;\r\n\r\n    return similarity > analyzer.config.echoSimilarityThreshold;\r\n}\r\n\r\n/**\r\n * V√©rifie si une vignette est une vignette friction\r\n */\r\nexport function isFrictionVignette(node: any): boolean {\r\n    if (!node) return false;\r\n    const textMatch = node.text?.includes('[FRICTION]');\r\n    const tagMatch = node.tags?.some(\r\n        (t: string) => t === 'friction' || t === '#friction' || t.toLowerCase() === 'friction',\r\n    );\r\n    return textMatch || tagMatch;\r\n}\r\n\r\n/**\r\n * V√©rifie si on peut injecter de la friction (cooldown)\r\n */\r\nexport function canInjectFriction(analyzer: any): boolean {\r\n    const turnsSinceLastFriction = analyzer.history.turns - analyzer.history.lastFrictionInjection;\r\n    return turnsSinceLastFriction >= analyzer.config.minTurnsBetweenFriction;\r\n}\r\n\r\n/**\r\n * Construit le bloc de friction √† injecter dans le prompt (v2)\r\n * Messages diff√©renci√©s par op√©ration et niveau de circularit√©\r\n */\r\nexport function buildFrictionBlock(\r\n    circularityResult: any,\r\n    operation: string = 'D√âVELOPPER',\r\n    context: any = {},\r\n): string {\r\n    // SYNTH√âTISER n'a pas de friction - ses questions d'observation remplissent ce r√¥le\r\n    if (operation === 'SYNTH√âTISER') {\r\n        return '';\r\n    }\r\n\r\n    const score = circularityResult.score || 0;\r\n    const threshold = circularityResult.details?.threshold || 2;\r\n\r\n    // D√©terminer le niveau : mod√©r√© (score > threshold) ou fort (score > threshold * 1.5)\r\n    const isStrong = score > threshold * 1.5;\r\n\r\n    const templates = getTemplates().friction;\r\n\r\n    if (operation === 'D√âVELOPPER') {\r\n        if (isStrong && context.recentKeywords) {\r\n            return interpolateTemplate(templates.develop.strong, { recentKeywords: context.recentKeywords });\r\n        } else {\r\n            return templates.develop.moderate;\r\n        }\r\n    }\r\n\r\n    if (operation === 'RELIER') {\r\n        if (isStrong && context.recentMechanisms) {\r\n            return interpolateTemplate(templates.link.strong, { recentMechanisms: context.recentMechanisms });\r\n        } else {\r\n            return templates.link.moderate;\r\n        }\r\n    }\r\n\r\n    // Fallback pour op√©rations inconnues (ne devrait pas arriver)\r\n    return '';\r\n}\r\n\r\n/**\r\n * Injecte la friction dans un prompt (v2)\r\n */\r\nexport function injectFriction(\r\n    analyzer: any,\r\n    basePrompt: string,\r\n    circularityResult: any,\r\n    operation: string = 'D√âVELOPPER',\r\n): string {\r\n    if (!circularityResult.shouldInjectFriction) {\r\n        return basePrompt;\r\n    }\r\n\r\n    // SYNTH√âTISER n'a pas de friction\r\n    if (operation === 'SYNTH√âTISER') {\r\n        return basePrompt;\r\n    }\r\n\r\n    analyzer.history.lastFrictionInjection = analyzer.history.turns;\r\n    analyzer.history.frictionLogs.push({\r\n        turn: analyzer.history.turns,\r\n        score: circularityResult.score,\r\n        signals: circularityResult.signals,\r\n        operation: operation,\r\n        injected: true,\r\n        timestamp: new Date().toISOString(),\r\n    });\r\n\r\n    // Garder seulement les 50 derniers logs\r\n    if (analyzer.history.frictionLogs.length > 50) {\r\n        analyzer.history.frictionLogs = analyzer.history.frictionLogs.slice(-50);\r\n    }\r\n\r\n    saveHistory(analyzer);\r\n\r\n    // Construire le contexte pour friction niveau 2 (si disponible)\r\n    const context = buildFrictionContext(analyzer, operation);\r\n\r\n    return basePrompt + buildFrictionBlock(circularityResult, operation, context);\r\n}\r\n\r\n/**\r\n * Construit le contexte pour friction niveau 2\r\n */\r\nfunction buildFrictionContext(\r\n    analyzer: any,\r\n    operation: string,\r\n): { recentKeywords?: string; recentMechanisms?: string } {\r\n    const context: { recentKeywords?: string; recentMechanisms?: string } = {};\r\n    const nodes = analyzer.canvas?.state?.nodes || [];\r\n    const connections = analyzer.canvas?.state?.connections || [];\r\n\r\n    if (operation === 'D√âVELOPPER') {\r\n        // Extraire les mots-cl√©s des 5 derni√®res vignettes\r\n        const recentNodes = nodes.slice(-5);\r\n        const keywords = recentNodes\r\n            .map((n: any) => extractKeywords(n.text))\r\n            .flat()\r\n            .slice(0, 10);\r\n        if (keywords.length > 0) {\r\n            context.recentKeywords = keywords.join(', ');\r\n        }\r\n    } else if (operation === 'RELIER') {\r\n        // Extraire les m√©canismes des 5 derni√®res connexions\r\n        const recentConns = connections.filter((c: any) => c.mechanism).slice(-5);\r\n        const mechanisms = recentConns.map((c: any) => c.mechanism).filter(Boolean);\r\n        if (mechanisms.length > 0) {\r\n            context.recentMechanisms = mechanisms.join(' / ');\r\n        }\r\n    }\r\n\r\n    return context;\r\n}\r\n\r\n/**\r\n * G√©n√®re des recommandations bas√©es sur l'analyse\r\n */\r\nexport function generateRecommendations(\r\n    analyzer: any,\r\n    _attractors: any[],\r\n    circularity: any,\r\n): Array<{ type: string; message: string; priority: string; nodeId?: string }> {\r\n    const recommendations: Array<{ type: string; message: string; priority: string; nodeId?: string }> = [];\r\n\r\n    // Bas√© sur circularit√©\r\n    if (circularity.score > 0 && circularity.score <= analyzer.config.circularityThreshold) {\r\n        recommendations.push({\r\n            type: 'warning_circularity',\r\n            message: 'L√©g√®re circularit√© d√©tect√©e ‚Äî varier les angles',\r\n            priority: 'low',\r\n        });\r\n    }\r\n\r\n    if (circularity.signals.some((s: string) => s.includes('stagnation'))) {\r\n        recommendations.push({\r\n            type: 'stagnation',\r\n            message: 'Stagnation d√©tect√©e ‚Äî introduire un nouveau concept',\r\n            priority: 'high',\r\n        });\r\n    }\r\n\r\n    return recommendations;\r\n}\r\n\r\n/**\r\n * Extrait les mots-cl√©s d'un texte\r\n */\r\nexport function extractKeywords(text: string): string[] {\r\n    if (!text) return [];\r\n    return text\r\n        .toLowerCase()\r\n        .normalize('NFD')\r\n        .replace(/[\\u0300-\\u036f]/g, '')\r\n        .split(/\\W+/)\r\n        .filter((w) => w.length > 3 && !STOPWORDS.has(w));\r\n}\r\n","/**\r\n * CanvasAnalyzer - Analyse unifi√©e du canvas (Friction + Diversit√©)\r\n *\r\n * Fusionne les fonctionnalit√©s de :\r\n * - CircularityDetector (d√©tection de circularit√©)\r\n * - CanvasHistory (historique pour stagnation)\r\n * - FrictionInjector (injection dans les prompts)\r\n *\r\n * Modularis√© en 3 modules:\r\n * - config.js : Configuration, seuils, constantes\r\n * - history.js : Persistance, tracking tours, migration\r\n * - friction.js : Circularit√©, stagnation, injection\r\n *\r\n * @module CanvasAnalyzer\r\n * @version 3.0.0\r\n */\r\n\r\nimport type { KairosNode, KairosConnection, CircularityResult, AppLike, CanvasManagerLike } from '../types/kairos.js';\r\n\r\n// === IMPORTS DES MODULES ===\r\nimport {\r\n    DEFAULT_CONFIG,\r\n    SIGNALS,\r\n    EMPTY_VALIDATION_PATTERNS,\r\n    STOPWORDS,\r\n    STORAGE_KEY,\r\n    createInitialHistory,\r\n    createInitialBehaviorLogs,\r\n} from './analyzer/config.js';\r\n\r\nimport {\r\n    saveHistory as _saveHistory,\r\n    loadHistory as _loadHistory,\r\n    migrateOldStorage as _migrateOldStorage,\r\n    recordTurn as _recordTurn,\r\n    updateHistory as _updateHistory,\r\n    reset as _reset,\r\n    loadReferentiels as _loadReferentiels,\r\n    setupEventListeners as _setupEventListeners,\r\n    trackSelection as _trackSelection,\r\n    trackLLMSend as _trackLLMSend,\r\n    trackCapture as _trackCapture,\r\n    trackConnectionEvent as _trackConnectionEvent,\r\n} from './analyzer/history.js';\r\n\r\nimport {\r\n    calculateDiversity as _calculateDiversity,\r\n    diversityTrend as _diversityTrend,\r\n    getCanvasTopKeywords as _getCanvasTopKeywords,\r\n    bootstrapDiversityHistory as _bootstrapDiversityHistory,\r\n} from './analyzer/diversity.js';\r\nimport type { DiversityResult, DiversityTrend, TopKeyword } from './analyzer/diversity.js';\r\n\r\nimport {\r\n    detectCircularity as _detectCircularity,\r\n    detectReformulations as _detectReformulations,\r\n    isSemanticallyClose as _isSemanticallyClose,\r\n    hasConnectionCycle as _hasConnectionCycle,\r\n    detectSaturatedTags as _detectSaturatedTags,\r\n    nodeHasSaturatedTag as _nodeHasSaturatedTag,\r\n    isEmptyValidation as _isEmptyValidation,\r\n    detectLLMEcho as _detectLLMEcho,\r\n    isFrictionVignette as _isFrictionVignette,\r\n    canInjectFriction as _canInjectFriction,\r\n    buildFrictionBlock as _buildFrictionBlock,\r\n    injectFriction as _injectFriction,\r\n    generateRecommendations as _generateRecommendations,\r\n    extractKeywords as _extractKeywords,\r\n} from './analyzer/friction.js';\r\n\r\ninterface AnalyzerConfig {\r\n    circularityThreshold: number;\r\n    minTurnsBetweenFriction: number;\r\n    [key: string]: any;\r\n}\r\n\r\ninterface AnalyzerHistory {\r\n    turns: number;\r\n    turnsWithoutNewConcept: number;\r\n    lastFrictionInjection: number | null;\r\n    frictionBonus: boolean;\r\n    [key: string]: any;\r\n}\r\n\r\ninterface BehaviorLogs {\r\n    selections: Map<string, number>;\r\n    llmSends: Map<string, number>;\r\n    connectionEvents: Array<{ fromId: string; toId: string; type: string; timestamp: number }>;\r\n    [key: string]: any;\r\n}\r\n\r\ninterface AnalysisResult {\r\n    circularity: CircularityResult;\r\n    shouldInjectFriction: boolean;\r\n    recommendations: Array<{ type: string; message: string; priority: string; nodeId?: string }>;\r\n    history: {\r\n        turns: number;\r\n        turnsWithoutNewConcept: number;\r\n        lastFrictionInjection: number | null;\r\n    };\r\n}\r\n\r\nexport class CanvasAnalyzer {\r\n    app: AppLike;\r\n    canvas: CanvasManagerLike;\r\n\r\n    // √âtat unifi√©\r\n    history: AnalyzerHistory;\r\n    behaviorLogs: BehaviorLogs;\r\n\r\n    // Derni√®re sortie LLM (pour d√©tection echo)\r\n    lastLLMOutput: string;\r\n    lastUserInput: string;\r\n\r\n    // Configuration (copie modifiable)\r\n    config: AnalyzerConfig;\r\n\r\n    // Constantes expos√©es (r√©f√©rence aux modules)\r\n    SIGNALS: typeof SIGNALS;\r\n    EMPTY_VALIDATION_PATTERNS: typeof EMPTY_VALIDATION_PATTERNS;\r\n    STOPWORDS: typeof STOPWORDS;\r\n    STORAGE_KEY: typeof STORAGE_KEY;\r\n\r\n    // R√©f√©rentiels (charg√©s async)\r\n    referentiels: Record<string, any> | null;\r\n\r\n    constructor(app: AppLike) {\r\n        this.app = app;\r\n        this.canvas = app.canvas;\r\n\r\n        // √âtat unifi√©\r\n        this.history = createInitialHistory();\r\n        this.behaviorLogs = createInitialBehaviorLogs();\r\n\r\n        // Derni√®re sortie LLM (pour d√©tection echo)\r\n        this.lastLLMOutput = '';\r\n        this.lastUserInput = '';\r\n\r\n        // Configuration (copie modifiable)\r\n        this.config = { ...DEFAULT_CONFIG };\r\n\r\n        // Constantes expos√©es (r√©f√©rence aux modules)\r\n        this.SIGNALS = SIGNALS;\r\n        this.EMPTY_VALIDATION_PATTERNS = EMPTY_VALIDATION_PATTERNS;\r\n        this.STOPWORDS = STOPWORDS;\r\n        this.STORAGE_KEY = STORAGE_KEY;\r\n\r\n        // R√©f√©rentiels (charg√©s async)\r\n        this.referentiels = null;\r\n    }\r\n\r\n    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n    // INITIALISATION\r\n    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n\r\n    async init(): Promise<void> {\r\n        await _loadReferentiels(this);\r\n        await _loadHistory(this);\r\n        await _migrateOldStorage(this);\r\n        _setupEventListeners(this);\r\n\r\n        // Bootstrap diversit√© pour les canvas existants (pr√©-feature)\r\n        const bootstrapped = _bootstrapDiversityHistory(this);\r\n        if (bootstrapped > 0) {\r\n            await _saveHistory(this);\r\n        }\r\n\r\n        console.log('[CanvasAnalyzer] Initialis√©, tour:', this.history.turns);\r\n    }\r\n\r\n    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n    // ANALYSE UNIFI√âE (Point d'entr√©e principal)\r\n    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n\r\n    /**\r\n     * Analyse compl√®te du canvas\r\n     */\r\n    analyze(userInput: string = ''): AnalysisResult {\r\n        if (userInput) {\r\n            this.lastUserInput = userInput;\r\n        }\r\n\r\n        const circularity = _detectCircularity(this);\r\n\r\n        const shouldInjectFriction = circularity.score > this.config.circularityThreshold && _canInjectFriction(this);\r\n\r\n        return {\r\n            circularity,\r\n            shouldInjectFriction,\r\n            recommendations: _generateRecommendations(this, [], circularity),\r\n            history: {\r\n                turns: this.history.turns,\r\n                turnsWithoutNewConcept: this.history.turnsWithoutNewConcept,\r\n                lastFrictionInjection: this.history.lastFrictionInjection,\r\n            },\r\n        };\r\n    }\r\n\r\n    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n    // WRAPPERS HISTORY (async)\r\n    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n\r\n    saveHistory(): Promise<void> {\r\n        return _saveHistory(this);\r\n    }\r\n    loadHistory(): Promise<void> {\r\n        return _loadHistory(this);\r\n    }\r\n    migrateOldStorage(): Promise<void> {\r\n        return _migrateOldStorage(this);\r\n    }\r\n    recordTurn(): Promise<void> {\r\n        return _recordTurn(this);\r\n    }\r\n    updateHistory(vignettes: KairosNode[], connections: KairosConnection[]): Promise<void> {\r\n        return _updateHistory(this, vignettes, connections);\r\n    }\r\n    reset(): Promise<void> {\r\n        return _reset(this);\r\n    }\r\n    loadReferentiels(): Promise<void> {\r\n        return _loadReferentiels(this);\r\n    }\r\n    setupEventListeners(): void {\r\n        _setupEventListeners(this);\r\n    }\r\n\r\n    // Tracking comportemental\r\n    trackSelection(nodeId: string): void {\r\n        _trackSelection(this, nodeId);\r\n    }\r\n    trackLLMSend(nodeId: string, operation: string): void {\r\n        _trackLLMSend(this, nodeId, operation);\r\n    }\r\n    trackCapture(nodeId: string): void {\r\n        _trackCapture(this, nodeId);\r\n    }\r\n    trackConnectionEvent(fromId: string, toId: string, type: string): void {\r\n        _trackConnectionEvent(this, fromId, toId, type);\r\n    }\r\n\r\n    // Alias pour compatibilit√©\r\n    saveState(): Promise<void> {\r\n        return _saveHistory(this);\r\n    }\r\n\r\n    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n    // WRAPPERS FRICTION\r\n    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n\r\n    detectCircularity(): CircularityResult {\r\n        return _detectCircularity(this);\r\n    }\r\n    detectReformulations(nodes: KairosNode[]): any[] {\r\n        return _detectReformulations(this, nodes);\r\n    }\r\n    isSemanticallyClose(text1: string, text2: string): boolean {\r\n        return _isSemanticallyClose(this, text1, text2);\r\n    }\r\n    hasConnectionCycle(connections: KairosConnection[]): boolean {\r\n        return _hasConnectionCycle(connections);\r\n    }\r\n    detectSaturatedTags(nodes: KairosNode[]): string[] {\r\n        return _detectSaturatedTags(this, nodes);\r\n    }\r\n    nodeHasSaturatedTag(node: KairosNode, nodes: KairosNode[]): boolean {\r\n        return _nodeHasSaturatedTag(this, node, nodes);\r\n    }\r\n    isEmptyValidation(input: string): boolean {\r\n        return _isEmptyValidation(input);\r\n    }\r\n    detectLLMEcho(): boolean {\r\n        return _detectLLMEcho(this);\r\n    }\r\n    isFrictionVignette(node: KairosNode): boolean {\r\n        return _isFrictionVignette(node);\r\n    }\r\n    canInjectFriction(): boolean {\r\n        return _canInjectFriction(this);\r\n    }\r\n    buildFrictionBlock(\r\n        circularityResult: CircularityResult,\r\n        operation: string = 'D√âVELOPPER',\r\n        context: Record<string, any> = {},\r\n    ): string {\r\n        return _buildFrictionBlock(circularityResult, operation, context);\r\n    }\r\n    injectFriction(basePrompt: string, circularityResult: CircularityResult, operation: string = 'D√âVELOPPER'): string {\r\n        return _injectFriction(this, basePrompt, circularityResult, operation);\r\n    }\r\n    generateRecommendations(\r\n        circularity: CircularityResult,\r\n    ): Array<{ type: string; message: string; priority: string; nodeId?: string }> {\r\n        return _generateRecommendations(this, [], circularity);\r\n    }\r\n    extractKeywords(text: string): string[] {\r\n        return _extractKeywords(text);\r\n    }\r\n\r\n    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n    // WRAPPERS DIVERSITY\r\n    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n\r\n    calculateDiversity(): DiversityResult {\r\n        return _calculateDiversity(this);\r\n    }\r\n    diversityTrend(): DiversityTrend {\r\n        return _diversityTrend(this);\r\n    }\r\n    getCanvasTopKeywords(topN?: number): TopKeyword[] {\r\n        return _getCanvasTopKeywords(this, topN);\r\n    }\r\n\r\n    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n    // DEBUG\r\n    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n\r\n    /**\r\n     * Affiche l'√©tat complet du syst√®me\r\n     */\r\n    status(): AnalysisResult {\r\n        console.group('[CanvasAnalyzer] Status');\r\n\r\n        console.log('Configuration:');\r\n        console.log('  - Seuil circularit√©:', this.config.circularityThreshold);\r\n        console.log('  - Cooldown friction:', this.config.minTurnsBetweenFriction, 'tours');\r\n\r\n        console.log('Historique:');\r\n        console.log('  - Tours:', this.history.turns);\r\n        console.log('  - Stagnation:', this.history.turnsWithoutNewConcept, 'tours');\r\n        console.log('  - Derni√®re friction:', this.history.lastFrictionInjection);\r\n        console.log('  - Bonus friction:', this.history.frictionBonus);\r\n\r\n        console.log('Tracking:');\r\n        console.log('  - S√©lections:', this.behaviorLogs.selections.size, 'nodes');\r\n        console.log('  - Envois LLM:', this.behaviorLogs.llmSends.size, 'nodes');\r\n        console.log('  - Events connexions:', this.behaviorLogs.connectionEvents.length);\r\n\r\n        const analysis = this.analyze();\r\n        console.log('Analyse actuelle:');\r\n        console.log('  - Score circularit√©:', analysis.circularity.score);\r\n        console.log('  - Signaux:', analysis.circularity.signals);\r\n        console.log('  - Injection friction:', analysis.shouldInjectFriction ? 'OUI' : 'NON');\r\n\r\n        console.groupEnd();\r\n\r\n        return analysis;\r\n    }\r\n\r\n    /**\r\n     * Simule une circularit√© pour test\r\n     */\r\n    simulateCircularity(): AnalysisResult {\r\n        console.group('[CanvasAnalyzer] Simulation');\r\n\r\n        // Forcer des signaux\r\n        this.history.turnsWithoutNewConcept = 5;\r\n        this.lastUserInput = 'oui';\r\n\r\n        const analysis = this.analyze();\r\n\r\n        console.log('Score:', analysis.circularity.score);\r\n        console.log('Signaux:', analysis.circularity.signals);\r\n        console.log('Friction:', analysis.shouldInjectFriction ? 'OUI' : 'NON');\r\n\r\n        if (analysis.shouldInjectFriction) {\r\n            console.log('Bloc friction:');\r\n            console.log(_buildFrictionBlock(analysis.circularity));\r\n        }\r\n\r\n        // Restaurer\r\n        this.history.turnsWithoutNewConcept = 0;\r\n\r\n        console.groupEnd();\r\n\r\n        return analysis;\r\n    }\r\n\r\n    /**\r\n     * Force une friction au prochain appel\r\n     */\r\n    forceNextFriction(): void {\r\n        const original = this.config.circularityThreshold;\r\n        this.config.circularityThreshold = 0;\r\n        console.log('[CanvasAnalyzer] Seuil abaiss√© √† 0');\r\n\r\n        setTimeout(() => {\r\n            this.config.circularityThreshold = original;\r\n            console.log('[CanvasAnalyzer] Seuil restaur√© √†', original);\r\n        }, 30000);\r\n    }\r\n}\r\n","/**\r\n * Capture-Parsers - Fonctions pures de parsing des r√©ponses LLM\r\n *\r\n * Responsabilit√© : Extraction de vignettes et connexions depuis le texte brut LLM\r\n * Ces fonctions sont sans effet de bord (pas de DOM, pas de handler)\r\n *\r\n * D√©pendances : aucune (fonctions pures)\r\n *\r\n * @exports cleanSynthesisText, parseSuggestedPoles, parseSuggestedConnections, splitIntoNodes\r\n */\r\n\r\nimport { createLogger } from '../../logger.js';\r\nimport type { ParsedVignette, ParsedConnection } from '../../types/kairos.js';\r\n\r\nconst log = createLogger('WebviewHandler');\r\n\r\n/**\r\n * Nettoie le texte de synth√®se en retirant les questions de suivi du LLM\r\n * @param {string} text - Texte brut de la synth√®se\r\n * @returns {string} - Texte nettoy√©\r\n */\r\nexport function cleanSynthesisText(text: string): string {\r\n    if (!text) return '';\r\n\r\n    // Patterns qui indiquent des questions de suivi ou propositions du LLM\r\n    const endPatterns: RegExp[] = [\r\n        /\\n\\s*Souhaite[sz]?-(?:tu|vous)[^\\n]*/gi,\r\n        /\\n\\s*Veu[xt]-(?:tu|vous)[^\\n]*/gi,\r\n        /\\n\\s*Voulez-vous[^\\n]*/gi,\r\n        /\\n\\s*Si (?:tu |vous )souhaite[sz]?[^\\n]*/gi,\r\n        /\\n\\s*N'h√©site[sz]? pas[^\\n]*/gi,\r\n        /\\n\\s*Je peux (?:aussi|√©galement)[^\\n]*/gi,\r\n        /\\n\\s*Dois-je[^\\n]*/gi,\r\n        /\\n\\s*Faut-il[^\\n]*/gi,\r\n        /\\n\\s*(?:Est-ce que |)(?:tu veux|vous voulez)[^\\n]*/gi,\r\n        /\\n\\s*Je reste √† (?:ta|votre) disposition[^\\n]*/gi,\r\n        /\\n\\s*(?:Que |Qu'est-ce que )(?:tu |vous )(?:en )?pense[sz]?[^\\n]*/gi,\r\n    ];\r\n\r\n    let cleaned = text;\r\n\r\n    // Appliquer chaque pattern\r\n    for (const pattern of endPatterns) {\r\n        cleaned = cleaned.replace(pattern, '');\r\n    }\r\n\r\n    // Retirer les lignes vides multiples √† la fin\r\n    cleaned = cleaned.replace(/\\n\\s*\\n\\s*$/g, '\\n').trim();\r\n\r\n    return cleaned;\r\n}\r\n\r\n/**\r\n * Parse la r√©ponse du LLM pour extraire les vignettes structur√©es\r\n * Approche robuste bas√©e sur split() pour √©viter les probl√®mes de regex\r\n * Note: Toutes les vignettes import√©es ont le statut 'neutral' (‚óã) par d√©faut\r\n * @param {string} responseText - Texte de la r√©ponse\r\n */\r\nexport function parseSuggestedPoles(responseText: string): ParsedVignette[] {\r\n    const vignettes: ParsedVignette[] = [];\r\n\r\n    // Regex pour extraire les tags (supporte accents et tirets)\r\n    const extractTags = (str: string): string[] => {\r\n        if (!str) return [];\r\n        const tagRegex = /#[\\w\\u00C0-\\u017F][\\w\\u00C0-\\u017F-]*/g;\r\n        return str.match(tagRegex) || [];\r\n    };\r\n\r\n    // ===== FONCTION UTILITAIRE : Couper le texte au premier marqueur ou pattern de fin =====\r\n    // G√®re le cas o√π Gemini ne met pas de saut de ligne entre les vignettes\r\n    const cutAtNextMarker = (text: string): string => {\r\n        // Marqueurs qui indiquent le d√©but d'un nouvel √©l√©ment\r\n        const markers: RegExp[] = [\r\n            /\\[NOUVELLE\\s*VIGNETTE(?:\\s*\\d+)?\\]/i,\r\n            /\\[FRICTION\\]/i,\r\n            /\\[CONNEXION\\]/i,\r\n        ];\r\n\r\n        // Patterns qui indiquent la fin du contenu utile (Gemini ajoute souvent des questions)\r\n        const endPatterns: RegExp[] = [\r\n            /Souhaitez-vous/i,\r\n            /Voulez-vous/i,\r\n            /Si vous souhaitez/i,\r\n            /N'h\\u00E9sitez pas/i,\r\n            /Je peux aussi/i,\r\n            /Dois-je/i,\r\n        ];\r\n\r\n        let cutIndex = text.length;\r\n\r\n        // Couper aux marqueurs\r\n        for (const marker of markers) {\r\n            const match = text.match(marker);\r\n            if (match && match.index! > 0 && match.index! < cutIndex) {\r\n                cutIndex = match.index!;\r\n            }\r\n        }\r\n\r\n        // Couper aux patterns de fin\r\n        for (const pattern of endPatterns) {\r\n            const match = text.match(pattern);\r\n            if (match && match.index! > 0 && match.index! < cutIndex) {\r\n                cutIndex = match.index!;\r\n            }\r\n        }\r\n\r\n        return text.substring(0, cutIndex).trim();\r\n    };\r\n\r\n    // ===== M√âTHODE PRINCIPALE : Split par tous les marqueurs pertinents =====\r\n    // Split unifi√© par [NOUVELLE VIGNETTE], [FRICTION], etc.\r\n    const allMarkersRegex = /(\\[NOUVELLE\\s*VIGNETTE(?:\\s*\\d+)?\\]|\\[FRICTION\\])/gi;\r\n    const parts = responseText.split(allMarkersRegex);\r\n\r\n    log.info(`Split unifi\\u00E9: ${parts.length} parties`);\r\n    log.info(`Texte brut (200 premiers chars):`, responseText.substring(0, 200));\r\n\r\n    // Parcourir les parties : [texte_avant, marqueur1, contenu1, marqueur2, contenu2, ...]\r\n    for (let i = 1; i < parts.length; i += 2) {\r\n        const marker = parts[i];\r\n        const content = parts[i + 1] || '';\r\n\r\n        if (!marker || !content.trim()) continue;\r\n\r\n        const segment = content.trim();\r\n        log.info(`Marqueur: ${marker}, Segment:`, segment.substring(0, 100));\r\n\r\n        if (segment.length < 5) continue;\r\n\r\n        // D√©terminer si c'est une friction\r\n        const isFriction = /\\[FRICTION\\]/i.test(marker);\r\n\r\n        // Extraire le texte et les tags du segment\r\n        // Format attendu: \"Texte de la vignette | #tag1 #tag2\" ou juste \"Texte\"\r\n        let text = segment;\r\n        let tags: string[] = [];\r\n\r\n        // √âTAPE 1: D'abord couper aux patterns de fin et marqueurs\r\n        text = cutAtNextMarker(text);\r\n\r\n        // √âTAPE 2: Limiter √† la premi√®re ligne si multi-lignes\r\n        text = text.split('\\n')[0].trim();\r\n\r\n        // √âTAPE 3: Extraire texte et tags en utilisant le pipe comme s√©parateur\r\n        const pipeIndex = text.indexOf('|');\r\n        if (pipeIndex > 0) {\r\n            const beforePipe = text.substring(0, pipeIndex).trim();\r\n            const afterPipe = text.substring(pipeIndex + 1).trim();\r\n            // Extraire les tags uniquement de la partie apr√®s le pipe\r\n            tags = extractTags(afterPipe);\r\n            text = beforePipe;\r\n        } else {\r\n            // Pas de pipe - chercher les tags √† la fin du texte\r\n            const allTags = extractTags(text);\r\n            if (allTags.length > 0) {\r\n                tags = allTags;\r\n                // Retirer les tags du texte\r\n                text = text.replace(/\\s*#[\\w\\u00C0-\\u017F][\\w\\u00C0-\\u017F-]*/g, '').trim();\r\n            }\r\n        }\r\n\r\n        // √âTAPE 4: Couper aux fl√®ches ‚Üí ou ‚Üî (connexions embarqu√©es dans le texte)\r\n        // Le LLM g√©n√®re parfois \"Texte A ‚Üí Texte B\" au lieu de s√©parer vignette et connexion\r\n        const arrowIndex = text.search(/[\\u2192\\u2194]/);\r\n        if (arrowIndex > 0) {\r\n            text = text.substring(0, arrowIndex).trim();\r\n        }\r\n\r\n        // Nettoyer le texte final\r\n        const firstLine = text.trim();\r\n\r\n        if (firstLine.length > 5 && firstLine.length <= 500) {\r\n            // Pour les frictions, ajouter #friction si pas pr√©sent\r\n            if (isFriction && !tags.includes('#friction')) {\r\n                tags.push('#friction');\r\n            }\r\n\r\n            vignettes.push({\r\n                text: firstLine,\r\n                status: 'neutral',\r\n                tags: tags,\r\n                isFriction: isFriction,\r\n            });\r\n            log.debug(\r\n                `${isFriction ? 'Friction' : 'Vignette'} ajout\\u00E9e: \"${firstLine.substring(0, 50)}...\" tags:`,\r\n                tags,\r\n            );\r\n        }\r\n    }\r\n\r\n    log.info(`M\\u00E9thode split unifi\\u00E9: ${vignettes.length} vignettes extraites`);\r\n\r\n    if (vignettes.length > 0) return vignettes.slice(0, 10);\r\n\r\n    // ===== FALLBACK : Patterns alternatifs =====\r\n    let match: RegExpExecArray | null;\r\n\r\n    // Pattern 2 : Format num√©rot√© \"1. [Titre] Description | #tags\"\r\n    const altRegex = /\\d+\\.\\s*\\[([^\\]]+)\\]\\s*([^|#\\n]*)?(?:\\s*\\|[^|#\\n]*)?(?:\\s*\\|\\s*(#[^\\n]+))?/gi;\r\n\r\n    while ((match = altRegex.exec(responseText)) !== null) {\r\n        const title = match[1].trim();\r\n        if (title.toUpperCase() === 'CONNEXION') continue;\r\n\r\n        const description = match[2] ? match[2].trim() : '';\r\n        const tagsStr = match[3] || '';\r\n        const text = description ? `${title} - ${description}` : title;\r\n\r\n        if (text.length > 5) {\r\n            vignettes.push({\r\n                text,\r\n                status: 'neutral',\r\n                tags: extractTags(tagsStr),\r\n            });\r\n        }\r\n    }\r\n\r\n    log.info(`Pattern num\\u00E9rot\\u00E9 [Titre]: ${vignettes.length} total`);\r\n    if (vignettes.length > 0) return vignettes.slice(0, 10);\r\n\r\n    // Pattern 3 : Format num√©rot√© avec guillemets \"1. \"Texte\" | #tags\"\r\n    const quotedRegex =\r\n        /\\d+\\.\\s*[\"\"\\u201C\\u201D]([^\"\"\\u201C\\u201D]+)[\"\"\\u201C\\u201D]\\s*(?:\\|[^|#\\n]*)?(?:\\s*\\|\\s*(#[^\\n]+))?/gi;\r\n\r\n    while ((match = quotedRegex.exec(responseText)) !== null) {\r\n        const text = match[1].trim();\r\n        const tagsStr = match[2] || '';\r\n\r\n        if (text.length > 5) {\r\n            vignettes.push({\r\n                text,\r\n                status: 'neutral',\r\n                tags: extractTags(tagsStr),\r\n            });\r\n        }\r\n    }\r\n\r\n    log.info(`Pattern guillemets: ${vignettes.length} total`);\r\n    if (vignettes.length > 0) return vignettes.slice(0, 10);\r\n\r\n    // Pattern 4 : Format avec tiret \"- Texte\"\r\n    const dashRegex = /^-\\s+(.{10,200})$/gm;\r\n\r\n    while ((match = dashRegex.exec(responseText)) !== null) {\r\n        const text = match[1].trim();\r\n        const tags = extractTags(text);\r\n        const cleanText = text.replace(/\\s*#[\\w\\u00C0-\\u017F-]+/g, '').trim();\r\n\r\n        if (cleanText.length > 5) {\r\n            vignettes.push({\r\n                text: cleanText,\r\n                status: 'neutral',\r\n                tags: tags,\r\n            });\r\n        }\r\n    }\r\n\r\n    log.info(`Pattern tiret: ${vignettes.length} total`);\r\n    if (vignettes.length > 0) return vignettes.slice(0, 10);\r\n\r\n    // Pattern 5 : Format avec tiret et crochets - [Titre] Description | #tags\r\n    const dashBracketRegex = /-\\s*\\[([^\\]]+)\\]\\s*([^|#\\n]*)?(?:\\|[^|#\\n]*)?(?:\\s*\\|\\s*(#[^\\n]+))?/gi;\r\n\r\n    while ((match = dashBracketRegex.exec(responseText)) !== null) {\r\n        const title = match[1].trim();\r\n        if (title.toUpperCase() === 'CONNEXION') continue;\r\n\r\n        const description = match[2] ? match[2].trim() : '';\r\n        const tagsStr = match[3] || '';\r\n        const text = description ? `${title} - ${description}` : title;\r\n\r\n        if (text.length > 5) {\r\n            vignettes.push({\r\n                text,\r\n                status: 'neutral',\r\n                tags: extractTags(tagsStr),\r\n            });\r\n        }\r\n    }\r\n\r\n    log.info(`Pattern 5 (tiret crochets): ${vignettes.length} total`);\r\n    return vignettes.slice(0, 10);\r\n}\r\n\r\n/**\r\n * Parse les connexions sugg√©r√©es par le LLM\r\n * Format: [CONNEXION] \"Vignette A\" ‚Üí \"Vignette B\" | Justification\r\n * Symboles: ‚Üí (implique) ou ‚Üî (r√©sonance)\r\n * @param {string} responseText - Texte de la r√©ponse\r\n */\r\nexport function parseSuggestedConnections(responseText: string): ParsedConnection[] {\r\n    const connections: ParsedConnection[] = [];\r\n\r\n    // Fonction pour nettoyer les guillemets au d√©but et √† la fin\r\n    const cleanQuotes = (text: string): string => {\r\n        return text.replace(/^[\"\"\\u201C\\u201D\\s]+|[\"\"\\u201C\\u201D\\s]+$/g, '').trim();\r\n    };\r\n\r\n    // Approche robuste : split par [CONNEXION] puis parser chaque segment\r\n    const segments = responseText.split(/\\[CONNEXION\\]/gi);\r\n\r\n    for (let i = 1; i < segments.length; i++) {\r\n        const segment = segments[i].trim();\r\n        if (!segment) continue;\r\n\r\n        // Chercher le symbole ‚Üí ou ‚Üî comme s√©parateur principal\r\n        const arrowMatch = segment.match(/([\\u2192\\u2194])/);\r\n        if (!arrowMatch) continue;\r\n\r\n        const arrowIndex = arrowMatch.index!;\r\n        const symbolRaw = arrowMatch[1];\r\n\r\n        // Extraire fromText (avant la fl√®che) et le reste (apr√®s la fl√®che)\r\n        let fromText = segment.substring(0, arrowIndex).trim();\r\n        const afterArrow = segment.substring(arrowIndex + 1).trim();\r\n\r\n        // Nettoyer fromText des guillemets\r\n        fromText = cleanQuotes(fromText);\r\n\r\n        // Extraire toText et justification du reste\r\n        // Chercher le pipe | comme s√©parateur de justification\r\n        let toText = afterArrow;\r\n        let justification = '';\r\n\r\n        const pipeIndex = afterArrow.indexOf('|');\r\n        if (pipeIndex > 0) {\r\n            toText = afterArrow.substring(0, pipeIndex).trim();\r\n            justification = afterArrow.substring(pipeIndex + 1).trim();\r\n            // Couper la justification au prochain marqueur ou saut de ligne\r\n            justification = justification.split(/\\n|\\[CONNEXION\\]|\\[NOUVELLE/i)[0].trim();\r\n        } else {\r\n            // Pas de pipe - couper au saut de ligne ou prochain marqueur\r\n            toText = afterArrow.split(/\\n|\\[CONNEXION\\]|\\[NOUVELLE/i)[0].trim();\r\n        }\r\n\r\n        // Nettoyer toText des guillemets\r\n        toText = cleanQuotes(toText);\r\n\r\n        if (fromText.length < 3 || toText.length < 3) continue;\r\n\r\n        // Normaliser le symbole\r\n        const symbol = symbolRaw === '\\u2194' || symbolRaw === '\\u2194' ? '\\u2194' : '\\u2192';\r\n        const type = symbol === '\\u2194' ? 'resonance' : 'implies';\r\n\r\n        connections.push({\r\n            fromText,\r\n            toText,\r\n            type,\r\n            symbol,\r\n            justification,\r\n        });\r\n\r\n        log.debug(\r\n            `Connexion pars\\u00E9e: \"${fromText.substring(0, 30)}...\" ${symbol} \"${toText.substring(0, 30)}...\"${justification ? ` | ${justification.substring(0, 20)}...` : ''}`,\r\n        );\r\n    }\r\n\r\n    log.info(`${connections.length} connexion(s) pars√©e(s)`);\r\n    return connections.slice(0, 10);\r\n}\r\n\r\n/**\r\n * D√©coupe le contenu en morceaux logiques pour cr√©er des vignettes (fallback)\r\n * @param {string} content - Contenu √† d√©couper\r\n */\r\nexport function splitIntoNodes(content: string): ParsedVignette[] {\r\n    // Strat√©gie: d√©couper par paragraphes ou listes num√©rot√©es\r\n    const lines = content.split('\\n');\r\n    const nodes: ParsedVignette[] = [];\r\n    let currentParagraph = '';\r\n\r\n    for (const line of lines) {\r\n        const trimmed = line.trim();\r\n\r\n        // Ignorer les lignes vides\r\n        if (!trimmed) {\r\n            if (currentParagraph.length > 20) {\r\n                nodes.push({ text: currentParagraph.trim(), status: 'neutral', tags: [] });\r\n                currentParagraph = '';\r\n            }\r\n            continue;\r\n        }\r\n\r\n        // D√©tecter les √©l√©ments de liste ou titres\r\n        const isListItem = /^[-\\u2022*]\\s|^\\d+[.)]\\s/.test(trimmed);\r\n        const isTitle = /^#{1,3}\\s/.test(trimmed);\r\n\r\n        if (isListItem || isTitle) {\r\n            // Sauvegarder le paragraphe pr√©c√©dent\r\n            if (currentParagraph.length > 20) {\r\n                nodes.push({ text: currentParagraph.trim(), status: 'neutral', tags: [] });\r\n            }\r\n            currentParagraph = trimmed.replace(/^[-\\u2022*#]+\\s*/, '').replace(/^\\d+[.)]\\s*/, '');\r\n        } else {\r\n            currentParagraph += (currentParagraph ? ' ' : '') + trimmed;\r\n        }\r\n    }\r\n\r\n    // Derni√®re partie\r\n    if (currentParagraph.length > 20) {\r\n        nodes.push({ text: currentParagraph.trim(), status: 'neutral', tags: [] });\r\n    }\r\n\r\n    // Limiter la longueur des vignettes\r\n    return nodes\r\n        .filter((n) => n.text.length >= 10)\r\n        .map((n) => ({\r\n            ...n,\r\n            text: n.text.length > 300 ? n.text.substring(0, 297) + '...' : n.text,\r\n        }))\r\n        .slice(0, 10); // Maximum 10 vignettes\r\n}\r\n","/**\r\n * Capture - Capture des r√©ponses LLM et cr√©ation de vignettes\r\n *\r\n * Responsabilit√© : Capture r√©ponses, UI s√©lection, cr√©ation nodes, import vignettes\r\n * Les fonctions de parsing pur sont dans capture-parsers.ts (re-export√©es ici)\r\n *\r\n * D√©pendances :\r\n * - handler.webview : √âl√©ment webview\r\n * - handler.currentProvider : Provider actuel\r\n * - handler.canvas : CanvasManager pour cr√©er les vignettes\r\n *\r\n * @exports executeWithTimeout, showCaptureError, showManualCaptureModal,\r\n *          captureResponseFromLLM, captureWithMode, buildCaptureScript,\r\n *          createNodesFromResponse, showVignetteSelectionUI, importSingleVignette,\r\n *          importAllVignettes, findVignetteByText, createConnectionsFromParsed\r\n * @reexports cleanSynthesisText, parseSuggestedPoles, parseSuggestedConnections, splitIntoNodes\r\n */\r\n\r\nimport { updateStatus, updateCaptureButtonText, updateSuggestionBanner } from './ui-controls.js';\r\nimport { captureLastUserMessageForCircularity } from './monitor.js';\r\nimport { PROVIDER_SELECTORS } from './providers.js';\r\nimport { createLogger } from '../../logger.js';\r\nimport type { ParsedVignette, ParsedConnection } from '../../types/kairos.js';\r\n\r\n// Import pour usage local + re-export pour les consommateurs externes\r\nimport {\r\n    cleanSynthesisText,\r\n    parseSuggestedPoles,\r\n    parseSuggestedConnections,\r\n    splitIntoNodes,\r\n} from './capture-parsers.js';\r\n\r\nexport { cleanSynthesisText, parseSuggestedPoles, parseSuggestedConnections, splitIntoNodes };\r\n\r\nconst log = createLogger('WebviewHandler');\r\n\r\n/**\r\n * Execute JavaScript dans le webview avec timeout\r\n * √âvite les freezes sur les pages lentes ou non-responsive\r\n * @param {any} handler - Instance du handler\r\n * @param {string} script - Script √† ex√©cuter\r\n * @param {number} timeoutMs - Timeout en ms (optionnel)\r\n */\r\nexport async function executeWithTimeout(handler: any, script: string, timeoutMs: number | null = null): Promise<any> {\r\n    const timeout = timeoutMs || handler.captureTimeout;\r\n\r\n    const timeoutPromise = new Promise<never>((_, reject) => {\r\n        setTimeout(() => reject(new Error(`Timeout apr\\u00E8s ${timeout / 1000}s`)), timeout);\r\n    });\r\n\r\n    try {\r\n        return await Promise.race([handler.webview.executeJavaScript(script), timeoutPromise]);\r\n    } catch (error: any) {\r\n        if (error.message.includes('Timeout')) {\r\n            log.warn('Script timeout:', error.message);\r\n            throw error;\r\n        }\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Affiche une notification d'erreur avec options de r√©cup√©ration\r\n * @param {any} handler - Instance du handler\r\n * @param {string} message - Message d'erreur\r\n * @param {boolean} canRetry - Afficher le bouton r√©essayer\r\n */\r\nexport function showCaptureError(handler: any, message: string, canRetry: boolean = true): void {\r\n    // Supprimer notification existante\r\n    const existing = document.querySelector('.capture-error-notification');\r\n    if (existing) existing.remove();\r\n\r\n    const notification = document.createElement('div');\r\n    notification.className = 'capture-error-notification';\r\n    notification.innerHTML = `\r\n        <div class=\"capture-error-content\">\r\n            <span class=\"capture-error-icon\">\\u26A0\\uFE0F</span>\r\n            <span class=\"capture-error-message\">${message}</span>\r\n        </div>\r\n        <div class=\"capture-error-actions\">\r\n            ${canRetry ? '<button class=\"capture-error-retry\">R\\u00E9essayer</button>' : ''}\r\n            <button class=\"capture-error-manual\">Capture manuelle</button>\r\n            <button class=\"capture-error-close\">\\u00D7</button>\r\n        </div>\r\n    `;\r\n\r\n    document.body.appendChild(notification);\r\n\r\n    // Event listeners\r\n    notification.querySelector('.capture-error-close')?.addEventListener('click', () => {\r\n        notification.remove();\r\n    });\r\n\r\n    if (canRetry) {\r\n        notification.querySelector('.capture-error-retry')?.addEventListener('click', () => {\r\n            notification.remove();\r\n            captureResponseFromLLM(handler);\r\n        });\r\n    }\r\n\r\n    notification.querySelector('.capture-error-manual')?.addEventListener('click', () => {\r\n        notification.remove();\r\n        showManualCaptureModal(handler);\r\n    });\r\n\r\n    // Auto-dismiss apr√®s 15 secondes\r\n    setTimeout(() => notification.remove(), 15000);\r\n}\r\n\r\n/**\r\n * Affiche le modal de capture manuelle (fallback)\r\n * @param {any} handler - Instance du handler\r\n */\r\nexport function showManualCaptureModal(handler: any): void {\r\n    // Supprimer modal existant\r\n    const existing = document.getElementById('manual-capture-modal');\r\n    if (existing) existing.remove();\r\n\r\n    const modal = document.createElement('div');\r\n    modal.id = 'manual-capture-modal';\r\n    modal.className = 'manual-capture-overlay';\r\n    modal.innerHTML = `\r\n        <div class=\"manual-capture-modal\">\r\n            <div class=\"manual-capture-header\">\r\n                <h3>\\uD83D\\uDCCB Capture manuelle</h3>\r\n                <button class=\"manual-capture-close\">\\u00D7</button>\r\n            </div>\r\n            <div class=\"manual-capture-body\">\r\n                <p>La capture automatique a \\u00E9chou\\u00E9. Copiez-collez la r\\u00E9ponse du LLM ci-dessous :</p>\r\n                <textarea id=\"manual-capture-text\" spellcheck=\"true\" placeholder=\"Collez le texte ici...\"></textarea>\r\n            </div>\r\n            <div class=\"manual-capture-footer\">\r\n                <button class=\"manual-capture-cancel\">Annuler</button>\r\n                <button class=\"manual-capture-import\">Importer</button>\r\n            </div>\r\n        </div>\r\n    `;\r\n\r\n    document.body.appendChild(modal);\r\n\r\n    // Event listeners\r\n    const closeModal = () => modal.remove();\r\n\r\n    modal.querySelector('.manual-capture-close')!.addEventListener('click', closeModal);\r\n    modal.querySelector('.manual-capture-cancel')!.addEventListener('click', closeModal);\r\n\r\n    modal.querySelector('.manual-capture-import')!.addEventListener('click', () => {\r\n        const text = (document.getElementById('manual-capture-text') as HTMLTextAreaElement).value.trim();\r\n        if (text.length > 10) {\r\n            createNodesFromResponse(handler, text);\r\n            closeModal();\r\n            updateStatus(handler, 'Contenu import\\u00E9 manuellement', 'ready');\r\n        } else {\r\n            alert('Le texte est trop court (minimum 10 caract\\u00E8res)');\r\n        }\r\n    });\r\n\r\n    // Fermer en cliquant sur l'overlay\r\n    modal.addEventListener('click', (e) => {\r\n        if (e.target === modal) closeModal();\r\n    });\r\n\r\n    // Focus sur le textarea\r\n    setTimeout(() => (document.getElementById('manual-capture-text') as HTMLTextAreaElement | null)?.focus(), 100);\r\n}\r\n\r\n/**\r\n * Construit le script de capture principal pour ex√©cution dans le webview\r\n * @param {string} marker - Le marqueur √† rechercher (ou vide pour synth√®se)\r\n * @param {string} provider - Le provider actuel\r\n */\r\nexport function buildCaptureScript(marker: string, provider: string = 'claude'): string {\r\n    // S√©lecteurs centralis√©s depuis PROVIDER_SELECTORS\r\n    const providerConfig = PROVIDER_SELECTORS[provider];\r\n    const captureSelectors = providerConfig?.capture?.responseSelectors || [];\r\n    const captureFallback = providerConfig?.capture?.responseFallback || [];\r\n\r\n    return `\r\n        (function() {\r\n            const marker = '${marker}';\r\n            const currentProvider = '${provider}';\r\n            const captureSelectors = ${JSON.stringify(captureSelectors)};\r\n            const captureFallback = ${JSON.stringify(captureFallback)};\r\n            let fullContent = '';\r\n\r\n            // Patterns √† exclure (contenu du prompt utilisateur)\r\n            const excludePatterns = [\r\n                'FORMAT DE R\\u00C9PONSE OBLIGATOIRE',\r\n                'T\\u00C2CHE :',\r\n                'Tu es un assistant. Voici des vignettes',\r\n                'Exemple :',\r\n                'Utilise le texte EXACT des vignettes'\r\n            ];\r\n            const isPromptContent = (text) => excludePatterns.some(p => text.includes(p));\r\n\r\n            log.debug('Provider:', currentProvider, 'Marker:', marker || 'aucun');\r\n\r\n            // ===== CLAUDE.AI =====\r\n            if (currentProvider === 'claude') {\r\n            const claudeResponses = document.querySelectorAll(captureSelectors[0] || '[class*=\"font-claude-response\"]');\r\n            if (claudeResponses.length > 0) {\r\n                const extractAssistantContent = (container) => {\r\n                    const parts = [];\r\n                    const seenTexts = new Set();\r\n                    container.querySelectorAll('[class*=\"standard-markdown\"]').forEach(mdBlock => {\r\n                        if (mdBlock.closest('[class*=\"text-text-300\"]')) return;\r\n                        const text = (mdBlock.innerText || mdBlock.textContent || '').trim();\r\n                        if (text && text.length >= 10) {\r\n                            const key = text.substring(0, 100);\r\n                            if (!seenTexts.has(key)) {\r\n                                seenTexts.add(key);\r\n                                parts.push(text);\r\n                            }\r\n                        }\r\n                    });\r\n                    if (parts.length === 0) {\r\n                        container.querySelectorAll('[class*=\"font-claude-response-body\"]').forEach(el => {\r\n                            if (el.closest('[class*=\"text-text-300\"]')) return;\r\n                            const text = (el.innerText || el.textContent || '').trim();\r\n                            if (text && text.length >= 10) {\r\n                                const key = text.substring(0, 100);\r\n                                if (!seenTexts.has(key)) {\r\n                                    seenTexts.add(key);\r\n                                    parts.push(text);\r\n                                }\r\n                            }\r\n                        });\r\n                    }\r\n                    return parts.join('\\\\n\\\\n');\r\n                };\r\n\r\n                for (let i = claudeResponses.length - 1; i >= 0; i--) {\r\n                    const assistantText = extractAssistantContent(claudeResponses[i]);\r\n                    if (!marker && assistantText.length > 100) {\r\n                        fullContent = assistantText;\r\n                        break;\r\n                    }\r\n                    if (marker && assistantText.includes(marker)) {\r\n                        fullContent = assistantText;\r\n                        break;\r\n                    }\r\n                    if (assistantText.length > fullContent.length && assistantText.length > 200) {\r\n                        fullContent = assistantText;\r\n                    }\r\n                }\r\n            }\r\n            } // fin claude\r\n\r\n            // ===== CHATGPT =====\r\n            if (currentProvider === 'chatgpt' && fullContent.length < 50) {\r\n                let chatgptResponses = [];\r\n                for (const sel of captureSelectors) {\r\n                    chatgptResponses = document.querySelectorAll(sel);\r\n                    if (chatgptResponses.length > 0) break;\r\n                }\r\n                if (chatgptResponses.length > 0) {\r\n                    for (let i = chatgptResponses.length - 1; i >= 0; i--) {\r\n                        const markdown = chatgptResponses[i].querySelector('.markdown') || chatgptResponses[i];\r\n                        const text = (markdown.innerText || '').trim();\r\n                        if (!marker && text.length > 100) { fullContent = text; break; }\r\n                        if (marker && text.includes(marker)) { fullContent = text; break; }\r\n                        if (text.length > fullContent.length) fullContent = text;\r\n                    }\r\n                }\r\n            } // fin chatgpt\r\n\r\n            // ===== GEMINI =====\r\n            if (currentProvider === 'gemini' && fullContent.length < 50) {\r\n                let geminiResponses = [];\r\n                for (const sel of captureSelectors) {\r\n                    geminiResponses = document.querySelectorAll(sel);\r\n                    if (geminiResponses.length > 0) {\r\n                        log.debug('Gemini:S\\u00E9lecteur trouv\\u00E9:', sel, 'count:', geminiResponses.length);\r\n                        break;\r\n                    }\r\n                }\r\n\r\n                // Fonction pour extraire le texte en pr√©servant les sauts de ligne\r\n                const extractGeminiText = (element) => {\r\n                    const clone = element.cloneNode(true);\r\n                    clone.querySelectorAll('button, nav, header, footer, [role=\"button\"]').forEach(el => el.remove());\r\n\r\n                    // Collecter le texte des blocs en pr√©servant les sauts de ligne\r\n                    const blocks = clone.querySelectorAll('p, div, li, h1, h2, h3, h4, pre, blockquote');\r\n                    if (blocks.length > 0) {\r\n                        const parts = [];\r\n                        const seenTexts = new Set();\r\n                        blocks.forEach(block => {\r\n                            // Ignorer les blocs imbriqu√©s (√©viter doublons)\r\n                            if (block.querySelector('p, div, li')) return;\r\n                            const text = (block.innerText || '').trim();\r\n                            if (text && text.length > 3) {\r\n                                const key = text.substring(0, 80);\r\n                                if (!seenTexts.has(key)) {\r\n                                    seenTexts.add(key);\r\n                                    parts.push(text);\r\n                                }\r\n                            }\r\n                        });\r\n                        if (parts.length > 0) {\r\n                            return parts.join('\\\\n');\r\n                        }\r\n                    }\r\n                    // Fallback: innerText brut\r\n                    return (clone.innerText || '').trim();\r\n                };\r\n\r\n                if (geminiResponses.length > 0) {\r\n                    for (let i = geminiResponses.length - 1; i >= 0; i--) {\r\n                        const text = extractGeminiText(geminiResponses[i]);\r\n                        log.debug('Gemini:Texte extrait (100 chars):', text.substring(0, 100));\r\n                        if (isPromptContent(text)) continue;\r\n                        if (!marker && text.length > 100) { fullContent = text; break; }\r\n                        if (marker && text.includes(marker)) { fullContent = text; break; }\r\n                        if (text.length > fullContent.length && text.length > 100) fullContent = text;\r\n                    }\r\n                }\r\n            } // fin gemini\r\n\r\n            // ===== DEEPSEEK =====\r\n            if (currentProvider === 'deepseek' && fullContent.length < 50) {\r\n                let deepseekResponses = [];\r\n                for (const sel of captureSelectors) {\r\n                    deepseekResponses = document.querySelectorAll(sel);\r\n                    if (deepseekResponses.length > 0) break;\r\n                }\r\n\r\n                if (deepseekResponses.length > 0) {\r\n                    for (let i = deepseekResponses.length - 1; i >= 0; i--) {\r\n                        const el = deepseekResponses[i];\r\n                        // Exclure messages user\r\n                        if (el.closest('.user-message') || el.closest('[data-role=\"user\"]')) continue;\r\n                        const text = (el.innerText || '').trim();\r\n                        if (isPromptContent(text)) continue;\r\n                        if (!marker && text.length > 100) { fullContent = text; break; }\r\n                        if (marker && text.includes(marker)) { fullContent = text; break; }\r\n                        if (text.length > fullContent.length && text.length > 100) fullContent = text;\r\n                    }\r\n                }\r\n\r\n                // Fallback DeepSeek: s√©lecteurs fallback depuis config\r\n                if (fullContent.length < 50) {\r\n                    const fallbackSel = captureFallback.length > 0 ? captureFallback.join(', ') : '.ds-markdown, .ds-markdown--block';\r\n                    const allMd = document.querySelectorAll(fallbackSel);\r\n                    for (let i = allMd.length - 1; i >= 0; i--) {\r\n                        const el = allMd[i];\r\n                        if (el.closest('.user-message') || el.closest('[data-role=\"user\"]') || el.closest('[class*=\"user\"]')) continue;\r\n                        const text = (el.innerText || '').trim();\r\n                        if (isPromptContent(text)) continue;\r\n                        if (marker && text.includes(marker) && text.length > 100) { fullContent = text; break; }\r\n                        if (!marker && text.length > fullContent.length && text.length > 100) fullContent = text;\r\n                    }\r\n                }\r\n            } // fin deepseek\r\n\r\n            // ===== GROK =====\r\n            if (currentProvider === 'grok' && fullContent.length < 50) {\r\n                const grokResponses = document.querySelectorAll(captureSelectors.join(', '));\r\n                if (grokResponses.length > 0) {\r\n                    for (let i = grokResponses.length - 1; i >= 0; i--) {\r\n                        const text = (grokResponses[i].innerText || '').trim();\r\n                        if (isPromptContent(text)) continue;\r\n                        if (!marker && text.length > 100) { fullContent = text; break; }\r\n                        if (marker && text.includes(marker)) { fullContent = text; break; }\r\n                        if (text.length > fullContent.length && text.length > 100) fullContent = text;\r\n                    }\r\n                }\r\n            } // fin grok\r\n\r\n            // ===== FALLBACK G√âN√âRIQUE =====\r\n            if (fullContent.length < 50) {\r\n                log.debug('Fallback - recherche g\\u00E9n\\u00E9rique');\r\n                const allDivs = document.querySelectorAll('div');\r\n                allDivs.forEach(div => {\r\n                    const text = div.innerText || '';\r\n                    // Exclure le contenu du prompt et les messages user\r\n                    if (isPromptContent(text)) return;\r\n                    if (div.closest('.user-message') || div.closest('[data-role=\"user\"]') || div.closest('[class*=\"user\"]')) return;\r\n\r\n                    if (marker && text.includes(marker) && text.length > 100 && text.length < 10000) {\r\n                        if (text.length > fullContent.length) fullContent = text;\r\n                    } else if (!marker && text.length > fullContent.length && text.length > 100 && text.length < 10000) {\r\n                        fullContent = text;\r\n                    }\r\n                });\r\n            }\r\n\r\n            if (fullContent.length > 10) {\r\n                return { success: true, content: fullContent };\r\n            }\r\n            return { success: false, error: 'Aucun contenu trouv\\u00E9' };\r\n        })();\r\n    `;\r\n}\r\n\r\n/**\r\n * Capture la derni√®re r√©ponse du LLM et cr√©e des vignettes\r\n * @param {any} handler - Instance du handler\r\n */\r\nexport async function captureResponseFromLLM(handler: any): Promise<void> {\r\n    if (!handler.isReady) {\r\n        updateStatus(handler, 'Webview pas encore pr\\u00EAt', 'error');\r\n        return;\r\n    }\r\n\r\n    updateStatus(handler, 'Capture en cours...', 'loading');\r\n\r\n    // Marqueur √† chercher selon l'op√©ration\r\n    let marker = '[NOUVELLE VIGNETTE';\r\n    if (handler.currentOperation === 'RELIER') {\r\n        marker = '[CONNEXION]';\r\n    } else if (handler.currentOperation === 'SYNTH\\u00C9TISER') {\r\n        marker = ''; // Pas de marqueur pour synth√®se, on prend la derni√®re r√©ponse\r\n    }\r\n    log.info(\r\n        `Capture pour ${handler.currentOperation || 'standard'}, marqueur: \"${marker || 'aucun'}\", provider: ${handler.currentProvider}`,\r\n    );\r\n\r\n    const captureScript = buildCaptureScript(marker, handler.currentProvider);\r\n\r\n    try {\r\n        updateStatus(handler, 'Capture en cours...', 'loading');\r\n\r\n        // Utiliser executeWithTimeout pour √©viter les freezes\r\n        const result = await executeWithTimeout(handler, captureScript);\r\n\r\n        if (result.success && result.content) {\r\n            // DEBUG: Afficher le contenu brut captur√©\r\n            log.debug('Contenu brut captur\\u00E9:', result.content.substring(0, 500) + '...');\r\n            log.debug('Longueur:', result.content.length, 'caract\\u00E8res');\r\n            createNodesFromResponse(handler, result.content);\r\n\r\n            // √âmettre √©v√©nement pour tracking capture\r\n            const selectedIds = handler.canvas.interaction.selectedNodes;\r\n            document.dispatchEvent(\r\n                new CustomEvent('captureTracked', {\r\n                    detail: {\r\n                        nodeIds: selectedIds ? Array.from(selectedIds) : [],\r\n                    },\r\n                }),\r\n            );\r\n        } else {\r\n            const errorMsg = result.error || 'Contenu vide ou trop court';\r\n            log.warn('Capture \\u00E9chou\\u00E9e:', errorMsg);\r\n            updateStatus(handler, 'Capture \\u00E9chou\\u00E9e', 'error');\r\n            showCaptureError(handler, `Capture \\u00E9chou\\u00E9e: ${errorMsg}`);\r\n        }\r\n    } catch (e: any) {\r\n        log.error('Capture error:', e);\r\n\r\n        // Diff√©rencier timeout vs autres erreurs\r\n        if (e.message.includes('Timeout')) {\r\n            updateStatus(handler, 'Timeout - page trop lente', 'error');\r\n            showCaptureError(\r\n                handler,\r\n                'La capture a pris trop de temps. La page est peut-\\u00EAtre lente ou bloqu\\u00E9e.',\r\n            );\r\n        } else {\r\n            updateStatus(handler, 'Erreur de capture', 'error');\r\n            showCaptureError(handler, `Erreur: ${e.message}`);\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Capture avec un mode sp√©cifique choisi par l'utilisateur\r\n * @param {any} handler - Instance du handler\r\n * @param {string} mode - 'vignettes', 'connexions', 'synthese'\r\n */\r\nexport async function captureWithMode(handler: any, mode: string): Promise<void> {\r\n    if (!handler.isReady) {\r\n        updateStatus(handler, 'Webview pas encore pr\\u00EAt', 'error');\r\n        return;\r\n    }\r\n\r\n    log.info(`Capture manuelle mode: ${mode}`);\r\n    updateStatus(handler, `Capture ${mode} en cours...`, 'loading');\r\n\r\n    // D√©finir le marqueur selon le mode\r\n    const markers: Record<string, string> = {\r\n        vignettes: '[NOUVELLE VIGNETTE]',\r\n        connexions: '[CONNEXION]',\r\n        synthese: '', // Pas de marqueur, on prend tout le texte\r\n    };\r\n\r\n    const marker = markers[mode] || '';\r\n\r\n    // Messages d'erreur personnalis√©s\r\n    const errorMessages: Record<string, string> = {\r\n        vignettes:\r\n            \"Aucune vignette [NOUVELLE VIGNETTE] trouv\\u00E9e dans la r\\u00E9ponse.\\n\\nAssurez-vous que le LLM a g\\u00E9n\\u00E9r\\u00E9 des vignettes avec le format:\\n[NOUVELLE VIGNETTE] Texte de l'id\\u00E9e | #tag1 #tag2\",\r\n        connexions:\r\n            'Aucune connexion [CONNEXION] trouv\\u00E9e dans la r\\u00E9ponse.\\n\\nAssurez-vous que le LLM a g\\u00E9n\\u00E9r\\u00E9 des connexions avec le format:\\n[CONNEXION] \"Vignette A\" \\u2192 \"Vignette B\" | Justification',\r\n        synthese: 'Aucun texte narratif trouv\\u00E9 dans la r\\u00E9ponse.',\r\n    };\r\n\r\n    // Forcer le mode op√©ration pour le traitement\r\n    const operationMap: Record<string, string | null> = {\r\n        vignettes: 'D\\u00C9VELOPPER',\r\n        connexions: 'RELIER',\r\n        synthese: 'SYNTH\\u00C9TISER',\r\n    };\r\n\r\n    handler.currentOperation = operationMap[mode];\r\n\r\n    // R√©utiliser la capture existante\r\n    try {\r\n        // Ex√©cuter le script de capture standard avec le provider actuel\r\n        const captureScript = buildCaptureScript(marker, handler.currentProvider);\r\n        const result = await executeWithTimeout(handler, captureScript);\r\n\r\n        if (result.success && result.content) {\r\n            const content = result.content;\r\n\r\n            // V√©rifier si le contenu correspond au mode demand√©\r\n            if (mode !== 'synthese' && marker && !content.includes(marker)) {\r\n                // Aucun marqueur trouv√© - afficher erreur\r\n                updateStatus(handler, `Aucun ${mode} trouv\\u00E9`, 'error');\r\n                showCaptureError(handler, errorMessages[mode]);\r\n                handler.currentOperation = null;\r\n                return;\r\n            }\r\n\r\n            // Traiter le contenu selon le mode\r\n            log.info(`Contenu captur\\u00E9 (${content.length} caract\\u00E8res), traitement mode ${mode}`);\r\n            createNodesFromResponse(handler, content);\r\n        } else {\r\n            const errorMsg = result.error || 'Contenu vide';\r\n            log.warn('Capture \\u00E9chou\\u00E9e:', errorMsg);\r\n            updateStatus(handler, 'Capture \\u00E9chou\\u00E9e', 'error');\r\n            showCaptureError(handler, `${errorMessages[mode]}\\n\\nErreur technique: ${errorMsg}`);\r\n        }\r\n    } catch (e: any) {\r\n        log.error('Capture error:', e);\r\n        updateStatus(handler, 'Erreur de capture', 'error');\r\n        showCaptureError(handler, `Erreur: ${e.message}`);\r\n    } finally {\r\n        // Reset op√©ration si n√©cessaire\r\n    }\r\n}\r\n\r\n/**\r\n * Cr√©e des vignettes et connexions √† partir du texte captur√©\r\n * Affiche une UI de s√©lection au lieu d'auto-importer\r\n * Pour RELIER: ne parse que les connexions (pas de vignettes)\r\n * @param {any} handler - Instance du handler\r\n * @param {string} content - Contenu captur√©\r\n */\r\nexport function createNodesFromResponse(handler: any, content: string): void {\r\n    if (!content || content.trim().length === 0) {\r\n        updateStatus(handler, 'R\\u00E9ponse vide', 'error');\r\n        return;\r\n    }\r\n\r\n    // === TRACKING CIRCULARIT√â ===\r\n    // Capturer le dernier message user pour la d√©tection validation_vide et echo_llm\r\n    captureLastUserMessageForCircularity(handler);\r\n\r\n    // Stocker la r√©ponse LLM pour la d√©tection echo_llm\r\n    if ((window as any).app && (window as any).app.llm && (window as any).app.llm.canvasAnalyzer) {\r\n        (window as any).app.llm.canvasAnalyzer.lastLLMOutput = content;\r\n        log.info('lastLLMOutput stock\\u00E9 pour circularit\\u00E9');\r\n    }\r\n\r\n    log.info(`Capture pour op\\u00E9ration: ${handler.currentOperation || 'inconnue'}`);\r\n\r\n    // === MODE SYNTH√âTISER: Capturer le texte et proposer l'archivage ===\r\n    if (handler.currentOperation === 'SYNTH\\u00C9TISER') {\r\n        log.info(`SYNTH\\u00C9TISER: Texte captur\\u00E9 (${content.length} caract\\u00E8res)`);\r\n\r\n        // Nettoyer le texte de synth√®se des questions de suivi du LLM\r\n        const cleanedContent = cleanSynthesisText(content);\r\n        log.info(`SYNTH\\u00C9TISER: Texte nettoy\\u00E9 (${cleanedContent.length} caract\\u00E8res)`);\r\n\r\n        // √âmettre l'√©v√©nement pour d√©clencher le modal d'archivage\r\n        document.dispatchEvent(\r\n            new CustomEvent('responseCaptured', {\r\n                detail: {\r\n                    content: cleanedContent,\r\n                    operation: 'SYNTH\\u00C9TISER',\r\n                },\r\n            }),\r\n        );\r\n\r\n        updateStatus(handler, 'Synth\\u00E8se captur\\u00E9e - archivage propos\\u00E9', 'ready');\r\n\r\n        // Reset l'op√©ration et mettre √† jour l'UI\r\n        handler.currentOperation = null;\r\n        updateCaptureButtonText(handler);\r\n        updateSuggestionBanner();\r\n        return;\r\n    }\r\n\r\n    // === MODE RELIER: Uniquement des connexions, pas de vignettes ===\r\n    if (handler.currentOperation === 'RELIER') {\r\n        const connections = parseSuggestedConnections(content);\r\n        log.info(`RELIER: ${connections.length} connexions pars\\u00E9es`);\r\n\r\n        if (connections.length === 0) {\r\n            updateStatus(handler, 'Aucune connexion trouv\\u00E9e dans la r\\u00E9ponse', 'error');\r\n            return;\r\n        }\r\n\r\n        const created = createConnectionsFromParsed(handler, connections);\r\n        updateStatus(handler, `${created}/${connections.length} connexion(s) cr\\u00E9\\u00E9e(s)`, 'ready');\r\n\r\n        // Reset l'op√©ration et mettre √† jour l'UI\r\n        handler.currentOperation = null;\r\n        updateCaptureButtonText(handler);\r\n\r\n        // Attendre que les connexions soient cr√©√©es (asynchrone via queueConnection)\r\n        setTimeout(() => {\r\n            updateSuggestionBanner();\r\n        }, 150);\r\n        return;\r\n    }\r\n\r\n    // === MODE STANDARD (D√âVELOPPER): Vignettes + connexions ===\r\n\r\n    // 1. Parser les vignettes avec marqueurs [NOUVELLE VIGNETTE]\r\n    let vignettes = parseSuggestedPoles(content);\r\n    log.info(`Parsing texte: ${vignettes.length} vignettes trouv\\u00E9es`);\r\n\r\n    // 2. Fallback: d√©coupage simple si pas de marqueurs\r\n    if (vignettes.length === 0) {\r\n        vignettes = splitIntoNodes(content);\r\n        log.info(`Fallback d\\u00E9coupage: ${vignettes.length} vignettes`);\r\n    }\r\n\r\n    // 3. Parser les connexions optionnelles\r\n    const connections = parseSuggestedConnections(content);\r\n    log.info(`Connexions trouv\\u00E9es: ${connections.length}`);\r\n\r\n    // Si seulement des connexions (pas de nouvelles vignettes)\r\n    if (vignettes.length === 0 && connections.length > 0) {\r\n        const created = createConnectionsFromParsed(handler, connections);\r\n        updateStatus(handler, `${created} connexion(s) cr\\u00E9\\u00E9e(s)`, 'ready');\r\n        // Attendre que les connexions soient cr√©√©es puis mettre √† jour les m√©triques\r\n        setTimeout(() => {\r\n            updateSuggestionBanner();\r\n        }, 150);\r\n        return;\r\n    }\r\n\r\n    if (vignettes.length === 0) {\r\n        updateStatus(handler, 'Aucun contenu \\u00E0 importer', 'error');\r\n        return;\r\n    }\r\n\r\n    // Stocker les connexions en attente\r\n    handler.pendingTextConnections = connections;\r\n\r\n    // Afficher l'UI de s√©lection\r\n    showVignetteSelectionUI(handler, vignettes, content, connections.length);\r\n    updateStatus(handler, `${vignettes.length} vignette(s), ${connections.length} connexion(s)`, 'ready');\r\n\r\n    // Reset l'op√©ration et mettre √† jour l'UI\r\n    handler.currentOperation = null;\r\n    updateCaptureButtonText(handler); // Reset le bouton\r\n}\r\n\r\n/**\r\n * Affiche le panneau de s√©lection des vignettes captur√©es\r\n * @param {any} handler - Instance du handler\r\n * @param {Array} vignettes - Vignettes pars√©es\r\n * @param {string} originalContent - Contenu original pour archivage\r\n * @param {number} connectionsCount - Nombre de connexions d√©tect√©es\r\n */\r\nexport function showVignetteSelectionUI(\r\n    handler: any,\r\n    vignettes: ParsedVignette[],\r\n    originalContent: string,\r\n    connectionsCount: number = 0,\r\n): void {\r\n    // Supprimer un √©ventuel panneau existant\r\n    const existingPanel = document.getElementById('vignette-selection-panel');\r\n    if (existingPanel) {\r\n        existingPanel.remove();\r\n    }\r\n\r\n    // Cr√©er le panneau flottant\r\n    const panel = document.createElement('div');\r\n    panel.id = 'vignette-selection-panel';\r\n    panel.className = 'vignette-selection-panel';\r\n\r\n    // Header avec titre et bouton fermer\r\n    const header = document.createElement('div');\r\n    header.className = 'vignette-selection-header';\r\n    const connInfo = connectionsCount > 0 ? ` + ${connectionsCount} connexion(s)` : '';\r\n    header.innerHTML = `\r\n        <span class=\"vignette-selection-title\">\\uD83D\\uDCE5 ${vignettes.length} vignette(s)${connInfo}</span>\r\n        <button class=\"vignette-selection-close\" title=\"Fermer\">\\u2715</button>\r\n    `;\r\n    panel.appendChild(header);\r\n\r\n    // Conteneur des vignettes (scrollable)\r\n    const container = document.createElement('div');\r\n    container.className = 'suggested-poles';\r\n\r\n    const subtitle = document.createElement('div');\r\n    subtitle.className = 'suggested-poles-title';\r\n    subtitle.textContent = \"Cliquez sur une vignette pour l'importer\";\r\n    container.appendChild(subtitle);\r\n\r\n    // Cr√©er les √©l√©ments de vignette\r\n    vignettes.forEach((vignette, index) => {\r\n        const poleDiv = document.createElement('div');\r\n        poleDiv.className = 'suggested-pole';\r\n        poleDiv.dataset.index = String(index);\r\n\r\n        const textDiv = document.createElement('div');\r\n        textDiv.className = 'suggested-pole-text';\r\n        textDiv.textContent = vignette.text;\r\n\r\n        const statusDiv = document.createElement('div');\r\n        statusDiv.className = 'suggested-pole-status';\r\n        const tagsText = vignette.tags && vignette.tags.length > 0 ? vignette.tags.join(' ') : '';\r\n        statusDiv.textContent = `\\u25CB ${tagsText}`;\r\n\r\n        poleDiv.appendChild(textDiv);\r\n        poleDiv.appendChild(statusDiv);\r\n\r\n        // Click pour importer individuellement\r\n        poleDiv.addEventListener('click', () => {\r\n            if (!poleDiv.classList.contains('imported')) {\r\n                importSingleVignette(handler, vignette, poleDiv, index, vignettes.length);\r\n            }\r\n        });\r\n\r\n        container.appendChild(poleDiv);\r\n    });\r\n\r\n    panel.appendChild(container);\r\n\r\n    // Footer avec boutons d'action\r\n    const footer = document.createElement('div');\r\n    footer.className = 'vignette-selection-footer';\r\n\r\n    // Bouton \"Importer tout\"\r\n    const importAllBtn = document.createElement('button');\r\n    importAllBtn.className = 'import-all-btn';\r\n    importAllBtn.textContent = `\\uD83D\\uDCE5 Importer les ${vignettes.length} vignettes`;\r\n    importAllBtn.addEventListener('click', () => {\r\n        importAllVignettes(handler, vignettes, container, importAllBtn);\r\n    });\r\n    footer.appendChild(importAllBtn);\r\n\r\n    // Bouton \"Annuler\"\r\n    const cancelBtn = document.createElement('button');\r\n    cancelBtn.className = 'cancel-btn';\r\n    cancelBtn.textContent = 'Annuler';\r\n    cancelBtn.addEventListener('click', () => {\r\n        panel.remove();\r\n    });\r\n    footer.appendChild(cancelBtn);\r\n\r\n    panel.appendChild(footer);\r\n\r\n    // Gestionnaire de fermeture\r\n    header.querySelector('.vignette-selection-close')!.addEventListener('click', () => {\r\n        panel.remove();\r\n    });\r\n\r\n    // Ajouter au DOM (dans le conteneur principal ou body)\r\n    const mainContainer = document.querySelector('.canvas-area') || document.body;\r\n    mainContainer.appendChild(panel);\r\n\r\n    // Stocker la r√©f√©rence du contenu original pour l'archivage\r\n    panel.dataset.originalContent = originalContent;\r\n\r\n    log.info(`UI de s\\u00E9lection affich\\u00E9e avec ${vignettes.length} vignettes`);\r\n}\r\n\r\n/**\r\n * V√©rifie si un texte de connexion pars√© correspond au texte d'une vignette.\r\n * Comparaison par d√©but de texte (50 premiers caract√®res) pour robustesse.\r\n */\r\nfunction vignetteTextMatch(connText: string, vignetteText: string): boolean {\r\n    const a = connText.toLowerCase().trim().substring(0, 50);\r\n    const b = vignetteText.toLowerCase().trim().substring(0, 50);\r\n    return a === b || a.includes(b) || b.includes(a);\r\n}\r\n\r\n/**\r\n * Importe une seule vignette depuis le panneau de s√©lection\r\n * @param {any} handler - Instance du handler\r\n * @param {Object} vignette - Donn√©es de la vignette\r\n * @param {HTMLElement} poleDiv - √âl√©ment DOM de la vignette\r\n * @param {number} index - Index de la vignette\r\n * @param {number} total - Nombre total de vignettes\r\n */\r\nexport function importSingleVignette(\r\n    handler: any,\r\n    vignette: ParsedVignette,\r\n    poleDiv: HTMLElement,\r\n    index: number,\r\n    total: number,\r\n): void {\r\n    // Chercher la cible de connexion pour positionner pr√®s du n≈ìud li√©\r\n    let targetNodeId: string | null = null;\r\n    if (handler.pendingTextConnections && handler.pendingTextConnections.length > 0) {\r\n        for (const conn of handler.pendingTextConnections) {\r\n            // Si cette vignette est la cible, trouver le n≈ìud source existant\r\n            if (conn.toText) {\r\n                const fromNode = findVignetteByText(handler, conn.fromText);\r\n                if (fromNode && vignetteTextMatch(conn.toText, vignette.text)) {\r\n                    targetNodeId = fromNode.id;\r\n                    break;\r\n                }\r\n            }\r\n            // Si cette vignette est la source, trouver le n≈ìud cible existant\r\n            if (conn.fromText) {\r\n                const toNode = findVignetteByText(handler, conn.toText);\r\n                if (toNode && vignetteTextMatch(conn.fromText, vignette.text)) {\r\n                    targetNodeId = toNode.id;\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    // Position intelligente : pr√®s de la cible ou fallback en grille\r\n    const pos = handler.canvas.getSmartImportPosition(targetNodeId, index, total);\r\n\r\n    // Cr√©er la vignette avec halo\r\n    handler.canvas.createNode(\r\n        pos.x,\r\n        pos.y,\r\n        vignette.text,\r\n        vignette.status || 'neutral',\r\n        vignette.tags || [],\r\n        true, // skipAutoPosition\r\n        { newlyImported: true },\r\n    );\r\n\r\n    // Marquer comme import√©e dans l'UI\r\n    poleDiv.classList.add('imported');\r\n    poleDiv.innerHTML = `\r\n        <div class=\"suggested-pole-text\">\\u2713 ${vignette.text}</div>\r\n        <div class=\"suggested-pole-status\">Import\\u00E9</div>\r\n    `;\r\n\r\n    log.info(`Vignette ${index + 1}/${total} import\\u00E9e`);\r\n\r\n    // Rafra√Æchir le bandeau de suggestion\r\n    updateSuggestionBanner();\r\n}\r\n\r\n/**\r\n * Importe toutes les vignettes restantes\r\n * @param {any} handler - Instance du handler\r\n * @param {Array} vignettes - Tableau des vignettes\r\n * @param {HTMLElement} container - Conteneur DOM\r\n * @param {HTMLElement} importAllBtn - Bouton importer tout\r\n */\r\nexport function importAllVignettes(\r\n    handler: any,\r\n    vignettes: ParsedVignette[],\r\n    container: HTMLElement,\r\n    importAllBtn: HTMLButtonElement,\r\n): void {\r\n    const poleDivs = container.querySelectorAll('.suggested-pole:not(.imported)');\r\n    let gridIndex = 0;\r\n\r\n    poleDivs.forEach((poleDiv) => {\r\n        const index = parseInt((poleDiv as HTMLElement).dataset.index!);\r\n        const vignette = vignettes[index];\r\n        if (vignette) {\r\n            importSingleVignette(handler, vignette, poleDiv as HTMLElement, gridIndex, poleDivs.length);\r\n            gridIndex++;\r\n        }\r\n    });\r\n\r\n    // Mettre √† jour le bouton\r\n    importAllBtn.disabled = true;\r\n    importAllBtn.textContent = '\\u2713 Tous import\\u00E9s';\r\n\r\n    // √âmettre l'√©v√©nement de capture pour l'archivage\r\n    const panel = document.getElementById('vignette-selection-panel');\r\n    if (panel && panel.dataset.originalContent) {\r\n        document.dispatchEvent(\r\n            new CustomEvent('responseCaptured', {\r\n                detail: {\r\n                    content: panel.dataset.originalContent,\r\n                    vignettesCount: vignettes.length,\r\n                },\r\n            }),\r\n        );\r\n    }\r\n\r\n    log.info(`Toutes les vignettes import\\u00E9es (${vignettes.length})`);\r\n\r\n    // Rafra√Æchir le bandeau de suggestion\r\n    updateSuggestionBanner();\r\n\r\n    // Cr√©er les connexions en attente (apr√®s un petit d√©lai pour que les vignettes soient cr√©√©es)\r\n    if (handler.pendingTextConnections && handler.pendingTextConnections.length > 0) {\r\n        setTimeout(() => {\r\n            const connectionsCreated = createConnectionsFromParsed(handler, handler.pendingTextConnections);\r\n            handler.pendingTextConnections = [];\r\n\r\n            if (connectionsCreated > 0) {\r\n                updateStatus(handler, `${vignettes.length} vignette(s) + ${connectionsCreated} connexion(s)`, 'ready');\r\n            }\r\n            // Attendre que les connexions soient effectivement cr√©√©es (async via queueConnection)\r\n            setTimeout(() => {\r\n                updateSuggestionBanner();\r\n            }, 150);\r\n        }, 100);\r\n    }\r\n}\r\n\r\n/**\r\n * Trouve une vignette dans le canvas par texte similaire\r\n * @param {any} handler - Instance du handler\r\n * @param {string} searchText - Texte √† rechercher\r\n */\r\nexport function findVignetteByText(handler: any, searchText: string): any | null {\r\n    if (!handler.canvas || !handler.canvas.state || !handler.canvas.state.nodes) return null;\r\n\r\n    const searchLower = searchText.toLowerCase().trim();\r\n    const nodes: any[] = handler.canvas.state.nodes;\r\n\r\n    // Essai 1: Correspondance exacte (texte identique)\r\n    let found = nodes.find((v) => v.text.toLowerCase().trim() === searchLower);\r\n\r\n    // Essai 2: Inclusion mutuelle, mais priorit√© au meilleur match (ratio longueur le plus proche)\r\n    if (!found) {\r\n        let bestMatch: any | null = null;\r\n        let bestRatio = 0;\r\n\r\n        for (const v of nodes) {\r\n            const vLower = v.text.toLowerCase().trim();\r\n            if (vLower.includes(searchLower) || searchLower.includes(vLower)) {\r\n                // Ratio de longueur : plus les textes sont proches en taille, meilleur le match\r\n                const ratio = Math.min(vLower.length, searchLower.length) / Math.max(vLower.length, searchLower.length);\r\n                if (ratio > bestRatio) {\r\n                    bestRatio = ratio;\r\n                    bestMatch = v;\r\n                }\r\n            }\r\n        }\r\n        found = bestMatch;\r\n    }\r\n\r\n    // Essai 3: Correspondance par d√©but de texte (premiers 50 chars)\r\n    if (!found) {\r\n        const searchStart = searchLower.substring(0, 50);\r\n        found = nodes.find((v) => {\r\n            const vignetteStart = v.text.toLowerCase().substring(0, 50);\r\n            return vignetteStart.includes(searchStart) || searchStart.includes(vignetteStart);\r\n        });\r\n    }\r\n\r\n    // Essai 4: Correspondance par mots-cl√©s (au moins 2 mots communs de 4+ chars)\r\n    if (!found) {\r\n        const searchWords = searchLower.split(/\\s+/).filter((w) => w.length > 3);\r\n        let bestMatch: any | null = null;\r\n        let bestCount = 0;\r\n\r\n        for (const v of nodes) {\r\n            const vignetteWords = v.text.toLowerCase().split(/\\s+/);\r\n            const matchCount = searchWords.filter((sw) =>\r\n                vignetteWords.some((vw: string) => vw.includes(sw) || sw.includes(vw)),\r\n            ).length;\r\n            if (matchCount >= Math.min(2, searchWords.length) && matchCount > bestCount) {\r\n                bestCount = matchCount;\r\n                bestMatch = v;\r\n            }\r\n        }\r\n        found = bestMatch;\r\n    }\r\n\r\n    // Essai 5: Correspondance par score de similarit√© (Jaccard simplifi√©)\r\n    if (!found) {\r\n        const searchWords = new Set(searchLower.split(/\\s+/).filter((w) => w.length > 2));\r\n        let bestMatch: any | null = null;\r\n        let bestScore = 0;\r\n\r\n        for (const v of nodes) {\r\n            const vignetteWords = new Set(\r\n                v.text\r\n                    .toLowerCase()\r\n                    .split(/\\s+/)\r\n                    .filter((w: string) => w.length > 2),\r\n            );\r\n            const intersection = [...searchWords].filter((w) => vignetteWords.has(w)).length;\r\n            const union = new Set([...searchWords, ...vignetteWords]).size;\r\n            const score = union > 0 ? intersection / union : 0;\r\n\r\n            if (score > bestScore && score >= 0.3) {\r\n                bestScore = score;\r\n                bestMatch = v;\r\n            }\r\n        }\r\n        found = bestMatch;\r\n    }\r\n\r\n    if (!found) {\r\n        log.info(`Vignette non trouv√©e pour: \"${searchText.substring(0, 40)}...\"`);\r\n    }\r\n\r\n    return found;\r\n}\r\n\r\n/**\r\n * Cr√©e les connexions dans le canvas via le syst√®me de file d'attente\r\n * Utilise queueConnection pour attendre que le DOM soit stable\r\n * @param {any} handler - Instance du handler\r\n * @param {Array} parsedConnections - Connexions pars√©es\r\n */\r\nexport function createConnectionsFromParsed(handler: any, parsedConnections: ParsedConnection[]): number {\r\n    let queued = 0;\r\n\r\n    for (const conn of parsedConnections) {\r\n        const fromNode = findVignetteByText(handler, conn.fromText);\r\n        const toNode = findVignetteByText(handler, conn.toText);\r\n\r\n        if (fromNode && toNode && fromNode.id !== toNode.id) {\r\n            // Utiliser le syst√®me de file d'attente (attend la stabilisation DOM)\r\n            // Passer justification comme mechanism (v2)\r\n            handler.canvas.queueConnection(fromNode.id, toNode.id, conn.type, conn.justification || null);\r\n            queued++;\r\n            log.debug(\r\n                `Connexion en file: ${fromNode.text.substring(0, 20)}... ${conn.symbol} ${toNode.text.substring(0, 20)}...${conn.justification ? ` [${conn.justification.substring(0, 30)}...]` : ''}`,\r\n            );\r\n        } else {\r\n            log.warn(\r\n                `Vignettes non trouv\\u00E9es pour connexion: \"${conn.fromText.substring(0, 30)}...\" \\u2192 \"${conn.toText.substring(0, 30)}...\"`,\r\n            );\r\n        }\r\n    }\r\n\r\n    // Traiter les connexions en attente (attend que le DOM soit stable)\r\n    if (queued > 0) {\r\n        log.info(`${queued} connexion(s) mises en file, traitement...`);\r\n        handler.canvas.processPendingConnections();\r\n    }\r\n\r\n    return queued;\r\n}\r\n","/**\r\n * Router - D√©cide si une op√©ration passe par API ou webview\r\n *\r\n * Responsabilit√© : V√©rifier la disponibilit√© API et router l'op√©ration\r\n *\r\n * @exports routeOperation, getAPIProvider, isAPIAvailable\r\n */\r\n\r\nimport type { LLMManagerLike, APIProviderResult, RoutingResult } from '../../types/kairos.js';\r\n\r\n// Providers support√©s en mode API direct\r\nconst API_SUPPORTED_PROVIDERS: string[] = ['claude', 'openai', 'gemini', 'deepseek', 'grok', 'lmstudio'];\r\n\r\n/**\r\n * V√©rifie si un provider a une cl√© API configur√©e\r\n * @param {LLMManagerLike} llm - Instance du LLMManager\r\n * @param {string} providerName - Nom du provider\r\n * @returns {boolean}\r\n */\r\nfunction hasAPIKey(llm: LLMManagerLike, providerName: string): boolean {\r\n    const provider = llm.providers[providerName];\r\n    if (!provider) return false;\r\n\r\n    // LM Studio n'a pas besoin de cl√© API\r\n    if (providerName === 'lmstudio') return true;\r\n\r\n    return Boolean(provider.apiKey);\r\n}\r\n\r\n/**\r\n * Retourne le provider √† utiliser pour les appels API\r\n * Permet un provider API diff√©rent du provider webview (multi-provider)\r\n * @param {LLMManagerLike} llm - Instance du LLMManager\r\n * @returns {{ name: string, provider: object }|null}\r\n */\r\nexport function getAPIProvider(llm: LLMManagerLike): APIProviderResult | null {\r\n    // 1. V√©rifier si un provider API sp√©cifique est configur√©\r\n    const apiProviderName = localStorage.getItem('kairos_api_provider');\r\n\r\n    if (apiProviderName && API_SUPPORTED_PROVIDERS.includes(apiProviderName)) {\r\n        if (hasAPIKey(llm, apiProviderName)) {\r\n            return {\r\n                name: apiProviderName,\r\n                provider: llm.providers[apiProviderName],\r\n            };\r\n        }\r\n    }\r\n\r\n    // 2. Fallback : utiliser le provider webview actuel s'il a une cl√© API\r\n    if (API_SUPPORTED_PROVIDERS.includes(llm.currentProvider)) {\r\n        if (hasAPIKey(llm, llm.currentProvider)) {\r\n            return {\r\n                name: llm.currentProvider,\r\n                provider: llm.providers[llm.currentProvider],\r\n            };\r\n        }\r\n    }\r\n\r\n    // 3. Chercher n'importe quel provider avec une cl√© API\r\n    for (const providerName of API_SUPPORTED_PROVIDERS) {\r\n        if (hasAPIKey(llm, providerName)) {\r\n            return {\r\n                name: providerName,\r\n                provider: llm.providers[providerName],\r\n            };\r\n        }\r\n    }\r\n\r\n    return null;\r\n}\r\n\r\n/**\r\n * V√©rifie si le mode API est disponible\r\n * @param {LLMManagerLike} llm - Instance du LLMManager\r\n * @returns {boolean}\r\n */\r\nexport function isAPIAvailable(llm: LLMManagerLike): boolean {\r\n    return getAPIProvider(llm) !== null;\r\n}\r\n\r\n/**\r\n * D√©termine si l'op√©ration doit passer par API ou webview\r\n * @param {LLMManagerLike} llm - Instance du LLMManager\r\n * @param {string} operation - D√âVELOPPER, RELIER, SYNTH√âTISER\r\n * @returns {RoutingResult}\r\n */\r\nexport function routeOperation(llm: LLMManagerLike, _operation: string): RoutingResult {\r\n    // V√©rifier si le mode API est forc√©ment d√©sactiv√© (pour tests)\r\n    if (localStorage.getItem('kairos_force_webview_mode') === 'true') {\r\n        return {\r\n            mode: 'webview',\r\n            reason: 'Mode webview forc√© (test)',\r\n        };\r\n    }\r\n\r\n    // V√©rifier si le mode API est explicitement d√©sactiv√© par l'utilisateur\r\n    if (localStorage.getItem('kairos_api_mode_enabled') === 'false') {\r\n        return {\r\n            mode: 'webview',\r\n            reason: \"Mode API d√©sactiv√© par l'utilisateur\",\r\n        };\r\n    }\r\n\r\n    // Chercher un provider API disponible\r\n    const apiProvider = getAPIProvider(llm);\r\n\r\n    if (!apiProvider) {\r\n        return {\r\n            mode: 'webview',\r\n            reason: 'Aucune cl√© API configur√©e',\r\n        };\r\n    }\r\n\r\n    return {\r\n        mode: 'api',\r\n        reason: `API ${apiProvider.provider.name || apiProvider.name} disponible`,\r\n        provider: apiProvider,\r\n    };\r\n}\r\n\r\n/**\r\n * Sauvegarde le provider API pr√©f√©r√© (multi-provider)\r\n * @param {string} providerName - Nom du provider\r\n */\r\nexport function setAPIProvider(providerName: string): void {\r\n    if (API_SUPPORTED_PROVIDERS.includes(providerName)) {\r\n        localStorage.setItem('kairos_api_provider', providerName);\r\n    }\r\n}\r\n\r\n/**\r\n * Active ou d√©sactive le mode API\r\n * @param {boolean} enabled\r\n */\r\nexport function setAPIModeEnabled(enabled: boolean): void {\r\n    localStorage.setItem('kairos_api_mode_enabled', enabled ? 'true' : 'false');\r\n}\r\n","/**\r\n * Executor - Ex√©cute les appels API LLM pour les op√©rations structur√©es\r\n *\r\n * Responsabilit√© : Appels API, gestion erreurs, parsing r√©ponses\r\n *\r\n * @exports executeViaAPI, parseAPIResponse\r\n */\r\n\r\nimport { parseSuggestedPoles, parseSuggestedConnections, cleanSynthesisText } from '../webview/capture-parsers.js';\r\nimport type { LLMProviderConfig, LLMManagerLike, ParsedResponse } from '../../types/kairos.js';\r\n\r\ninterface APIProviderParam {\r\n    name: string;\r\n    provider: LLMProviderConfig;\r\n}\r\n\r\ninterface ProgressInfo {\r\n    state: string;\r\n    message: string;\r\n}\r\n\r\ninterface ExecuteViaAPIParams {\r\n    llm: LLMManagerLike;\r\n    operation: string;\r\n    prompt: string;\r\n    apiProvider: APIProviderParam;\r\n    onSuccess?: (parsed: ParsedResponse) => void;\r\n    onError?: (error: Error) => void;\r\n    onProgress?: (info: ProgressInfo) => void;\r\n}\r\n\r\n/**\r\n * Ex√©cute une op√©ration structur√©e via API directe\r\n */\r\nexport async function executeViaAPI({\r\n    llm,\r\n    operation,\r\n    prompt,\r\n    apiProvider,\r\n    onSuccess,\r\n    onError,\r\n    onProgress,\r\n}: ExecuteViaAPIParams): Promise<void> {\r\n    const { name: providerName, provider } = apiProvider;\r\n\r\n    onProgress?.({ state: 'loading', message: `Envoi √† ${provider.name || providerName}...` });\r\n\r\n    try {\r\n        // Construire le system prompt pour les op√©rations structur√©es\r\n        const systemPrompt = llm.buildSystemPrompt(operation);\r\n\r\n        // Pr√©parer le message\r\n        const messages = [{ role: 'user', content: prompt }];\r\n\r\n        // Options par d√©faut\r\n        const options = {\r\n            max_tokens: 4096,\r\n        };\r\n\r\n        // Appel API via IPC Electron (bypass CORS)\r\n        if (!window.fgraph || !window.fgraph.llmQuery) {\r\n            throw new Error('API Electron non disponible (window.fgraph.llmQuery)');\r\n        }\r\n\r\n        console.log(`[LLM-API Executor] Appel ${providerName}, operation: ${operation}`);\r\n\r\n        const API_TIMEOUT_MS = 30000;\r\n        const timeoutPromise = new Promise<never>((_, reject) =>\r\n            setTimeout(\r\n                () =>\r\n                    reject(\r\n                        new Error(\r\n                            `Timeout: pas de r√©ponse de ${provider.name || providerName} apr√®s ${API_TIMEOUT_MS / 1000}s`,\r\n                        ),\r\n                    ),\r\n                API_TIMEOUT_MS,\r\n            ),\r\n        );\r\n\r\n        const response = await Promise.race([\r\n            window.fgraph.llmQuery({\r\n                provider: providerName,\r\n                apiKey: provider.apiKey,\r\n                model: provider.model,\r\n                messages: messages,\r\n                systemPrompt: systemPrompt,\r\n                options: options,\r\n            }),\r\n            timeoutPromise,\r\n        ]);\r\n\r\n        if (!response.success) {\r\n            throw new Error(response.error || 'Erreur API inconnue');\r\n        }\r\n\r\n        if (!response.content || response.content.trim().length === 0) {\r\n            throw new Error('R√©ponse vide du LLM');\r\n        }\r\n\r\n        console.log(`[LLM-API Executor] R√©ponse re√ßue (${response.content.length} chars)`);\r\n        onProgress?.({ state: 'parsing', message: 'Analyse de la r√©ponse...' });\r\n\r\n        // Parser la r√©ponse selon l'op√©ration\r\n        let parsed: ParsedResponse;\r\n        try {\r\n            parsed = parseAPIResponse(response.content, operation);\r\n        } catch (parseError) {\r\n            throw new Error(`Erreur de parsing (${operation}): ${(parseError as Error).message}`);\r\n        }\r\n\r\n        // Ajouter m√©tadonn√©es\r\n        (parsed as any).provider = providerName;\r\n        (parsed as any).usage = (response as any).usage;\r\n\r\n        onSuccess?.(parsed);\r\n    } catch (error) {\r\n        console.error('[LLM-API Executor] Erreur:', error);\r\n        onError?.(error as Error);\r\n    }\r\n}\r\n\r\n/**\r\n * Parse la r√©ponse API selon l'op√©ration\r\n * @param {string} content - Contenu de la r√©ponse LLM\r\n * @param {string} operation - Type d'op√©ration\r\n * @returns {ParsedResponse} - Donn√©es pars√©es\r\n */\r\nexport function parseAPIResponse(content: string, operation: string): ParsedResponse {\r\n    switch (operation) {\r\n        case 'D√âVELOPPER': {\r\n            const vignettes = parseSuggestedPoles(content);\r\n            const connections = parseSuggestedConnections(content);\r\n\r\n            console.log(\r\n                `[LLM-API Executor] D√âVELOPPER: ${vignettes.length} vignettes, ${connections.length} connexions`,\r\n            );\r\n\r\n            return {\r\n                type: 'vignettes',\r\n                vignettes: vignettes,\r\n                connections: connections,\r\n                raw: content,\r\n            };\r\n        }\r\n\r\n        case 'RELIER': {\r\n            const connections = parseSuggestedConnections(content);\r\n\r\n            console.log(`[LLM-API Executor] RELIER: ${connections.length} connexions`);\r\n\r\n            return {\r\n                type: 'connections',\r\n                connections: connections,\r\n                raw: content,\r\n            };\r\n        }\r\n\r\n        case 'SYNTH√âTISER': {\r\n            const cleanedText = cleanSynthesisText(content);\r\n\r\n            console.log(`[LLM-API Executor] SYNTH√âTISER: ${cleanedText.length} chars (nettoy√©)`);\r\n\r\n            return {\r\n                type: 'synthesis',\r\n                text: cleanedText,\r\n                raw: content,\r\n            };\r\n        }\r\n\r\n        default:\r\n            console.warn(`[LLM-API Executor] Op√©ration inconnue: ${operation}`);\r\n            return {\r\n                type: 'raw',\r\n                content: content,\r\n            };\r\n    }\r\n}\r\n\r\n/**\r\n * R√©essaie une op√©ration avec backoff exponentiel\r\n * @param {Function} fn - Fonction √† r√©essayer\r\n * @param {number} maxRetries - Nombre max de tentatives\r\n * @param {number} baseDelay - D√©lai initial en ms\r\n */\r\nexport async function retryWithBackoff<T>(\r\n    fn: () => Promise<T>,\r\n    maxRetries: number = 3,\r\n    baseDelay: number = 1000,\r\n): Promise<T> {\r\n    let lastError: Error | undefined;\r\n\r\n    for (let attempt = 1; attempt <= maxRetries; attempt++) {\r\n        try {\r\n            return await fn();\r\n        } catch (error) {\r\n            lastError = error as Error;\r\n\r\n            // Ne pas r√©essayer certaines erreurs\r\n            const noRetryErrors = ['API key', 'non configur√©e', 'Invalid API', 'Unauthorized'];\r\n            if (noRetryErrors.some((msg) => (error as Error).message?.includes(msg))) {\r\n                throw error;\r\n            }\r\n\r\n            if (attempt < maxRetries) {\r\n                const delay = baseDelay * Math.pow(2, attempt - 1);\r\n                console.log(`[LLM-API Executor] Tentative ${attempt}/${maxRetries} √©chou√©e, retry dans ${delay}ms`);\r\n                await new Promise((resolve) => setTimeout(resolve, delay));\r\n            }\r\n        }\r\n    }\r\n\r\n    throw lastError;\r\n}\r\n","/**\r\n * UI States - Gestion des √©tats visuels pendant les appels API\r\n *\r\n * Responsabilit√© : Overlay loading, messages d'erreur, notifications\r\n *\r\n * @exports showAPILoadingState, updateAPILoadingState, hideAPILoadingState,\r\n *          showAPIError, showAPISuccess\r\n */\r\n\r\ninterface APIErrorCallbacks {\r\n    onRetry?: () => void;\r\n    onFallbackWebview?: () => void;\r\n    onDismiss?: () => void;\r\n}\r\n\r\n/**\r\n * Affiche l'overlay de chargement pendant l'appel API\r\n * @param {string} operation - D√âVELOPPER, RELIER, SYNTH√âTISER\r\n * @param {string} providerName - Nom du provider\r\n */\r\nexport function showAPILoadingState(operation: string, providerName: string = ''): void {\r\n    // Supprimer overlay existant\r\n    hideAPILoadingState();\r\n\r\n    const overlay = document.createElement('div');\r\n    overlay.id = 'api-loading-overlay';\r\n    overlay.className = 'api-loading-overlay';\r\n\r\n    const providerInfo = providerName ? ` via ${providerName}` : '';\r\n\r\n    overlay.innerHTML = `\r\n        <div class=\"api-loading-content\">\r\n            <div class=\"api-loading-spinner\"></div>\r\n            <div class=\"api-loading-text\">${operation} en cours${providerInfo}...</div>\r\n            <div class=\"api-loading-subtext\">Appel API direct</div>\r\n        </div>\r\n    `;\r\n\r\n    document.body.appendChild(overlay);\r\n\r\n    // Animation d'entr√©e\r\n    requestAnimationFrame(() => {\r\n        overlay.classList.add('visible');\r\n    });\r\n}\r\n\r\n/**\r\n * Met √† jour le message de l'overlay\r\n * @param {string} message - Nouveau message\r\n */\r\nexport function updateAPILoadingState(message: string): void {\r\n    const textEl = document.querySelector('.api-loading-text');\r\n    if (textEl) {\r\n        textEl.textContent = message;\r\n    }\r\n}\r\n\r\n/**\r\n * Cache l'overlay de chargement\r\n */\r\nexport function hideAPILoadingState(): void {\r\n    const overlay = document.getElementById('api-loading-overlay');\r\n    if (overlay) {\r\n        overlay.classList.remove('visible');\r\n        // Attendre la fin de l'animation\r\n        setTimeout(() => overlay.remove(), 200);\r\n    }\r\n}\r\n\r\n/**\r\n * Affiche une erreur API avec options de r√©cup√©ration\r\n * @param {Error} error - Erreur survenue\r\n * @param {APIErrorCallbacks} callbacks\r\n */\r\nexport function showAPIError(error: Error, { onRetry, onFallbackWebview, onDismiss }: APIErrorCallbacks): void {\r\n    // Supprimer modal existante\r\n    const existing = document.getElementById('api-error-modal');\r\n    if (existing) existing.remove();\r\n\r\n    const modal = document.createElement('div');\r\n    modal.id = 'api-error-modal';\r\n    modal.className = 'api-error-overlay';\r\n\r\n    // D√©terminer le type d'erreur\r\n    const errorMessage = error.message || String(error);\r\n    let suggestion = '';\r\n    let canRetry = true;\r\n\r\n    if (errorMessage.includes('API key') || errorMessage.includes('Unauthorized') || errorMessage.includes('401')) {\r\n        suggestion = 'V√©rifiez votre cl√© API dans les param√®tres.';\r\n        canRetry = false;\r\n    } else if (errorMessage.includes('rate') || errorMessage.includes('429')) {\r\n        suggestion = 'Limite de requ√™tes atteinte. R√©essayez dans quelques instants.';\r\n    } else if (errorMessage.includes('timeout') || errorMessage.includes('network')) {\r\n        suggestion = 'Probl√®me de connexion. V√©rifiez votre r√©seau.';\r\n    }\r\n\r\n    modal.innerHTML = `\r\n        <div class=\"api-error-content\">\r\n            <div class=\"api-error-header\">\r\n                <span class=\"api-error-icon\">\\u26A0\\uFE0F</span>\r\n                <span class=\"api-error-title\">Erreur API</span>\r\n            </div>\r\n            <div class=\"api-error-message\"></div>\r\n            ${suggestion ? `<div class=\"api-error-suggestion\">${suggestion}</div>` : ''}\r\n            <div class=\"api-error-actions\">\r\n                ${canRetry ? '<button class=\"api-error-btn api-error-retry\">R√©essayer</button>' : ''}\r\n                <button class=\"api-error-btn api-error-webview\">Utiliser webview</button>\r\n                <button class=\"api-error-btn api-error-close\">Annuler</button>\r\n            </div>\r\n        </div>\r\n    `;\r\n\r\n    // Injecter le message d'erreur via textContent (anti-XSS)\r\n    const msgEl = modal.querySelector('.api-error-message');\r\n    if (msgEl) msgEl.textContent = errorMessage;\r\n\r\n    document.body.appendChild(modal);\r\n\r\n    // Animation d'entr√©e\r\n    requestAnimationFrame(() => {\r\n        modal.classList.add('visible');\r\n    });\r\n\r\n    // Event listeners\r\n    const closeModal = (): void => {\r\n        modal.classList.remove('visible');\r\n        setTimeout(() => modal.remove(), 200);\r\n        onDismiss?.();\r\n    };\r\n\r\n    if (canRetry) {\r\n        modal.querySelector('.api-error-retry')?.addEventListener('click', () => {\r\n            modal.remove();\r\n            onRetry?.();\r\n        });\r\n    }\r\n\r\n    modal.querySelector('.api-error-webview')?.addEventListener('click', () => {\r\n        modal.remove();\r\n        onFallbackWebview?.();\r\n    });\r\n\r\n    modal.querySelector('.api-error-close')?.addEventListener('click', closeModal);\r\n\r\n    // Fermer en cliquant sur l'overlay\r\n    modal.addEventListener('click', (e: MouseEvent) => {\r\n        if (e.target === modal) closeModal();\r\n    });\r\n}\r\n\r\n/**\r\n * Affiche une notification de succ√®s\r\n * @param {string} message - Message √† afficher\r\n * @param {number} duration - Dur√©e en ms (d√©faut 3000)\r\n */\r\nexport function showAPISuccess(message: string, duration: number = 3000): void {\r\n    // Supprimer notification existante\r\n    const existing = document.querySelector('.api-success-notification');\r\n    if (existing) existing.remove();\r\n\r\n    const notification = document.createElement('div');\r\n    notification.className = 'api-success-notification';\r\n    notification.innerHTML = `\r\n        <span class=\"api-success-icon\">\\u2705</span>\r\n        <span class=\"api-success-message\">${message}</span>\r\n    `;\r\n\r\n    document.body.appendChild(notification);\r\n\r\n    // Animation d'entr√©e\r\n    requestAnimationFrame(() => {\r\n        notification.classList.add('visible');\r\n    });\r\n\r\n    // Auto-dismiss\r\n    setTimeout(() => {\r\n        notification.classList.remove('visible');\r\n        setTimeout(() => notification.remove(), 200);\r\n    }, duration);\r\n}\r\n\r\n/**\r\n * Injecte les styles CSS n√©cessaires (appel√© une fois au chargement)\r\n */\r\nexport function injectAPIStyles(): void {\r\n    if (document.getElementById('api-states-styles')) return;\r\n\r\n    const styles = document.createElement('style');\r\n    styles.id = 'api-states-styles';\r\n    styles.textContent = `\r\n        /* Overlay de chargement */\r\n        .api-loading-overlay {\r\n            position: fixed;\r\n            top: 0;\r\n            left: 0;\r\n            right: 0;\r\n            bottom: 0;\r\n            background: rgba(0, 0, 0, 0.7);\r\n            display: flex;\r\n            align-items: center;\r\n            justify-content: center;\r\n            z-index: 10000;\r\n            opacity: 0;\r\n            transition: opacity 0.2s ease;\r\n        }\r\n\r\n        .api-loading-overlay.visible {\r\n            opacity: 1;\r\n        }\r\n\r\n        .api-loading-content {\r\n            background: var(--bg-tertiary, #2a2a3e);\r\n            padding: 2rem 3rem;\r\n            border-radius: 12px;\r\n            text-align: center;\r\n            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);\r\n        }\r\n\r\n        .api-loading-spinner {\r\n            width: 40px;\r\n            height: 40px;\r\n            border: 3px solid var(--accent-color, #6366f1);\r\n            border-top-color: transparent;\r\n            border-radius: 50%;\r\n            animation: api-spin 1s linear infinite;\r\n            margin: 0 auto 1rem;\r\n        }\r\n\r\n        @keyframes api-spin {\r\n            to { transform: rotate(360deg); }\r\n        }\r\n\r\n        .api-loading-text {\r\n            color: var(--text-primary, #fff);\r\n            font-size: 1.1rem;\r\n            margin-bottom: 0.5rem;\r\n        }\r\n\r\n        .api-loading-subtext {\r\n            color: var(--text-secondary, #888);\r\n            font-size: 0.85rem;\r\n        }\r\n\r\n        /* Modal d'erreur */\r\n        .api-error-overlay {\r\n            position: fixed;\r\n            top: 0;\r\n            left: 0;\r\n            right: 0;\r\n            bottom: 0;\r\n            background: rgba(0, 0, 0, 0.7);\r\n            display: flex;\r\n            align-items: center;\r\n            justify-content: center;\r\n            z-index: 10001;\r\n            opacity: 0;\r\n            transition: opacity 0.2s ease;\r\n        }\r\n\r\n        .api-error-overlay.visible {\r\n            opacity: 1;\r\n        }\r\n\r\n        .api-error-content {\r\n            background: var(--bg-tertiary, #2a2a3e);\r\n            padding: 1.5rem 2rem;\r\n            border-radius: 12px;\r\n            max-width: 450px;\r\n            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);\r\n        }\r\n\r\n        .api-error-header {\r\n            display: flex;\r\n            align-items: center;\r\n            gap: 0.5rem;\r\n            margin-bottom: 1rem;\r\n        }\r\n\r\n        .api-error-icon {\r\n            font-size: 1.5rem;\r\n        }\r\n\r\n        .api-error-title {\r\n            color: var(--text-primary, #fff);\r\n            font-size: 1.2rem;\r\n            font-weight: 600;\r\n        }\r\n\r\n        .api-error-message {\r\n            color: var(--text-secondary, #ccc);\r\n            margin-bottom: 0.75rem;\r\n            line-height: 1.4;\r\n        }\r\n\r\n        .api-error-suggestion {\r\n            color: var(--accent-color, #6366f1);\r\n            font-size: 0.9rem;\r\n            margin-bottom: 1rem;\r\n        }\r\n\r\n        .api-error-actions {\r\n            display: flex;\r\n            gap: 0.75rem;\r\n            justify-content: flex-end;\r\n        }\r\n\r\n        .api-error-btn {\r\n            padding: 0.5rem 1rem;\r\n            border: none;\r\n            border-radius: 6px;\r\n            cursor: pointer;\r\n            font-size: 0.9rem;\r\n            transition: background 0.2s;\r\n        }\r\n\r\n        .api-error-retry {\r\n            background: var(--accent-color, #6366f1);\r\n            color: white;\r\n        }\r\n\r\n        .api-error-retry:hover {\r\n            background: var(--accent-hover, #5558e3);\r\n        }\r\n\r\n        .api-error-webview {\r\n            background: var(--bg-secondary, #1e1e2e);\r\n            color: var(--text-primary, #fff);\r\n            border: 1px solid var(--border-color, #444);\r\n        }\r\n\r\n        .api-error-webview:hover {\r\n            background: var(--bg-hover, #2e2e3e);\r\n        }\r\n\r\n        .api-error-close {\r\n            background: transparent;\r\n            color: var(--text-secondary, #888);\r\n        }\r\n\r\n        .api-error-close:hover {\r\n            color: var(--text-primary, #fff);\r\n        }\r\n\r\n        /* Notification de succ√®s */\r\n        .api-success-notification {\r\n            position: fixed;\r\n            bottom: 24px;\r\n            right: 24px;\r\n            background: var(--success-color, #22c55e);\r\n            color: white;\r\n            padding: 0.75rem 1.25rem;\r\n            border-radius: 8px;\r\n            display: flex;\r\n            align-items: center;\r\n            gap: 0.5rem;\r\n            z-index: 10000;\r\n            opacity: 0;\r\n            transform: translateY(20px);\r\n            transition: all 0.2s ease;\r\n            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);\r\n        }\r\n\r\n        .api-success-notification.visible {\r\n            opacity: 1;\r\n            transform: translateY(0);\r\n        }\r\n\r\n        .api-success-icon {\r\n            font-size: 1.1rem;\r\n        }\r\n\r\n        .api-success-message {\r\n            font-size: 0.95rem;\r\n        }\r\n    `;\r\n\r\n    document.head.appendChild(styles);\r\n}\r\n","/**\r\n * Config Modal - Interface de configuration des cl√©s API\r\n *\r\n * Responsabilit√© : Modal pour saisir/modifier les cl√©s API, s√©lectionner le provider API\r\n *\r\n * @exports showAPIConfigModal, setupAPIConfigButton\r\n */\r\n\r\nimport { setAPIProvider, setAPIModeEnabled, getAPIProvider } from './router.js';\r\nimport type { LLMProviderConfig, LLMManagerLike } from '../../types/kairos.js';\r\n\r\ninterface LLMApiManagerLike {\r\n    isAvailable(): boolean;\r\n    getProvider(): { name: string; provider: LLMProviderConfig } | null;\r\n    [key: string]: any;\r\n}\r\n\r\ninterface ProviderInfo {\r\n    label: string;\r\n    placeholder: string;\r\n    keyPrefix: string;\r\n}\r\n\r\n/**\r\n * Providers support√©s avec leurs infos\r\n */\r\nconst PROVIDERS_INFO: Record<string, ProviderInfo> = {\r\n    claude: { label: 'Claude (Anthropic)', placeholder: 'sk-ant-...', keyPrefix: 'sk-ant-' },\r\n    openai: { label: 'ChatGPT (OpenAI)', placeholder: 'sk-...', keyPrefix: 'sk-' },\r\n    gemini: { label: 'Gemini (Google)', placeholder: 'AIza...', keyPrefix: 'AIza' },\r\n    deepseek: { label: 'DeepSeek', placeholder: 'sk-...', keyPrefix: 'sk-' },\r\n    grok: { label: 'Grok (xAI)', placeholder: 'xai-...', keyPrefix: 'xai-' },\r\n};\r\n\r\n/**\r\n * Affiche le modal de configuration des cl√©s API\r\n * @param {LLMManagerLike} llm - Instance du LLMManager\r\n * @param {Function} onSave - Callback apr√®s sauvegarde\r\n */\r\nexport async function showAPIConfigModal(llm: LLMManagerLike, onSave?: () => void): Promise<void> {\r\n    // Attendre que les cl√©s API soient charg√©es depuis le secure storage\r\n    if (llm.whenReady) {\r\n        await llm.whenReady();\r\n    }\r\n\r\n    // Supprimer modal existant\r\n    const existing = document.getElementById('api-config-modal');\r\n    if (existing) existing.remove();\r\n\r\n    const apiModeEnabled = localStorage.getItem('kairos_api_mode_enabled') !== 'false';\r\n    const currentAPIProvider = localStorage.getItem('kairos_api_provider') || '';\r\n\r\n    const modal = document.createElement('div');\r\n    modal.id = 'api-config-modal';\r\n    modal.className = 'api-config-overlay';\r\n\r\n    modal.innerHTML = `\r\n        <div class=\"api-config-content\">\r\n            <div class=\"api-config-header\">\r\n                <h3>Configuration API</h3>\r\n                <button class=\"api-config-close\">\\u2715</button>\r\n            </div>\r\n\r\n            <div class=\"api-config-body\">\r\n                <div class=\"api-config-toggle-row\">\r\n                    <label for=\"api-mode-toggle\">Mode API pour op\\u00e9rations</label>\r\n                    <div class=\"api-toggle-switch\">\r\n                        <input type=\"checkbox\" id=\"api-mode-toggle\" ${apiModeEnabled ? 'checked' : ''}>\r\n                        <span class=\"api-toggle-slider\"></span>\r\n                    </div>\r\n                </div>\r\n                <p class=\"api-config-hint\">Quand activ\\u00e9, D\\u00c9VELOPPER / RELIER / SYNTH\\u00c9TISER utilisent l'API directe au lieu du webview.</p>\r\n\r\n                <div class=\"api-config-provider-select\">\r\n                    <label for=\"api-provider-select\">Provider API (op\\u00e9rations)</label>\r\n                    <select id=\"api-provider-select\">\r\n                        <option value=\"\">Automatique (m\\u00eame que webview)</option>\r\n                        ${Object.entries(PROVIDERS_INFO)\r\n                            .map(\r\n                                ([key, info]) =>\r\n                                    `<option value=\"${key}\" ${currentAPIProvider === key ? 'selected' : ''}>${info.label}</option>`,\r\n                            )\r\n                            .join('')}\r\n                    </select>\r\n                </div>\r\n\r\n                <div class=\"api-config-keys\">\r\n                    <h4>Cl\\u00e9s API</h4>\r\n                    ${Object.entries(PROVIDERS_INFO)\r\n                        .map(([key, info]) => {\r\n                            const hasKey = !!llm.providers[key]?.apiKey;\r\n                            return `\r\n                        <div class=\"api-key-row\" data-provider=\"${key}\">\r\n                            <label>${info.label}</label>\r\n                            <div class=\"api-key-input-group\">\r\n                                <input type=\"password\"\r\n                                    class=\"api-key-input\"\r\n                                    data-provider=\"${key}\"\r\n                                    placeholder=\"${info.placeholder}\"\r\n                                    value=\"${hasKey ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : ''}\"\r\n                                    data-has-key=\"${hasKey}\"\r\n                                >\r\n                                <button class=\"api-key-toggle\" title=\"Afficher/masquer\">\\uD83D\\uDC41</button>\r\n                                ${hasKey ? '<span class=\"api-key-status configured\">\\u2713</span>' : '<span class=\"api-key-status\"></span>'}\r\n                            </div>\r\n                        </div>`;\r\n                        })\r\n                        .join('')}\r\n                </div>\r\n            </div>\r\n\r\n            <div class=\"api-config-footer\">\r\n                <button class=\"api-config-cancel\">Annuler</button>\r\n                <button class=\"api-config-save\">Sauvegarder</button>\r\n            </div>\r\n        </div>\r\n    `;\r\n\r\n    document.body.appendChild(modal);\r\n\r\n    // Animation d'entr√©e\r\n    requestAnimationFrame(() => modal.classList.add('visible'));\r\n\r\n    // === Event listeners ===\r\n\r\n    const closeModal = (): void => {\r\n        modal.classList.remove('visible');\r\n        setTimeout(() => modal.remove(), 200);\r\n    };\r\n\r\n    modal.querySelector('.api-config-close')!.addEventListener('click', closeModal);\r\n    modal.querySelector('.api-config-cancel')!.addEventListener('click', closeModal);\r\n    modal.addEventListener('click', (e: MouseEvent) => {\r\n        if (e.target === modal) closeModal();\r\n    });\r\n\r\n    // Toggle afficher/masquer les cl√©s\r\n    modal.querySelectorAll('.api-key-toggle').forEach((btn) => {\r\n        btn.addEventListener('click', () => {\r\n            const input = btn.previousElementSibling as HTMLInputElement;\r\n            if (input.type === 'password') {\r\n                input.type = 'text';\r\n                // Si c'est une cl√© existante masqu√©e, afficher la vraie valeur\r\n                if (input.dataset.hasKey === 'true' && input.value === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {\r\n                    const provider = input.dataset.provider!;\r\n                    input.value = llm.providers[provider]?.apiKey || '';\r\n                }\r\n            } else {\r\n                input.type = 'password';\r\n            }\r\n        });\r\n    });\r\n\r\n    // Focus sur un champ le vide si c'est le placeholder masqu√©\r\n    // On ne marque hasKey='false' que si l'utilisateur tape r√©ellement (blur handler)\r\n    modal.querySelectorAll('.api-key-input').forEach((input) => {\r\n        input.addEventListener('focus', () => {\r\n            const inputEl = input as HTMLInputElement;\r\n            if (inputEl.value === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {\r\n                inputEl.value = '';\r\n                inputEl.dataset.cleared = 'true'; // Track that we cleared the dots\r\n            }\r\n        });\r\n        // Si l'utilisateur quitte le champ sans rien taper, restaurer les dots\r\n        input.addEventListener('blur', () => {\r\n            const inputEl = input as HTMLInputElement;\r\n            if (inputEl.dataset.cleared === 'true' && inputEl.value === '') {\r\n                // L'utilisateur a focus√© mais n'a rien tap√© ‚Üí restaurer\r\n                inputEl.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';\r\n                inputEl.dataset.cleared = 'false';\r\n            } else if (inputEl.dataset.cleared === 'true' && inputEl.value !== '') {\r\n                // L'utilisateur a tap√© une nouvelle cl√© ‚Üí marquer comme modifi√©\r\n                inputEl.dataset.hasKey = 'false';\r\n                inputEl.dataset.cleared = 'false';\r\n            }\r\n        });\r\n    });\r\n\r\n    // Sauvegarde\r\n    modal.querySelector('.api-config-save')!.addEventListener('click', async () => {\r\n        // Sauvegarder le mode API\r\n        const apiEnabled = (document.getElementById('api-mode-toggle') as HTMLInputElement).checked;\r\n        setAPIModeEnabled(apiEnabled);\r\n\r\n        // Sauvegarder le provider API\r\n        const apiProvider = (document.getElementById('api-provider-select') as HTMLSelectElement).value;\r\n        if (apiProvider) {\r\n            setAPIProvider(apiProvider);\r\n        } else {\r\n            localStorage.removeItem('kairos_api_provider');\r\n        }\r\n\r\n        // Sauvegarder les cl√©s API\r\n        const inputs = modal.querySelectorAll('.api-key-input');\r\n        for (const input of inputs) {\r\n            const inputEl = input as HTMLInputElement;\r\n            const provider = inputEl.dataset.provider!;\r\n            const value = inputEl.value.trim();\r\n\r\n            if (value === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {\r\n                // Cl√© existante non modifi√©e ‚Üí ne rien faire\r\n                continue;\r\n            }\r\n\r\n            if (value) {\r\n                // Nouvelle cl√© saisie ‚Üí sauvegarder\r\n                llm.setApiKey(provider, value);\r\n            } else if (inputEl.dataset.hasKey === 'false') {\r\n                // Champ explicitement vid√© par l'utilisateur ‚Üí supprimer la cl√©\r\n                llm.setApiKey(provider, null);\r\n            }\r\n        }\r\n\r\n        await llm.saveConfig();\r\n\r\n        closeModal();\r\n        onSave?.();\r\n    });\r\n}\r\n\r\n/**\r\n * Configure le bouton de configuration API dans la toolbar\r\n * @param {HTMLElement} button - Bouton d√©clencheur\r\n * @param {LLMManagerLike} llm - Instance du LLMManager\r\n * @param {LLMApiManagerLike} llmApiManager - Instance du LLMApiManager (optionnel)\r\n */\r\nexport function setupAPIConfigButton(\r\n    button: HTMLElement,\r\n    llm: LLMManagerLike,\r\n    llmApiManager?: LLMApiManagerLike,\r\n): void {\r\n    if (!button) return;\r\n\r\n    // Mettre √† jour l'indicateur visuel apr√®s que les cl√©s soient charg√©es\r\n    if (llm.whenReady) {\r\n        llm.whenReady().then(() => updateAPIConfigIndicator(button, llm));\r\n    } else {\r\n        updateAPIConfigIndicator(button, llm);\r\n    }\r\n\r\n    button.addEventListener('click', () => {\r\n        showAPIConfigModal(llm, () => {\r\n            // Callback apr√®s sauvegarde : mettre √† jour l'√©tat\r\n            updateAPIConfigIndicator(button, llm);\r\n\r\n            // Log le nouvel √©tat\r\n            if (llmApiManager) {\r\n                const available = llmApiManager.isAvailable();\r\n                const provider = llmApiManager.getProvider();\r\n                console.log(\r\n                    `[API Config] Mode API: ${available ? 'actif' : 'inactif'}${provider ? ` (${provider.name})` : ''}`,\r\n                );\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\n/**\r\n * Met √† jour l'indicateur visuel du bouton config\r\n */\r\nfunction updateAPIConfigIndicator(button: HTMLElement, llm: LLMManagerLike): void {\r\n    const hasAnyKey = Object.values(llm.providers).some((p) => !!p.apiKey);\r\n    const apiEnabled = localStorage.getItem('kairos_api_mode_enabled') !== 'false';\r\n\r\n    button.classList.toggle('api-configured', hasAnyKey && apiEnabled);\r\n    button.title = hasAnyKey && apiEnabled ? 'API configur√©e - Cliquer pour modifier' : 'Configurer les cl√©s API';\r\n\r\n    // Mettre √† jour le badge du provider actif\r\n    const badge = document.getElementById('api-provider-badge');\r\n    if (badge) {\r\n        const activeProvider = hasAnyKey && apiEnabled ? getAPIProvider(llm) : null;\r\n        if (activeProvider) {\r\n            const info = PROVIDERS_INFO[activeProvider.name];\r\n            badge.textContent = info?.label || activeProvider.name;\r\n            badge.classList.remove('hidden');\r\n        } else {\r\n            badge.textContent = '';\r\n            badge.classList.add('hidden');\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Injecte les styles CSS du modal de configuration\r\n */\r\nexport function injectConfigStyles(): void {\r\n    if (document.getElementById('api-config-styles')) return;\r\n\r\n    const styles = document.createElement('style');\r\n    styles.id = 'api-config-styles';\r\n    styles.textContent = `\r\n        .api-config-overlay {\r\n            position: fixed;\r\n            top: 0; left: 0; right: 0; bottom: 0;\r\n            background: rgba(0, 0, 0, 0.7);\r\n            display: flex;\r\n            align-items: center;\r\n            justify-content: center;\r\n            z-index: 10002;\r\n            opacity: 0;\r\n            transition: opacity 0.2s ease;\r\n        }\r\n        .api-config-overlay.visible { opacity: 1; }\r\n\r\n        .api-config-content {\r\n            background: var(--bg-tertiary, #2a2a3e);\r\n            border-radius: 12px;\r\n            width: 480px;\r\n            max-height: 85vh;\r\n            overflow-y: auto;\r\n            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);\r\n        }\r\n\r\n        .api-config-header {\r\n            display: flex;\r\n            justify-content: space-between;\r\n            align-items: center;\r\n            padding: 1.25rem 1.5rem;\r\n            border-bottom: 1px solid var(--border-color, #444);\r\n        }\r\n        .api-config-header h3 {\r\n            margin: 0;\r\n            color: var(--text-primary, #fff);\r\n            font-size: 1.1rem;\r\n        }\r\n        .api-config-close {\r\n            background: none;\r\n            border: none;\r\n            color: var(--text-secondary, #888);\r\n            font-size: 1.2rem;\r\n            cursor: pointer;\r\n        }\r\n        .api-config-close:hover { color: var(--text-primary, #fff); }\r\n\r\n        .api-config-body {\r\n            padding: 1.5rem;\r\n        }\r\n\r\n        .api-config-toggle-row {\r\n            display: flex;\r\n            justify-content: space-between;\r\n            align-items: center;\r\n            margin-bottom: 0.5rem;\r\n        }\r\n        .api-config-toggle-row label {\r\n            color: var(--text-primary, #fff);\r\n            font-weight: 500;\r\n        }\r\n\r\n        .api-toggle-switch {\r\n            position: relative;\r\n            width: 44px;\r\n            height: 24px;\r\n        }\r\n        .api-toggle-switch input {\r\n            opacity: 0;\r\n            width: 0;\r\n            height: 0;\r\n        }\r\n        .api-toggle-slider {\r\n            position: absolute;\r\n            cursor: pointer;\r\n            top: 0; left: 0; right: 0; bottom: 0;\r\n            background: var(--bg-secondary, #1e1e2e);\r\n            border-radius: 24px;\r\n            transition: 0.3s;\r\n        }\r\n        .api-toggle-slider::before {\r\n            content: \"\";\r\n            position: absolute;\r\n            height: 18px;\r\n            width: 18px;\r\n            left: 3px;\r\n            bottom: 3px;\r\n            background: white;\r\n            border-radius: 50%;\r\n            transition: 0.3s;\r\n        }\r\n        .api-toggle-switch input:checked + .api-toggle-slider {\r\n            background: var(--accent-color, #6366f1);\r\n        }\r\n        .api-toggle-switch input:checked + .api-toggle-slider::before {\r\n            transform: translateX(20px);\r\n        }\r\n\r\n        .api-config-hint {\r\n            color: var(--text-secondary, #888);\r\n            font-size: 0.8rem;\r\n            margin: 0 0 1.25rem;\r\n            line-height: 1.4;\r\n        }\r\n\r\n        .api-config-provider-select {\r\n            margin-bottom: 1.25rem;\r\n        }\r\n        .api-config-provider-select label {\r\n            display: block;\r\n            color: var(--text-primary, #fff);\r\n            font-size: 0.9rem;\r\n            margin-bottom: 0.4rem;\r\n        }\r\n        .api-config-provider-select select {\r\n            width: 100%;\r\n            padding: 0.5rem;\r\n            background: var(--bg-secondary, #1e1e2e);\r\n            color: var(--text-primary, #fff);\r\n            border: 1px solid var(--border-color, #444);\r\n            border-radius: 6px;\r\n            font-size: 0.9rem;\r\n        }\r\n\r\n        .api-config-keys h4 {\r\n            color: var(--text-primary, #fff);\r\n            margin: 0 0 0.75rem;\r\n            font-size: 0.95rem;\r\n        }\r\n\r\n        .api-key-row {\r\n            margin-bottom: 0.75rem;\r\n        }\r\n        .api-key-row label {\r\n            display: block;\r\n            color: var(--text-secondary, #ccc);\r\n            font-size: 0.85rem;\r\n            margin-bottom: 0.3rem;\r\n        }\r\n\r\n        .api-key-input-group {\r\n            display: flex;\r\n            align-items: center;\r\n            gap: 0.4rem;\r\n        }\r\n        .api-key-input {\r\n            flex: 1;\r\n            padding: 0.45rem 0.6rem;\r\n            background: var(--bg-secondary, #1e1e2e);\r\n            color: var(--text-primary, #fff);\r\n            border: 1px solid var(--border-color, #444);\r\n            border-radius: 6px;\r\n            font-size: 0.85rem;\r\n            font-family: monospace;\r\n        }\r\n        .api-key-input:focus {\r\n            outline: none;\r\n            border-color: var(--accent-color, #6366f1);\r\n        }\r\n\r\n        .api-key-toggle {\r\n            background: none;\r\n            border: none;\r\n            cursor: pointer;\r\n            font-size: 1rem;\r\n            padding: 0.3rem;\r\n        }\r\n\r\n        .api-key-status {\r\n            font-size: 0.9rem;\r\n            width: 1.2rem;\r\n            text-align: center;\r\n        }\r\n        .api-key-status.configured {\r\n            color: var(--success-color, #22c55e);\r\n        }\r\n\r\n        .api-config-footer {\r\n            display: flex;\r\n            justify-content: flex-end;\r\n            gap: 0.75rem;\r\n            padding: 1rem 1.5rem;\r\n            border-top: 1px solid var(--border-color, #444);\r\n        }\r\n\r\n        .api-config-cancel,\r\n        .api-config-save {\r\n            padding: 0.5rem 1.25rem;\r\n            border: none;\r\n            border-radius: 6px;\r\n            cursor: pointer;\r\n            font-size: 0.9rem;\r\n        }\r\n        .api-config-cancel {\r\n            background: var(--bg-secondary, #1e1e2e);\r\n            color: var(--text-primary, #fff);\r\n        }\r\n        .api-config-save {\r\n            background: var(--accent-color, #6366f1);\r\n            color: white;\r\n        }\r\n        .api-config-save:hover {\r\n            background: var(--accent-hover, #5558e3);\r\n        }\r\n\r\n        /* Bouton config dans la toolbar */\r\n        #api-config-btn {\r\n            background: none;\r\n            border: 1px solid var(--border-color, #444);\r\n            color: var(--text-secondary, #888);\r\n            cursor: pointer;\r\n            padding: 2px 8px;\r\n            border-radius: 4px;\r\n            font-size: 14px;\r\n            transition: all 0.2s;\r\n        }\r\n        #api-config-btn:hover {\r\n            color: var(--text-primary, #fff);\r\n            border-color: var(--text-secondary, #888);\r\n        }\r\n        #api-config-btn.api-configured {\r\n            color: var(--success-color, #22c55e);\r\n            border-color: var(--success-color, #22c55e);\r\n        }\r\n\r\n        .api-provider-badge {\r\n            font-size: 11px;\r\n            color: var(--success-color, #22c55e);\r\n            background: rgba(34, 197, 94, 0.1);\r\n            border: 1px solid rgba(34, 197, 94, 0.3);\r\n            border-radius: 4px;\r\n            padding: 1px 6px;\r\n            white-space: nowrap;\r\n        }\r\n        .api-provider-badge.hidden {\r\n            display: none;\r\n        }\r\n    `;\r\n\r\n    document.head.appendChild(styles);\r\n}\r\n","/**\r\n * LLMApiManager - Orchestration des appels API pour op√©rations structur√©es\r\n *\r\n * Point d'entr√©e pour ex√©cuter D√âVELOPPER, RELIER, SYNTH√âTISER via API directe\r\n * avec fallback automatique vers webview si n√©cessaire.\r\n *\r\n * D√©pendances :\r\n * - app.llm : LLMManager\r\n * - app.webviewHandler : WebviewHandler (pour fallback et UI)\r\n * - app.canvas : CanvasManager\r\n */\r\n\r\nimport type {\r\n    AppLike,\r\n    LLMManagerLike,\r\n    WebviewHandlerLike,\r\n    CanvasManagerLike,\r\n    RoutingResult,\r\n    APIProviderResult,\r\n    ParsedVignette,\r\n    ParsedConnection,\r\n    ParsedResponse,\r\n} from '../types/kairos.js';\r\nimport { createConnectionsFromParsed } from './webview/capture.js';\r\n\r\nimport { routeOperation, getAPIProvider, isAPIAvailable } from './llm-api/router.js';\r\nimport { executeViaAPI } from './llm-api/executor.js';\r\nimport {\r\n    showAPILoadingState,\r\n    updateAPILoadingState,\r\n    hideAPILoadingState,\r\n    showAPIError,\r\n    showAPISuccess,\r\n    injectAPIStyles,\r\n} from './llm-api/ui-states.js';\r\nimport { setupAPIConfigButton, injectConfigStyles } from './llm-api/config-modal.js';\r\n\r\nexport class LLMApiManager {\r\n    app: AppLike;\r\n    llm: LLMManagerLike;\r\n    webviewHandler: WebviewHandlerLike | null;\r\n    canvas: CanvasManagerLike;\r\n\r\n    constructor(app: AppLike) {\r\n        this.app = app;\r\n        this.llm = app.llm;\r\n        this.webviewHandler = app.webviewHandler;\r\n        this.canvas = app.canvas;\r\n\r\n        // Injecter les styles CSS au premier chargement\r\n        injectAPIStyles();\r\n        injectConfigStyles();\r\n\r\n        // Initialiser le bouton de configuration API\r\n        const configBtn = document.getElementById('api-config-btn');\r\n        if (configBtn) {\r\n            setupAPIConfigButton(configBtn, this.llm, this);\r\n        }\r\n\r\n        console.log('[LLMApiManager] Initialis√©');\r\n    }\r\n\r\n    /**\r\n     * V√©rifie si le mode API est disponible\r\n     */\r\n    isAvailable(): boolean {\r\n        return isAPIAvailable(this.llm);\r\n    }\r\n\r\n    /**\r\n     * Retourne le provider API actuel\r\n     */\r\n    getProvider(): APIProviderResult | null {\r\n        return getAPIProvider(this.llm);\r\n    }\r\n\r\n    /**\r\n     * Ex√©cute une op√©ration via API ou webview selon configuration\r\n     */\r\n    async executeOperation(operation: string, prompt: string, contexte: Record<string, any>): Promise<any> {\r\n        const routing: RoutingResult = routeOperation(this.llm, operation);\r\n\r\n        console.log(`[LLMApiManager] Route: ${routing.mode} (${routing.reason})`);\r\n\r\n        if (routing.mode === 'api') {\r\n            return this.executeViaAPIPath(operation, prompt, contexte, routing.provider);\r\n        } else {\r\n            return this.executeViaWebviewPath(operation, prompt);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Ex√©cute via le chemin API direct\r\n     */\r\n    async executeViaAPIPath(\r\n        operation: string,\r\n        prompt: string,\r\n        contexte: Record<string, any>,\r\n        apiProvider: APIProviderResult | any,\r\n    ): Promise<ParsedResponse> {\r\n        return new Promise((resolve, reject) => {\r\n            executeViaAPI({\r\n                llm: this.llm,\r\n                operation,\r\n                prompt,\r\n                apiProvider,\r\n                onSuccess: (parsed: ParsedResponse) => {\r\n                    hideAPILoadingState();\r\n                    this.handleParsedResponse(operation, parsed, contexte);\r\n                    resolve(parsed);\r\n                },\r\n                onError: (error: Error) => {\r\n                    hideAPILoadingState();\r\n                    this.handleAPIError(error, operation, prompt, contexte);\r\n                    reject(error);\r\n                },\r\n                onProgress: ({ state, message }: { state: string; message: string }) => {\r\n                    if (state === 'loading') {\r\n                        showAPILoadingState(operation, apiProvider.provider.name || apiProvider.name);\r\n                    } else {\r\n                        updateAPILoadingState(message);\r\n                    }\r\n                },\r\n            });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Ex√©cute via le chemin webview (fallback)\r\n     */\r\n    async executeViaWebviewPath(operation: string, prompt: string): Promise<{ mode: string; success: boolean }> {\r\n        if (!this.webviewHandler) {\r\n            throw new Error('WebviewHandler non disponible');\r\n        }\r\n\r\n        // Comportement existant inchang√©\r\n        this.webviewHandler.currentOperation = operation;\r\n        this.webviewHandler.updateCaptureButtonText(operation);\r\n\r\n        const success = await this.webviewHandler.injectPromptToWebview(prompt);\r\n\r\n        if (success) {\r\n            const msg = `${operation}: Prompt inject√© \\u2192 envoyez dans le webview`;\r\n            this.app.showNotification?.(msg);\r\n        }\r\n\r\n        return { mode: 'webview', success };\r\n    }\r\n\r\n    /**\r\n     * Traite la r√©ponse pars√©e selon le type d'op√©ration\r\n     */\r\n    handleParsedResponse(operation: string, parsed: ParsedResponse, contexte: Record<string, any>): void {\r\n        // Mettre √† jour le tracking de circularit√©\r\n        this.updateCircularityTracking((parsed as any).raw || (parsed as any).content || '');\r\n\r\n        switch (parsed.type) {\r\n            case 'vignettes':\r\n                this.importVignettes(parsed.vignettes, parsed.connections);\r\n                break;\r\n\r\n            case 'connections':\r\n                this.importConnections(parsed.connections);\r\n                break;\r\n\r\n            case 'synthesis':\r\n                this.handleSynthesis(parsed.text, contexte);\r\n                break;\r\n\r\n            default:\r\n                console.warn('[LLMApiManager] Type de r√©ponse inconnu:', parsed.type);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Met √† jour le tracking de circularit√© avec la r√©ponse LLM\r\n     */\r\n    updateCircularityTracking(rawContent: string): void {\r\n        if (this.llm?.canvasAnalyzer && rawContent) {\r\n            this.llm.canvasAnalyzer.lastLLMOutput = rawContent;\r\n            console.log('[LLMApiManager] lastLLMOutput stock√© pour circularit√©');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Importe les vignettes via l'UI de s√©lection existante\r\n     */\r\n    importVignettes(vignettes: ParsedVignette[], connections: ParsedConnection[]): void {\r\n        if (vignettes.length === 0 && connections.length === 0) {\r\n            showAPISuccess('Aucun contenu √† importer', 2000);\r\n            return;\r\n        }\r\n\r\n        if (vignettes.length === 0 && connections.length > 0) {\r\n            // Seulement des connexions\r\n            this.importConnections(connections);\r\n            return;\r\n        }\r\n\r\n        // Utiliser l'UI de s√©lection existante du webviewHandler\r\n        if (this.webviewHandler) {\r\n            this.webviewHandler.pendingTextConnections = connections;\r\n            this.webviewHandler.showVignetteSelectionUI(\r\n                vignettes,\r\n                '', // originalContent\r\n                connections.length,\r\n            );\r\n        } else {\r\n            // Fallback: import direct\r\n            this.importVignettesDirect(vignettes, connections);\r\n        }\r\n\r\n        showAPISuccess(`${vignettes.length} vignette(s) propos√©e(s)`, 2000);\r\n    }\r\n\r\n    /**\r\n     * Import direct des vignettes (fallback si pas de webviewHandler)\r\n     */\r\n    importVignettesDirect(vignettes: ParsedVignette[], connections: ParsedConnection[]): void {\r\n        vignettes.forEach((vignette, index) => {\r\n            // Chercher la cible de connexion pour positionner pr√®s du n≈ìud li√©\r\n            let targetNodeId: string | null = null;\r\n            for (const conn of connections) {\r\n                if (conn.toText) {\r\n                    const toLower = conn.toText.toLowerCase().trim().substring(0, 50);\r\n                    const vigLower = vignette.text.toLowerCase().trim().substring(0, 50);\r\n                    if (toLower === vigLower || toLower.includes(vigLower) || vigLower.includes(toLower)) {\r\n                        // Cette vignette est la cible ‚Äî trouver le n≈ìud source existant\r\n                        const fromNode = this.canvas.state.nodes.find((n: any) => {\r\n                            const nLower = n.text.toLowerCase().trim().substring(0, 50);\r\n                            const fLower = conn.fromText.toLowerCase().trim().substring(0, 50);\r\n                            return nLower === fLower || nLower.includes(fLower) || fLower.includes(nLower);\r\n                        });\r\n                        if (fromNode) { targetNodeId = fromNode.id; break; }\r\n                    }\r\n                }\r\n            }\r\n\r\n            const pos = this.canvas.getSmartImportPosition(targetNodeId, index, vignettes.length);\r\n            this.canvas.createNode(\r\n                pos.x,\r\n                pos.y,\r\n                vignette.text,\r\n                vignette.status || 'neutral',\r\n                vignette.tags || [],\r\n                true,\r\n                { newlyImported: true },\r\n            );\r\n        });\r\n\r\n        // Cr√©er les connexions apr√®s un d√©lai\r\n        if (connections.length > 0) {\r\n            setTimeout(() => {\r\n                this.importConnections(connections);\r\n            }, 100);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Importe les connexions\r\n     */\r\n    importConnections(connections: ParsedConnection[]): void {\r\n        if (connections.length === 0) {\r\n            return;\r\n        }\r\n\r\n        if (!this.webviewHandler) {\r\n            console.error('[LLMApiManager] webviewHandler non disponible');\r\n            return;\r\n        }\r\n\r\n        const created = createConnectionsFromParsed(this.webviewHandler, connections);\r\n\r\n        showAPISuccess(`${created} connexion(s) cr√©√©e(s)`, 2000);\r\n\r\n        // Mettre √† jour le bandeau de suggestion\r\n        setTimeout(() => {\r\n            this.app.metrics?.updateSuggestionBanner?.();\r\n        }, 150);\r\n    }\r\n\r\n    /**\r\n     * G√®re la synth√®se\r\n     */\r\n    handleSynthesis(text: string, _contexte: Record<string, any>): void {\r\n        if (!text || text.trim().length === 0) {\r\n            showAPISuccess('Synth√®se vide', 2000);\r\n            return;\r\n        }\r\n\r\n        // √âmettre l'√©v√©nement pour d√©clencher le modal d'archivage\r\n        document.dispatchEvent(\r\n            new CustomEvent('responseCaptured', {\r\n                detail: {\r\n                    content: text,\r\n                    operation: 'SYNTH√âTISER',\r\n                },\r\n            }),\r\n        );\r\n\r\n        showAPISuccess('Synth√®se captur√©e', 2000);\r\n    }\r\n\r\n    /**\r\n     * G√®re les erreurs API avec options de r√©cup√©ration\r\n     */\r\n    handleAPIError(error: Error, operation: string, prompt: string, contexte: Record<string, any>): void {\r\n        console.error('[LLMApiManager] Erreur:', error);\r\n\r\n        showAPIError(error, {\r\n            onRetry: () => {\r\n                // R√©essayer via API\r\n                const apiProvider = getAPIProvider(this.llm);\r\n                if (apiProvider) {\r\n                    this.executeViaAPIPath(operation, prompt, contexte, apiProvider);\r\n                }\r\n            },\r\n            onFallbackWebview: () => {\r\n                // Basculer sur webview\r\n                this.executeViaWebviewPath(operation, prompt);\r\n            },\r\n            onDismiss: () => {\r\n                console.log(\"[LLMApiManager] Erreur ignor√©e par l'utilisateur\");\r\n            },\r\n        });\r\n    }\r\n}\r\n\r\nexport default LLMApiManager;\r\n","/**\r\n * graph-analysis.ts ‚Äî Pure graph topology functions\r\n * Mode-agnostic: no DOM, no IPC, no assisted/ dependency.\r\n * Reusable by any module needing graph structure analysis.\r\n */\r\n\r\nimport type { KairosNode, KairosConnection } from '../types/kairos.js';\r\n\r\n// ‚îÄ‚îÄ Connected components (BFS, undirected) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n\r\n/**\r\n * Count connected components via BFS on an undirected view of the graph.\r\n * Both `implies` and `resonance` edges are treated as bidirectional.\r\n * Returns 0 for an empty graph.\r\n */\r\nexport function countConnectedComponents(nodes: KairosNode[], connections: KairosConnection[]): number {\r\n    if (nodes.length === 0) return 0;\r\n\r\n    const adj = new Map<string, Set<string>>();\r\n    for (const node of nodes) {\r\n        adj.set(node.id, new Set());\r\n    }\r\n    for (const conn of connections) {\r\n        adj.get(conn.from)?.add(conn.to);\r\n        adj.get(conn.to)?.add(conn.from);\r\n    }\r\n\r\n    const visited = new Set<string>();\r\n    let components = 0;\r\n\r\n    for (const node of nodes) {\r\n        if (visited.has(node.id)) continue;\r\n        components++;\r\n        const queue = [node.id];\r\n        visited.add(node.id);\r\n        while (queue.length > 0) {\r\n            const current = queue.shift()!;\r\n            for (const neighbor of adj.get(current) || []) {\r\n                if (!visited.has(neighbor)) {\r\n                    visited.add(neighbor);\r\n                    queue.push(neighbor);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    return components;\r\n}\r\n\r\n// ‚îÄ‚îÄ Connection density ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n\r\n/**\r\n * Connections-to-nodes ratio. Returns 0 if no nodes.\r\n */\r\nexport function calculateConnectionDensity(nodes: KairosNode[], connections: KairosConnection[]): number {\r\n    return nodes.length > 0 ? connections.length / nodes.length : 0;\r\n}\r\n\r\n// ‚îÄ‚îÄ Graph structure evaluation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n\r\nexport interface GraphStructureConfig {\r\n    underConnectedThreshold: number; // ratio below this = under-connected\r\n    overConnectedThreshold: number; // ratio above this = over-connected\r\n    neutralBonusMax: number; // bonus for healthy ratio range\r\n    disconnectedMalus: number; // malus per extra component (beyond 1)\r\n    underConnectedMalus: number; // flat malus when ratio < threshold\r\n    overConnectedMalus: number; // flat malus when ratio > threshold\r\n}\r\n\r\nexport interface GraphStructureResult {\r\n    enabled: boolean;\r\n    ratio: number;\r\n    components: number;\r\n    malus: number;\r\n    bonus: number;\r\n}\r\n\r\n/**\r\n * Evaluate graph structure health.\r\n * Disabled (all zeros) when nodeCount < minNodes.\r\n */\r\nexport function evaluateGraphStructure(\r\n    nodes: KairosNode[],\r\n    connections: KairosConnection[],\r\n    minNodes: number,\r\n    config: GraphStructureConfig,\r\n): GraphStructureResult {\r\n    if (nodes.length < minNodes) {\r\n        return { enabled: false, ratio: 0, components: 0, malus: 0, bonus: 0 };\r\n    }\r\n\r\n    const ratio = calculateConnectionDensity(nodes, connections);\r\n    const components = countConnectedComponents(nodes, connections);\r\n\r\n    let malus = 0;\r\n    let bonus = 0;\r\n\r\n    // Density signal (flat malus for under/over-connected)\r\n    if (ratio < config.underConnectedThreshold) {\r\n        malus += config.underConnectedMalus;\r\n    } else if (ratio > config.overConnectedThreshold) {\r\n        malus += config.overConnectedMalus;\r\n    } else if (ratio >= 1.0 && ratio <= 2.0) {\r\n        bonus += config.neutralBonusMax;\r\n    }\r\n\r\n    // Disconnected components\r\n    if (components > 1) {\r\n        malus += (components - 1) * config.disconnectedMalus;\r\n    }\r\n\r\n    return { enabled: true, ratio, components, malus, bonus };\r\n}\r\n","/**\r\n * oxygen.ts ‚Äî Oxygen Gauge: cognitive vitality indicator\r\n * Mode-agnostic: no dependency on assisted/, reusable by any mode.\r\n * Contains: types, config, keyword utils, calculation, persistence, OxygenManager.\r\n */\r\n\r\nimport type { KairosNode, KairosConnection } from '../types/kairos.js';\r\nimport { evaluateGraphStructure } from './graph-analysis.js';\r\nimport type { GraphStructureResult } from './graph-analysis.js';\r\nimport { getCanvasId } from '../canvas-id-store.js';\r\n\r\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n// TYPES\r\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n\r\nexport interface OxygenConfig {\r\n    defaultScore: number;\r\n    newTagBonus: number;\r\n    llmEchoThreshold: number;\r\n    llmEchoMalus: number;\r\n    stagnationMalus: number;\r\n    frictionAcceptedBonus: number;\r\n    graphMinNodes: number;\r\n    graphUnderConnectedThreshold: number;\r\n    graphOverConnectedThreshold: number;\r\n    graphNeutralBonusMax: number;\r\n    graphDisconnectedMalus: number;\r\n    graphUnderConnectedMalus: number;\r\n    graphOverConnectedMalus: number;\r\n    moderateFrictionThreshold: number;\r\n    radicalFrictionThreshold: number;\r\n    echoJaccardThreshold: number;\r\n    maxHistory: number;\r\n    tagLookbackTurns: number;\r\n}\r\n\r\nexport interface OxygenState {\r\n    score: number;\r\n    history: OxygenHistoryEntry[];\r\n    turnCount: number;\r\n    lastTurnTags: string[][]; // sliding window: last N turns' tag snapshots\r\n    lastLLMOutput: string;\r\n    lastUserInput: string;\r\n    frictionBonusPending: boolean;\r\n    lastFrictionAcceptedTurn: number; // turn number when friction was last accepted (-Infinity = never)\r\n}\r\n\r\nexport interface OxygenHistoryEntry {\r\n    turn: number;\r\n    score: number;\r\n    delta: number;\r\n    signals: string[];\r\n    timestamp: number;\r\n}\r\n\r\nexport interface OxygenSignals {\r\n    newTags: { count: number; bonus: number };\r\n    llmEcho: { overlap: number; malus: number; maxJaccard: number };\r\n    stagnation: { turns: number; malus: number };\r\n    frictionBonus: { accepted: boolean; bonus: number };\r\n    graphStructure: GraphStructureResult;\r\n}\r\n\r\nexport type OxygenLevel = 'critical' | 'low' | 'moderate' | 'healthy' | 'thriving';\r\nexport type FrictionLevel = 'none' | 'moderate' | 'radical';\r\n\r\nexport interface OxygenResult {\r\n    score: number;\r\n    previousScore: number;\r\n    delta: number;\r\n    signals: OxygenSignals;\r\n    level: OxygenLevel;\r\n    shouldInjectFriction: boolean;\r\n    frictionLevel: FrictionLevel;\r\n    timestamp: number;\r\n}\r\n\r\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n// CONFIG\r\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n\r\nexport const DEFAULT_OXYGEN_CONFIG: OxygenConfig = {\r\n    defaultScore: 50,\r\n    newTagBonus: 10,\r\n    llmEchoThreshold: 0.7,\r\n    llmEchoMalus: -20,\r\n    stagnationMalus: -15,\r\n    frictionAcceptedBonus: 15,\r\n    graphMinNodes: 8,\r\n    graphUnderConnectedThreshold: 0.5,\r\n    graphOverConnectedThreshold: 3.0,\r\n    graphNeutralBonusMax: 10,\r\n    graphDisconnectedMalus: -5,\r\n    graphUnderConnectedMalus: -25,\r\n    graphOverConnectedMalus: -25,\r\n    moderateFrictionThreshold: 50,\r\n    radicalFrictionThreshold: 30,\r\n    echoJaccardThreshold: 0.35,\r\n    maxHistory: 100,\r\n    tagLookbackTurns: 3,\r\n};\r\n\r\n// ‚îÄ‚îÄ Calibration constants (easy to tune) ‚îÄ‚îÄ\r\nconst MAX_TAG_BONUS_PER_TURN = 20;\r\nconst MAX_FRICTION_BONUS_PER_TURN = 15;\r\nconst FRICTION_DECAY_TURNS = 2; // friction bonus active for N turns after acceptance\r\nconst ECHO_JACCARD_THRESHOLD = 0.35;\r\nconst ECHO_JACCARD_MALUS = -20;\r\n\r\nexport function createInitialOxygenState(config: OxygenConfig = DEFAULT_OXYGEN_CONFIG): OxygenState {\r\n    return {\r\n        score: config.defaultScore,\r\n        history: [],\r\n        turnCount: 0,\r\n        lastTurnTags: [],\r\n        lastLLMOutput: '',\r\n        lastUserInput: '',\r\n        frictionBonusPending: false,\r\n        lastFrictionAcceptedTurn: -Infinity,\r\n    };\r\n}\r\n\r\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n// KEYWORD UTILITIES (autonomous copy ‚Äî no import from assisted/)\r\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n\r\nconst STOPWORDS: Set<string> = new Set([\r\n    'le',\r\n    'la',\r\n    'les',\r\n    'un',\r\n    'une',\r\n    'de',\r\n    'du',\r\n    'des',\r\n    'et',\r\n    'ou',\r\n    'est',\r\n    'sont',\r\n    'dans',\r\n    'pour',\r\n    'qui',\r\n    'que',\r\n    'sur',\r\n    'par',\r\n    'avec',\r\n    'sans',\r\n    'ce',\r\n    'cette',\r\n    'ces',\r\n    'au',\r\n    'aux',\r\n    'en',\r\n    'ne',\r\n    'pas',\r\n    'plus',\r\n    'moins',\r\n    'tout',\r\n    'tous',\r\n    'toute',\r\n    'toutes',\r\n    'autre',\r\n    'autres',\r\n    'meme',\r\n    'comme',\r\n    'mais',\r\n    'donc',\r\n    'car',\r\n    'ni',\r\n    'si',\r\n    'se',\r\n    'son',\r\n    'sa',\r\n    'ses',\r\n    'leur',\r\n    'leurs',\r\n    'nous',\r\n    'vous',\r\n    'ils',\r\n    'elles',\r\n    'lui',\r\n    'elle',\r\n    'il',\r\n    'on',\r\n    'je',\r\n    'tu',\r\n    'etre',\r\n    'avoir',\r\n    'faire',\r\n    'dit',\r\n    'fait',\r\n    'peut',\r\n    'faut',\r\n    'doit',\r\n    'vers',\r\n    'chez',\r\n]);\r\n\r\nfunction extractKeywords(text: string): string[] {\r\n    if (!text) return [];\r\n    return text\r\n        .toLowerCase()\r\n        .normalize('NFD')\r\n        .replace(/[\\u0300-\\u036f]/g, '')\r\n        .split(/\\W+/)\r\n        .filter((w) => w.length > 3 && !STOPWORDS.has(w));\r\n}\r\n\r\n/**\r\n * Result of canvas Jaccard analysis (richer than just boolean).\r\n */\r\nexport interface JaccardAnalysis {\r\n    detected: boolean; // any pair above threshold?\r\n    maxJaccard: number; // highest Jaccard score found\r\n    pairsAbove: number; // count of pairs above threshold\r\n    totalPairs: number; // total pairs compared\r\n    topPairs: Array<{ nodeA: string; nodeB: string; idA: string; idB: string; jaccard: number }>;\r\n}\r\n\r\n/**\r\n * Analyze canvas redundancy: compare ALL pairs of vignettes.\r\n * Returns full analysis with max Jaccard, top pairs, etc.\r\n * Pure function of canvas state, no buffer/event dependency.\r\n */\r\nexport function analyzeCanvasJaccard(nodes: KairosNode[], threshold: number = ECHO_JACCARD_THRESHOLD): JaccardAnalysis {\r\n    const result: JaccardAnalysis = { detected: false, maxJaccard: 0, pairsAbove: 0, totalPairs: 0, topPairs: [] };\r\n    if (nodes.length < 2) return result;\r\n\r\n    const kwSets = nodes.map((n) => new Set(extractKeywords(n.text)));\r\n\r\n    for (let i = 0; i < kwSets.length; i++) {\r\n        if (kwSets[i].size === 0) continue;\r\n        for (let j = i + 1; j < kwSets.length; j++) {\r\n            if (kwSets[j].size === 0) continue;\r\n            result.totalPairs++;\r\n            const intersection = [...kwSets[i]].filter((w) => kwSets[j].has(w)).length;\r\n            const union = new Set([...kwSets[i], ...kwSets[j]]).size;\r\n            const jaccard = union > 0 ? intersection / union : 0;\r\n\r\n            if (jaccard > result.maxJaccard) {\r\n                result.maxJaccard = jaccard;\r\n            }\r\n            if (jaccard > threshold) {\r\n                result.pairsAbove++;\r\n                result.detected = true;\r\n                // Garder les 10 paires les plus proches\r\n                if (result.topPairs.length < 10) {\r\n                    result.topPairs.push({\r\n                        nodeA: nodes[i].text.substring(0, 60),\r\n                        nodeB: nodes[j].text.substring(0, 60),\r\n                        idA: nodes[i].id,\r\n                        idB: nodes[j].id,\r\n                        jaccard: Math.round(jaccard * 100) / 100,\r\n                    });\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    // Trier top pairs par jaccard d√©croissant\r\n    result.topPairs.sort((a, b) => b.jaccard - a.jaccard);\r\n    result.maxJaccard = Math.round(result.maxJaccard * 100) / 100;\r\n\r\n    return result;\r\n}\r\n\r\n/**\r\n * Detect redundancy on canvas (simple boolean wrapper for calculateOxygen).\r\n * Uses analyzeCanvasJaccard internally, stores last analysis for debugging.\r\n */\r\nlet _lastJaccardAnalysis: JaccardAnalysis | null = null;\r\n\r\nfunction detectCanvasRedundancy(nodes: KairosNode[], threshold: number = ECHO_JACCARD_THRESHOLD): boolean {\r\n    _lastJaccardAnalysis = analyzeCanvasJaccard(nodes, threshold);\r\n    if (_lastJaccardAnalysis.detected) {\r\n        console.log('[OXYGEN ECHO]', {\r\n            maxJaccard: _lastJaccardAnalysis.maxJaccard,\r\n            pairsAbove: _lastJaccardAnalysis.pairsAbove,\r\n            topPair: _lastJaccardAnalysis.topPairs[0] || null,\r\n        });\r\n    }\r\n    return _lastJaccardAnalysis.detected;\r\n}\r\n\r\nfunction getLastJaccardAnalysis(): JaccardAnalysis | null {\r\n    return _lastJaccardAnalysis;\r\n}\r\n\r\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n// CALCULATION (pure function, no side effects)\r\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n\r\nfunction collectAllTags(nodes: KairosNode[]): string[] {\r\n    const tags = new Set<string>();\r\n    for (const node of nodes) {\r\n        if (node.tags) {\r\n            for (const tag of node.tags) {\r\n                tags.add(tag.replace(/^#/, '').toLowerCase());\r\n            }\r\n        }\r\n    }\r\n    return [...tags];\r\n}\r\n\r\nfunction scoreToLevel(score: number): OxygenLevel {\r\n    if (score < 20) return 'critical';\r\n    if (score < 40) return 'low';\r\n    if (score < 60) return 'moderate';\r\n    if (score < 80) return 'healthy';\r\n    return 'thriving';\r\n}\r\n\r\n/**\r\n * Core oxygen calculation ‚Äî PURE SNAPSHOT MODEL.\r\n *\r\n * The score is ALWAYS recomputed from scratch as a function of:\r\n *   BASE(50) + structural + echo + tagDiversity + friction\r\n *\r\n * No deltas, no accumulation. evaluate() and recordTurn() call this\r\n * same function and get the same score for the same graph state.\r\n * The only difference: recordTurn() also advances the turn history.\r\n */\r\nexport function calculateOxygen(\r\n    state: OxygenState,\r\n    nodes: KairosNode[],\r\n    connections: KairosConnection[],\r\n    config: OxygenConfig,\r\n): OxygenResult {\r\n    const signals: OxygenSignals = {\r\n        newTags: { count: 0, bonus: 0 },\r\n        llmEcho: { overlap: 0, malus: 0, maxJaccard: 0 },\r\n        stagnation: { turns: 0, malus: 0 },\r\n        frictionBonus: { accepted: false, bonus: 0 },\r\n        graphStructure: { enabled: false, ratio: 0, components: 0, malus: 0, bonus: 0 },\r\n    };\r\n\r\n    let score = config.defaultScore; // BASE = 50\r\n\r\n    // ‚îÄ‚îÄ Signal 1: Graph structure (absolute contribution) ‚îÄ‚îÄ\r\n    signals.graphStructure = evaluateGraphStructure(nodes, connections, config.graphMinNodes, {\r\n        underConnectedThreshold: config.graphUnderConnectedThreshold,\r\n        overConnectedThreshold: config.graphOverConnectedThreshold,\r\n        neutralBonusMax: config.graphNeutralBonusMax,\r\n        disconnectedMalus: config.graphDisconnectedMalus,\r\n        underConnectedMalus: config.graphUnderConnectedMalus,\r\n        overConnectedMalus: config.graphOverConnectedMalus,\r\n    });\r\n    score += signals.graphStructure.malus + signals.graphStructure.bonus;\r\n\r\n    // ‚îÄ‚îÄ Signal 2: Canvas redundancy (all-pairs Jaccard, absolute) ‚îÄ‚îÄ\r\n    const hasRedundancy = detectCanvasRedundancy(nodes, config.echoJaccardThreshold);\r\n    const jaccardInfo = getLastJaccardAnalysis();\r\n    signals.llmEcho.overlap = hasRedundancy ? 1 : 0;\r\n    signals.llmEcho.maxJaccard = jaccardInfo?.maxJaccard ?? 0;\r\n    if (hasRedundancy) {\r\n        signals.llmEcho.malus = ECHO_JACCARD_MALUS;\r\n    }\r\n    score += signals.llmEcho.malus;\r\n\r\n    // ‚îÄ‚îÄ Signal 3: Tag diversity (snapshot comparison vs historical baseline) ‚îÄ‚îÄ\r\n    const currentTags = collectAllTags(nodes);\r\n    const tagResult = computeTagDiversity(currentTags, state.lastTurnTags, state.turnCount, config);\r\n    signals.newTags.count = tagResult.newCount;\r\n    signals.newTags.bonus = tagResult.bonus;\r\n    signals.stagnation.turns = tagResult.stagnant ? 1 : 0;\r\n    signals.stagnation.malus = tagResult.stagnationMalus;\r\n    score += tagResult.bonus + tagResult.stagnationMalus;\r\n\r\n    // ‚îÄ‚îÄ Signal 4: Friction bonus (decaying reward) ‚îÄ‚îÄ\r\n    const frictionResult = computeFrictionSnapshot(state, config);\r\n    signals.frictionBonus.accepted = frictionResult.active;\r\n    signals.frictionBonus.bonus = frictionResult.bonus;\r\n    score += frictionResult.bonus;\r\n\r\n    // ‚îÄ‚îÄ Clamp ‚îÄ‚îÄ\r\n    const newScore = Math.max(0, Math.min(100, score));\r\n\r\n    console.log('[OXYGEN SNAPSHOT]', {\r\n        base: config.defaultScore,\r\n        structural: signals.graphStructure.malus + signals.graphStructure.bonus,\r\n        echo: signals.llmEcho.malus,\r\n        tagDiversity: tagResult.bonus + tagResult.stagnationMalus,\r\n        friction: frictionResult.bonus,\r\n        rawScore: score,\r\n        clampedScore: newScore,\r\n        ratio: signals.graphStructure.ratio,\r\n        components: signals.graphStructure.components,\r\n        turnCount: state.turnCount,\r\n    });\r\n\r\n    const level = scoreToLevel(newScore);\r\n    const frictionLevel: FrictionLevel =\r\n        newScore < config.radicalFrictionThreshold\r\n            ? 'radical'\r\n            : newScore < config.moderateFrictionThreshold\r\n              ? 'moderate'\r\n              : 'none';\r\n\r\n    return {\r\n        score: newScore,\r\n        previousScore: state.score,\r\n        delta: newScore - state.score,\r\n        signals,\r\n        level,\r\n        shouldInjectFriction: frictionLevel !== 'none',\r\n        frictionLevel,\r\n        timestamp: Date.now(),\r\n    };\r\n}\r\n\r\n/**\r\n * Compute tag diversity contribution (snapshot-based).\r\n * Compares current tags against the OLDEST snapshot in the sliding window.\r\n * Returns a bonus for new tags, or a malus for stagnation.\r\n */\r\nfunction computeTagDiversity(\r\n    currentTags: string[],\r\n    tagHistory: string[][],\r\n    turnCount: number,\r\n    config: OxygenConfig,\r\n): { bonus: number; stagnationMalus: number; newCount: number; stagnant: boolean } {\r\n    // No history yet ‚Äî neutral (no penalty, no bonus)\r\n    if (tagHistory.length === 0 || turnCount === 0) {\r\n        return { bonus: 0, stagnationMalus: 0, newCount: 0, stagnant: false };\r\n    }\r\n\r\n    // Compare current tags against the OLDEST snapshot in the window (= baseline)\r\n    const baseline = new Set(tagHistory[0]);\r\n    const newTags = currentTags.filter((t) => !baseline.has(t));\r\n\r\n    if (newTags.length > 0) {\r\n        // Diversity detected ‚Äî bonus capped at MAX_TAG_BONUS_PER_TURN\r\n        const bonus = Math.min(newTags.length * config.newTagBonus, MAX_TAG_BONUS_PER_TURN);\r\n        return { bonus, stagnationMalus: 0, newCount: newTags.length, stagnant: false };\r\n    }\r\n\r\n    // No new tags ‚Äî stagnation only if enough turns have passed\r\n    if (turnCount >= config.tagLookbackTurns) {\r\n        return { bonus: 0, stagnationMalus: config.stagnationMalus, newCount: 0, stagnant: true };\r\n    }\r\n\r\n    return { bonus: 0, stagnationMalus: 0, newCount: 0, stagnant: false };\r\n}\r\n\r\n/**\r\n * Compute friction contribution (snapshot-based).\r\n * Bonus is active if friction is pending OR was accepted within FRICTION_DECAY_TURNS.\r\n */\r\nfunction computeFrictionSnapshot(\r\n    state: OxygenState,\r\n    config: OxygenConfig,\r\n): { active: boolean; bonus: number } {\r\n    // Pending friction (not yet consumed by recordTurn)\r\n    if (state.frictionBonusPending) {\r\n        return { active: true, bonus: Math.min(config.frictionAcceptedBonus, MAX_FRICTION_BONUS_PER_TURN) };\r\n    }\r\n\r\n    // Recently accepted friction (within decay window)\r\n    if (state.lastFrictionAcceptedTurn > -Infinity) {\r\n        const turnsSince = state.turnCount - state.lastFrictionAcceptedTurn;\r\n        if (turnsSince <= FRICTION_DECAY_TURNS) {\r\n            return { active: true, bonus: Math.min(config.frictionAcceptedBonus, MAX_FRICTION_BONUS_PER_TURN) };\r\n        }\r\n    }\r\n\r\n    return { active: false, bonus: 0 };\r\n}\r\n\r\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n// PERSISTENCE (via existing attractors table in SQLite)\r\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n\r\nasync function saveOxygenState(state: OxygenState): Promise<void> {\r\n    try {\r\n        const fgraph = (window as any).fgraph;\r\n        if (fgraph?.db?.attractors?.mergeData) {\r\n            await fgraph.db.attractors.mergeData(getCanvasId(), { oxygen: serializeState(state) });\r\n        }\r\n    } catch (e) {\r\n        console.warn('[Oxygen] Save failed:', e);\r\n    }\r\n}\r\n\r\nasync function loadOxygenState(): Promise<OxygenState | null> {\r\n    try {\r\n        const fgraph = (window as any).fgraph;\r\n        if (!fgraph?.db?.attractors?.getData) return null;\r\n        const data = await fgraph.db.attractors.getData(getCanvasId());\r\n        if (data?.oxygen) {\r\n            return deserializeState(data.oxygen);\r\n        }\r\n    } catch (e) {\r\n        console.warn('[Oxygen] Load failed:', e);\r\n    }\r\n    return null;\r\n}\r\n\r\nfunction serializeState(state: OxygenState): Record<string, unknown> {\r\n    return {\r\n        score: state.score,\r\n        history: state.history,\r\n        turnCount: state.turnCount,\r\n        lastTurnTags: state.lastTurnTags,\r\n        lastFrictionAcceptedTurn: state.lastFrictionAcceptedTurn,\r\n    };\r\n}\r\n\r\nfunction deserializeState(raw: any): OxygenState {\r\n    return {\r\n        score: typeof raw.score === 'number' ? raw.score : DEFAULT_OXYGEN_CONFIG.defaultScore,\r\n        history: Array.isArray(raw.history) ? raw.history : [],\r\n        turnCount: typeof raw.turnCount === 'number' ? raw.turnCount : 0,\r\n        lastTurnTags: Array.isArray(raw.lastTurnTags) ? raw.lastTurnTags : [],\r\n        lastLLMOutput: '',\r\n        lastUserInput: '',\r\n        frictionBonusPending: false,\r\n        lastFrictionAcceptedTurn: typeof raw.lastFrictionAcceptedTurn === 'number' ? raw.lastFrictionAcceptedTurn : -Infinity,\r\n    };\r\n}\r\n\r\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n// OXYGEN MANAGER (orchestrator class)\r\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n\r\nexport class OxygenManager {\r\n    state: OxygenState;\r\n    config: OxygenConfig;\r\n    lastResult: OxygenResult | null = null;\r\n\r\n    constructor(config?: Partial<OxygenConfig>) {\r\n        this.config = { ...DEFAULT_OXYGEN_CONFIG, ...config };\r\n        this.state = createInitialOxygenState(this.config);\r\n    }\r\n\r\n    /**\r\n     * Update config at runtime (e.g. when posture changes).\r\n     * Preserves state (history, turnCount, lastTurnTags).\r\n     */\r\n    updateConfig(overrides: Partial<OxygenConfig>): void {\r\n        this.config = { ...this.config, ...overrides };\r\n    }\r\n\r\n    /** Load persisted state from SQLite */\r\n    async init(): Promise<void> {\r\n        const saved = await loadOxygenState();\r\n        if (saved) {\r\n            this.state = saved;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Evaluate oxygen score from current graph state WITHOUT recording a turn.\r\n     * Same snapshot calculation as recordTurn() ‚Äî both produce identical scores\r\n     * for the same graph state. Does NOT advance history or consume flags.\r\n     * Seeds lastTurnTags on first call so recordTurn() has a baseline.\r\n     */\r\n    evaluate(nodes: KairosNode[], connections: KairosConnection[]): OxygenResult {\r\n        // Seed tag window if empty (first evaluation at startup)\r\n        if (this.state.lastTurnTags.length === 0) {\r\n            this.state.lastTurnTags = [collectAllTags(nodes)];\r\n        }\r\n\r\n        const result = calculateOxygen(this.state, nodes, connections, this.config);\r\n        this.state.score = result.score;\r\n        this.lastResult = result;\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * Record a turn: recalculate oxygen with current graph state + advance history.\r\n     * Call this after each LLM operation completes.\r\n     * Same snapshot calculation as evaluate(), but also:\r\n     *   - Pushes current tags to sliding window\r\n     *   - Increments turnCount\r\n     *   - Consumes frictionBonusPending ‚Üí lastFrictionAcceptedTurn\r\n     *   - Appends to history\r\n     *   - Persists to SQLite\r\n     */\r\n    async recordTurn(nodes: KairosNode[], connections: KairosConnection[]): Promise<OxygenResult> {\r\n        const result = calculateOxygen(this.state, nodes, connections, this.config);\r\n\r\n        // Update score\r\n        this.state.score = result.score;\r\n        this.state.turnCount++;\r\n\r\n        // Sliding window of tags per turn\r\n        const currentTags = collectAllTags(nodes);\r\n        this.state.lastTurnTags.push(currentTags);\r\n        if (this.state.lastTurnTags.length > this.config.tagLookbackTurns) {\r\n            this.state.lastTurnTags.shift();\r\n        }\r\n\r\n        // Consume friction bonus ‚Üí record the turn it was accepted\r\n        if (this.state.frictionBonusPending) {\r\n            this.state.lastFrictionAcceptedTurn = this.state.turnCount;\r\n            this.state.frictionBonusPending = false;\r\n        }\r\n\r\n        // Append to history\r\n        this.state.history.push({\r\n            turn: this.state.turnCount,\r\n            score: result.score,\r\n            delta: result.delta,\r\n            signals: buildSignalSummary(result.signals),\r\n            timestamp: result.timestamp,\r\n        });\r\n        if (this.state.history.length > this.config.maxHistory) {\r\n            this.state.history.shift();\r\n        }\r\n\r\n        this.lastResult = result;\r\n\r\n        // Persist\r\n        await saveOxygenState(this.state);\r\n\r\n        return result;\r\n    }\r\n\r\n    setLLMOutput(text: string): void {\r\n        this.state.lastLLMOutput = text;\r\n    }\r\n\r\n    setUserInput(text: string): void {\r\n        this.state.lastUserInput = text;\r\n    }\r\n\r\n    markFrictionAccepted(): void {\r\n        this.state.frictionBonusPending = true;\r\n    }\r\n\r\n    getScore(): number {\r\n        return this.state.score;\r\n    }\r\n\r\n    getLastResult(): OxygenResult | null {\r\n        return this.lastResult;\r\n    }\r\n\r\n    getFrictionLevel(): FrictionLevel {\r\n        if (this.state.score < this.config.radicalFrictionThreshold) return 'radical';\r\n        if (this.state.score < this.config.moderateFrictionThreshold) return 'moderate';\r\n        return 'none';\r\n    }\r\n\r\n    /** Persist current state to SQLite (call before canvas switch) */\r\n    async save(): Promise<void> {\r\n        await saveOxygenState(this.state);\r\n    }\r\n\r\n    async reset(): Promise<void> {\r\n        this.state = createInitialOxygenState(this.config);\r\n        this.lastResult = null;\r\n        await saveOxygenState(this.state);\r\n    }\r\n\r\n    /** Debug output for console */\r\n    status(): void {\r\n        console.group('[OxygenManager] Status');\r\n        console.log('Score:', this.state.score);\r\n        console.log('Level:', scoreToLevel(this.state.score));\r\n        console.log('Turn:', this.state.turnCount);\r\n        console.log('Friction:', this.getFrictionLevel());\r\n        console.log('Last result:', this.lastResult);\r\n        console.log('Tags window:', this.state.lastTurnTags);\r\n        console.log('History entries:', this.state.history.length);\r\n        console.groupEnd();\r\n    }\r\n\r\n    /**\r\n     * Run and display a full Jaccard analysis on current canvas nodes.\r\n     * Call from console: window.app.oxygen.jaccardReport(window.app.canvas.state.nodes)\r\n     */\r\n    jaccardReport(nodes: KairosNode[]): JaccardAnalysis {\r\n        const analysis = analyzeCanvasJaccard(nodes);\r\n        console.group(`[Jaccard Report] ${nodes.length} nodes, ${analysis.totalPairs} paires`);\r\n        console.log(`Max Jaccard: ${analysis.maxJaccard} (seuil: ${ECHO_JACCARD_THRESHOLD})`);\r\n        console.log(`Paires au-dessus du seuil: ${analysis.pairsAbove}`);\r\n        console.log(`√âcho d√©tect√©: ${analysis.detected ? 'OUI' : 'non'}`);\r\n        if (analysis.topPairs.length > 0) {\r\n            console.log('Top paires:');\r\n            console.table(analysis.topPairs);\r\n        } else {\r\n            console.log('Aucune paire au-dessus du seuil.');\r\n        }\r\n        console.groupEnd();\r\n        return analysis;\r\n    }\r\n\r\n    /** Last Jaccard analysis (from most recent evaluate/recordTurn) */\r\n    getLastJaccardAnalysis(): JaccardAnalysis | null {\r\n        return getLastJaccardAnalysis();\r\n    }\r\n}\r\n\r\n// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\r\n\r\nfunction buildSignalSummary(signals: OxygenSignals): string[] {\r\n    const summary: string[] = [];\r\n    if (signals.newTags.bonus > 0) summary.push(`tags+${signals.newTags.count}`);\r\n    if (signals.llmEcho.malus < 0) summary.push(`echo(${signals.llmEcho.overlap.toFixed(2)})`);\r\n    if (signals.stagnation.malus < 0) summary.push(`stagnation(${signals.stagnation.turns}t)`);\r\n    if (signals.frictionBonus.accepted) summary.push('friction+');\r\n    if (signals.graphStructure.enabled) {\r\n        if (signals.graphStructure.malus < 0)\r\n            summary.push(`graph(r=${signals.graphStructure.ratio.toFixed(1)},c=${signals.graphStructure.components})`);\r\n        if (signals.graphStructure.bonus > 0) summary.push('graph+');\r\n    }\r\n    return summary;\r\n}\r\n","/**\r\n * ThemeManager ‚Äî Gestion des th√®mes visuels KAIROS\r\n *\r\n * 4 th√®mes : Obsidian (dark), Porcelain (light), Aurora (dark bleu), Kraft (warm)\r\n * Persistance localStorage, appliqu√© via data-theme sur <html>\r\n *\r\n * @exports initTheme, applyTheme, getCurrentTheme, setupThemeSelector\r\n */\r\n\r\nimport { createLogger } from './logger.js';\r\n\r\nconst log = createLogger('ThemeManager');\r\n\r\nconst STORAGE_KEY = 'kairos_theme';\r\nconst DEFAULT_THEME = 'obsidian';\r\nconst VALID_THEMES = ['obsidian', 'porcelain', 'aurora', 'kraft'] as const;\r\n\r\nexport type ThemeName = (typeof VALID_THEMES)[number];\r\n\r\nconst THEME_COLORS: Record<ThemeName, string> = {\r\n    obsidian: '#0f1117',\r\n    porcelain: '#e8e6e0',\r\n    aurora: '#0c1222',\r\n    kraft: '#1a1714',\r\n};\r\n\r\nconst THEME_LABELS: Record<ThemeName, string> = {\r\n    obsidian: 'Obsidian',\r\n    porcelain: 'Porcelain',\r\n    aurora: 'Aurora',\r\n    kraft: 'Kraft',\r\n};\r\n\r\n/**\r\n * Initialise le th√®me au chargement de la page.\r\n * Lit localStorage et applique le data-theme sur <html>.\r\n * Appel√© au plus t√¥t dans init() de chaque orchestrateur.\r\n */\r\nexport function initTheme(): void {\r\n    const saved = localStorage.getItem(STORAGE_KEY) as ThemeName | null;\r\n    const theme = saved && (VALID_THEMES as readonly string[]).includes(saved) ? saved : DEFAULT_THEME;\r\n    applyTheme(theme);\r\n    log.info(`Th√®me initial : ${theme}`);\r\n}\r\n\r\n/**\r\n * Applique un th√®me et le persiste dans localStorage.\r\n */\r\nexport function applyTheme(theme: ThemeName): void {\r\n    document.documentElement.setAttribute('data-theme', theme);\r\n    localStorage.setItem(STORAGE_KEY, theme);\r\n\r\n    // Met √† jour l'indicateur actif dans le menu si ouvert\r\n    updateActiveIndicator(theme);\r\n}\r\n\r\n/**\r\n * Retourne le th√®me actuellement actif.\r\n */\r\nexport function getCurrentTheme(): ThemeName {\r\n    return (document.documentElement.getAttribute('data-theme') as ThemeName) || DEFAULT_THEME;\r\n}\r\n\r\n/**\r\n * Configure le s√©lecteur de th√®me dans la toolbar.\r\n * Cherche #btn-theme et #theme-menu dans le DOM.\r\n */\r\nexport function setupThemeSelector(): void {\r\n    const btn = document.getElementById('btn-theme');\r\n    const menu = document.getElementById('theme-menu');\r\n    if (!btn || !menu) {\r\n        log.warn('Bouton ou menu th√®me introuvable dans le DOM');\r\n        return;\r\n    }\r\n\r\n    // Toggle menu\r\n    btn.addEventListener('click', (e: Event) => {\r\n        e.stopPropagation();\r\n        const isVisible = menu.classList.contains('visible');\r\n        if (isVisible) {\r\n            menu.classList.remove('visible');\r\n        } else {\r\n            updateActiveIndicator(getCurrentTheme());\r\n            menu.classList.add('visible');\r\n        }\r\n    });\r\n\r\n    // Click sur une option\r\n    menu.addEventListener('click', (e: Event) => {\r\n        const target = (e.target as HTMLElement).closest('.theme-option') as HTMLElement | null;\r\n        if (!target) return;\r\n\r\n        const theme = target.dataset.theme as ThemeName;\r\n        if (theme && (VALID_THEMES as readonly string[]).includes(theme)) {\r\n            applyTheme(theme);\r\n            menu.classList.remove('visible');\r\n            log.info(`Th√®me chang√© : ${theme}`);\r\n        }\r\n    });\r\n\r\n    // Fermer le menu au clic ailleurs\r\n    document.addEventListener('click', () => {\r\n        menu.classList.remove('visible');\r\n    });\r\n\r\n    // Emp√™cher la fermeture quand on clique dans le menu\r\n    menu.addEventListener('click', (e: Event) => {\r\n        e.stopPropagation();\r\n    });\r\n\r\n    log.info('S√©lecteur de th√®me configur√©');\r\n}\r\n\r\n/**\r\n * Met √† jour la classe .active sur les options du menu + le label/couleur du bouton.\r\n */\r\nfunction updateActiveIndicator(activeTheme: ThemeName): void {\r\n    // Menu options\r\n    const options = document.querySelectorAll('.theme-option');\r\n    options.forEach((opt) => {\r\n        const el = opt as HTMLElement;\r\n        if (el.dataset.theme === activeTheme) {\r\n            el.classList.add('active');\r\n        } else {\r\n            el.classList.remove('active');\r\n        }\r\n    });\r\n\r\n    // Bouton toolbar : label + pastille couleur\r\n    const label = document.getElementById('theme-label');\r\n    if (label) label.textContent = THEME_LABELS[activeTheme];\r\n\r\n    const swatch = document.getElementById('theme-btn-swatch');\r\n    if (swatch) swatch.style.background = THEME_COLORS[activeTheme];\r\n}\r\n","/**\r\n * web-app.ts ‚Äî Orchestrateur version web (iframe int√©grable)\r\n *\r\n * Version all√©g√©e de assisted-app.ts :\r\n * - Pas de persistence (session √©ph√©m√®re)\r\n * - Pas de webview LLM (API-only)\r\n * - Pas de synth√®ses, multi-canvas, minimap, audio\r\n * - Pas de migration DB\r\n */\r\n\r\nimport type { CircularityResult } from './types/kairos.js';\r\nimport { installFgraphShim } from './web/fgraph-shim.js';\r\nimport { setupApiKeyUI } from './web/api-key-ui.js';\r\nimport { setupIframeAPI } from './web/iframe-api.js';\r\n\r\nimport { setupHistoryButtons as _setupHistoryButtons } from './assisted/app/history.js';\r\nimport {\r\n    executeAdaptiveOperation as _executeAdaptiveOperation,\r\n    handleResponseCaptured as _handleResponseCaptured,\r\n    updateFrictionIndicator as _updateFrictionIndicator,\r\n    updateDebugPanel as _updateDebugPanel,\r\n    updateSelectionLLMButton as _updateSelectionLLMButton,\r\n    mapOxygenToCircularity,\r\n} from './assisted/app/adaptive.js';\r\n\r\nimport { StorageManager } from './storage.js';\r\nimport { CanvasManager } from './canvas.js';\r\nimport { HistoryManager } from './history.js';\r\nimport { LLMManager } from './assisted/llm.js';\r\nimport { MetricsManager } from './assisted/metrics.js';\r\nimport { CanvasAnalyzer } from './assisted/canvas-analyzer.js';\r\nimport { LLMApiManager } from './assisted/llm-api.js';\r\nimport { OxygenManager } from './oxygen/oxygen.js';\r\nimport { initTheme, setupThemeSelector } from './theme-manager.js';\r\nimport { initPosture, applyPosture, setupPostureSelector } from './posture-manager.js';\r\nimport { createLogger } from './logger.js';\r\n\r\nconst log = createLogger('WebApp');\r\n\r\ndeclare const window: Window & {\r\n    app?: WebGraphApp;\r\n};\r\n\r\nclass WebGraphApp {\r\n    canvas: CanvasManager | null;\r\n    storage: StorageManager | null;\r\n    llm: LLMManager | null;\r\n    webviewHandler: { canvas: CanvasManager | null } | null;\r\n    metrics: MetricsManager | null;\r\n    syntheses: null; // Pas de synth√®ses en web\r\n\r\n    history: HistoryManager | null;\r\n    currentOperation: string;\r\n    canvasAnalyzer: CanvasAnalyzer | null;\r\n    llmApiManager: LLMApiManager | null;\r\n    oxygen: OxygenManager | null;\r\n\r\n    _switching: boolean;\r\n    _saveChain: Promise<void>;\r\n    _debounceSaveTimer: ReturnType<typeof setTimeout> | null;\r\n\r\n    constructor() {\r\n        this.canvas = null;\r\n        this.storage = null;\r\n        this.llm = null;\r\n        this.webviewHandler = null; // Initialis√© apr√®s canvas\r\n        this.metrics = null;\r\n        this.syntheses = null;\r\n\r\n        this.history = null;\r\n        this.currentOperation = 'D√âVELOPPER';\r\n        this.canvasAnalyzer = null;\r\n        this.llmApiManager = null;\r\n        this.oxygen = null;\r\n\r\n        this._switching = false;\r\n        this._saveChain = Promise.resolve();\r\n        this._debounceSaveTimer = null;\r\n\r\n        this.init();\r\n    }\r\n\r\n    async init(): Promise<void> {\r\n        log.info('Initialisation KAIROS Web...');\r\n\r\n        // 1. Installer le shim AVANT tout autre import/init\r\n        installFgraphShim();\r\n\r\n        // 2. Th√®me\r\n        initTheme();\r\n\r\n        try {\r\n            // 3. Modules de base\r\n            this.storage = new StorageManager();\r\n            this.canvas = new CanvasManager();\r\n            // Shim webviewHandler : seule propri√©t√© requise = .canvas (pour createConnectionsFromParsed)\r\n            this.webviewHandler = { canvas: this.canvas };\r\n            this.llm = new LLMManager();\r\n            await this.llm.loadConfig();\r\n\r\n            // 4. Metrics & Oxygen\r\n            this.metrics = new MetricsManager(this.canvas);\r\n\r\n            try {\r\n                this.oxygen = new OxygenManager();\r\n                await this.oxygen.init();\r\n                if (this.metrics) this.metrics.oxygen = this.oxygen;\r\n                log.info(`OxygenManager initialis√©, score: ${this.oxygen.getScore()}`);\r\n            } catch (e) {\r\n                log.error('Erreur init OxygenManager:', e);\r\n            }\r\n\r\n            // 5. History (undo/redo)\r\n            this.history = new HistoryManager(this);\r\n            _setupHistoryButtons(this);\r\n\r\n            // 6. Canvas Analyzer\r\n            try {\r\n                this.canvasAnalyzer = new CanvasAnalyzer(this);\r\n                await this.canvasAnalyzer.init();\r\n                this.llm.setCanvasAnalyzer(this.canvasAnalyzer);\r\n                if (this.metrics) this.metrics.analyzer = this.canvasAnalyzer;\r\n                log.info('CanvasAnalyzer initialis√©');\r\n            } catch (e) {\r\n                log.error('Erreur init CanvasAnalyzer:', e);\r\n            }\r\n\r\n            // 7. LLM API Manager (API-only, pas de webview fallback)\r\n            this.llmApiManager = new LLMApiManager(this);\r\n            // En web : forcer importVignettesDirect (pas de showVignetteSelectionUI)\r\n            const directImport = this.llmApiManager.importVignettesDirect.bind(this.llmApiManager);\r\n            this.llmApiManager.importVignettes = (vignettes: any[], connections: any[]) => {\r\n                if (vignettes.length === 0 && connections.length > 0) {\r\n                    this.llmApiManager!.importConnections(connections);\r\n                    return;\r\n                }\r\n                if (vignettes.length === 0) return;\r\n                directImport(vignettes, connections);\r\n            };\r\n            log.info(`LLMApiManager: ${this.llmApiManager.isAvailable() ? 'API disponible' : 'pas de cl√©'}`);\r\n\r\n            // 8. Posture\r\n            const savedPosture = initPosture();\r\n            applyPosture(savedPosture, this);\r\n\r\n            // 9. Setup UI\r\n            this.setupToolbar();\r\n            setupThemeSelector();\r\n            setupPostureSelector(this);\r\n            this.setupAdaptiveSystem();\r\n            this.setupEventListeners();\r\n\r\n            // 10. API key modal\r\n            setupApiKeyUI(this.llm, () => {\r\n                // Callback quand cl√© API configur√©e ‚Üí refresh l'√©tat\r\n                if (this.llmApiManager) {\r\n                    log.info(`API key configur√©e, available: ${this.llmApiManager.isAvailable()}`);\r\n                }\r\n            });\r\n\r\n            // 11. iframe API\r\n            setupIframeAPI(this);\r\n\r\n            // 12. M√©triques initiales\r\n            this.metrics.calculateMetrics();\r\n            this.metrics.updateMetricsDisplay();\r\n            if (this.oxygen && this.canvas) {\r\n                this.oxygen.evaluate(this.canvas.state.nodes, this.canvas.state.connections);\r\n            }\r\n            this.metrics.updateSuggestionBanner();\r\n            this.updateDebugPanel();\r\n\r\n            // Exposer pour debug ‚Äî proxy qui masque les cl√©s API\r\n            const self = this;\r\n            window.app = new Proxy(self, {\r\n                get(target: any, prop: string) {\r\n                    if (prop === 'llm') {\r\n                        // Retourner un objet sans les apiKey\r\n                        return {\r\n                            currentProvider: target.llm?.currentProvider,\r\n                            providers: Object.fromEntries(\r\n                                Object.entries(target.llm?.providers || {}).map(\r\n                                    ([k, v]: [string, any]) => [\r\n                                        k,\r\n                                        { ...v, apiKey: v.apiKey ? '***' : null },\r\n                                    ],\r\n                                ),\r\n                            ),\r\n                        };\r\n                    }\r\n                    return target[prop];\r\n                },\r\n            });\r\n\r\n            log.info('KAIROS Web initialis√© avec succ√®s');\r\n        } catch (error) {\r\n            log.error('Erreur initialisation:', error);\r\n        }\r\n    }\r\n\r\n    // ===== TOOLBAR (simplifi√©, pas de fichier externe) =====\r\n\r\n    setupToolbar(): void {\r\n        const createPoleBtn = document.getElementById('create-pole-btn');\r\n        const clearBtn = document.getElementById('clear-btn');\r\n        const treeLayoutBtn = document.getElementById('btn-tree-layout');\r\n\r\n        if (createPoleBtn) {\r\n            createPoleBtn.addEventListener('click', () => this.createNewNode());\r\n        }\r\n\r\n        if (clearBtn) {\r\n            clearBtn.addEventListener('click', () => this.clearGraph());\r\n        }\r\n\r\n        if (treeLayoutBtn) {\r\n            treeLayoutBtn.addEventListener('click', async () => {\r\n                const hasNewlyImported = this.canvas!.state.nodes.some((n: any) => n.newlyImported);\r\n                if (hasNewlyImported) {\r\n                    this.showNotification(\"Validez d'abord les vignettes import√©es\");\r\n                    return;\r\n                }\r\n                if (this.canvas!.state.nodes.filter((n: any) => !n.synthesized).length === 0) {\r\n                    this.showNotification('Aucune vignette √† r√©organiser');\r\n                    return;\r\n                }\r\n                if (this.history) this.history.saveState('layout arbre');\r\n                this.canvas!.applyTreeLayout();\r\n                this.showNotification('Layout en arbre appliqu√©');\r\n            });\r\n        }\r\n    }\r\n\r\n    // ===== ADAPTIVE SYSTEM =====\r\n\r\n    setupAdaptiveSystem(): void {\r\n        // Menu op√©rations (D√âVELOPPER + RELIER dans le bandeau)\r\n        document.querySelectorAll('.btn-operation').forEach((btn: Element) => {\r\n            btn.addEventListener('click', () => {\r\n                const operation = (btn as HTMLElement).dataset.operation;\r\n                if (operation) this.executeAdaptiveOperation(operation);\r\n            });\r\n        });\r\n\r\n        // Boutons flottants de s√©lection\r\n        document.querySelectorAll('.btn-sel-op').forEach((btn: Element) => {\r\n            btn.addEventListener('click', () => {\r\n                const operation = (btn as HTMLElement).dataset.operation;\r\n                if (operation) this.executeAdaptiveOperation(operation);\r\n            });\r\n        });\r\n\r\n        // Hooks m√©triques sur le canvas\r\n        this.setupMetricsHooks();\r\n    }\r\n\r\n    // ===== METRICS HOOKS =====\r\n\r\n    setupMetricsHooks(): void {\r\n        const originalCreateNode = this.canvas!.createNode.bind(this.canvas);\r\n        this.canvas!.createNode = (...args: any[]): any => {\r\n            if (this.history) this.history.saveState('cr√©ation vignette');\r\n            const result = originalCreateNode(...args);\r\n            this.metrics!.recalculateDebounced();\r\n            this.scheduleSave();\r\n            return result;\r\n        };\r\n\r\n        const originalDeleteNode = this.canvas!.deleteNode.bind(this.canvas);\r\n        this.canvas!.deleteNode = async (...args: any[]): Promise<any> => {\r\n            if (this.history) this.history.saveState('suppression vignette');\r\n            const result = await originalDeleteNode(...args);\r\n            this.metrics!.recalculateDebounced();\r\n            await this.saveData();\r\n            return result;\r\n        };\r\n\r\n        const originalCreateConnection = this.canvas!.createConnection.bind(this.canvas);\r\n        this.canvas!.createConnection = (...args: any[]): any => {\r\n            if (this.history) this.history.saveState('cr√©ation connexion');\r\n            const result = originalCreateConnection(...args);\r\n            this.metrics!.recalculateDebounced();\r\n            this.scheduleSave();\r\n            return result;\r\n        };\r\n\r\n        const originalUpdateNodeElement = this.canvas!.updateNodeElement.bind(this.canvas);\r\n        this.canvas!.updateNodeElement = (...args: any[]): any => {\r\n            const result = originalUpdateNodeElement(...args);\r\n            this.metrics!.recalculateDebounced();\r\n            return result;\r\n        };\r\n\r\n        const originalDeleteConnection = this.canvas!.deleteConnection.bind(this.canvas);\r\n        this.canvas!.deleteConnection = (...args: any[]): any => {\r\n            if (this.history) this.history.saveState('suppression connexion');\r\n            const result = originalDeleteConnection(...args);\r\n            this.metrics!.recalculateDebounced();\r\n            this.scheduleSave();\r\n            return result;\r\n        };\r\n\r\n        const originalCycleNodeStatus = this.canvas!.cycleNodeStatus.bind(this.canvas);\r\n        this.canvas!.cycleNodeStatus = (...args: any[]): any => {\r\n            if (this.history) this.history.saveState('changement statut');\r\n            const result = originalCycleNodeStatus(...args);\r\n            const node = args[0];\r\n            if (node && node.status === 'priority') {\r\n                this.showNotification('Ancre du graphe ‚Äî le LLM structurera ses r√©ponses autour de cette vignette');\r\n            }\r\n            this.metrics!.recalculateDebounced();\r\n            this.scheduleSave();\r\n            return result;\r\n        };\r\n\r\n        // √âv√©nements drag\r\n        document.addEventListener('nodeDragStart', () => {\r\n            if (this.history) this.history.saveState('d√©placement vignette');\r\n        });\r\n        document.addEventListener('nodeDragEnd', async () => {\r\n            await this.saveData();\r\n        });\r\n        document.addEventListener('nodeEditStart', () => {\r\n            if (this.history) this.history.saveState('√©dition vignette');\r\n        });\r\n        document.addEventListener('nodeEdited', async () => {\r\n            await this.saveData();\r\n        });\r\n    }\r\n\r\n    // ===== EVENT LISTENERS =====\r\n\r\n    setupEventListeners(): void {\r\n        // Raccourcis clavier\r\n        document.addEventListener('keydown', async (e: KeyboardEvent) => {\r\n            // Ctrl+Shift+D : toggle debug strip\r\n            if (e.ctrlKey && e.shiftKey && (e.key === 'D' || e.key === 'd')) {\r\n                e.preventDefault();\r\n                const strip = document.getElementById('oxygen-strip');\r\n                if (strip) strip.classList.toggle('oxygen-strip-hidden');\r\n            }\r\n        });\r\n\r\n        // Friction accept√©e ‚Üí oxygen\r\n        document.addEventListener('frictionVignetteAccepted', () => {\r\n            this.oxygen?.markFrictionAccepted();\r\n        });\r\n\r\n        // S√©lection chang√©e ‚Üí bouton flottant + bandeau\r\n        document.addEventListener('selectionChanged', () => {\r\n            this.updateSelectionLLMButton();\r\n            if (this.metrics) this.metrics.updateSuggestionBanner();\r\n        });\r\n\r\n        // Connexions chang√©es\r\n        document.addEventListener('connectionsChanged', () => {\r\n            if (this.metrics) this.metrics.recalculateDebounced();\r\n        });\r\n\r\n        // R√©sultat connexions pendantes\r\n        document.addEventListener('connectionsPendingResult', (e: Event) => {\r\n            const detail = (e as CustomEvent).detail;\r\n            this.showNotification(\r\n                `${detail.processed}/${detail.total} connexions cr√©√©es, ${detail.failed} introuvable(s)`,\r\n            );\r\n        });\r\n\r\n        // Suppression de noeud\r\n        document.addEventListener('nodeDeleted', () => {\r\n            if (this.metrics) this.metrics.recalculateDebounced();\r\n        });\r\n\r\n        // Oxygen mis √† jour\r\n        document.addEventListener('oxygenUpdated', () => {\r\n            this.updateDebugPanel();\r\n        });\r\n    }\r\n\r\n    // ===== DELEGATED METHODS (same interface as assisted-app.ts) =====\r\n\r\n    async executeAdaptiveOperation(operation: any): Promise<void> {\r\n        // En web, bloquer si aucune cl√© API configur√©e (pas de fallback webview)\r\n        if (this.llmApiManager && !this.llmApiManager.isAvailable()) {\r\n            this.showNotification('Configurez une cl√© API pour utiliser cette op√©ration');\r\n            // Rouvrir la modal API\r\n            const modal = document.getElementById('api-key-modal');\r\n            if (modal) modal.classList.remove('hidden');\r\n            return;\r\n        }\r\n        await _executeAdaptiveOperation(this, operation);\r\n    }\r\n\r\n    handleResponseCaptured(detail: any): void {\r\n        _handleResponseCaptured(this, detail);\r\n    }\r\n\r\n    updateSelectionLLMButton(): void {\r\n        _updateSelectionLLMButton(this);\r\n    }\r\n\r\n    updateFrictionIndicator(circularityResult: CircularityResult | null = null): void {\r\n        _updateFrictionIndicator(this, circularityResult);\r\n    }\r\n\r\n    updateDebugPanel(circularityResult: CircularityResult | null = null): void {\r\n        _updateDebugPanel(this, circularityResult);\r\n    }\r\n\r\n    // ===== DATA (no-ops via shim, but maintain interface) =====\r\n\r\n    async loadData(): Promise<void> {\r\n        const data = await this.storage!.load();\r\n        if (data) this.canvas!.loadData(data);\r\n    }\r\n\r\n    scheduleSave(): void {\r\n        if (this._switching) return;\r\n        if (this._debounceSaveTimer) clearTimeout(this._debounceSaveTimer);\r\n        this._debounceSaveTimer = setTimeout(() => {\r\n            this._debounceSaveTimer = null;\r\n            void this.saveData();\r\n        }, 300);\r\n    }\r\n\r\n    async saveData(historyAction: string | null = null): Promise<void> {\r\n        if (this._switching) return;\r\n        if (historyAction && this.history) this.history.saveState(historyAction);\r\n        if (this._debounceSaveTimer) {\r\n            clearTimeout(this._debounceSaveTimer);\r\n            this._debounceSaveTimer = null;\r\n        }\r\n        // Le shim rend save no-op, mais on garde l'interface\r\n        this._saveChain = this._saveChain\r\n            .then(async () => {\r\n                const data = this.canvas!.getData();\r\n                await this.storage!.save(data);\r\n            })\r\n            .catch((e) => log.error('Erreur sauvegarde:', e));\r\n        await this._saveChain;\r\n    }\r\n\r\n    // ===== ACTIONS =====\r\n\r\n    createNewNode(): void {\r\n        const rect = this.canvas!.polesContainer.getBoundingClientRect();\r\n        const centerX = rect.width / 2 - this.canvas!.state.panX;\r\n        const centerY = rect.height / 2 - this.canvas!.state.panY;\r\n        const node = this.canvas!.createNode(centerX, centerY, 'Nouvelle vignette');\r\n        setTimeout(() => {\r\n            (this.canvas as any).showEditModal(node, true);\r\n        }, 10);\r\n    }\r\n\r\n    async clearGraph(): Promise<void> {\r\n        if (!confirm('Effacer tout le canvas ? Cette action est irr√©versible.')) return;\r\n\r\n        try {\r\n            if (this.history) this.history.saveState('clear canvas');\r\n            this.canvas!.clear();\r\n            if (this.history) this.history.clear();\r\n            if (this.llm && this.llm.canvasHistory) this.llm.canvasHistory.reset();\r\n            if (this.canvasAnalyzer) this.canvasAnalyzer.reset();\r\n            if (this.oxygen) await this.oxygen.reset();\r\n            this.updateFrictionIndicator({ score: 0, signals: [], shouldInjectFriction: false });\r\n\r\n            if (this.metrics) {\r\n                this.metrics.calculateMetrics();\r\n                this.metrics.updateMetricsDisplay();\r\n                this.metrics.updateSuggestionBanner();\r\n            }\r\n\r\n            this.showNotification('Canvas effac√©');\r\n        } catch (error) {\r\n            log.error('Erreur clearGraph:', error);\r\n            this.showNotification(\"Erreur lors de l'effacement\");\r\n        }\r\n    }\r\n\r\n    showNotification(message: string, _type?: string): void {\r\n        const notification = document.createElement('div');\r\n        notification.style.cssText = `\r\n            position: fixed;\r\n            bottom: 80px;\r\n            left: 50%;\r\n            transform: translateX(-50%);\r\n            background: var(--theme-notification-bg);\r\n            color: var(--theme-text-primary);\r\n            padding: 12px 24px;\r\n            border-radius: 6px;\r\n            z-index: 2000;\r\n            font-size: 14px;\r\n            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);\r\n        `;\r\n        notification.textContent = message;\r\n        document.body.appendChild(notification);\r\n        setTimeout(() => {\r\n            notification.style.opacity = '0';\r\n            notification.style.transition = 'opacity 0.3s';\r\n            setTimeout(() => notification.remove(), 300);\r\n        }, 2000);\r\n    }\r\n}\r\n\r\n// ===== BOOTSTRAP =====\r\nnew WebGraphApp();\r\n"],"names":["msg","url","line","_col","_error","createLogger","tag","prefix","args","log","apiKeyStore","proxyUrl","ALLOWED_PROXY_PATTERNS","isProxyUrlAllowed","pattern","setProxyUrl","callLLMDirect","params","provider","apiKey","model","messages","systemPrompt","options","maxTokens","headers","body","fullMessages","response","safeError","data","content","thinking","block","callLLMProxy","errorText","error","installFgraphShim","key","value","DEFAULT_MODELS","setupApiKeyUI","llm","onConfigured","modal","providerSelect","modelInput","keyInput","saveBtn","cancelBtn","configBtn","lastProvider","updateModelForProvider","defaultModel","openModal","currentProvider","closeModal","hasApiKey","e","p","ALLOWED_ORIGINS","trustedParentOrigin","sanitizeErrorMessage","sendToParent","payload","setupIframeAPI","app","isInIframe","event","handleConfig","handleSetApiKey","origin","emitNodeCount","count","setupHistoryButtons","undoBtn","redoBtn","defaultTemplates","interpolateTemplate","template","variables","result","activeTemplates","getTemplates","setCustomTemplates","overrides","op","regimes","devOverrides","devDefaults","levels","resetTemplates","STORAGE_KEY","DEFAULT_POSTURE","VALID_POSTURES","POSTURE_COLORS","POSTURE_LABELS","POSTURE_CONFIGS","_currentPosture","initPosture","saved","applyPosture","name","config","updateActiveIndicator","getCurrentPosture","setupPostureSelector","btn","menu","target","posture","activePosture","opt","el","label","swatch","mapOxygenToCircularity","oxygenResult","mappedScore","executeAdaptiveOperation","operation","selectedIds","selectedVignettes","n","contexte","circularityResult","updateFrictionIndicator","subMode","syntheseReinjected","prompt","logEntryId","signalNames","s","selectionInfo","handleResponseCaptured","detail","vignettesForSynthese","connections","connectedIds","c","v","synthese","updateDebugPanel","_circularityResult","strip","oxygenScore","lastResult","level","scoreEl","delta","text","updateDebugMetricsStrip","suggestion","elO2","state","elMode","sub","elFric","fl","injected","elEcho","maxJ","echoDetected","elStruct","gs","elPosture","cfg","elSynth","ready","updateSelectionLLMButton","button","countSpan","currentCanvasId","getCanvasId","VALID_CONNECTION_TYPES","validateCanvasState","nodes","errors","warnings","nodeIdSet","duplicateNodeIds","node","priorityNodes","connIdSet","pairSet","conn","pairKey","repairState","seenNodeIds","repairedNodes","foundPriority","validNodeIds","seenConnIds","seenPairs","repairedConnections","StorageManager","rawConnections","validation","issue","hasNodes","hasConnections","hasVignettes","savedData","parsed","hasPoles","blob","a","file","resolve","reject","reader","oldData","MiniMap","canvasManager","rect","x","y","bounds","zoom","containerRect","worldX","worldY","deltaX","deltaY","worldDeltaX","worldDeltaY","newZoom","lastUpdate","UPDATE_INTERVAL","tick","timestamp","panX","panY","viewLeft","viewTop","viewRight","viewBottom","minX","minY","maxX","maxY","margin","scaleX","scaleY","cs","bgDeep","nodeFill","nodeBorder","textSecondary","connImplies","connResonance","badgeRedBg","w","h","borderColor","fillColor","nodeMap","fromNode","toNode","x1","y1","x2","y2","worldViewLeft","worldViewTop","screenWorldWidth","screenWorldHeight","viewX","viewY","viewW","viewH","ensureNodeMap","cm","enterConnectionMode","nodeDiv","exitConnectionMode","toggleConnectionModeWaiting","createConnection","type","mechanism","connection","scheduleConnectionRender","renderAllConnections","queueConnection","fromNodeId","toNodeId","existsInConnections","existsInPending","pendingConn","processPendingConnections","waitForDOMStable","processed","failed","pending","fromElement","toElement","timeout","lastChangeTime","resolved","observer","checkStable","deleteConnection","existingLines","existingHitboxes","lineMap","path","connId","hitboxMap","currentConnectionIds","fromCenter","getNodeCenter","toCenter","newD","calculatePathD","hitbox","renderConnection","forceRefreshConnections","rebuildAllConnections","defs","updateConnections","updateNodeConnections","nodeId","relatedConnections","existingPath","nodeSizeCache","invalidateNodeSizeCache","from","to","dy","curvature","cx1","cy1","cx2","cy2","width","height","cached","element","pathD","isArchived","title","hitboxTitle","markerMap","getData","loadData","rawNodes","clearCanvas","toggleStatusFilter","status","applyFilters","updateConnectionsVisibility","isFromVisible","isToVisible","SpatialGrid","cellWidth","cellHeight","cx","cy","id","k","pos","cell","NODE_WIDTH","NODE_HEIGHT","COLLISION_MARGIN","checkCollision","w1","h1","w2","h2","isPositionFree","grid","candidates","findFreePosition","startX","startY","buildSpatialGrid","step","maxAttempts","attempt","radius","angles","angle","rad","getVisibleBottomPosition","index","total","nodeWidth","nodeHeight","visibleBottom","visibleLeft","visibleWidth","cols","col","row","adjustPositionForCollisions","excludeNodeId","pushDistance","adjustedX","adjustedY","hasCollision","maxIterations","iterations","centerX1","centerY1","centerX2","centerY2","distance","pushX","pushY","getSmartImportPosition","connectionTargetId","targetNode","offsetX","offsetY","idealX","idealY","SYNTHESIS_ZONE_GAP","SYNTHESIS_STACK_GAP","relocateSynthesizedNodes","_newIds","allSynthesized","activeNodes","activeMaxX","activeMinY","right","baseY","newPositions","i","animateNodesToPositions","durationMs","onComplete","elements","rafId","animateConnections","detectCollisions","collisions","j","n1","n2","checked","nearbyIds","resolveAllCollisions","movedNodes","node2","newPos","handleZoom","oldZoom","mouseX","mouseY","canvasX","canvasY","applyTransform","transform","nodeScale","startPan","updatePan","stopPan","centerOnNode","centerX","centerY","TREE_LAYER_GAP","TREE_NODE_GAP","TREE_COMPONENT_GAP","buildImpliesGraph","graph","parent","child","roots","assignLayers","visited","queue","root","depth","childId","layers","layer","minimizeCrossings","maxDepth","d","prevLayer","parentPos","barycenters","sum","parentId","b","nextLayer","childPos","calculatePositions","positions","maxLayerWidth","layerWidths","layerWidth","layerOffsetX","findConnectedComponents","components","startId","component","stack","neighborId","layoutAllComponents","allPositions","treeComponents","isolatedNodes","currentOffsetX","maxTreeHeight","subGraph","componentRoots","effectiveRoots","isolatedY","isolatedGap","applyTreeLayout","fitViewportToNodes","containerWidth","containerHeight","newPanX","newPanY","toggleNodeSelection","isSelected","updateNodeSelectionVisual","updateSelectionToolbar","clearSelection","checkbox","selectAllNodes","getConnectedNodes","nodeIds","_selectionToolbarTimeout","_updateSelectionToolbarNow","toolbar","createSelectionToolbar","chatIndicator","deleteBtn","clearBtn","createContextMenu","hideContextMenu","action","option","showContextMenu","screenX","screenY","createNodeMenu","hideNodeMenu","handleNodeMenuAction","showNodeMenu","createEditModal","showCreateModal","blurAllNodeElements","blurWebview","setWebviewInert","textInput","statusSelect","tagsInput","showEditModal","hideEditModal","saveEditModal","newText","newStatus","parsedTags","t","newNode","focusables","_cm","webview","inert","webviewContainer","createConnectionTypeMenu","ct","handleConnectionTypeSelection","hideConnectionTypeMenu","lastChild","showConnectionTypeMenu","createConnectionContextMenu","deleteOption","hideConnectionContextMenu","showConnectionContextMenu","getNodeFromElement","poleElement","startDragNode","cleanupDrag","isMultiDrag","nodesToDrag","initialPositions","startMouseX","startMouseY","DRAG_THRESHOLD","canvasRect","mouseCanvasX","mouseCanvasY","nodeElements","lastMouseX","lastMouseY","hasDragStarted","onMouseMove","distanceMoved","newMainX","newMainY","initialMainPos","initialPos","onMouseUp","_e","oldNodeElement","ensureNodeEventDelegation","currentNode","actualNode","isCurrentlySelected","createNode","tags","skipAutoPosition","finalPos","renderNode","className","hasFrictionTag","header","connectBtn","captureMeta","platformIcons","platformIcon","roleLabel","tagsContainer","tagSpan","accentBar","port","updateNodeElement","isReinjected","isSynthesized","isFromCapture","isNewlyImported","isFriction","statusBadge","getStatusIcon","deleteNode","skipBlurWebview","nodeEl","deleteSelectedNodes","confirmMsg","forceRefreshCanvas","cycleNodeStatus","statusCycle","currentIndex","other","CanvasManager","_updateNodeConnections","canvasArea","_checkCollision","_isPositionFree","_findFreePosition","_getVisibleBottomPosition","_getSmartImportPosition","synthesizedIds","_relocateSynthesizedNodes","_animateNodesToPositions","_applyTreeLayout","_fitViewportToNodes","_createNode","_renderNode","_updateNodeElement","_deleteNode","_deleteSelectedNodes","_blurWebview","_forceRefreshCanvas","_getStatusIcon","_cycleNodeStatus","_toggleNodeSelection","_updateNodeSelectionVisual","_clearSelection","_selectAllNodes","_getConnectedNodes","_updateSelectionToolbar","_createSelectionToolbar","_adjustPositionForCollisions","_getNodeFromElement","_startDragNode","_cleanupDrag","_enterConnectionMode","_exitConnectionMode","_toggleConnectionModeWaiting","_createConnection","_scheduleConnectionRender","_queueConnection","_processPendingConnections","_waitForDOMStable","_deleteConnection","_renderAllConnections","_forceRefreshConnections","_rebuildAllConnections","_updateConnections","_getNodeCenter","_renderConnection","_handleZoom","_applyTransform","_startPan","_updatePan","_stopPan","_centerOnNode","_createContextMenu","_showContextMenu","_hideContextMenu","_createNodeMenu","_showNodeMenu","_hideNodeMenu","_handleNodeMenuAction","_createEditModal","_showCreateModal","_blurAllNodeElements","_setWebviewInert","_showEditModal","_hideEditModal","_saveEditModal","_createConnectionTypeMenu","_showConnectionTypeMenu","_hideConnectionTypeMenu","_handleConnectionTypeSelection","_createConnectionContextMenu","_showConnectionContextMenu","_hideConnectionContextMenu","_detectCollisions","_resolveAllCollisions","_toggleStatusFilter","_applyFilters","_updateConnectionsVisibility","_getData","_loadData","HistoryManager","maxSize","actionName","lastState","state1","state2","currentState","previousState","redoState","LLMManager","tsA","tsB","relevantConnections","inDegree","adjacency","sorted","degree","targetId","newDegree","configStr","vignettes","vignetteSelectionnees","regime","selection","selectionIds","connectionsInternes","vignettesActives","voisinage","vignettesFiltered","vignettesIds","connectionsFiltered","limit","prioritaires","prioritairesIds","autres","totalVignettes","allVignettes","voisinageMap","fromInSelection","toInSelection","voisinNode","statusOverride","symbol","synth","nbVignettes","date","templates","framingKey","anchor","idx","anchorInSelection","anchorInVoisinage","anchorText","startIndex","selNode","targetCount","isolatedCount","connectionTarget","topKeywords","topKeywordsCanvas","graphContext","userMessage","isChat","messageToSend","contextMessage","ipcResponse","contents","m","analyzer","canvasHistory","enabled","lastUserInput","lastLLMOutput","basePrompt","userInput","MetricsManager","activeNodeIds","vignettePrioritaires","vignetteNeutres","activeConnections","connexionsImplique","connexionsResonance","connectedNodeIds","vignetteConnectees","vignetteIsolees","connexionsTotal","densiteConnexions","ratioPriorite","selectionCount","ratioIsolees","trend","circularity","circularityThreshold","selectedSet","internalConnections","maxPossible","metriquesText","bannerText","banner","emoji","synthBadge","DEFAULT_CONFIG","SIGNALS","EMPTY_VALIDATION_PATTERNS","STOPWORDS","createInitialHistory","createInitialBehaviorLogs","ReferentielsLoader","r","files","results","loadedCount","referentiel","items","category","weight","textLower","detected","item","normalizeTags","extractKeywords","jaccardDistance","setA","setB","intersection","union","calculateDiversity","latestNode","latestTags","latestKeywords","distances","otherTags","overlap","maxLen","wordsA","wordsB","diversityTrend","history","recent","weights","_","midWeight","cumWeight","firstWeightedSum","secondWeightedSum","firstWeightTotal","secondWeightTotal","firstMean","diff","getCanvasTopKeywords","topN","frequencyMap","keyword","bootstrapDiversityHistory","currentTags","currentKeywords","prevTags","maxEntries","saveHistory","loadHistory","reset","migrateOldStorage","_analyzer","recordTurn","currentNodes","currentConnections","previousIds","hasNewConcept","hasNewFrictionVignette","isFrictionVignette","updateHistory","diversityResult","loadReferentiels","setupEventListeners","trackSelection","trackConnectionEvent","trackLLMSend","trackCapture","fromId","toId","textMatch","tagMatch","detectCircularity","signals","score","reformulations","detectReformulations","hasConnectionCycle","isEmptyValidation","saturatedTags","detectSaturatedTags","detectLLMEcho","frictionBonusApplied","canInjectFriction","isSemanticallyClose","text1","text2","kw1","kw2","recursionStack","hasCycle","neighbor","tagCounts","normalized","_tag","nodeHasSaturatedTag","nodeTags","input","userKeywords","llmKeywords","buildFrictionBlock","context","threshold","isStrong","injectFriction","buildFrictionContext","keywords","mechanisms","generateRecommendations","_attractors","recommendations","CanvasAnalyzer","_loadReferentiels","_loadHistory","_migrateOldStorage","_setupEventListeners","_bootstrapDiversityHistory","_saveHistory","_detectCircularity","shouldInjectFriction","_canInjectFriction","_generateRecommendations","_recordTurn","_updateHistory","_reset","_trackSelection","_trackLLMSend","_trackCapture","_trackConnectionEvent","_detectReformulations","_isSemanticallyClose","_hasConnectionCycle","_detectSaturatedTags","_nodeHasSaturatedTag","_isEmptyValidation","_detectLLMEcho","_isFrictionVignette","_buildFrictionBlock","_injectFriction","_extractKeywords","_calculateDiversity","_diversityTrend","_getCanvasTopKeywords","analysis","original","cleanSynthesisText","endPatterns","cleaned","parseSuggestedPoles","responseText","extractTags","str","tagRegex","cutAtNextMarker","markers","cutIndex","marker","match","allMarkersRegex","parts","segment","pipeIndex","beforePipe","afterPipe","allTags","arrowIndex","firstLine","altRegex","description","tagsStr","quotedRegex","dashRegex","cleanText","dashBracketRegex","parseSuggestedConnections","cleanQuotes","segments","arrowMatch","symbolRaw","fromText","afterArrow","toText","justification","findVignetteByText","handler","searchText","searchLower","found","bestMatch","bestRatio","vLower","ratio","searchStart","vignetteStart","searchWords","bestCount","vignetteWords","matchCount","sw","vw","bestScore","createConnectionsFromParsed","parsedConnections","queued","API_SUPPORTED_PROVIDERS","hasAPIKey","providerName","getAPIProvider","apiProviderName","isAPIAvailable","routeOperation","_operation","apiProvider","setAPIProvider","setAPIModeEnabled","executeViaAPI","onSuccess","onError","onProgress","API_TIMEOUT_MS","timeoutPromise","parseAPIResponse","parseError","cleanedText","showAPILoadingState","hideAPILoadingState","overlay","providerInfo","updateAPILoadingState","message","textEl","showAPIError","onRetry","onFallbackWebview","onDismiss","existing","errorMessage","canRetry","msgEl","showAPISuccess","duration","notification","injectAPIStyles","styles","PROVIDERS_INFO","showAPIConfigModal","onSave","apiModeEnabled","currentAPIProvider","info","hasKey","inputEl","apiEnabled","inputs","setupAPIConfigButton","llmApiManager","updateAPIConfigIndicator","available","hasAnyKey","badge","activeProvider","injectConfigStyles","LLMApiManager","routing","success","rawContent","vignette","targetNodeId","toLower","vigLower","nLower","fLower","created","_contexte","countConnectedComponents","adj","current","calculateConnectionDensity","evaluateGraphStructure","minNodes","malus","bonus","DEFAULT_OXYGEN_CONFIG","MAX_TAG_BONUS_PER_TURN","MAX_FRICTION_BONUS_PER_TURN","FRICTION_DECAY_TURNS","ECHO_JACCARD_THRESHOLD","ECHO_JACCARD_MALUS","createInitialOxygenState","analyzeCanvasJaccard","kwSets","jaccard","_lastJaccardAnalysis","detectCanvasRedundancy","getLastJaccardAnalysis","collectAllTags","scoreToLevel","calculateOxygen","hasRedundancy","jaccardInfo","tagResult","computeTagDiversity","frictionResult","computeFrictionSnapshot","newScore","frictionLevel","tagHistory","turnCount","baseline","newTags","saveOxygenState","fgraph","serializeState","loadOxygenState","deserializeState","raw","OxygenManager","buildSignalSummary","summary","DEFAULT_THEME","VALID_THEMES","THEME_COLORS","THEME_LABELS","initTheme","theme","applyTheme","getCurrentTheme","setupThemeSelector","activeTheme","WebGraphApp","_setupHistoryButtons","directImport","savedPosture","self","prop","createPoleBtn","treeLayoutBtn","originalCreateNode","originalDeleteNode","originalCreateConnection","originalUpdateNodeElement","originalDeleteConnection","originalCycleNodeStatus","_executeAdaptiveOperation","_handleResponseCaptured","_updateSelectionLLMButton","_updateFrictionIndicator","_updateDebugPanel","historyAction","_type"],"mappings":"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"}